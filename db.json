{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","path":"lib/needsharebutton/font-embedded.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","path":"lib/needsharebutton/needsharebutton.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","path":"lib/needsharebutton/needsharebutton.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","path":"lib/Han/dist/font/han.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1}],"Cache":[{"_id":"source/_drafts/如何设计并实现一个db连接池？.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616348583589},{"_id":"source/_discarded/Spring-Cloud-Eureka-使用Nginx做路由网关-1.md","hash":"ff0a54fd95ae4d6df527344aa0b46704e31c3509","modified":1616348583798},{"_id":"source/_posts/Kick-Start-Round-A-2021-L-Shaped-Plots.md","hash":"67d29750c04d85a2b4dac5f6c23937b7811edc88","modified":1616360144670},{"_id":"source/_posts/Kick-Start-Round-A-2021-K-Goodness-String.md","hash":"93c820d328c8ff71872d16fc5afdbdbf5f088ada","modified":1616360164444},{"_id":"source/_posts/Google-Code-Jam-Round-1A-2021-Rabbit-House.md","hash":"f1580a4bf3c5f98142c365ed17b970a7cf1e1b20","modified":1618409089139},{"_id":"source/_posts/Jenkins安装及自动部署Maven项目.md","hash":"c12420e67fca7a5e349755c2a65664c18a2e0ebe","modified":1616348586310},{"_id":"source/_posts/Kick-Start-Round-A-2021-Rabbit-House.md","hash":"9dc6bae99d71245e104396d55395ecc278d27e3d","modified":1616388844807},{"_id":"source/_posts/Linux平台Nginx的安装及使用.md","hash":"9d0876330f9d67d91109cd9c6ea81227c55660a0","modified":1616348585066},{"_id":"source/_posts/Spring-Cloud-Config-入门.md","hash":"15f86d5e53552874e2dc23c3b2ae67a114096f04","modified":1616348585237},{"_id":"source/_posts/Round-1C-2021-Code-Jam-2021-Closest-Pick.md","hash":"0e216fb4f225dc431a90fbe81c3fb7329f031c61","modified":1619872133192},{"_id":"source/_posts/Spring-Cloud-Eureka-使用Nginx做路由网关.md","hash":"a65ea9fd1b77c08c8ecd4959044ddd3d18e77b44","modified":1616348585956},{"_id":"source/_posts/如何使用Defender优雅的管理权限？.md","hash":"a30f54d67504bb824ea166bb7a1939be728706fa","modified":1616348584536},{"_id":"source/_posts/Spring-Cloud-Gateway深入探究.md","hash":"36fb301cdee98eb7bc3dc1c7fd284a219d03b9c2","modified":1616348584421},{"_id":"source/_posts/hello-world.md","hash":"b4a99093815eb852fb5683c6928ed84395399b5f","modified":1616348585797},{"_id":"source/_posts/【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计.md","hash":"975a62ab523a7901f183f4a3415ec208fe667d0b","modified":1645504012166},{"_id":"source/_posts/如何设计并实现一个db连接池？.md","hash":"77b73dafc933efd5019c3606d70af8262e00fcad","modified":1616348585651},{"_id":"source/_posts/测试，hexo.md","hash":"8a7f6e460c1f1022c9716d74e9511b6852efcd35","modified":1616348584893},{"_id":"source/_posts/深入JAVA8的HashMap实现原理.md","hash":"11df54e0c75c88dfb5905aa34f811a56d7dce122","modified":1616348584770},{"_id":"source/_posts/存储介质.md","hash":"814fd932efca4ab67b8c0f662a24e42e8118bbc2","modified":1645504565296},{"_id":"source/_posts/深入浅说服务如何以Jar包的方式发布.md","hash":"64997dcbebaf809840d4f7756684e53053513fb2","modified":1616348585559},{"_id":"source/_posts/设计模式一：单例模式.md","hash":"9f3809c04a74ffb1290b0594e112ab9944101889","modified":1616348586193},{"_id":"source/categories/index.md","hash":"bce57d4f95379ad6c6fdfeb272b68ac6dc7cc45c","modified":1616359990286},{"_id":"source/tags/index.md","hash":"ad432e1b7c2b9a7ecd2231d63d61607f4444af32","modified":1616359987033},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399338},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399283},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399283},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399329},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399329},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399330},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399337},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616359399338},{"_id":"themes/next/.bowerrc","hash":"334da94ca6f024d60d012cc26ea655681e724ad8","modified":1616359399261},{"_id":"themes/next/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1616359399262},{"_id":"themes/next/.gitattributes","hash":"8454b9313cb1a97b63fb87e2d29daee497ce6249","modified":1616359399262},{"_id":"themes/next/.gitignore","hash":"ee0b13c268cc8695d3883a5da84930af02d4ed08","modified":1616359399262},{"_id":"themes/next/.javascript_ignore","hash":"cd250ad74ca22bd2c054476456a73d9687f05f87","modified":1616359399263},{"_id":"themes/next/.hound.yml","hash":"289dcf5bfe92dbd680d54d6e0668f41c9c9c0c78","modified":1616359399263},{"_id":"themes/next/.jshintrc","hash":"b7d23f2ce8d99fa073f22f9960605f318acd7710","modified":1616359399263},{"_id":"themes/next/.stylintrc","hash":"3b7f9785e9ad0dab764e1c535b40df02f4ff5fd6","modified":1616359399264},{"_id":"themes/next/.travis.yml","hash":"6674fbdfe0d0c03b8a04527ffb8ab66a94253acd","modified":1616359399264},{"_id":"themes/next/LICENSE","hash":"ec44503d7e617144909e54533754f0147845f0c5","modified":1616359399264},{"_id":"themes/next/README.cn.md","hash":"23e92a2599725db2f8dbd524fbef2087c6d11c7b","modified":1616359399265},{"_id":"themes/next/README.md","hash":"50abff86ffe4113051a409c1ed9261195d2aead0","modified":1616359399265},{"_id":"themes/next/_config.yml","hash":"d4b868e5ea4aea628eefedc2bb386977c5b126c3","modified":1616359399266},{"_id":"themes/next/bower.json","hash":"486ebd72068848c97def75f36b71cbec9bb359c5","modified":1616359399266},{"_id":"themes/next/gulpfile.coffee","hash":"412defab3d93d404b7c26aaa0279e2e586e97454","modified":1616359399267},{"_id":"themes/next/languages/de.yml","hash":"fd02d9c2035798d5dc7c1a96b4c3e24b05b31a47","modified":1616359399267},{"_id":"themes/next/languages/en.yml","hash":"2f4b4776ca1a08cc266a19afb0d1350a3926f42c","modified":1616359399268},{"_id":"themes/next/package.json","hash":"3963ad558a24c78a3fd4ef23cf5f73f421854627","modified":1616359399298},{"_id":"themes/next/languages/default.yml","hash":"b3bcd8934327448a43d9bfada5dd11b1b8c1402e","modified":1616359399267},{"_id":"themes/next/languages/fr-FR.yml","hash":"efeeb55d5c4add54ad59a612fc0630ee1300388c","modified":1616359399268},{"_id":"themes/next/languages/id.yml","hash":"dccae33e2a5b3c9f11c0e05ec4a7201af1b25745","modified":1616359399268},{"_id":"themes/next/languages/it.yml","hash":"a215d016146b1bd92cef046042081cbe0c7f976f","modified":1616359399268},{"_id":"themes/next/languages/ja.yml","hash":"37f954e47a3bc669620ca559e3edb3b0072a4be5","modified":1616359399269},{"_id":"themes/next/languages/pt-BR.yml","hash":"568d494a1f37726a5375b11452a45c71c3e2852d","modified":1616359399270},{"_id":"themes/next/languages/ko.yml","hash":"dc8f3e8c64eb7c4bb2385025b3006b8efec8b31d","modified":1616359399269},{"_id":"themes/next/languages/nl-NL.yml","hash":"213e7a002b82fb265f69dabafbbc382cfd460030","modified":1616359399269},{"_id":"themes/next/languages/ru.yml","hash":"e33ee44e80f82e329900fc41eb0bb6823397a4d6","modified":1616359399270},{"_id":"themes/next/languages/pt.yml","hash":"2efcd240c66ab1a122f061505ca0fb1e8819877b","modified":1616359399270},{"_id":"themes/next/languages/zh-Hans.yml","hash":"66b9b42f143c3cb2f782a94abd4c4cbd5fd7f55f","modified":1616359399271},{"_id":"themes/next/languages/vi.yml","hash":"a9b89ebd3e5933033d1386c7c56b66c44aca299a","modified":1616359399271},{"_id":"themes/next/languages/zh-hk.yml","hash":"fe0d45807d015082049f05b54714988c244888da","modified":1616359399271},{"_id":"themes/next/layout/_layout.swig","hash":"2164570bb05db11ee4bcfbbb5d183a759afe9d07","modified":1616359399273},{"_id":"themes/next/languages/zh-tw.yml","hash":"432463b481e105073accda16c3e590e54c8e7b74","modified":1616359399272},{"_id":"themes/next/layout/archive.swig","hash":"9a2c14874a75c7085d2bada5e39201d3fc4fd2b4","modified":1616359399296},{"_id":"themes/next/layout/category.swig","hash":"3cbb3f72429647411f9e85f2544bdf0e3ad2e6b2","modified":1616359399296},{"_id":"themes/next/layout/page.swig","hash":"e8fcaa641d46930237675d2ad4b56964d9e262e9","modified":1616359399297},{"_id":"themes/next/layout/index.swig","hash":"555a357ecf17128db4e29346c92bb6298e66547a","modified":1616359399297},{"_id":"themes/next/layout/schedule.swig","hash":"87ad6055df01fa2e63e51887d34a2d8f0fbd2f5a","modified":1616359399298},{"_id":"themes/next/layout/tag.swig","hash":"34e1c016cbdf94a31f9c5d494854ff46b2a182e9","modified":1616359399298},{"_id":"themes/next/layout/post.swig","hash":"7a6ce102ca82c3a80f776e555dddae1a9981e1ed","modified":1616359399297},{"_id":"themes/next/scripts/merge-configs.js","hash":"38d86aab4fc12fb741ae52099be475196b9db972","modified":1616359399299},{"_id":"themes/next/scripts/merge.js","hash":"39b84b937b2a9608b94e5872349a47200e1800ff","modified":1616359399300},{"_id":"themes/next/test/.jshintrc","hash":"c9fca43ae0d99718e45a6f5ce736a18ba5fc8fb6","modified":1616359399399},{"_id":"themes/next/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1616359399400},{"_id":"themes/next/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1616359399399},{"_id":"themes/next/layout/_custom/header.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1616359399272},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"8c56dd26157cbc580ae41d97ac34b90ab48ced3f","modified":1616359399273},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1616359399273},{"_id":"themes/next/layout/_macro/post.swig","hash":"4ba938822d56c597490f0731893eaa2443942e0f","modified":1616359399274},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"f83befdc740beb8dc88805efd7fbb0fef9ed19be","modified":1616359399274},{"_id":"themes/next/layout/_macro/reward.swig","hash":"357d86ec9586705bfbb2c40a8c7d247a407db21a","modified":1616359399274},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"9c7343fd470e0943ebd75f227a083a980816290b","modified":1616359399275},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"e2e4eae391476da994045ed4c7faf5e05aca2cd7","modified":1616359399275},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"c0f5a0955f69ca4ed9ee64a2d5f8aa75064935ad","modified":1616359399281},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"931808ad9b8d8390c0dcf9bdeb0954eeb9185d68","modified":1616359399281},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9be624634703be496a5d2535228bc568a8373af9","modified":1616359399284},{"_id":"themes/next/layout/_partials/footer.swig","hash":"776fa8751e79279dd16881b76e42c8f73be3e793","modified":1616359399276},{"_id":"themes/next/layout/_partials/comments.swig","hash":"4adc65a602d1276615da3b887dcbf2ac68e7382b","modified":1616359399275},{"_id":"themes/next/layout/_partials/head.swig","hash":"f14a39dad1ddd98e6d3ceb25dda092ba80d391b5","modified":1616359399276},{"_id":"themes/next/layout/_partials/header.swig","hash":"c54b32263bc8d75918688fb21f795103b3f57f03","modified":1616359399277},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"77c61e0baea3544df361b7338c3cd13dc84dde22","modified":1616359399277},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"1634fb887842698e01ff6e632597fe03c75d2d01","modified":1616359399278},{"_id":"themes/next/layout/_partials/search.swig","hash":"b4ebe4a52a3b51efe549dd1cdee846103664f5eb","modified":1616359399278},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"a0bd3388587fd943baae0d84ca779a707fbcad89","modified":1616359399292},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"ba75672183d94f1de7c8bd0eeee497a58c70e889","modified":1616359399291},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"8301c9600bb3e47f7fb98b0e0332ef3c51bb1688","modified":1616359399292},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"fa882641da3bd83d9a58a8a97f9d4c62a9ee7b5c","modified":1616359399293},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"554ec568e9d2c71e4a624a8de3cb5929050811d6","modified":1616359399293},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"db15d7e1552aa2d2386a6b8a33b3b3a40bf9e43d","modified":1616359399293},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"9a188938d46931d5f3882a140aa1c48b3a893f0c","modified":1616359399293},{"_id":"themes/next/scripts/tags/button.js","hash":"eddbb612c15ac27faf11c59c019ce188f33dec2c","modified":1616359399300},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"99b66949f18398689b904907af23c013be1b978f","modified":1616359399300},{"_id":"themes/next/scripts/tags/exturl.js","hash":"5022c0ba9f1d13192677cf1fd66005c57c3d0f53","modified":1616359399301},{"_id":"themes/next/scripts/tags/full-image.js","hash":"c9f833158c66bd72f627a0559cf96550e867aa72","modified":1616359399301},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"ac681b0d0d8d39ba3817336c0270c6787c2b6b70","modified":1616359399302},{"_id":"themes/next/scripts/tags/label.js","hash":"6f00952d70aadece844ce7fd27adc52816cc7374","modified":1616359399302},{"_id":"themes/next/scripts/tags/note.js","hash":"f7eae135f35cdab23728e9d0d88b76e00715faa0","modified":1616359399304},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"bcba2ff25cd7850ce6da322d8bd85a8dd00b5ceb","modified":1616359399303},{"_id":"themes/next/source/css/main.styl","hash":"a91dbb7ef799f0a171b5e726c801139efe545176","modified":1616359399338},{"_id":"themes/next/scripts/tags/tabs.js","hash":"aa7fc94a5ec27737458d9fe1a75c0db7593352fd","modified":1616359399304},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1616359399339},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1616359399339},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1616359399339},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1616359399340},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1616359399340},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1616359399341},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1616359399341},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1616359399341},{"_id":"themes/next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1616359399342},{"_id":"themes/next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1616359399342},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1616359399342},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1616359399343},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1616359399343},{"_id":"themes/next/source/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1616359399343},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1616359399343},{"_id":"themes/next/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1616359399344},{"_id":"themes/next/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1616359399344},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1616359399344},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"9b84ab576982b2c3bb0291da49143bc77fba3cc6","modified":1616359399282},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1616359399282},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1616359399283},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"a223919d2e1bf17ca4d6abb2c86f2efca9883dc1","modified":1616359399276},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"f5e487b0d213ca0bd94aa30bc23b240d65081627","modified":1616359399277},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"b2f0d247b213e4cf8de47af6a304d98070cc7256","modified":1616359399278},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a8c7f9ca7c605d039a1f3bf4e4d3183700a3dd62","modified":1616359399279},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"b25002a83cbd2ca0c4a5df87ad5bff26477c0457","modified":1616359399279},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"9e3d133ac5bcc6cb51702c83b2611a49811abad1","modified":1616359399279},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"d9e2d9282f9be6e04eae105964abb81e512bffed","modified":1616359399280},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"d4fbffd7fa8f2090eb32a871872665d90a885fac","modified":1616359399280},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"0a9cdd6958395fcdffc80ab60f0c6301b63664a5","modified":1616359399280},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"ff947f3561b229bc528cb1837d4ca19612219411","modified":1616359399285},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"71397a5823e8ec8aad3b68aace13150623b3e19d","modified":1616359399285},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"7b11eac3a0685fa1ab2ab6ecff60afc4f15f0d16","modified":1616359399286},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"753d262911c27baf663fcaf199267133528656af","modified":1616359399285},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"a10b7f19d7b5725527514622899df413a34a89db","modified":1616359399286},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"7d94845f96197d9d84a405fa5d4ede75fb81b225","modified":1616359399286},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"ccc443b22bd4f8c7ac4145664686c756395b90e0","modified":1616359399286},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"b1e13df83fb2b1d5d513b30b7aa6158b0837daab","modified":1616359399287},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"45f3f629c2aacc381095750e1c8649041a71a84b","modified":1616359399287},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"e6d10ee4fb70b3ae1cd37e9e36e000306734aa2e","modified":1616359399287},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"8a399df90dadba5ad4e781445b58f4765aeb701e","modified":1616359399288},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"f9a1647a8f1866deeb94052d1f87a5df99cb1e70","modified":1616359399288},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"5a8027328f060f965b3014060bebec1d7cf149c1","modified":1616359399288},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"4c501ea0b9c494181eb3c607c5526a5754e7fbd8","modified":1616359399289},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b83a51bbe0f1e2ded9819070840b0ea145f003a6","modified":1616359399289},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"4dcc3213c033994d342d02b800b6229295433d30","modified":1616359399290},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"1600f340e0225361580c44890568dc07dbcf2c89","modified":1616359399289},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"af7f3e43cbdc4f88c13f101f0f341af96ace3383","modified":1616359399290},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"493bd5999a1061b981922be92d8277a0f9152447","modified":1616359399290},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"9246162d4bc7e949ce1d12d135cbbaf5dc3024ec","modified":1616359399291},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"7e65ff8fe586cd655b0e9d1ad2912663ff9bd36c","modified":1616359399291},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"4050553d44ba1396174161c9a6bb0f89fa779eca","modified":1616359399291},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"d8c98938719284fa06492c114d99a1904652a555","modified":1616359399296},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"34599633658f3b0ffb487728b7766e1c7b551f5a","modified":1616359399295},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"fe95dd3d166634c466e19aa756e65ad6e8254d3e","modified":1616359399295},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"93479642fd076a1257fecc25fcf5d20ccdefe509","modified":1616359399295},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"3403fdd8efde1a0afd11ae8a5a97673f5903087f","modified":1616359399328},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"07f7da320689f828f6e36a6123807964a45157a0","modified":1616359399328},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"7896c3ee107e1a8b9108b6019f1c070600a1e8cc","modified":1616359399329},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"0e55cbd93852dc3f8ccb44df74d35d9918f847e0","modified":1616359399329},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"58e7dd5947817d9fc30770712fc39b2f52230d1e","modified":1616359399336},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"a25408534f8fe6e321db4bbf9dd03335d648fe17","modified":1616359399337},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"4069f918ccc312da86db6c51205fc6c6eaabb116","modified":1616359399337},{"_id":"themes/next/source/css/_variables/base.styl","hash":"b1f6ea881a4938a54603d68282b0f8efb4d7915d","modified":1616359399337},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1616359399354},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"b02737510e9b89aeed6b54f89f602a9c24b06ff2","modified":1616359399358},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1616359399357},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1616359399364},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1616359399364},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"68a9b9d53126405b0fa5f3324f1fb96dbcc547aa","modified":1616359399365},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1616359399365},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"865d6c1328ab209a4376b9d2b7a7824369565f28","modified":1616359399380},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"b4aefc910578d76b267e86dfffdd5121c8db9aec","modified":1616359399366},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1616359399367},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1616359399367},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1616359399367},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1616359399368},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1616359399382},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4ded6fee668544778e97e38c2b211fc56c848e77","modified":1616359399382},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"b930297cb98b8e1dbd5abe9bc1ed9d5935d18ce8","modified":1616359399382},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1616359399382},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1616359399383},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1616359399383},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","hash":"14264a210bf94232d58d7599ea2ba93bfa4fb458","modified":1616359399384},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","hash":"e33aa8fa48b6639d8d8b937d13261597dd473b3a","modified":1616359399384},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","hash":"2ce5f3bf15c523b9bfc97720d8884bb22602a454","modified":1616359399385},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1616359399385},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1616359399385},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1616359399386},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1616359399386},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1616359399386},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1616359399387},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1616359399387},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1616359399387},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1616359399387},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1616359399388},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1616359399388},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1616359399388},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1616359399389},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"8aaa675f577d5501f5f22d5ccb07c2b76310b690","modified":1616359399389},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"63da5e80ebb61bb66a2794d5936315ca44231f0c","modified":1616359399395},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"92d92860418c4216aa59eb4cb4a556290a7ad9c3","modified":1616359399395},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1616359399397},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1616359399398},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"dbbfb50f6502f6b81dcc9fee7b31f1e812da3464","modified":1616359399398},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"2d9a9f38c493fdf7c0b833bb9184b6a1645c11b2","modified":1616359399389},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"46a50b91c98b639c9a2b9265c5a1e66a5c656881","modified":1616359399390},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"8148492dd49aa876d32bb7d5b728d3f5bf6f5074","modified":1616359399390},{"_id":"themes/next/source/js/src/affix.js","hash":"1b509c3b5b290a6f4607f0f06461a0c33acb69b1","modified":1616359399345},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"cb431b54ba9c692165a1f5a12e4c564a560f8058","modified":1616359399345},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"0289031200c3d4c2bdd801ee10fff13bb2c353e4","modified":1616359399346},{"_id":"themes/next/source/js/src/exturl.js","hash":"a2a0f0de07e46211f74942a468f42ee270aa555c","modified":1616359399346},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"b35a7dc47b634197b93487cea8671a40a9fdffce","modified":1616359399346},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"1512c751d219577d338ac0780fb2bbd9075d5298","modified":1616359399347},{"_id":"themes/next/source/js/src/motion.js","hash":"885176ed51d468f662fbf0fc09611f45c7e5a3b1","modified":1616359399347},{"_id":"themes/next/source/js/src/post-details.js","hash":"93a18271b4123dd8f94f09d1439b47c3c19a8712","modified":1616359399347},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"02cf91514e41200bc9df5d8bdbeb58575ec06074","modified":1616359399348},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"b7657be25fc52ec67c75ab5481bdcb483573338b","modified":1616359399348},{"_id":"themes/next/source/js/src/utils.js","hash":"b3e9eca64aba59403334f3fa821f100d98d40337","modified":1616359399349},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"218cc936ba3518a3591b2c9eda46bc701edf7710","modified":1616359399294},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"2530de0f3125a912756f6c0e9090cd012134a4c5","modified":1616359399294},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"8f86f694c0749a18ab3ad6f6df75466ca137a4bc","modified":1616359399305},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"237d185ac62ec9877e300947fa0109c44fb8db19","modified":1616359399305},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"8b32928686c327151e13d3ab100157f9a03cd59f","modified":1616359399306},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1616359399306},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"7ad4081466b397e2a6204141bb7768b7c01bd93c","modified":1616359399306},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"4f2801fc4cf3f31bf2069f41db8c6ce0e3da9e39","modified":1616359399311},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"6eb4bcc3056bd279d000607e8b4dad50d368ca69","modified":1616359399319},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"24ee4b356ff55fc6e58f26a929fa07750002cf29","modified":1616359399326},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"1da5c800d025345f212a3bf1be035060f4e5e6ed","modified":1616359399326},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"91ca75492cd51f2553f4d294ed2f48239fcd55eb","modified":1616359399327},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"3f40e8a9fe8e7bd5cfc4cf4cbbbcb9539462e973","modified":1616359399327},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a17e2b871a335f290afb392a08f94fd35f59c715","modified":1616359399327},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"ea9069645696f86c5df64208490876fe150c8cae","modified":1616359399328},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"12662536c7a07fff548abe94171f34b768dd610f","modified":1616359399325},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"60fa84aa7731760f05f52dd7d8f79b5f74ac478d","modified":1616359399330},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"25d5e45a355ee2093f3b8b8eeac125ebf3905026","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"d0bfd1bef988c76f7d7dd72d88af6f0908a8b0db","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"26666c1f472bf5f3fb9bc62081cca22b4de15ccb","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9b913b73d31d21f057f97115ffab93cfa578b884","modified":1616359399332},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"9c99034f8e00d47e978b3959f51eb4a9ded0fcc8","modified":1616359399331},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"e695e58f714129ca292c2e54cd62c251aca7f7fe","modified":1616359399333},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"31127dcbf4c7b4ada53ffbf1638b5fe325b7cbc0","modified":1616359399333},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"748dbfbf9c08e719ddc775958003c64b00d39dab","modified":1616359399333},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1616359399334},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1616359399334},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"bce344d3a665b4c55230d2a91eac2ad16d6f32fd","modified":1616359399335},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"416988dca389e6e2fdfa51fa7f4ee07eb53f82fb","modified":1616359399335},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"4642e30010af8b2b037f5b43146b10a934941958","modified":1616359399335},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"1f6e2ce674735269599acc6d77b3ea18d31967fc","modified":1616359399335},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"ad2dcedf393ed1f3f5afd2508d24969c916d02fc","modified":1616359399336},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"86197902dfd3bededba10ba62b8f9f22e0420bde","modified":1616359399336},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"6c26cdb36687d4f0a11dabf5290a909c3506be5c","modified":1616359399352},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"6d586bfcfb7ae48f1b12f76eec82d3ad31947501","modified":1616359399353},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"16b03db23a52623348f37c04544f2792032c1fb6","modified":1616359399354},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1616359399358},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1616359399359},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1616359399359},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1616359399359},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1616359399359},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"82f33ad0842aa9c154d029e0dada2497d4eb1d57","modified":1616359399362},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1616359399360},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"d71602cbca33b9ecdb7ab291b7f86a49530f3601","modified":1616359399363},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"ae6318aeb62ad4ce7a7e9a4cdacd93ffb004f0fb","modified":1616359399363},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"1d6aeda0480d0e4cb6198edf7719d601d4ae2ccc","modified":1616359399366},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1616359399366},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"3655f1fdf1e584c4d8e8d39026093ca306a5a341","modified":1616359399368},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"88af80502c44cd52ca81ffe7dc7276b7eccb06cf","modified":1616359399369},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1616359399369},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"41ea797c68dbcff2f6fb3aba1d1043a22e7cc0f6","modified":1616359399394},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"a817b6c158cbc5bab3582713de9fe18a18a80552","modified":1616359399395},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"f1d0b5d7af32c423eaa8bb93ab6a0b45655645dc","modified":1616359399348},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"9f73c4696f0907aa451a855444f88fc0698fa472","modified":1616359399307},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1616359399307},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"0656e753f182c9f47fef7304c847b7587a85ef0d","modified":1616359399308},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"43117dbe13cb769e796705b729d23148d342d3a9","modified":1616359399307},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"1a0d059799a298fe17c49a44298d32cebde93785","modified":1616359399308},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"1727702eac5d326b5c81a667944a245016668231","modified":1616359399308},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"167986d0f649516671ddf7193eebba7b421cd115","modified":1616359399309},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"7fe4d4d656e86276c17cb4e48a560cb6a4def703","modified":1616359399309},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"50450d9fdc8a2b2be8cfca51e3e1a01ffd636c0b","modified":1616359399309},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"b6f3a06a94a6ee5470c956663164d58eda818a64","modified":1616359399310},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1616359399310},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"f9760ecf186954cee3ba4a149be334e9ba296b89","modified":1616359399310},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1616359399311},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"8cf318644acc8b4978537c263290363e21c7f5af","modified":1616359399311},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"761eba9811b050b25d548cc0854de4824b41eb08","modified":1616359399316},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"39f04c4c7237a4e10acd3002331992b79945d241","modified":1616359399316},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"8dd9a1c6f4f6baa00c2cf01837e7617120cf9660","modified":1616359399317},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"1153bb71edf253765145559674390e16dd67c633","modified":1616359399317},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"61f8cea3c01acd600e90e1bc2a07def405503748","modified":1616359399317},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"11c22f0fb3f6beb13e5a425ec064a4ff974c13b7","modified":1616359399317},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"c8fe49a4bc014c24dead05b782a7082411a4abc5","modified":1616359399318},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a1521d48bb06d8d703753f52a198baa197af7da2","modified":1616359399318},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"5ef6343835f484a2c0770bd1eb9cc443609e4c39","modified":1616359399318},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"e71652d3216e289c8548b1ea2357822c1476a425","modified":1616359399319},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"2fe76476432b31993338cb45cdb3b29a518b6379","modified":1616359399319},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"a3bdd71237afc112b2aa255f278cab6baeb25351","modified":1616359399320},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"f825da191816eef69ea8efb498a7f756d5ebb498","modified":1616359399320},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1616359399320},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"2ab1322fe52ab5aafd49e68f5bd890e8380ee927","modified":1616359399320},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"b7076e58d647265ee0ad2b461fe8ce72c9373bc5","modified":1616359399321},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"9a409b798decdefdaf7a23f0b11004a8c27e82f3","modified":1616359399321},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"154a87a32d2fead480d5e909c37f6c476671c5e6","modified":1616359399321},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"b80604868e4f5cf20fccafd7ee415c20c804f700","modified":1616359399322},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"62fbbd32cf5a99ae550c45c763a2c4813a138d01","modified":1616359399311},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"875cbe88d5c7f6248990e2beb97c9828920e7e24","modified":1616359399312},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"caf263d1928496688c0e1419801eafd7e6919ce5","modified":1616359399312},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"a6c6eb8adba0a090ad1f4b9124e866887f20d10d","modified":1616359399313},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"a200c0a1c5a895ac9dc41e0641a5dfcd766be99b","modified":1616359399312},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"cd9e214e502697f2f2db84eb721bac57a49b0fce","modified":1616359399313},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"d0d7a5c90d62b685520d2b47fea8ba6019ff5402","modified":1616359399313},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"27deb3d3a243d30022055dac7dad851024099a8b","modified":1616359399314},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"ca88ea6999a61fb905eb6e72eba5f92d4ee31e6e","modified":1616359399314},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"b2495ae5e04dcca610aacadc47881d9e716cd440","modified":1616359399314},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1616359399314},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"ccb34c52be8adba5996c6b94f9e723bd07d34c16","modified":1616359399315},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"01567edaea6978628aa5521a122a85434c418bfd","modified":1616359399315},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"7968343e41f8b94b318c36289dff1196c3eb1791","modified":1616359399315},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"89d6c3b697efc63de42afd2e89194b1be14152af","modified":1616359399315},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"bba4f3bdb7517cd85376df3e1209b570c0548c69","modified":1616359399322},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"5dbeed535d63a50265d96b396a5440f9bb31e4ba","modified":1616359399322},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"717cc7f82be9cc151e23a7678601ff2fd3a7fa1d","modified":1616359399323},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"a6e7d698702c2e383dde3fde2abde27951679084","modified":1616359399323},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"874278147115601d2abf15987f5f7a84ada1ac6b","modified":1616359399324},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"10599e16414a8b7a76c4e79e6617b5fe3d4d1adf","modified":1616359399324},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"28825ae15fa20ae3942cdaa7bcc1f3523ce59acc","modified":1616359399325},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9c8196394a89dfa40b87bf0019e80144365a9c93","modified":1616359399325},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"16087276945fa038f199692e3eabb1c52b8ea633","modified":1616359399324},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"15975ba7456b96916b1dbac448a1a0d2c38b8f3d","modified":1616359399324},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1616359399332},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1616359399334},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1616359399332},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1616359399350},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1616359399350},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1616359399351},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1616359399351},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1616359399351},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1616359399360},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1616359399361},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"51139a4c79573d372a347ef01a493222a1eaf10a","modified":1616359399361},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"ee948b4489aedeb548a77c9e45d8c7c5732fd62d","modified":1616359399361},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"d22b1629cb23a6181bebb70d0cf653ffe4b835c8","modified":1616359399362},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1616359399362},{"_id":"themes/next/source/lib/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1616359399381},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"4ac683b2bc8531c84d98f51b86957be0e6f830f3","modified":1616359399353},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1616359399380},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1616359399379},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1616359399371},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1616359399373},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1616359399378},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"4237c6e9d59da349639de20e559e87c2c0218cfd","modified":1616359399397},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"90a1b22129efc172e2dfcceeeb76bff58bc3192f","modified":1616359399357},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"b5483b11f8ba213e733b5b8af9927a04fec996f6","modified":1616359399376},{"_id":"themes/next/source/lib/three/three.min.js","hash":"26273b1cb4914850a89529b48091dc584f2c57b8","modified":1616359399393},{"_id":"public/content.json","hash":"8bc814183aa0b41e2c95881a1933d414721df02a","modified":1645505005347},{"_id":"public/categories/index.html","hash":"969caaee05bdea725e99016eb63d810893a73e99","modified":1645505005347},{"_id":"public/tags/index.html","hash":"969caaee05bdea725e99016eb63d810893a73e99","modified":1645505005347},{"_id":"public/2022/02/22/【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2022/02/22/存储介质/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2021/05/01/Round-1C-2021-Code-Jam-2021-Closest-Pick/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2021/04/14/Google-Code-Jam-Round-1A-2021-Rabbit-House/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2021/03/22/Kick-Start-Round-A-2021-L-Shaped-Plots/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2021/03/22/Kick-Start-Round-A-2021-Rabbit-House/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2021/03/22/Kick-Start-Round-A-2021-K-Goodness-String/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2019/05/26/如何设计并实现一个db连接池？/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/12/25/深入JAVA8的HashMap实现原理/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/12/11/如何使用Defender优雅的管理权限？/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/Linux平台Nginx的安装及使用/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/12/24/设计模式一：单例模式/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/深入浅说服务如何以Jar包的方式发布/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/Spring-Cloud-Config-入门/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/Spring-Cloud-Eureka-使用Nginx做路由网关/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/Jenkins安装及自动部署Maven项目/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/hello-world/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/Spring-Cloud-Gateway深入探究/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/2018/11/06/测试，hexo/index.html","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1645505005347},{"_id":"public/archives/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/page/2/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2018/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2018/page/2/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2018/11/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2019/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2018/12/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2019/05/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2021/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2021/03/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2021/05/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2021/04/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2022/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/archives/2022/02/index.html","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1645505005347},{"_id":"public/categories/Algorithm/index.html","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1645505005347},{"_id":"public/categories/DevOps/index.html","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1645505005347},{"_id":"public/categories/数据结构/index.html","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1645505005347},{"_id":"public/categories/设计模式/index.html","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1645505005347},{"_id":"public/index.html","hash":"783611349c941848a0e26ee2f1dc44dd14879bd1","modified":1645505005347},{"_id":"public/tags/Kick-Start/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/page/2/index.html","hash":"783611349c941848a0e26ee2f1dc44dd14879bd1","modified":1645505005347},{"_id":"public/tags/Code-Jam/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/tags/Maven/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/tags/Jenkins/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/tags/Java/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/tags/连接池/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347},{"_id":"public/tags/设计模式/index.html","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1645505005347}],"Category":[{"name":"Algorithm","_id":"ckzxn6uxz0004b0tzhrsx6n5w"},{"name":"DevOps","_id":"ckzxn6uye000xb0tz4ibb8s2c"},{"name":"数据结构","_id":"ckzxn6uyh0015b0tz03vbcdw0"},{"name":"设计模式","_id":"ckzxn6uym001cb0tz06l13at9"}],"Data":[],"Page":[{"title":"分类","date":"2021-03-21T20:51:59.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2021-03-22 04:51:59\ntype: \"categories\"\ncomments: false\n---\n","updated":"2021-03-21T20:53:10.286Z","path":"categories/index.html","layout":"page","_id":"ckzxn6uxr0000b0tz1x3q0z0r","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","date":"2021-03-21T20:52:13.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2021-03-22 04:52:13\ntype: \"tags\"\ncomments: false\n---\n","updated":"2021-03-21T20:53:07.033Z","path":"tags/index.html","layout":"page","_id":"ckzxn6uxw0002b0tzgijgg0e2","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Kick Start Round A 2021 -  L Shaped Plots ","author":"Nico","date":"2021-03-21T20:01:00.000Z","_content":"原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068c509)\n\n### 分析\n在二维坐标系中由很多坐标点组成段，段的最小长度为2，且段只有x轴（横轴）和y轴（纵轴）之分，求由两个段组成，垂直有共同顶点，且长边是短边两倍的组合数量。\n\n输入集是一个二维数组，要求中的两个线段互相垂直，这里可以分析出组合中的两个线段一个在x轴一个在y轴。一种思路是通过遍历二维数组得到x和y轴所有的段，再对每个段的端点做索引，再做dfs求组合数，不过这种简单的思路在Test2会出现超时或内存溢出的错误，所以要换一种更简单的思路。\n\n个人解决思路是先对x或y任意维度做head的索引（y轴由上到下，head为上顶点，x轴head为左顶点），例如先对y轴所有段的head做索引，这里直接使用二维数组，假设y轴段的索引定义为二维数组``indexs = [1000][1000]int``, indexs第一层下标为x轴坐标，第二层下标为y轴坐标，值为段的长度。之后再遍历获取所有的x轴段，对于x轴的每个段，取其对应的head和tail坐标以及长度len，通过枚举所有满足的y轴坐标值：\n - y1 (head.x, head.y - （len/2） + 1)\n - y2 (head.x, head.y)\n - y3 (head.x, head.y - （len*2） + 1)\n - y4 (tail.x, tail.y - （len/2） + 1)\n - y5 (tail.x, tail.y)\n - y6 (tail.x, tail.y - （len*2） + 1)\n\n(y1和y4只有当len为偶数且大于等于4的时候才成立)\n之后通过得到的y轴坐标去检索indexs，如果存在则判断对应段的长度是否满足与当前x轴段长的规则，如果满足则count ++，所有x轴段匹配完毕，输出count为结果值。\n### Slove\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\n\nvar in = bufio.NewReader(os.Stdin)\n\n\n\nfunc solve(){\n\tinputs := readInts(in)\n\tr := inputs[0]\n\tc := inputs[1]\n\tgrid := make([][]int, r)\n\tfor i := 0; i < r; i ++ {\n\t\tgrid[i] = readInts(in)\n\t}\n\tcols := [1000][1000]int{}\n\tfor i := 0; i < c; i ++ {\n\t\ty := -1\n\t\tfor j := 0; j < r;\tj ++  {\n\t\t\tif grid[j][i] == 1{\n\t\t\t\tif y == -1 {\n\t\t\t\t\ty = j\n\t\t\t\t}\n\t\t\t}\n\t\t\tif y != -1 && (grid[j][i] != 1  || j == r - 1){\n\t\t\t\td := j - y\n\t\t\t\tif j == r - 1 && grid[j][i] == 1{\n\t\t\t\t\td ++\n\t\t\t\t}\n\t\t\t\tif d > 1 {\n\t\t\t\t\tfor di := 0; di < d; di ++ {\n\t\t\t\t\t\tfor dj := di + 1; dj < d;  dj ++{\n\t\t\t\t\t\t\tcols[i][y + di] = dj - di + 1\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ty = -1\n\t\t\t}\n\t\t}\n\t}\n\tcount := 0\n\tfor i := 0; i < r; i ++ {\n\t\tx := -1\n\t\tfor j := 0; j < c;\tj ++  {\n\t\t\tif grid[i][j] == 1{\n\t\t\t\tif x == -1 {\n\t\t\t\t\tx = j\n\t\t\t\t}\n\t\t\t}\n\t\t\tif x != -1 &&(grid[i][j] != 1  || j == c - 1){\n\t\t\t\td := j - x\n\t\t\t\tif j == c - 1 && grid[i][j] == 1{\n\t\t\t\t\td ++\n\t\t\t\t}\n\t\t\t\tif d > 1 {\n\t\t\t\t\tfor di := 0; di < d; di ++ {\n\t\t\t\t\t\tfor dj := di + 1; dj < d;  dj ++{\n\t\t\t\t\t\t\thx := x + di\n\t\t\t\t\t\t\thy := i\n\t\t\t\t\t\t\ttx := x + dj\n\t\t\t\t\t\t\tty := i\n\t\t\t\t\t\t\tl := dj - di + 1\n\n\t\t\t\t\t\t\tif l % 2 == 0 && l >= 4{\n\t\t\t\t\t\t\t\tchy := hy - l / 2 + 1\n\t\t\t\t\t\t\t\tcty := ty - l / 2 + 1\n\t\t\t\t\t\t\t\tif chy >= 0 {\n\t\t\t\t\t\t\t\t\tif n := cols[hx][chy]; n >= l / 2{\n\t\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif n := cols[hx][hy]; n >= l / 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif cty >= 0 {\n\t\t\t\t\t\t\t\t\tif n := cols[tx][cty]; n >= l / 2{\n\t\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif n := cols[tx][ty]; n >= l / 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tchy := hy - l * 2 + 1\n\t\t\t\t\t\t\tcty := ty - l * 2 + 1\n\t\t\t\t\t\t\tif chy >= 0 {\n\t\t\t\t\t\t\t\tif n := cols[hx][chy]; n >= l * 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif n := cols[hx][hy]; n >= l * 2 {\n\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif cty >= 0 {\n\t\t\t\t\t\t\t\tif n := cols[tx][cty]; n >= l * 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif n := cols[tx][ty]; n >= l * 2 {\n\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tx = -1\n\t\t\t}\n\t\t}\n\t}\n\n\tres = append(res, count)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n```","source":"_posts/Kick-Start-Round-A-2021-L-Shaped-Plots.md","raw":"title: 'Kick Start Round A 2021 -  L Shaped Plots '\nauthor: Nico\ntags:\n  - Kick Start\ncategories:\n  - Algorithm\ndate: 2021-03-22 04:01:00\n---\n原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068c509)\n\n### 分析\n在二维坐标系中由很多坐标点组成段，段的最小长度为2，且段只有x轴（横轴）和y轴（纵轴）之分，求由两个段组成，垂直有共同顶点，且长边是短边两倍的组合数量。\n\n输入集是一个二维数组，要求中的两个线段互相垂直，这里可以分析出组合中的两个线段一个在x轴一个在y轴。一种思路是通过遍历二维数组得到x和y轴所有的段，再对每个段的端点做索引，再做dfs求组合数，不过这种简单的思路在Test2会出现超时或内存溢出的错误，所以要换一种更简单的思路。\n\n个人解决思路是先对x或y任意维度做head的索引（y轴由上到下，head为上顶点，x轴head为左顶点），例如先对y轴所有段的head做索引，这里直接使用二维数组，假设y轴段的索引定义为二维数组``indexs = [1000][1000]int``, indexs第一层下标为x轴坐标，第二层下标为y轴坐标，值为段的长度。之后再遍历获取所有的x轴段，对于x轴的每个段，取其对应的head和tail坐标以及长度len，通过枚举所有满足的y轴坐标值：\n - y1 (head.x, head.y - （len/2） + 1)\n - y2 (head.x, head.y)\n - y3 (head.x, head.y - （len*2） + 1)\n - y4 (tail.x, tail.y - （len/2） + 1)\n - y5 (tail.x, tail.y)\n - y6 (tail.x, tail.y - （len*2） + 1)\n\n(y1和y4只有当len为偶数且大于等于4的时候才成立)\n之后通过得到的y轴坐标去检索indexs，如果存在则判断对应段的长度是否满足与当前x轴段长的规则，如果满足则count ++，所有x轴段匹配完毕，输出count为结果值。\n### Slove\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\n\nvar in = bufio.NewReader(os.Stdin)\n\n\n\nfunc solve(){\n\tinputs := readInts(in)\n\tr := inputs[0]\n\tc := inputs[1]\n\tgrid := make([][]int, r)\n\tfor i := 0; i < r; i ++ {\n\t\tgrid[i] = readInts(in)\n\t}\n\tcols := [1000][1000]int{}\n\tfor i := 0; i < c; i ++ {\n\t\ty := -1\n\t\tfor j := 0; j < r;\tj ++  {\n\t\t\tif grid[j][i] == 1{\n\t\t\t\tif y == -1 {\n\t\t\t\t\ty = j\n\t\t\t\t}\n\t\t\t}\n\t\t\tif y != -1 && (grid[j][i] != 1  || j == r - 1){\n\t\t\t\td := j - y\n\t\t\t\tif j == r - 1 && grid[j][i] == 1{\n\t\t\t\t\td ++\n\t\t\t\t}\n\t\t\t\tif d > 1 {\n\t\t\t\t\tfor di := 0; di < d; di ++ {\n\t\t\t\t\t\tfor dj := di + 1; dj < d;  dj ++{\n\t\t\t\t\t\t\tcols[i][y + di] = dj - di + 1\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ty = -1\n\t\t\t}\n\t\t}\n\t}\n\tcount := 0\n\tfor i := 0; i < r; i ++ {\n\t\tx := -1\n\t\tfor j := 0; j < c;\tj ++  {\n\t\t\tif grid[i][j] == 1{\n\t\t\t\tif x == -1 {\n\t\t\t\t\tx = j\n\t\t\t\t}\n\t\t\t}\n\t\t\tif x != -1 &&(grid[i][j] != 1  || j == c - 1){\n\t\t\t\td := j - x\n\t\t\t\tif j == c - 1 && grid[i][j] == 1{\n\t\t\t\t\td ++\n\t\t\t\t}\n\t\t\t\tif d > 1 {\n\t\t\t\t\tfor di := 0; di < d; di ++ {\n\t\t\t\t\t\tfor dj := di + 1; dj < d;  dj ++{\n\t\t\t\t\t\t\thx := x + di\n\t\t\t\t\t\t\thy := i\n\t\t\t\t\t\t\ttx := x + dj\n\t\t\t\t\t\t\tty := i\n\t\t\t\t\t\t\tl := dj - di + 1\n\n\t\t\t\t\t\t\tif l % 2 == 0 && l >= 4{\n\t\t\t\t\t\t\t\tchy := hy - l / 2 + 1\n\t\t\t\t\t\t\t\tcty := ty - l / 2 + 1\n\t\t\t\t\t\t\t\tif chy >= 0 {\n\t\t\t\t\t\t\t\t\tif n := cols[hx][chy]; n >= l / 2{\n\t\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif n := cols[hx][hy]; n >= l / 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif cty >= 0 {\n\t\t\t\t\t\t\t\t\tif n := cols[tx][cty]; n >= l / 2{\n\t\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif n := cols[tx][ty]; n >= l / 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tchy := hy - l * 2 + 1\n\t\t\t\t\t\t\tcty := ty - l * 2 + 1\n\t\t\t\t\t\t\tif chy >= 0 {\n\t\t\t\t\t\t\t\tif n := cols[hx][chy]; n >= l * 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif n := cols[hx][hy]; n >= l * 2 {\n\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif cty >= 0 {\n\t\t\t\t\t\t\t\tif n := cols[tx][cty]; n >= l * 2 {\n\t\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif n := cols[tx][ty]; n >= l * 2 {\n\t\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tx = -1\n\t\t\t}\n\t\t}\n\t}\n\n\tres = append(res, count)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n```","slug":"Kick-Start-Round-A-2021-L-Shaped-Plots","published":1,"updated":"2021-03-21T20:55:44.670Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uxu0001b0tz9bnldgxq","content":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068c509\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>在二维坐标系中由很多坐标点组成段，段的最小长度为2，且段只有x轴（横轴）和y轴（纵轴）之分，求由两个段组成，垂直有共同顶点，且长边是短边两倍的组合数量。</p>\n<p>输入集是一个二维数组，要求中的两个线段互相垂直，这里可以分析出组合中的两个线段一个在x轴一个在y轴。一种思路是通过遍历二维数组得到x和y轴所有的段，再对每个段的端点做索引，再做dfs求组合数，不过这种简单的思路在Test2会出现超时或内存溢出的错误，所以要换一种更简单的思路。</p>\n<p>个人解决思路是先对x或y任意维度做head的索引（y轴由上到下，head为上顶点，x轴head为左顶点），例如先对y轴所有段的head做索引，这里直接使用二维数组，假设y轴段的索引定义为二维数组<code>indexs = [1000][1000]int</code>, indexs第一层下标为x轴坐标，第二层下标为y轴坐标，值为段的长度。之后再遍历获取所有的x轴段，对于x轴的每个段，取其对应的head和tail坐标以及长度len，通过枚举所有满足的y轴坐标值：</p>\n<ul>\n<li>y1 (head.x, head.y - （len/2） + 1)</li>\n<li>y2 (head.x, head.y)</li>\n<li>y3 (head.x, head.y - （len*2） + 1)</li>\n<li>y4 (tail.x, tail.y - （len/2） + 1)</li>\n<li>y5 (tail.x, tail.y)</li>\n<li>y6 (tail.x, tail.y - （len*2） + 1)</li>\n</ul>\n<p>(y1和y4只有当len为偶数且大于等于4的时候才成立)<br>\n之后通过得到的y轴坐标去检索indexs，如果存在则判断对应段的长度是否满足与当前x轴段长的规则，如果满足则count ++，所有x轴段匹配完毕，输出count为结果值。</p>\n<h3 id=\"slove\"><a class=\"header-anchor\" href=\"#slove\">¶</a>Slove</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tr := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tc := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tgrid := <span class=\"built_in\">make</span>([][]<span class=\"type\">int</span>, r)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tgrid[i] = readInts(in)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tcols := [<span class=\"number\">1000</span>][<span class=\"number\">1000</span>]<span class=\"type\">int</span>&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; c; i ++ &#123;</span><br><span class=\"line\">\t\ty := <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; r;\tj ++  &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> grid[j][i] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> y == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\ty = j</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> y != <span class=\"number\">-1</span> &amp;&amp; (grid[j][i] != <span class=\"number\">1</span>  || j == r - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\td := j - y</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> j == r - <span class=\"number\">1</span> &amp;&amp; grid[j][i] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\td ++</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> d &gt; <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> di := <span class=\"number\">0</span>; di &lt; d; di ++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">for</span> dj := di + <span class=\"number\">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tcols[i][y + di] = dj - di + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\ty = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tx := <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; c;\tj ++  &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> grid[i][j] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> x == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tx = j</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> x != <span class=\"number\">-1</span> &amp;&amp;(grid[i][j] != <span class=\"number\">1</span>  || j == c - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\td := j - x</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> j == c - <span class=\"number\">1</span> &amp;&amp; grid[i][j] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\td ++</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> d &gt; <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> di := <span class=\"number\">0</span>; di &lt; d; di ++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">for</span> dj := di + <span class=\"number\">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\thx := x + di</span><br><span class=\"line\">\t\t\t\t\t\t\thy := i</span><br><span class=\"line\">\t\t\t\t\t\t\ttx := x + dj</span><br><span class=\"line\">\t\t\t\t\t\t\tty := i</span><br><span class=\"line\">\t\t\t\t\t\t\tl := dj - di + <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> l % <span class=\"number\">2</span> == <span class=\"number\">0</span> &amp;&amp; l &gt;= <span class=\"number\">4</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tchy := hy - l / <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\tcty := ty - l / <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> chy &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][chy]; n &gt;= l / <span class=\"number\">2</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][hy]; n &gt;= l / <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> cty &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][cty]; n &gt;= l / <span class=\"number\">2</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][ty]; n &gt;= l / <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tchy := hy - l * <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\tcty := ty - l * <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> chy &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][chy]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][hy]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> cty &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][cty]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][ty]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tx = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068c509\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>在二维坐标系中由很多坐标点组成段，段的最小长度为2，且段只有x轴（横轴）和y轴（纵轴）之分，求由两个段组成，垂直有共同顶点，且长边是短边两倍的组合数量。</p>\n<p>输入集是一个二维数组，要求中的两个线段互相垂直，这里可以分析出组合中的两个线段一个在x轴一个在y轴。一种思路是通过遍历二维数组得到x和y轴所有的段，再对每个段的端点做索引，再做dfs求组合数，不过这种简单的思路在Test2会出现超时或内存溢出的错误，所以要换一种更简单的思路。</p>\n<p>个人解决思路是先对x或y任意维度做head的索引（y轴由上到下，head为上顶点，x轴head为左顶点），例如先对y轴所有段的head做索引，这里直接使用二维数组，假设y轴段的索引定义为二维数组<code>indexs = [1000][1000]int</code>, indexs第一层下标为x轴坐标，第二层下标为y轴坐标，值为段的长度。之后再遍历获取所有的x轴段，对于x轴的每个段，取其对应的head和tail坐标以及长度len，通过枚举所有满足的y轴坐标值：</p>\n<ul>\n<li>y1 (head.x, head.y - （len/2） + 1)</li>\n<li>y2 (head.x, head.y)</li>\n<li>y3 (head.x, head.y - （len*2） + 1)</li>\n<li>y4 (tail.x, tail.y - （len/2） + 1)</li>\n<li>y5 (tail.x, tail.y)</li>\n<li>y6 (tail.x, tail.y - （len*2） + 1)</li>\n</ul>\n<p>(y1和y4只有当len为偶数且大于等于4的时候才成立)<br>\n之后通过得到的y轴坐标去检索indexs，如果存在则判断对应段的长度是否满足与当前x轴段长的规则，如果满足则count ++，所有x轴段匹配完毕，输出count为结果值。</p>\n<h3 id=\"slove\"><a class=\"header-anchor\" href=\"#slove\">¶</a>Slove</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tr := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tc := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tgrid := <span class=\"built_in\">make</span>([][]<span class=\"type\">int</span>, r)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tgrid[i] = readInts(in)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tcols := [<span class=\"number\">1000</span>][<span class=\"number\">1000</span>]<span class=\"type\">int</span>&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; c; i ++ &#123;</span><br><span class=\"line\">\t\ty := <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; r;\tj ++  &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> grid[j][i] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> y == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\ty = j</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> y != <span class=\"number\">-1</span> &amp;&amp; (grid[j][i] != <span class=\"number\">1</span>  || j == r - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\td := j - y</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> j == r - <span class=\"number\">1</span> &amp;&amp; grid[j][i] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\td ++</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> d &gt; <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> di := <span class=\"number\">0</span>; di &lt; d; di ++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">for</span> dj := di + <span class=\"number\">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tcols[i][y + di] = dj - di + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\ty = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tx := <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; c;\tj ++  &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> grid[i][j] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> x == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tx = j</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> x != <span class=\"number\">-1</span> &amp;&amp;(grid[i][j] != <span class=\"number\">1</span>  || j == c - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\td := j - x</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> j == c - <span class=\"number\">1</span> &amp;&amp; grid[i][j] == <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\td ++</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> d &gt; <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> di := <span class=\"number\">0</span>; di &lt; d; di ++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">for</span> dj := di + <span class=\"number\">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\thx := x + di</span><br><span class=\"line\">\t\t\t\t\t\t\thy := i</span><br><span class=\"line\">\t\t\t\t\t\t\ttx := x + dj</span><br><span class=\"line\">\t\t\t\t\t\t\tty := i</span><br><span class=\"line\">\t\t\t\t\t\t\tl := dj - di + <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> l % <span class=\"number\">2</span> == <span class=\"number\">0</span> &amp;&amp; l &gt;= <span class=\"number\">4</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tchy := hy - l / <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\tcty := ty - l / <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> chy &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][chy]; n &gt;= l / <span class=\"number\">2</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][hy]; n &gt;= l / <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> cty &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][cty]; n &gt;= l / <span class=\"number\">2</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][ty]; n &gt;= l / <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tchy := hy - l * <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\tcty := ty - l * <span class=\"number\">2</span> + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> chy &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][chy]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[hx][hy]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> cty &gt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][cty]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">if</span> n := cols[tx][ty]; n &gt;= l * <span class=\"number\">2</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tx = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Round 1A 2021 - Code Jam 2021 -  Append Sort","author":"Nico","date":"2021-04-14T13:37:00.000Z","_content":"原题地址: [传送门](https://codingcompetitions.withgoogle.com/codejam/round/000000000043585d/00000000007549e5)\n\n### 分析\n题目要求是对于输入的``X1,X2,…,XN``，求至少在每个数字后方增加多少个的``0-9``来保证``X1,X2,…,XN``的递增顺序。\n\n举个例子，输入集为``98,9,8``，很明显当前顺序不是递增的，如果要保证顺序递增，需要在保证数组第二个元素大于第一个元素，第三个元素大于第二个元素。在不考虑题目中添加位数数量限制的情况下，``98,900,8000``这种通过保证每个元素之间总位数差为1的方案也是蛮不错的，但是如果要求增加尽可能少的位数来达到题目要求，最佳方案为``98,99,900``，也就是说我们要做到尽可能保证后一个元素的值尽可能接近前一个元素的值。\n\n再举个例子，输入集为``1,1,1,1,1,1,1,1,1,1,1,1,1,1``，那么补全后的结果应该为``1 10 11 12 13 14 15 16 17 18 19 100 101 102``。\n\n另外需要注意，此题有两个测试集，Test1还好，每次输入集的``X``数量以及范围都比较小，用``int``完全可以搞定，但是对于Test2来说，int不一定能够满足，当``X``的最大值为``10^9``，``N``为100时，在极端情况下（前一个元素总是比后一个元素大），最终补全后的结果的位数最大为``10 + 100 - 1 = 109``位，此时用int将会溢出导致结果错误，可以通过使用bigint或者自己将大数按位拆位数组来避免溢出的问题！\n\n### Solve\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"math\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tcount := 0\n\tnums := readInts(in)\n\tpreMark := make([]int, 110)\n\tnextMark := make([]int, 110)\n\tfor i := 0; i < inputs[0]; i ++{\n\t\tif i == 0{\n\t\t\tmarkFlush(preMark, nums[i])\n\t\t\tcontinue\n\t\t}\n\t\tpreL := markLen(preMark)\n\t\tmarkFlush(nextMark, nums[i])\n\t\tnextL := markLen(nextMark)\n\n\t\tif preL > nextL {\n\t\t\tdiff := preL - nextL\n\t\t\tfor j := 0; j < nextL; j ++ {\n\t\t\t\tpv := preMark[j]\n\t\t\t\tnv := nextMark[j]\n\t\t\t\tif nv > pv {\n\t\t\t\t\tfor k := 0; k < diff; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = 0\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff\n\t\t\t\t\tbreak\n\t\t\t\t}else if nv < pv {\n\t\t\t\t\tfor k := 0; k < diff + 1; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = 0\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff + 1\n\t\t\t\t\tbreak\n\t\t\t\t}else if j == nextL - 1{\n\t\t\t\t\tfor k := 0; k < diff; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = preMark[nextL + k]\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff\n\t\t\t\t\tfor k := preL - 1; k > nextL - 1; k --{\n\t\t\t\t\t\tnextMark[k] ++\n\t\t\t\t\t\tif nextMark[k] < 10{\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnextMark[k] = 0\n\t\t\t\t\t\tif k == nextL {\n\t\t\t\t\t\t\tnextMark[preL] = 0\n\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t}else if preL == nextL{\n\t\t\tfor j := 0; j < preL; j ++ {\n\t\t\t\tpv := preMark[j]\n\t\t\t\tnv := nextMark[j]\n\t\t\t\tif nv > pv {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tif nv < pv || (nv == pv && j == preL - 1){\n\t\t\t\t\tcount ++\n\t\t\t\t\tnextMark[nextL] = 0\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcopy(preMark, nextMark)\n\t}\n\tres = append(res, count)\n}\n\nfunc markLen(mark []int) int{\n\tcount := 0\n\tfor ; count < len(mark); count++ {\n\t\tif mark[count] == -1 {\n\t\t\tbreak\n\t\t}\n\t}\n\treturn count\n}\n\nfunc markFlush(mark []int, num int) {\n\tl := numLen(num)\n\tfor i := 0; i < len(mark); i ++ {\n\t\tif i < l {\n\t\t\tmark[i] = num / pow(10, l - i - 1) % 10\n\t\t}else{\n\t\t\tmark[i] = -1\n\t\t}\n\t}\n}\n\nfunc pow(a, b int) int{\n\treturn int(math.Pow(float64(a), float64(b)))\n}\n\nfunc numLen(num int) int{\n\tcount := 0\n\tfor{\n\t\tif num <= 0 {\n\t\t\tbreak\n\t\t}\n\t\tnum = num / 10\n\t\tcount ++\n\t}\n\treturn count\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\n```","source":"_posts/Google-Code-Jam-Round-1A-2021-Rabbit-House.md","raw":"title: Round 1A 2021 - Code Jam 2021 -  Append Sort\nauthor: Nico\ntags:\n  - Code Jam\ncategories:\n  - Algorithm\ndate: 2021-04-14 21:37:00\n---\n原题地址: [传送门](https://codingcompetitions.withgoogle.com/codejam/round/000000000043585d/00000000007549e5)\n\n### 分析\n题目要求是对于输入的``X1,X2,…,XN``，求至少在每个数字后方增加多少个的``0-9``来保证``X1,X2,…,XN``的递增顺序。\n\n举个例子，输入集为``98,9,8``，很明显当前顺序不是递增的，如果要保证顺序递增，需要在保证数组第二个元素大于第一个元素，第三个元素大于第二个元素。在不考虑题目中添加位数数量限制的情况下，``98,900,8000``这种通过保证每个元素之间总位数差为1的方案也是蛮不错的，但是如果要求增加尽可能少的位数来达到题目要求，最佳方案为``98,99,900``，也就是说我们要做到尽可能保证后一个元素的值尽可能接近前一个元素的值。\n\n再举个例子，输入集为``1,1,1,1,1,1,1,1,1,1,1,1,1,1``，那么补全后的结果应该为``1 10 11 12 13 14 15 16 17 18 19 100 101 102``。\n\n另外需要注意，此题有两个测试集，Test1还好，每次输入集的``X``数量以及范围都比较小，用``int``完全可以搞定，但是对于Test2来说，int不一定能够满足，当``X``的最大值为``10^9``，``N``为100时，在极端情况下（前一个元素总是比后一个元素大），最终补全后的结果的位数最大为``10 + 100 - 1 = 109``位，此时用int将会溢出导致结果错误，可以通过使用bigint或者自己将大数按位拆位数组来避免溢出的问题！\n\n### Solve\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"math\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tcount := 0\n\tnums := readInts(in)\n\tpreMark := make([]int, 110)\n\tnextMark := make([]int, 110)\n\tfor i := 0; i < inputs[0]; i ++{\n\t\tif i == 0{\n\t\t\tmarkFlush(preMark, nums[i])\n\t\t\tcontinue\n\t\t}\n\t\tpreL := markLen(preMark)\n\t\tmarkFlush(nextMark, nums[i])\n\t\tnextL := markLen(nextMark)\n\n\t\tif preL > nextL {\n\t\t\tdiff := preL - nextL\n\t\t\tfor j := 0; j < nextL; j ++ {\n\t\t\t\tpv := preMark[j]\n\t\t\t\tnv := nextMark[j]\n\t\t\t\tif nv > pv {\n\t\t\t\t\tfor k := 0; k < diff; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = 0\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff\n\t\t\t\t\tbreak\n\t\t\t\t}else if nv < pv {\n\t\t\t\t\tfor k := 0; k < diff + 1; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = 0\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff + 1\n\t\t\t\t\tbreak\n\t\t\t\t}else if j == nextL - 1{\n\t\t\t\t\tfor k := 0; k < diff; k ++{\n\t\t\t\t\t\tnextMark[nextL + k] = preMark[nextL + k]\n\t\t\t\t\t}\n\t\t\t\t\tcount += diff\n\t\t\t\t\tfor k := preL - 1; k > nextL - 1; k --{\n\t\t\t\t\t\tnextMark[k] ++\n\t\t\t\t\t\tif nextMark[k] < 10{\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnextMark[k] = 0\n\t\t\t\t\t\tif k == nextL {\n\t\t\t\t\t\t\tnextMark[preL] = 0\n\t\t\t\t\t\t\tcount ++\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t}else if preL == nextL{\n\t\t\tfor j := 0; j < preL; j ++ {\n\t\t\t\tpv := preMark[j]\n\t\t\t\tnv := nextMark[j]\n\t\t\t\tif nv > pv {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tif nv < pv || (nv == pv && j == preL - 1){\n\t\t\t\t\tcount ++\n\t\t\t\t\tnextMark[nextL] = 0\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcopy(preMark, nextMark)\n\t}\n\tres = append(res, count)\n}\n\nfunc markLen(mark []int) int{\n\tcount := 0\n\tfor ; count < len(mark); count++ {\n\t\tif mark[count] == -1 {\n\t\t\tbreak\n\t\t}\n\t}\n\treturn count\n}\n\nfunc markFlush(mark []int, num int) {\n\tl := numLen(num)\n\tfor i := 0; i < len(mark); i ++ {\n\t\tif i < l {\n\t\t\tmark[i] = num / pow(10, l - i - 1) % 10\n\t\t}else{\n\t\t\tmark[i] = -1\n\t\t}\n\t}\n}\n\nfunc pow(a, b int) int{\n\treturn int(math.Pow(float64(a), float64(b)))\n}\n\nfunc numLen(num int) int{\n\tcount := 0\n\tfor{\n\t\tif num <= 0 {\n\t\t\tbreak\n\t\t}\n\t\tnum = num / 10\n\t\tcount ++\n\t}\n\treturn count\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\n```","slug":"Google-Code-Jam-Round-1A-2021-Rabbit-House","published":1,"updated":"2021-04-14T14:04:49.139Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uxx0003b0tze3sk7msa","content":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/codejam/round/000000000043585d/00000000007549e5\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>题目要求是对于输入的<code>X1,X2,…,XN</code>，求至少在每个数字后方增加多少个的<code>0-9</code>来保证<code>X1,X2,…,XN</code>的递增顺序。</p>\n<p>举个例子，输入集为<code>98,9,8</code>，很明显当前顺序不是递增的，如果要保证顺序递增，需要在保证数组第二个元素大于第一个元素，第三个元素大于第二个元素。在不考虑题目中添加位数数量限制的情况下，<code>98,900,8000</code>这种通过保证每个元素之间总位数差为1的方案也是蛮不错的，但是如果要求增加尽可能少的位数来达到题目要求，最佳方案为<code>98,99,900</code>，也就是说我们要做到尽可能保证后一个元素的值尽可能接近前一个元素的值。</p>\n<p>再举个例子，输入集为<code>1,1,1,1,1,1,1,1,1,1,1,1,1,1</code>，那么补全后的结果应该为<code>1 10 11 12 13 14 15 16 17 18 19 100 101 102</code>。</p>\n<p>另外需要注意，此题有两个测试集，Test1还好，每次输入集的<code>X</code>数量以及范围都比较小，用<code>int</code>完全可以搞定，但是对于Test2来说，int不一定能够满足，当<code>X</code>的最大值为<code>10^9</code>，<code>N</code>为100时，在极端情况下（前一个元素总是比后一个元素大），最终补全后的结果的位数最大为<code>10 + 100 - 1 = 109</code>位，此时用int将会溢出导致结果错误，可以通过使用bigint或者自己将大数按位拆位数组来避免溢出的问题！</p>\n<h3 id=\"solve\"><a class=\"header-anchor\" href=\"#solve\">¶</a>Solve</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;math&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\tnums := readInts(in)</span><br><span class=\"line\">\tpreMark := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">110</span>)</span><br><span class=\"line\">\tnextMark := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">110</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; inputs[<span class=\"number\">0</span>]; i ++&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i == <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\tmarkFlush(preMark, nums[i])</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tpreL := markLen(preMark)</span><br><span class=\"line\">\t\tmarkFlush(nextMark, nums[i])</span><br><span class=\"line\">\t\tnextL := markLen(nextMark)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> preL &gt; nextL &#123;</span><br><span class=\"line\">\t\t\tdiff := preL - nextL</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; nextL; j ++ &#123;</span><br><span class=\"line\">\t\t\t\tpv := preMark[j]</span><br><span class=\"line\">\t\t\t\tnv := nextMark[j]</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &gt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> nv &lt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff + <span class=\"number\">1</span>; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> j == nextL - <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = preMark[nextL + k]</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := preL - <span class=\"number\">1</span>; k &gt; nextL - <span class=\"number\">1</span>; k --&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[k] ++</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> nextMark[k] &lt; <span class=\"number\">10</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> k == nextL &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tnextMark[preL] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> preL == nextL&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; preL; j ++ &#123;</span><br><span class=\"line\">\t\t\t\tpv := preMark[j]</span><br><span class=\"line\">\t\t\t\tnv := nextMark[j]</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &gt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &lt; pv || (nv == pv &amp;&amp; j == preL - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\tnextMark[nextL] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">copy</span>(preMark, nextMark)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">markLen</span><span class=\"params\">(mark []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ; count &lt; <span class=\"built_in\">len</span>(mark); count++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mark[count] == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> count</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">markFlush</span><span class=\"params\">(mark []<span class=\"type\">int</span>, num <span class=\"type\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tl := numLen(num)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(mark); i ++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &lt; l &#123;</span><br><span class=\"line\">\t\t\tmark[i] = num / pow(<span class=\"number\">10</span>, l - i - <span class=\"number\">1</span>) % <span class=\"number\">10</span></span><br><span class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\t\tmark[i] = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">pow</span><span class=\"params\">(a, b <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">int</span>(math.Pow(<span class=\"type\">float64</span>(a), <span class=\"type\">float64</span>(b)))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">numLen</span><span class=\"params\">(num <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> num &lt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tnum = num / <span class=\"number\">10</span></span><br><span class=\"line\">\t\tcount ++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> count</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/codejam/round/000000000043585d/00000000007549e5\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>题目要求是对于输入的<code>X1,X2,…,XN</code>，求至少在每个数字后方增加多少个的<code>0-9</code>来保证<code>X1,X2,…,XN</code>的递增顺序。</p>\n<p>举个例子，输入集为<code>98,9,8</code>，很明显当前顺序不是递增的，如果要保证顺序递增，需要在保证数组第二个元素大于第一个元素，第三个元素大于第二个元素。在不考虑题目中添加位数数量限制的情况下，<code>98,900,8000</code>这种通过保证每个元素之间总位数差为1的方案也是蛮不错的，但是如果要求增加尽可能少的位数来达到题目要求，最佳方案为<code>98,99,900</code>，也就是说我们要做到尽可能保证后一个元素的值尽可能接近前一个元素的值。</p>\n<p>再举个例子，输入集为<code>1,1,1,1,1,1,1,1,1,1,1,1,1,1</code>，那么补全后的结果应该为<code>1 10 11 12 13 14 15 16 17 18 19 100 101 102</code>。</p>\n<p>另外需要注意，此题有两个测试集，Test1还好，每次输入集的<code>X</code>数量以及范围都比较小，用<code>int</code>完全可以搞定，但是对于Test2来说，int不一定能够满足，当<code>X</code>的最大值为<code>10^9</code>，<code>N</code>为100时，在极端情况下（前一个元素总是比后一个元素大），最终补全后的结果的位数最大为<code>10 + 100 - 1 = 109</code>位，此时用int将会溢出导致结果错误，可以通过使用bigint或者自己将大数按位拆位数组来避免溢出的问题！</p>\n<h3 id=\"solve\"><a class=\"header-anchor\" href=\"#solve\">¶</a>Solve</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;math&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\tnums := readInts(in)</span><br><span class=\"line\">\tpreMark := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">110</span>)</span><br><span class=\"line\">\tnextMark := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">110</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; inputs[<span class=\"number\">0</span>]; i ++&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i == <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\tmarkFlush(preMark, nums[i])</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tpreL := markLen(preMark)</span><br><span class=\"line\">\t\tmarkFlush(nextMark, nums[i])</span><br><span class=\"line\">\t\tnextL := markLen(nextMark)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> preL &gt; nextL &#123;</span><br><span class=\"line\">\t\t\tdiff := preL - nextL</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; nextL; j ++ &#123;</span><br><span class=\"line\">\t\t\t\tpv := preMark[j]</span><br><span class=\"line\">\t\t\t\tnv := nextMark[j]</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &gt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> nv &lt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff + <span class=\"number\">1</span>; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> j == nextL - <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := <span class=\"number\">0</span>; k &lt; diff; k ++&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[nextL + k] = preMark[nextL + k]</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tcount += diff</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> k := preL - <span class=\"number\">1</span>; k &gt; nextL - <span class=\"number\">1</span>; k --&#123;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[k] ++</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> nextMark[k] &lt; <span class=\"number\">10</span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\tnextMark[k] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> k == nextL &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tnextMark[preL] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> preL == nextL&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; preL; j ++ &#123;</span><br><span class=\"line\">\t\t\t\tpv := preMark[j]</span><br><span class=\"line\">\t\t\t\tnv := nextMark[j]</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &gt; pv &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> nv &lt; pv || (nv == pv &amp;&amp; j == preL - <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t\t\t\tcount ++</span><br><span class=\"line\">\t\t\t\t\tnextMark[nextL] = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">copy</span>(preMark, nextMark)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">markLen</span><span class=\"params\">(mark []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ; count &lt; <span class=\"built_in\">len</span>(mark); count++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mark[count] == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> count</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">markFlush</span><span class=\"params\">(mark []<span class=\"type\">int</span>, num <span class=\"type\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tl := numLen(num)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(mark); i ++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &lt; l &#123;</span><br><span class=\"line\">\t\t\tmark[i] = num / pow(<span class=\"number\">10</span>, l - i - <span class=\"number\">1</span>) % <span class=\"number\">10</span></span><br><span class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\t\tmark[i] = <span class=\"number\">-1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">pow</span><span class=\"params\">(a, b <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">int</span>(math.Pow(<span class=\"type\">float64</span>(a), <span class=\"type\">float64</span>(b)))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">numLen</span><span class=\"params\">(num <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tcount := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> num &lt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tnum = num / <span class=\"number\">10</span></span><br><span class=\"line\">\t\tcount ++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> count</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"Kick Start Round A 2021 -  K-Goodness String","author":"Nico","date":"2021-03-21T18:37:00.000Z","_content":"原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cca3#problem)\n\n### 分析\n题意大概是当字符串对称位置的字母如果不相同则score加一分，输入字符串以及期望的score分数，求将当前字符串变动任意位置的字母使之score等于期望的socre。\n\n其实就是求字符串对称位置字符不相同的数量，然后和期望score做差再取abs。\n### Slove\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tn := inputs[0]\n\tk := inputs[1]\n\tstr := readline(in)\n\ts := 0\n\n\tfor i := 0; i < len(str); i++ {\n\t\tr := n - 1 - i\n\t\tif r <= i {\n\t\t\tbreak\n\t\t}\n\t\tif str[i] != str[r] {\n\t\t\ts ++\n\t\t}\n\t}\n\tresult := k - s\n\tif result < 0{\n\t\tresult = - result\n\t}\n\tres = append(res, result)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\n\n```","source":"_posts/Kick-Start-Round-A-2021-K-Goodness-String.md","raw":"title: Kick Start Round A 2021 -  K-Goodness String\nauthor: Nico\ntags:\n  - Kick Start\ncategories:\n  - Algorithm\ndate: 2021-03-22 02:37:00\n---\n原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cca3#problem)\n\n### 分析\n题意大概是当字符串对称位置的字母如果不相同则score加一分，输入字符串以及期望的score分数，求将当前字符串变动任意位置的字母使之score等于期望的socre。\n\n其实就是求字符串对称位置字符不相同的数量，然后和期望score做差再取abs。\n### Slove\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tn := inputs[0]\n\tk := inputs[1]\n\tstr := readline(in)\n\ts := 0\n\n\tfor i := 0; i < len(str); i++ {\n\t\tr := n - 1 - i\n\t\tif r <= i {\n\t\t\tbreak\n\t\t}\n\t\tif str[i] != str[r] {\n\t\t\ts ++\n\t\t}\n\t}\n\tresult := k - s\n\tif result < 0{\n\t\tresult = - result\n\t}\n\tres = append(res, result)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\n\n```","slug":"Kick-Start-Round-A-2021-K-Goodness-String","published":1,"updated":"2021-03-21T20:56:04.444Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy00006b0tzanyy3uhe","content":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cca3#problem\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>题意大概是当字符串对称位置的字母如果不相同则score加一分，输入字符串以及期望的score分数，求将当前字符串变动任意位置的字母使之score等于期望的socre。</p>\n<p>其实就是求字符串对称位置字符不相同的数量，然后和期望score做差再取abs。</p>\n<h3 id=\"slove\"><a class=\"header-anchor\" href=\"#slove\">¶</a>Slove</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tn := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tk := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tstr := readline(in)</span><br><span class=\"line\">\ts := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(str); i++ &#123;</span><br><span class=\"line\">\t\tr := n - <span class=\"number\">1</span> - i</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> r &lt;= i &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> str[i] != str[r] &#123;</span><br><span class=\"line\">\t\t\ts ++</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tresult := k - s</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> result &lt; <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\tresult = - result</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, result)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cca3#problem\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>题意大概是当字符串对称位置的字母如果不相同则score加一分，输入字符串以及期望的score分数，求将当前字符串变动任意位置的字母使之score等于期望的socre。</p>\n<p>其实就是求字符串对称位置字符不相同的数量，然后和期望score做差再取abs。</p>\n<h3 id=\"slove\"><a class=\"header-anchor\" href=\"#slove\">¶</a>Slove</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tn := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tk := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tstr := readline(in)</span><br><span class=\"line\">\ts := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(str); i++ &#123;</span><br><span class=\"line\">\t\tr := n - <span class=\"number\">1</span> - i</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> r &lt;= i &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> str[i] != str[r] &#123;</span><br><span class=\"line\">\t\t\ts ++</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tresult := k - s</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> result &lt; <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\tresult = - result</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, result)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"Jenkins安装及自动部署Maven项目","author":"Nico","date":"2018-11-06T04:47:00.000Z","_content":"## 一、环境配置\n#### OS版本\n\n```\n[root@VM_0_11_centos /]# rpm -qa | grep centos-release\ncentos-release-7-4.1708.el7.centos.x86_64\n```\n#### Java版本\n```\n[root@VM_0_11_centos /]# java -version\nopenjdk version \"1.8.0_181\"\nOpenJDK Runtime Environment (build 1.8.0_181-b13)\nOpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)\n```\n#### Maven版本\n```\n[root@VM_0_11_centos /]# mvn -v\nApache Maven 3.0.5 (Red Hat 3.0.5-17)\nMaven home: /usr/share/maven\nJava version: 1.8.0_181, vendor: Oracle Corporation\nJava home: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre\nDefault locale: en_US, platform encoding: UTF-8\nOS name: \"linux\", version: \"3.10.0-693.el7.x86_64\", arch: \"amd64\", family: \"unix\"\n```\n#### Git版本\n```\n[root@VM_0_11_centos /]# git --version\ngit version 1.8.3.1\n```\n## 二、安装\n\n#### Java安装\n```\nyum install java-1.8.0-openjdk.x86_64\n```\n#### Maven安装\n```\nyum install maven\n```\n#### Git安装\n```\nyum install git\n```\n#### Jenkins安装\n\nrpm包地址：[https://pkg.jenkins.io/redhat-stable/](https://pkg.jenkins.io/redhat-stable/)\n```\nrpm -ivh xxx.npm\n```\n执行以上指令后即安装完毕，查看一下jenkins所在目录\n```\nwhereis jenkins\n```\n控制台输出\n```\n[root@VM_0_11_centos /]# whereis jenkins\njenkins: /usr/lib/jenkins\n```\n默认jenkins的配置文件在``/etc/sysconfig/jenkins``\n\n启动jenkins\n```\nservice jenkins start\n```\n关闭jenkins\n```\nservice jenkins stop\n```\n## 三、Jenkins部署Maven项目\nJenkins启动只有的默认端口为8080，在保证服务器安全组开放8080端口（或者自己在``/etc/sysconfig/jenkins``配置文件中修改端口）的前提下，我们可以直接通过浏览器访问Jenkins\n```\nhttp://xxxxxx:8080\n```\n第一次进入Jenkins会让你走几个步骤\n - 输入管理员密码，密码可以从页面提示的文件中看到\n - 下载默认插件，点击官方推荐的按钮继续往下走\n - 设置账号密码和邮箱地址\n - 登入\n\n一顿操作，我们就来到了Jenkins的Dashboard页面\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6974344c0?w=1897&h=598&f=png&s=72196)\n\n看到这里是不是很激动？别急，Jenkins的新建任务默认是没有Maven选项的,需要自行安装Jenkins的Maven插件！\n\n#### 1、安装Jenkins-Maven插件Maven Integration\n在首页中点击右侧的系统管理\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6976b76bd?w=1885&h=613&f=png&s=75878)\n选择管理插件\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b697a978f8?w=1892&h=862&f=png&s=133614)\n下载Maven Integration\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6979cd7a5?w=1892&h=651&f=png&s=67831)\n点击立即获取之后，等待一分钟左右就下载好了\n\n#### 2、配置全局工具\n接着我们要做一些工具的配置\n\n再次进入系统管理，点击列表中的**全局工具配置**\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b69783f279?w=1889&h=827&f=png&s=128413)\n配置JDK\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b697743f0a?w=1529&h=362&f=png&s=20752)\n配置Git\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c277f7c6?w=1523&h=320&f=png&s=17690)\n配置Maven\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c740707d?w=1507&h=331&f=png&s=19931)\n完毕之后点击``SAVE``按钮保存\n#### 3、配置任务信息\n经过前面两个步骤，我们的Jenkins可以正式开始工作了，不过在真正为我们提供服务之前，我们需要告诉任务该做什么事情，该怎么做。\n\n例如？我们要构建的项目从何而来？通过什么样的方式或者指令就构建？不废话，开始创建一个新的任务，并且是一个Maven项目\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c7c0c77f?w=1901&h=614&f=png&s=60467)\n点击创建一个新任务进入下一步\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6ca5adfa0?w=1852&h=933&f=png&s=132108)\n选择创建一个Maven项目，确定之后，进入任务配置界面\n\n任务信息配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d06d8e2b?w=1882&h=462&f=png&s=42624)\n源码库配置，Jenkins要知道如何获取到项目的源码\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d2fca2f2?w=1887&h=657&f=png&s=63920)\nMaven打包指令配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6e4036b64?w=1886&h=425&f=png&s=37257)\n构建策略配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6eb145739?w=1879&h=374&f=png&s=43226)\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f1a7a410?w=1889&h=327&f=png&s=33364)\n构建生命周期配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f5b10abc?w=1884&h=726&f=png&s=76468)\n这一步很关键，在Jenkins帮我们自动拉取代码并且打成jar包之后，我们需要执行shell指令去启动它们，``Pre Steps``和``Post Steps``使我们可以在整个周期内灵活的去控制流程~例如写个脚本启动它们！\n\n简单配置之后，点击保存，完成任务配置编辑！\n\n之后的事情就简单了，在首页可以看到一个任务列表，选中自己的任务点击进入\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fa1e7b0f?w=1890&h=567&f=png&s=67414)\n点击左侧工具栏的立即构建~ \n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fc49a77e?w=1891&h=879&f=png&s=108676)\nJenkins简单部署完成，看下我的任务构建控制台输出日志\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b7806857f7?w=1883&h=907&f=png&s=90364)\n\n看到最下方的成功就代表项目已经成功部署！","source":"_posts/Jenkins安装及自动部署Maven项目.md","raw":"title: Jenkins安装及自动部署Maven项目\nauthor: Nico\ntags:\n  - Jenkins\n  - Maven\ncategories: []\ndate: 2018-11-06 12:47:00\n---\n## 一、环境配置\n#### OS版本\n\n```\n[root@VM_0_11_centos /]# rpm -qa | grep centos-release\ncentos-release-7-4.1708.el7.centos.x86_64\n```\n#### Java版本\n```\n[root@VM_0_11_centos /]# java -version\nopenjdk version \"1.8.0_181\"\nOpenJDK Runtime Environment (build 1.8.0_181-b13)\nOpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)\n```\n#### Maven版本\n```\n[root@VM_0_11_centos /]# mvn -v\nApache Maven 3.0.5 (Red Hat 3.0.5-17)\nMaven home: /usr/share/maven\nJava version: 1.8.0_181, vendor: Oracle Corporation\nJava home: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre\nDefault locale: en_US, platform encoding: UTF-8\nOS name: \"linux\", version: \"3.10.0-693.el7.x86_64\", arch: \"amd64\", family: \"unix\"\n```\n#### Git版本\n```\n[root@VM_0_11_centos /]# git --version\ngit version 1.8.3.1\n```\n## 二、安装\n\n#### Java安装\n```\nyum install java-1.8.0-openjdk.x86_64\n```\n#### Maven安装\n```\nyum install maven\n```\n#### Git安装\n```\nyum install git\n```\n#### Jenkins安装\n\nrpm包地址：[https://pkg.jenkins.io/redhat-stable/](https://pkg.jenkins.io/redhat-stable/)\n```\nrpm -ivh xxx.npm\n```\n执行以上指令后即安装完毕，查看一下jenkins所在目录\n```\nwhereis jenkins\n```\n控制台输出\n```\n[root@VM_0_11_centos /]# whereis jenkins\njenkins: /usr/lib/jenkins\n```\n默认jenkins的配置文件在``/etc/sysconfig/jenkins``\n\n启动jenkins\n```\nservice jenkins start\n```\n关闭jenkins\n```\nservice jenkins stop\n```\n## 三、Jenkins部署Maven项目\nJenkins启动只有的默认端口为8080，在保证服务器安全组开放8080端口（或者自己在``/etc/sysconfig/jenkins``配置文件中修改端口）的前提下，我们可以直接通过浏览器访问Jenkins\n```\nhttp://xxxxxx:8080\n```\n第一次进入Jenkins会让你走几个步骤\n - 输入管理员密码，密码可以从页面提示的文件中看到\n - 下载默认插件，点击官方推荐的按钮继续往下走\n - 设置账号密码和邮箱地址\n - 登入\n\n一顿操作，我们就来到了Jenkins的Dashboard页面\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6974344c0?w=1897&h=598&f=png&s=72196)\n\n看到这里是不是很激动？别急，Jenkins的新建任务默认是没有Maven选项的,需要自行安装Jenkins的Maven插件！\n\n#### 1、安装Jenkins-Maven插件Maven Integration\n在首页中点击右侧的系统管理\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6976b76bd?w=1885&h=613&f=png&s=75878)\n选择管理插件\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b697a978f8?w=1892&h=862&f=png&s=133614)\n下载Maven Integration\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6979cd7a5?w=1892&h=651&f=png&s=67831)\n点击立即获取之后，等待一分钟左右就下载好了\n\n#### 2、配置全局工具\n接着我们要做一些工具的配置\n\n再次进入系统管理，点击列表中的**全局工具配置**\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b69783f279?w=1889&h=827&f=png&s=128413)\n配置JDK\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b697743f0a?w=1529&h=362&f=png&s=20752)\n配置Git\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c277f7c6?w=1523&h=320&f=png&s=17690)\n配置Maven\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c740707d?w=1507&h=331&f=png&s=19931)\n完毕之后点击``SAVE``按钮保存\n#### 3、配置任务信息\n经过前面两个步骤，我们的Jenkins可以正式开始工作了，不过在真正为我们提供服务之前，我们需要告诉任务该做什么事情，该怎么做。\n\n例如？我们要构建的项目从何而来？通过什么样的方式或者指令就构建？不废话，开始创建一个新的任务，并且是一个Maven项目\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c7c0c77f?w=1901&h=614&f=png&s=60467)\n点击创建一个新任务进入下一步\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6ca5adfa0?w=1852&h=933&f=png&s=132108)\n选择创建一个Maven项目，确定之后，进入任务配置界面\n\n任务信息配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d06d8e2b?w=1882&h=462&f=png&s=42624)\n源码库配置，Jenkins要知道如何获取到项目的源码\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d2fca2f2?w=1887&h=657&f=png&s=63920)\nMaven打包指令配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6e4036b64?w=1886&h=425&f=png&s=37257)\n构建策略配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6eb145739?w=1879&h=374&f=png&s=43226)\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f1a7a410?w=1889&h=327&f=png&s=33364)\n构建生命周期配置\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f5b10abc?w=1884&h=726&f=png&s=76468)\n这一步很关键，在Jenkins帮我们自动拉取代码并且打成jar包之后，我们需要执行shell指令去启动它们，``Pre Steps``和``Post Steps``使我们可以在整个周期内灵活的去控制流程~例如写个脚本启动它们！\n\n简单配置之后，点击保存，完成任务配置编辑！\n\n之后的事情就简单了，在首页可以看到一个任务列表，选中自己的任务点击进入\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fa1e7b0f?w=1890&h=567&f=png&s=67414)\n点击左侧工具栏的立即构建~ \n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fc49a77e?w=1891&h=879&f=png&s=108676)\nJenkins简单部署完成，看下我的任务构建控制台输出日志\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e77b7806857f7?w=1883&h=907&f=png&s=90364)\n\n看到最下方的成功就代表项目已经成功部署！","slug":"Jenkins安装及自动部署Maven项目","published":1,"updated":"2021-03-21T17:43:06.310Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy10007b0tzgnzka912","content":"<h2 id=\"一-环境配置\"><a class=\"header-anchor\" href=\"#一-环境配置\">¶</a>一、环境配置</h2>\n<h4 id=\"os版本\"><a class=\"header-anchor\" href=\"#os版本\">¶</a>OS版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# rpm -qa | grep centos-release</span><br><span class=\"line\">centos-release-7-4.1708.el7.centos.x86_64</span><br></pre></td></tr></table></figure>\n<h4 id=\"java版本\"><a class=\"header-anchor\" href=\"#java版本\">¶</a>Java版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# java -version</span><br><span class=\"line\">openjdk version &quot;1.8.0_181&quot;</span><br><span class=\"line\">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class=\"line\">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure>\n<h4 id=\"maven版本\"><a class=\"header-anchor\" href=\"#maven版本\">¶</a>Maven版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# mvn -v</span><br><span class=\"line\">Apache Maven 3.0.5 (Red Hat 3.0.5-17)</span><br><span class=\"line\">Maven home: /usr/share/maven</span><br><span class=\"line\">Java version: 1.8.0_181, vendor: Oracle Corporation</span><br><span class=\"line\">Java home: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre</span><br><span class=\"line\">Default locale: en_US, platform encoding: UTF-8</span><br><span class=\"line\">OS name: &quot;linux&quot;, version: &quot;3.10.0-693.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"git版本\"><a class=\"header-anchor\" href=\"#git版本\">¶</a>Git版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# git --version</span><br><span class=\"line\">git version 1.8.3.1</span><br></pre></td></tr></table></figure>\n<h2 id=\"二-安装\"><a class=\"header-anchor\" href=\"#二-安装\">¶</a>二、安装</h2>\n<h4 id=\"java安装\"><a class=\"header-anchor\" href=\"#java安装\">¶</a>Java安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>\n<h4 id=\"maven安装\"><a class=\"header-anchor\" href=\"#maven安装\">¶</a>Maven安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install maven</span><br></pre></td></tr></table></figure>\n<h4 id=\"git安装\"><a class=\"header-anchor\" href=\"#git安装\">¶</a>Git安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install git</span><br></pre></td></tr></table></figure>\n<h4 id=\"jenkins安装\"><a class=\"header-anchor\" href=\"#jenkins安装\">¶</a>Jenkins安装</h4>\n<p>rpm包地址：<a href=\"https://pkg.jenkins.io/redhat-stable/\">https://pkg.jenkins.io/redhat-stable/</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ivh xxx.npm</span><br></pre></td></tr></table></figure>\n<p>执行以上指令后即安装完毕，查看一下jenkins所在目录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whereis jenkins</span><br></pre></td></tr></table></figure>\n<p>控制台输出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# whereis jenkins</span><br><span class=\"line\">jenkins: /usr/lib/jenkins</span><br></pre></td></tr></table></figure>\n<p>默认jenkins的配置文件在<code>/etc/sysconfig/jenkins</code></p>\n<p>启动jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service jenkins start</span><br></pre></td></tr></table></figure>\n<p>关闭jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service jenkins stop</span><br></pre></td></tr></table></figure>\n<h2 id=\"三-jenkins部署maven项目\"><a class=\"header-anchor\" href=\"#三-jenkins部署maven项目\">¶</a>三、Jenkins部署Maven项目</h2>\n<p>Jenkins启动只有的默认端口为8080，在保证服务器安全组开放8080端口（或者自己在<code>/etc/sysconfig/jenkins</code>配置文件中修改端口）的前提下，我们可以直接通过浏览器访问Jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://xxxxxx:8080</span><br></pre></td></tr></table></figure>\n<p>第一次进入Jenkins会让你走几个步骤</p>\n<ul>\n<li>输入管理员密码，密码可以从页面提示的文件中看到</li>\n<li>下载默认插件，点击官方推荐的按钮继续往下走</li>\n<li>设置账号密码和邮箱地址</li>\n<li>登入</li>\n</ul>\n<p>一顿操作，我们就来到了Jenkins的Dashboard页面<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6974344c0?w=1897&amp;h=598&amp;f=png&amp;s=72196\" alt=\"这里写图片描述\"></p>\n<p>看到这里是不是很激动？别急，Jenkins的新建任务默认是没有Maven选项的,需要自行安装Jenkins的Maven插件！</p>\n<h4 id=\"1-安装jenkins-maven插件maven-integration\"><a class=\"header-anchor\" href=\"#1-安装jenkins-maven插件maven-integration\">¶</a>1、安装Jenkins-Maven插件Maven Integration</h4>\n<p>在首页中点击右侧的系统管理<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6976b76bd?w=1885&amp;h=613&amp;f=png&amp;s=75878\" alt=\"这里写图片描述\"><br>\n选择管理插件<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b697a978f8?w=1892&amp;h=862&amp;f=png&amp;s=133614\" alt=\"这里写图片描述\"><br>\n下载Maven Integration<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6979cd7a5?w=1892&amp;h=651&amp;f=png&amp;s=67831\" alt=\"这里写图片描述\"><br>\n点击立即获取之后，等待一分钟左右就下载好了</p>\n<h4 id=\"2-配置全局工具\"><a class=\"header-anchor\" href=\"#2-配置全局工具\">¶</a>2、配置全局工具</h4>\n<p>接着我们要做一些工具的配置</p>\n<p>再次进入系统管理，点击列表中的<strong>全局工具配置</strong><br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b69783f279?w=1889&amp;h=827&amp;f=png&amp;s=128413\" alt=\"这里写图片描述\"><br>\n配置JDK<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b697743f0a?w=1529&amp;h=362&amp;f=png&amp;s=20752\" alt=\"这里写图片描述\"><br>\n配置Git<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c277f7c6?w=1523&amp;h=320&amp;f=png&amp;s=17690\" alt=\"这里写图片描述\"><br>\n配置Maven<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c740707d?w=1507&amp;h=331&amp;f=png&amp;s=19931\" alt=\"这里写图片描述\"><br>\n完毕之后点击<code>SAVE</code>按钮保存</p>\n<h4 id=\"3-配置任务信息\"><a class=\"header-anchor\" href=\"#3-配置任务信息\">¶</a>3、配置任务信息</h4>\n<p>经过前面两个步骤，我们的Jenkins可以正式开始工作了，不过在真正为我们提供服务之前，我们需要告诉任务该做什么事情，该怎么做。</p>\n<p>例如？我们要构建的项目从何而来？通过什么样的方式或者指令就构建？不废话，开始创建一个新的任务，并且是一个Maven项目<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c7c0c77f?w=1901&amp;h=614&amp;f=png&amp;s=60467\" alt=\"这里写图片描述\"><br>\n点击创建一个新任务进入下一步<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6ca5adfa0?w=1852&amp;h=933&amp;f=png&amp;s=132108\" alt=\"这里写图片描述\"><br>\n选择创建一个Maven项目，确定之后，进入任务配置界面</p>\n<p>任务信息配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d06d8e2b?w=1882&amp;h=462&amp;f=png&amp;s=42624\" alt=\"这里写图片描述\"><br>\n源码库配置，Jenkins要知道如何获取到项目的源码<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d2fca2f2?w=1887&amp;h=657&amp;f=png&amp;s=63920\" alt=\"这里写图片描述\"><br>\nMaven打包指令配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6e4036b64?w=1886&amp;h=425&amp;f=png&amp;s=37257\" alt=\"这里写图片描述\"><br>\n构建策略配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6eb145739?w=1879&amp;h=374&amp;f=png&amp;s=43226\" alt=\"这里写图片描述\"><br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f1a7a410?w=1889&amp;h=327&amp;f=png&amp;s=33364\" alt=\"这里写图片描述\"><br>\n构建生命周期配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f5b10abc?w=1884&amp;h=726&amp;f=png&amp;s=76468\" alt=\"这里写图片描述\"><br>\n这一步很关键，在Jenkins帮我们自动拉取代码并且打成jar包之后，我们需要执行shell指令去启动它们，<code>Pre Steps</code>和<code>Post Steps</code>使我们可以在整个周期内灵活的去控制流程~例如写个脚本启动它们！</p>\n<p>简单配置之后，点击保存，完成任务配置编辑！</p>\n<p>之后的事情就简单了，在首页可以看到一个任务列表，选中自己的任务点击进入<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fa1e7b0f?w=1890&amp;h=567&amp;f=png&amp;s=67414\" alt=\"这里写图片描述\"><br>\n点击左侧工具栏的立即构建~<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fc49a77e?w=1891&amp;h=879&amp;f=png&amp;s=108676\" alt=\"这里写图片描述\"><br>\nJenkins简单部署完成，看下我的任务构建控制台输出日志<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b7806857f7?w=1883&amp;h=907&amp;f=png&amp;s=90364\" alt=\"这里写图片描述\"></p>\n<p>看到最下方的成功就代表项目已经成功部署！</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-环境配置\"><a class=\"header-anchor\" href=\"#一-环境配置\">¶</a>一、环境配置</h2>\n<h4 id=\"os版本\"><a class=\"header-anchor\" href=\"#os版本\">¶</a>OS版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# rpm -qa | grep centos-release</span><br><span class=\"line\">centos-release-7-4.1708.el7.centos.x86_64</span><br></pre></td></tr></table></figure>\n<h4 id=\"java版本\"><a class=\"header-anchor\" href=\"#java版本\">¶</a>Java版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# java -version</span><br><span class=\"line\">openjdk version &quot;1.8.0_181&quot;</span><br><span class=\"line\">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class=\"line\">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure>\n<h4 id=\"maven版本\"><a class=\"header-anchor\" href=\"#maven版本\">¶</a>Maven版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# mvn -v</span><br><span class=\"line\">Apache Maven 3.0.5 (Red Hat 3.0.5-17)</span><br><span class=\"line\">Maven home: /usr/share/maven</span><br><span class=\"line\">Java version: 1.8.0_181, vendor: Oracle Corporation</span><br><span class=\"line\">Java home: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre</span><br><span class=\"line\">Default locale: en_US, platform encoding: UTF-8</span><br><span class=\"line\">OS name: &quot;linux&quot;, version: &quot;3.10.0-693.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"git版本\"><a class=\"header-anchor\" href=\"#git版本\">¶</a>Git版本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# git --version</span><br><span class=\"line\">git version 1.8.3.1</span><br></pre></td></tr></table></figure>\n<h2 id=\"二-安装\"><a class=\"header-anchor\" href=\"#二-安装\">¶</a>二、安装</h2>\n<h4 id=\"java安装\"><a class=\"header-anchor\" href=\"#java安装\">¶</a>Java安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>\n<h4 id=\"maven安装\"><a class=\"header-anchor\" href=\"#maven安装\">¶</a>Maven安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install maven</span><br></pre></td></tr></table></figure>\n<h4 id=\"git安装\"><a class=\"header-anchor\" href=\"#git安装\">¶</a>Git安装</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install git</span><br></pre></td></tr></table></figure>\n<h4 id=\"jenkins安装\"><a class=\"header-anchor\" href=\"#jenkins安装\">¶</a>Jenkins安装</h4>\n<p>rpm包地址：<a href=\"https://pkg.jenkins.io/redhat-stable/\">https://pkg.jenkins.io/redhat-stable/</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ivh xxx.npm</span><br></pre></td></tr></table></figure>\n<p>执行以上指令后即安装完毕，查看一下jenkins所在目录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whereis jenkins</span><br></pre></td></tr></table></figure>\n<p>控制台输出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_0_11_centos /]# whereis jenkins</span><br><span class=\"line\">jenkins: /usr/lib/jenkins</span><br></pre></td></tr></table></figure>\n<p>默认jenkins的配置文件在<code>/etc/sysconfig/jenkins</code></p>\n<p>启动jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service jenkins start</span><br></pre></td></tr></table></figure>\n<p>关闭jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service jenkins stop</span><br></pre></td></tr></table></figure>\n<h2 id=\"三-jenkins部署maven项目\"><a class=\"header-anchor\" href=\"#三-jenkins部署maven项目\">¶</a>三、Jenkins部署Maven项目</h2>\n<p>Jenkins启动只有的默认端口为8080，在保证服务器安全组开放8080端口（或者自己在<code>/etc/sysconfig/jenkins</code>配置文件中修改端口）的前提下，我们可以直接通过浏览器访问Jenkins</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://xxxxxx:8080</span><br></pre></td></tr></table></figure>\n<p>第一次进入Jenkins会让你走几个步骤</p>\n<ul>\n<li>输入管理员密码，密码可以从页面提示的文件中看到</li>\n<li>下载默认插件，点击官方推荐的按钮继续往下走</li>\n<li>设置账号密码和邮箱地址</li>\n<li>登入</li>\n</ul>\n<p>一顿操作，我们就来到了Jenkins的Dashboard页面<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6974344c0?w=1897&amp;h=598&amp;f=png&amp;s=72196\" alt=\"这里写图片描述\"></p>\n<p>看到这里是不是很激动？别急，Jenkins的新建任务默认是没有Maven选项的,需要自行安装Jenkins的Maven插件！</p>\n<h4 id=\"1-安装jenkins-maven插件maven-integration\"><a class=\"header-anchor\" href=\"#1-安装jenkins-maven插件maven-integration\">¶</a>1、安装Jenkins-Maven插件Maven Integration</h4>\n<p>在首页中点击右侧的系统管理<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6976b76bd?w=1885&amp;h=613&amp;f=png&amp;s=75878\" alt=\"这里写图片描述\"><br>\n选择管理插件<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b697a978f8?w=1892&amp;h=862&amp;f=png&amp;s=133614\" alt=\"这里写图片描述\"><br>\n下载Maven Integration<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6979cd7a5?w=1892&amp;h=651&amp;f=png&amp;s=67831\" alt=\"这里写图片描述\"><br>\n点击立即获取之后，等待一分钟左右就下载好了</p>\n<h4 id=\"2-配置全局工具\"><a class=\"header-anchor\" href=\"#2-配置全局工具\">¶</a>2、配置全局工具</h4>\n<p>接着我们要做一些工具的配置</p>\n<p>再次进入系统管理，点击列表中的<strong>全局工具配置</strong><br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b69783f279?w=1889&amp;h=827&amp;f=png&amp;s=128413\" alt=\"这里写图片描述\"><br>\n配置JDK<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b697743f0a?w=1529&amp;h=362&amp;f=png&amp;s=20752\" alt=\"这里写图片描述\"><br>\n配置Git<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c277f7c6?w=1523&amp;h=320&amp;f=png&amp;s=17690\" alt=\"这里写图片描述\"><br>\n配置Maven<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c740707d?w=1507&amp;h=331&amp;f=png&amp;s=19931\" alt=\"这里写图片描述\"><br>\n完毕之后点击<code>SAVE</code>按钮保存</p>\n<h4 id=\"3-配置任务信息\"><a class=\"header-anchor\" href=\"#3-配置任务信息\">¶</a>3、配置任务信息</h4>\n<p>经过前面两个步骤，我们的Jenkins可以正式开始工作了，不过在真正为我们提供服务之前，我们需要告诉任务该做什么事情，该怎么做。</p>\n<p>例如？我们要构建的项目从何而来？通过什么样的方式或者指令就构建？不废话，开始创建一个新的任务，并且是一个Maven项目<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c7c0c77f?w=1901&amp;h=614&amp;f=png&amp;s=60467\" alt=\"这里写图片描述\"><br>\n点击创建一个新任务进入下一步<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6ca5adfa0?w=1852&amp;h=933&amp;f=png&amp;s=132108\" alt=\"这里写图片描述\"><br>\n选择创建一个Maven项目，确定之后，进入任务配置界面</p>\n<p>任务信息配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d06d8e2b?w=1882&amp;h=462&amp;f=png&amp;s=42624\" alt=\"这里写图片描述\"><br>\n源码库配置，Jenkins要知道如何获取到项目的源码<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d2fca2f2?w=1887&amp;h=657&amp;f=png&amp;s=63920\" alt=\"这里写图片描述\"><br>\nMaven打包指令配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6e4036b64?w=1886&amp;h=425&amp;f=png&amp;s=37257\" alt=\"这里写图片描述\"><br>\n构建策略配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6eb145739?w=1879&amp;h=374&amp;f=png&amp;s=43226\" alt=\"这里写图片描述\"><br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f1a7a410?w=1889&amp;h=327&amp;f=png&amp;s=33364\" alt=\"这里写图片描述\"><br>\n构建生命周期配置<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f5b10abc?w=1884&amp;h=726&amp;f=png&amp;s=76468\" alt=\"这里写图片描述\"><br>\n这一步很关键，在Jenkins帮我们自动拉取代码并且打成jar包之后，我们需要执行shell指令去启动它们，<code>Pre Steps</code>和<code>Post Steps</code>使我们可以在整个周期内灵活的去控制流程~例如写个脚本启动它们！</p>\n<p>简单配置之后，点击保存，完成任务配置编辑！</p>\n<p>之后的事情就简单了，在首页可以看到一个任务列表，选中自己的任务点击进入<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fa1e7b0f?w=1890&amp;h=567&amp;f=png&amp;s=67414\" alt=\"这里写图片描述\"><br>\n点击左侧工具栏的立即构建~<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fc49a77e?w=1891&amp;h=879&amp;f=png&amp;s=108676\" alt=\"这里写图片描述\"><br>\nJenkins简单部署完成，看下我的任务构建控制台输出日志<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e77b7806857f7?w=1883&amp;h=907&amp;f=png&amp;s=90364\" alt=\"这里写图片描述\"></p>\n<p>看到最下方的成功就代表项目已经成功部署！</p>\n"},{"title":"Kick Start Round A 2021 -  Rabbit House","author":"Nico","date":"2021-03-22T04:33:00.000Z","_content":"原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cb14)\n\n### 分析\n对于英文弱鸡的笔者，这道题着实看了很久才看懂题意，同样在一个二维平面内存在着``R * C``的格子，且每个格子都会有``0≤ Gi,j ≤2*10^6``各盒子，例如：\n```\n0 0 0\n0 2 0\n0 0 0\n```\n上述表示R为3，C为3的格子，中间格子的盒子数量为2，其余格子盒子数量为0。\n\n描述到此为止，最终问题是求输入的R*C的格子中，如果要保证每个格子与相邻格子的盒子数量差在1以内，需要在当前规格的基础上，至少增加多少个盒子？\n\n因为最终要保证整个平面内，所有的格子高度差绝对值 <= 1，所以应该从最高的格子开始，让其相邻格子条件，之后除去当前格子，再取剩下格子中最高的格子循环处理，直到当前最高的格子高度为1时结束循环，将新增的盒子数作为答案输出。\n\n分析后的问题转化为将格子从高到低排列，并优先取出最高的格子做处理，并且格子的高度排列是会随着处理过程发生变化，所以使用优先队列处理之！\n\n### Solve\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"container/heap\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\n\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tr := inputs[0]\n\tc := inputs[1]\n\tgrid := make([][]int, r)\n\tfor i := 0; i < r; i ++ {\n\t\tgrid[i] = readInts(in)\n\t}\n\n\tnodes := &nodes{}\n\tfor i := 0; i < r; i ++ {\n\t\tfor j := 0; j < c; j++ {\n\t\t\theap.Push(nodes, node{\n\t\t\t\tval: grid[i][j],\n\t\t\t\tx: j,\n\t\t\t\ty: i,\n\t\t\t})\n\t\t}\n\t}\n\tm := 0\n\tfor ;;{\n\t\tif nodes.Len() == 0{\n\t\t\tbreak\n\t\t}\n\t\tn := heap.Pop(nodes).(node)\n\t\tif n.val != grid[n.y][n.x] {\n\t\t\tcontinue\n\t\t}\n\t\tif n.x > 0 {\n\t\t\tif n.val - grid[n.y][n.x - 1] > 1{\n\t\t\t\tm += n.val - grid[n.y][n.x - 1] - 1\n\t\t\t\tgrid[n.y][n.x - 1] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y][n.x - 1],\n\t\t\t\t\tx: n.x - 1,\n\t\t\t\t\ty: n.y,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.x < c -1 {\n\t\t\tif n.val - grid[n.y][n.x + 1] > 1{\n\t\t\t\tm += n.val - grid[n.y][n.x + 1] - 1\n\t\t\t\tgrid[n.y][n.x + 1] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y][n.x + 1],\n\t\t\t\t\tx: n.x + 1,\n\t\t\t\t\ty: n.y,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.y > 0 {\n\t\t\tif n.val - grid[n.y - 1][n.x] > 1{\n\t\t\t\tm += n.val - grid[n.y - 1][n.x] - 1\n\t\t\t\tgrid[n.y - 1][n.x] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y - 1][n.x],\n\t\t\t\t\tx: n.x,\n\t\t\t\t\ty: n.y - 1,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.y < r - 1 {\n\t\t\tif n.val - grid[n.y + 1][n.x] > 1{\n\t\t\t\tm += n.val - grid[n.y + 1][n.x] - 1\n\t\t\t\tgrid[n.y + 1][n.x] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y + 1][n.x],\n\t\t\t\t\tx: n.x,\n\t\t\t\t\ty: n.y + 1,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\tres = append(res, m)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\ntype node struct {\n\tval int\n\tx int\n\ty int\n}\n\ntype nodes []node\n\nfunc (t *nodes) Len() int {\n\treturn len(*t) //\n}\n\nfunc (t *nodes) Less(i, j int) bool {\n\treturn (*t)[i].val >= (*t)[j].val\n}\n\nfunc (t *nodes) Swap(i, j int) {\n\t(*t)[i], (*t)[j] = (*t)[j], (*t)[i]\n}\n\nfunc (t *nodes) Push(x interface{}) {\n\t*t = append(*t, x.(node))\n}\n\nfunc (t *nodes) Pop() interface{} {\n\tn := len(*t)\n\tif n > 0 {\n\t\tx := (*t)[n-1]\n\t\t*t = (*t)[:n-1]\n\t\treturn x\n\t}\n\treturn -1\n}\n\nfunc (t *nodes) Peek() interface{} {\n\tn := len(*t)\n\tif n > 0 {\n\t\treturn (*t)[0]\n\t}\n\treturn -1\n}\n\n```","source":"_posts/Kick-Start-Round-A-2021-Rabbit-House.md","raw":"title: Kick Start Round A 2021 -  Rabbit House\nauthor: Nico\ntags:\n  - Kick Start\ncategories:\n  - Algorithm\ndate: 2021-03-22 12:33:00\n---\n原题地址: [传送门](https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cb14)\n\n### 分析\n对于英文弱鸡的笔者，这道题着实看了很久才看懂题意，同样在一个二维平面内存在着``R * C``的格子，且每个格子都会有``0≤ Gi,j ≤2*10^6``各盒子，例如：\n```\n0 0 0\n0 2 0\n0 0 0\n```\n上述表示R为3，C为3的格子，中间格子的盒子数量为2，其余格子盒子数量为0。\n\n描述到此为止，最终问题是求输入的R*C的格子中，如果要保证每个格子与相邻格子的盒子数量差在1以内，需要在当前规格的基础上，至少增加多少个盒子？\n\n因为最终要保证整个平面内，所有的格子高度差绝对值 <= 1，所以应该从最高的格子开始，让其相邻格子条件，之后除去当前格子，再取剩下格子中最高的格子循环处理，直到当前最高的格子高度为1时结束循环，将新增的盒子数作为答案输出。\n\n分析后的问题转化为将格子从高到低排列，并优先取出最高的格子做处理，并且格子的高度排列是会随着处理过程发生变化，所以使用优先队列处理之！\n\n### Solve\n```golang\npackage main\n\nimport (\n\t\"bufio\"\n\t\"container/heap\"\n\t\"fmt\"\n\t\"os\"\n\t\"strconv\"\n\t\"strings\"\n)\n\nvar res = make([]int, 0)\n\nvar in = bufio.NewReader(os.Stdin)\n\nfunc solve(){\n\tinputs := readInts(in)\n\tr := inputs[0]\n\tc := inputs[1]\n\tgrid := make([][]int, r)\n\tfor i := 0; i < r; i ++ {\n\t\tgrid[i] = readInts(in)\n\t}\n\n\tnodes := &nodes{}\n\tfor i := 0; i < r; i ++ {\n\t\tfor j := 0; j < c; j++ {\n\t\t\theap.Push(nodes, node{\n\t\t\t\tval: grid[i][j],\n\t\t\t\tx: j,\n\t\t\t\ty: i,\n\t\t\t})\n\t\t}\n\t}\n\tm := 0\n\tfor ;;{\n\t\tif nodes.Len() == 0{\n\t\t\tbreak\n\t\t}\n\t\tn := heap.Pop(nodes).(node)\n\t\tif n.val != grid[n.y][n.x] {\n\t\t\tcontinue\n\t\t}\n\t\tif n.x > 0 {\n\t\t\tif n.val - grid[n.y][n.x - 1] > 1{\n\t\t\t\tm += n.val - grid[n.y][n.x - 1] - 1\n\t\t\t\tgrid[n.y][n.x - 1] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y][n.x - 1],\n\t\t\t\t\tx: n.x - 1,\n\t\t\t\t\ty: n.y,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.x < c -1 {\n\t\t\tif n.val - grid[n.y][n.x + 1] > 1{\n\t\t\t\tm += n.val - grid[n.y][n.x + 1] - 1\n\t\t\t\tgrid[n.y][n.x + 1] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y][n.x + 1],\n\t\t\t\t\tx: n.x + 1,\n\t\t\t\t\ty: n.y,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.y > 0 {\n\t\t\tif n.val - grid[n.y - 1][n.x] > 1{\n\t\t\t\tm += n.val - grid[n.y - 1][n.x] - 1\n\t\t\t\tgrid[n.y - 1][n.x] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y - 1][n.x],\n\t\t\t\t\tx: n.x,\n\t\t\t\t\ty: n.y - 1,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tif n.y < r - 1 {\n\t\t\tif n.val - grid[n.y + 1][n.x] > 1{\n\t\t\t\tm += n.val - grid[n.y + 1][n.x] - 1\n\t\t\t\tgrid[n.y + 1][n.x] = n.val - 1\n\t\t\t\theap.Push(nodes, node{\n\t\t\t\t\tval: grid[n.y + 1][n.x],\n\t\t\t\t\tx: n.x,\n\t\t\t\t\ty: n.y + 1,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\tres = append(res, m)\n}\n\nfunc main()  {\n\tt := readInts(in)[0]\n\tfor i := 0; i < t; i ++ {\n\t\tsolve()\n\t}\n\tfor i, v := range res {\n\t\tfmt.Printf(\"Case #%d: %d\\n\", i + 1, v)\n\t}\n}\n\nfunc readline(in *bufio.Reader) string{\n\tline, _ := in.ReadString('\\n')\n\treturn line[0:len(line) - 1]\n}\n\nfunc readInts(in *bufio.Reader) []int{\n\tline := readline(in)\n\tarr := strings.Split(line, \" \")\n\tres := make([]int, 0)\n\tfor _, str := range arr {\n\t\tv, _ := strconv.ParseInt(str, 10, 64)\n\t\tres = append(res, int(v))\n\t}\n\treturn res\n}\n\ntype node struct {\n\tval int\n\tx int\n\ty int\n}\n\ntype nodes []node\n\nfunc (t *nodes) Len() int {\n\treturn len(*t) //\n}\n\nfunc (t *nodes) Less(i, j int) bool {\n\treturn (*t)[i].val >= (*t)[j].val\n}\n\nfunc (t *nodes) Swap(i, j int) {\n\t(*t)[i], (*t)[j] = (*t)[j], (*t)[i]\n}\n\nfunc (t *nodes) Push(x interface{}) {\n\t*t = append(*t, x.(node))\n}\n\nfunc (t *nodes) Pop() interface{} {\n\tn := len(*t)\n\tif n > 0 {\n\t\tx := (*t)[n-1]\n\t\t*t = (*t)[:n-1]\n\t\treturn x\n\t}\n\treturn -1\n}\n\nfunc (t *nodes) Peek() interface{} {\n\tn := len(*t)\n\tif n > 0 {\n\t\treturn (*t)[0]\n\t}\n\treturn -1\n}\n\n```","slug":"Kick-Start-Round-A-2021-Rabbit-House","published":1,"updated":"2021-03-22T04:54:04.807Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy20008b0tz5xarcjh7","content":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cb14\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>对于英文弱鸡的笔者，这道题着实看了很久才看懂题意，同样在一个二维平面内存在着<code>R * C</code>的格子，且每个格子都会有<code>0≤ Gi,j ≤2*10^6</code>各盒子，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0 0 0</span><br><span class=\"line\">0 2 0</span><br><span class=\"line\">0 0 0</span><br></pre></td></tr></table></figure>\n<p>上述表示R为3，C为3的格子，中间格子的盒子数量为2，其余格子盒子数量为0。</p>\n<p>描述到此为止，最终问题是求输入的R*C的格子中，如果要保证每个格子与相邻格子的盒子数量差在1以内，需要在当前规格的基础上，至少增加多少个盒子？</p>\n<p>因为最终要保证整个平面内，所有的格子高度差绝对值 &lt;= 1，所以应该从最高的格子开始，让其相邻格子条件，之后除去当前格子，再取剩下格子中最高的格子循环处理，直到当前最高的格子高度为1时结束循环，将新增的盒子数作为答案输出。</p>\n<p>分析后的问题转化为将格子从高到低排列，并优先取出最高的格子做处理，并且格子的高度排列是会随着处理过程发生变化，所以使用优先队列处理之！</p>\n<h3 id=\"solve\"><a class=\"header-anchor\" href=\"#solve\">¶</a>Solve</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;container/heap&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tr := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tc := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tgrid := <span class=\"built_in\">make</span>([][]<span class=\"type\">int</span>, r)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tgrid[i] = readInts(in)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tnodes := &amp;nodes&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; c; j++ &#123;</span><br><span class=\"line\">\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\tval: grid[i][j],</span><br><span class=\"line\">\t\t\t\tx: j,</span><br><span class=\"line\">\t\t\t\ty: i,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ;;&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> nodes.Len() == <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tn := heap.Pop(nodes).(node)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.val != grid[n.y][n.x] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.x &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y][n.x - <span class=\"number\">1</span>] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y][n.x - <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y][n.x - <span class=\"number\">1</span>] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y][n.x - <span class=\"number\">1</span>],</span><br><span class=\"line\">\t\t\t\t\tx: n.x - <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t\ty: n.y,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.x &lt; c <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y][n.x + <span class=\"number\">1</span>] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y][n.x + <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y][n.x + <span class=\"number\">1</span>] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y][n.x + <span class=\"number\">1</span>],</span><br><span class=\"line\">\t\t\t\t\tx: n.x + <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t\ty: n.y,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.y &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y - <span class=\"number\">1</span>][n.x] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y - <span class=\"number\">1</span>][n.x] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y - <span class=\"number\">1</span>][n.x] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y - <span class=\"number\">1</span>][n.x],</span><br><span class=\"line\">\t\t\t\t\tx: n.x,</span><br><span class=\"line\">\t\t\t\t\ty: n.y - <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.y &lt; r - <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y + <span class=\"number\">1</span>][n.x] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y + <span class=\"number\">1</span>][n.x] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y + <span class=\"number\">1</span>][n.x] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y + <span class=\"number\">1</span>][n.x],</span><br><span class=\"line\">\t\t\t\t\tx: n.x,</span><br><span class=\"line\">\t\t\t\t\ty: n.y + <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, m)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> node <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tval <span class=\"type\">int</span></span><br><span class=\"line\">\tx <span class=\"type\">int</span></span><br><span class=\"line\">\ty <span class=\"type\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> nodes []node</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Len() <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(*t) <span class=\"comment\">//</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Less(i, j <span class=\"type\">int</span>) <span class=\"type\">bool</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (*t)[i].val &gt;= (*t)[j].val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Swap(i, j <span class=\"type\">int</span>) &#123;</span><br><span class=\"line\">\t(*t)[i], (*t)[j] = (*t)[j], (*t)[i]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Push(x <span class=\"keyword\">interface</span>&#123;&#125;) &#123;</span><br><span class=\"line\">\t*t = <span class=\"built_in\">append</span>(*t, x.(node))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Pop() <span class=\"keyword\">interface</span>&#123;&#125; &#123;</span><br><span class=\"line\">\tn := <span class=\"built_in\">len</span>(*t)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> n &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tx := (*t)[n<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t*t = (*t)[:n<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> x</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Peek() <span class=\"keyword\">interface</span>&#123;&#125; &#123;</span><br><span class=\"line\">\tn := <span class=\"built_in\">len</span>(*t)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> n &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (*t)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cb14\">传送门</a></p>\n<h3 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h3>\n<p>对于英文弱鸡的笔者，这道题着实看了很久才看懂题意，同样在一个二维平面内存在着<code>R * C</code>的格子，且每个格子都会有<code>0≤ Gi,j ≤2*10^6</code>各盒子，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0 0 0</span><br><span class=\"line\">0 2 0</span><br><span class=\"line\">0 0 0</span><br></pre></td></tr></table></figure>\n<p>上述表示R为3，C为3的格子，中间格子的盒子数量为2，其余格子盒子数量为0。</p>\n<p>描述到此为止，最终问题是求输入的R*C的格子中，如果要保证每个格子与相邻格子的盒子数量差在1以内，需要在当前规格的基础上，至少增加多少个盒子？</p>\n<p>因为最终要保证整个平面内，所有的格子高度差绝对值 &lt;= 1，所以应该从最高的格子开始，让其相邻格子条件，之后除去当前格子，再取剩下格子中最高的格子循环处理，直到当前最高的格子高度为1时结束循环，将新增的盒子数作为答案输出。</p>\n<p>分析后的问题转化为将格子从高到低排列，并优先取出最高的格子做处理，并且格子的高度排列是会随着处理过程发生变化，所以使用优先队列处理之！</p>\n<h3 id=\"solve\"><a class=\"header-anchor\" href=\"#solve\">¶</a>Solve</h3>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;bufio&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;container/heap&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> res = <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinputs := readInts(in)</span><br><span class=\"line\">\tr := inputs[<span class=\"number\">0</span>]</span><br><span class=\"line\">\tc := inputs[<span class=\"number\">1</span>]</span><br><span class=\"line\">\tgrid := <span class=\"built_in\">make</span>([][]<span class=\"type\">int</span>, r)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\tgrid[i] = readInts(in)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tnodes := &amp;nodes&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; r; i ++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; c; j++ &#123;</span><br><span class=\"line\">\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\tval: grid[i][j],</span><br><span class=\"line\">\t\t\t\tx: j,</span><br><span class=\"line\">\t\t\t\ty: i,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ;;&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> nodes.Len() == <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tn := heap.Pop(nodes).(node)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.val != grid[n.y][n.x] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.x &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y][n.x - <span class=\"number\">1</span>] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y][n.x - <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y][n.x - <span class=\"number\">1</span>] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y][n.x - <span class=\"number\">1</span>],</span><br><span class=\"line\">\t\t\t\t\tx: n.x - <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t\ty: n.y,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.x &lt; c <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y][n.x + <span class=\"number\">1</span>] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y][n.x + <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y][n.x + <span class=\"number\">1</span>] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y][n.x + <span class=\"number\">1</span>],</span><br><span class=\"line\">\t\t\t\t\tx: n.x + <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t\ty: n.y,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.y &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y - <span class=\"number\">1</span>][n.x] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y - <span class=\"number\">1</span>][n.x] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y - <span class=\"number\">1</span>][n.x] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y - <span class=\"number\">1</span>][n.x],</span><br><span class=\"line\">\t\t\t\t\tx: n.x,</span><br><span class=\"line\">\t\t\t\t\ty: n.y - <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> n.y &lt; r - <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> n.val - grid[n.y + <span class=\"number\">1</span>][n.x] &gt; <span class=\"number\">1</span>&#123;</span><br><span class=\"line\">\t\t\t\tm += n.val - grid[n.y + <span class=\"number\">1</span>][n.x] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tgrid[n.y + <span class=\"number\">1</span>][n.x] = n.val - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\theap.Push(nodes, node&#123;</span><br><span class=\"line\">\t\t\t\t\tval: grid[n.y + <span class=\"number\">1</span>][n.x],</span><br><span class=\"line\">\t\t\t\t\tx: n.x,</span><br><span class=\"line\">\t\t\t\t\ty: n.y + <span class=\"number\">1</span>,</span><br><span class=\"line\">\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tres = <span class=\"built_in\">append</span>(res, m)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tt := readInts(in)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; t; i ++ &#123;</span><br><span class=\"line\">\t\tsolve()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> res &#123;</span><br><span class=\"line\">\t\tfmt.Printf(<span class=\"string\">&quot;Case #%d: %d\\n&quot;</span>, i + <span class=\"number\">1</span>, v)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readline</span><span class=\"params\">(in *bufio.Reader)</span></span> <span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\tline, _ := in.ReadString(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> line[<span class=\"number\">0</span>:<span class=\"built_in\">len</span>(line) - <span class=\"number\">1</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readInts</span><span class=\"params\">(in *bufio.Reader)</span></span> []<span class=\"type\">int</span>&#123;</span><br><span class=\"line\">\tline := readline(in)</span><br><span class=\"line\">\tarr := strings.Split(line, <span class=\"string\">&quot; &quot;</span>)</span><br><span class=\"line\">\tres := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, str := <span class=\"keyword\">range</span> arr &#123;</span><br><span class=\"line\">\t\tv, _ := strconv.ParseInt(str, <span class=\"number\">10</span>, <span class=\"number\">64</span>)</span><br><span class=\"line\">\t\tres = <span class=\"built_in\">append</span>(res, <span class=\"type\">int</span>(v))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> node <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tval <span class=\"type\">int</span></span><br><span class=\"line\">\tx <span class=\"type\">int</span></span><br><span class=\"line\">\ty <span class=\"type\">int</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> nodes []node</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Len() <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(*t) <span class=\"comment\">//</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Less(i, j <span class=\"type\">int</span>) <span class=\"type\">bool</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (*t)[i].val &gt;= (*t)[j].val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Swap(i, j <span class=\"type\">int</span>) &#123;</span><br><span class=\"line\">\t(*t)[i], (*t)[j] = (*t)[j], (*t)[i]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Push(x <span class=\"keyword\">interface</span>&#123;&#125;) &#123;</span><br><span class=\"line\">\t*t = <span class=\"built_in\">append</span>(*t, x.(node))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Pop() <span class=\"keyword\">interface</span>&#123;&#125; &#123;</span><br><span class=\"line\">\tn := <span class=\"built_in\">len</span>(*t)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> n &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tx := (*t)[n<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t*t = (*t)[:n<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> x</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(t *nodes)</span></span> Peek() <span class=\"keyword\">interface</span>&#123;&#125; &#123;</span><br><span class=\"line\">\tn := <span class=\"built_in\">len</span>(*t)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> n &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (*t)[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"Linux平台Nginx的安装及使用","author":"Nico","date":"2018-11-06T04:49:00.000Z","_content":"这几天因为需要部署静态资源服务器，所以就找了个vps部署一下Nginx，顺带将vsftpd配置好了，下面就给大家讲一下如何在CentOS上部署Nginx及vsftpd！\n\n如果大家不知道Nginx和vsftpd的用处，请自行百度，这里就不过多介绍，废话少说，进入正题。\n\n## 一、在CentOS上下载Nginx和vsftpd\n\n常用的Nginx下载方式有两种，一种是使用CentOS上自带的yum下载，第二种是从网上下载后在通过make进行编译安装，下面我将会向大家介绍一下这两种安装方式\n\n### 1、yum安装方式\n\n首先我们更新一下yum软件库\n\n```\nyum update\n\n```\n\n然后我们搜索一下yum库关于nginx的rpm包\n\n```\nyum list | grep nginx\n\n```\n\n可以看到下面的列表\n\n```\n[root@VM_239_130_centos html]# yum list | grep nginx\nnginx-filesystem.noarch                     1.10.2-1.el6                 @epel  \ncollectd-nginx.x86_64                       4.10.9-4.el6                 epel   \nmunin-nginx.noarch                          2.0.33-1.el6                 epel   \nnginx.x86_64                                1.10.2-1.el6                 epel   \nnginx-all-modules.noarch                    1.10.2-1.el6                 epel   \nnginx-mod-http-geoip.x86_64                 1.10.2-1.el6                 epel   \nnginx-mod-http-image-filter.x86_64          1.10.2-1.el6                 epel   \nnginx-mod-http-perl.x86_64                  1.10.2-1.el6                 epel   \nnginx-mod-http-xslt-filter.x86_64           1.10.2-1.el6                 epel   \nnginx-mod-mail.x86_64                       1.10.2-1.el6                 epel   \nnginx-mod-stream.x86_64                     1.10.2-1.el6                 epel   \npcp-pmda-nginx.x86_64                       3.10.9-9.el6                 os\n\n```\n\n接下来我们选择使用yum安装`nginx.x86_64 1.10.2-1.el6 epel`\n\n```\nyum install nginx\n\n```\n\n中间会提示我们一次是否确认安装\n\n```\n=======================================================================================================================\n Package                                   Arch                 Version                       Repository          Size\n=======================================================================================================================\nInstalling:\n nginx                                     x86_64               1.10.2-1.el6                  epel               462 k\nInstalling for dependencies:\n nginx-all-modules                         noarch               1.10.2-1.el6                  epel               7.7 k\n nginx-mod-http-geoip                      x86_64               1.10.2-1.el6                  epel                14 k\n nginx-mod-http-image-filter               x86_64               1.10.2-1.el6                  epel                16 k\n nginx-mod-http-perl                       x86_64               1.10.2-1.el6                  epel                26 k\n nginx-mod-http-xslt-filter                x86_64               1.10.2-1.el6                  epel                16 k\n nginx-mod-mail                            x86_64               1.10.2-1.el6                  epel                43 k\n nginx-mod-stream                          x86_64               1.10.2-1.el6                  epel                36 k\n\nTransaction Summary\n=======================================================================================================================\nInstall       8 Package(s)\n\nTotal download size: 620 k\nInstalled size: 1.6 M\nIs this ok [y/N]:\n\n```\n\n输入`y`继续\n\n```\nInstalled:\n  nginx.x86_64 0:1.10.2-1.el6                                                                                          \n\nDependency Installed:\n  nginx-all-modules.noarch 0:1.10.2-1.el6                       nginx-mod-http-geoip.x86_64 0:1.10.2-1.el6            \n  nginx-mod-http-image-filter.x86_64 0:1.10.2-1.el6             nginx-mod-http-perl.x86_64 0:1.10.2-1.el6             \n  nginx-mod-http-xslt-filter.x86_64 0:1.10.2-1.el6              nginx-mod-mail.x86_64 0:1.10.2-1.el6                  \n  nginx-mod-stream.x86_64 0:1.10.2-1.el6                       \n\nComplete!\n\n```\n\n安装完毕！！接下来我们来看一下nginx的文件分布\n\n```\nwhereis nginx\n\n```\n\n```\n[root@VM_239_130_centos html]# whereis nginx\nnginx: /usr/sbin/nginx /etc/nginx /usr/lib64/nginx /usr/local/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz\n\n```\n\n其中三个文件（夹）比较重要：\n\n| 路径 | 作用 |\n| --- | --- |\n| /usr/sbin/nginx | nginx启动路径 |\n| /etc/nginx | 存放nginx的配置文件 |\n| /usr/share/nginx | 默认的nginx资源库 |\n\n我们首先进入`/etc/nginx/`中看一下nginx到底有哪些配置文件\n\n```\n[root@VM_239_130_centos html]# cd /etc/nginx\n[root@VM_239_130_centos nginx]# ls\nconf.d        fastcgi.conf.default    koi-utf     mime.types.default  scgi_params          uwsgi_params.default\ndefault.d     fastcgi_params          koi-win     nginx.conf          scgi_params.default  win-utf\nfastcgi.conf  fastcgi_params.default  mime.types  nginx.conf.default  uwsgi_params\n\n```\n\n哇，看到这么多配置文件是不是吓了一跳，其实我们只需要在意nginx.conf就行了，其他的涉及到了再百度，接下来我们进入nginx.conf(这里我们使用vim，系统没有vim的小伙伴可以使用`yum install vim`进行下载安装)\n\n```\nvim nginx.conf\n\n```\n\n```\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '  #日志格式\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;                                                  #操作成功记录日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n}\n\n```\n\n上面的配置不要动，我们跟踪到这一行`include /etc/nginx/conf.d/*.conf`主要作用就是加载更多的配置文件，我们退出vim编辑`ESC+:q`进入到conf.d文件夹来看一下\n\n```\n[root@VM_239_130_centos nginx]# cd /etc/nginx/conf.d\n[root@VM_239_130_centos conf.d]# ls\ndefault.conf  default.conf.rpmsave  ssl.conf  virtual.conf\n\n```\n\n然后进入default.conf\n\n```\nvim default.conf\n\n```\n\n```\n#\n# The default server\n#\n\nserver {\n    listen       80 default_server;\n    listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n}\n\n```\n\n我们发现这个文件配置的是server{}，server的配置就是我们nginx的核心配置，这里先不过多的讲，下面会详细介绍server的配置，但是此时如果我们运行nginx的话将会报错\n\n```\n Address family not supported by protocol\n\n```\n\n我们需要将上面的\n\n```\n listen       [::]:80 default_server;\n\n```\n\n注释掉\n\n```\n   # listen       [::]:80 default_server;\n\n```\n\n退出vim编辑，使用`/usr/sbin/nginx`启动nginx\n\n```\n[root@VM_239_130_centos conf.d]# /usr/sbin/nginx\n\n```\n\n关闭nginx\n\n```\npkill -9 nginx\n\n```\n\n### 2、编译安装\n\n这里借鉴了腾讯云论坛上的一个帖子： [CentOS 7中Nginx1.9.5编译安装教程systemctl启动](http://bbs.qcloud.com/thread-10429-1-1.html)\n\n<font color=\"#555555\">先安装gcc 等</font>\n\n```\nyum -y install gcc gcc-c++ wget\n\n```\n\n<font>.然后装一些库</font>\n\n```\nyum -y install gcc wget automake autoconf libtool libxml2-devel libxslt-devel perl-devel perl-ExtUtils-Embed pcre-devel openssl-devel\n\n```\n\n<font color=\"#555555\">进入默认的软件目录</font>\n\n```\ncd /usr/local/src/\n\n```\n\n<font color=\"#555555\">下载 nginx软件</font>\n\n```\nwget http://nginx.org/download/nginx-1.9.5.tar.gz\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">如果这个下载太慢可以在这里下载</span><font>[http://nginx.org/download/nginx-1.9.5.tar.gz](http://nginx.org/download/nginx-1.9.5.tar.gz) 下载完后yum -y intall lrzsz 装好上传工具</font>\n\n<font>然后用rz上传到服务器</font> <font color=\"#555555\">然后解压文件.</font>\n\n```\ntar zxvf nginx-1.9.5.tar.gz\n\n```\n\n<font color=\"#555555\">进入 nginx1.9.5的源码 如果想改版本号 可以进入源码目录</font><font color=\"#555555\">src/core/nginx.h</font><font color=\"#555555\">更改</font>\n\n```\ncd nginx-1.9.5/\n\n```\n\n<font color=\"#555555\">创建一个nginx目录用来存放运行的临时文件夹</font>\n\n```\nmkdir -p /var/cache/nginx\n\n```\n\n<font color=\"#555555\">开始configure</font>\n\n```\n./configure \\\n--prefix=/usr/local/nginx \\\n--sbin-path=/usr/sbin/nginx \\\n--conf-path=/etc/nginx/nginx.conf \\\n--error-log-path=/var/log/nginx/error.log \\\n--http-log-path=/var/log/nginx/access.log \\\n--pid-path=/var/run/nginx.pid \\\n--lock-path=/var/run/nginx.lock \\\n--http-client-body-temp-path=/var/cache/nginx/client_temp \\\n--http-proxy-temp-path=/var/cache/nginx/proxy_temp \\\n--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \\\n--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \\\n--http-scgi-temp-path=/var/cache/nginx/scgi_temp \\\n--user=nobody \\\n--group=nobody \\\n--with-pcre \\\n--with-http_v2_module \\\n--with-http_ssl_module \\\n--with-http_realip_module \\\n--with-http_addition_module \\\n--with-http_sub_module \\\n--with-http_dav_module \\\n--with-http_flv_module \\\n--with-http_mp4_module \\\n--with-http_gunzip_module \\\n--with-http_gzip_static_module \\\n--with-http_random_index_module \\\n--with-http_secure_link_module \\\n--with-http_stub_status_module \\\n--with-http_auth_request_module \\\n--with-mail \\\n--with-mail_ssl_module \\\n--with-file-aio \\\n--with-ipv6 \\\n--with-http_v2_module \\\n--with-threads \\\n--with-stream \\\n--with-stream_ssl_module\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">接着 编译</span>\n\n```\nmake\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">安装</span>\n\n```\nmake install\n\n```\n\n<font color=\"#555555\">启动nginx</font>\n\n```\n/usr/sbin/nginx\n\n```\n\n<font color=\"#555555\">用ps aux来查看nginx是否启动</font>\n\n```\nps aux|grep nginx\n\n```\n\n<span style=\"font-size: 12px;\">复制代码</span>\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">然后配置服务</span>\n\n```\nvim /usr/lib/systemd/system/nginx.service\n\n```\n\n<font color=\"#555555\">按i输入以下内容</font>\n\n```\n[Unit]\nDescription=nginx - high performance web server \nDocumentation=http://nginx.org/en/docs/\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/var/run/nginx.pid\nExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf\nExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf\nExecReload=/bin/kill -s HUP $MAINPID\nExecStop=/bin/kill -s QUIT $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n\n```\n\n<font color=\"#555555\">编辑好后保存</font><font color=\"#555555\">然后开启开机启动</font>\n\n```\nsystemctl enable nginx.service\n\n```\n\n<font color=\"#555555\">用命令关掉nginx</font>\n\n```\npkill -9 nginx\n\n```\n\n<font color=\"#555555\">后面可以用systemctl来操作nginx.service</font>\n\n```\nsystemctl start nginx.service\n\n```\n\n这里值得一提的是nginx编译安装后的文件夹和yum安装的文件夹类似，nginx.conf文件都在/etc/nginx下，不过编译安装后的nginx.conf文件内部配置与yum安装略有差异\n\n编译安装后的nginx.conf内部直接配置server，所以编译安装的小伙伴配置server就不用去改/etc/nginx/conf.d下的default.conf文件配置了，直接到nginx.conf文件中改server配置就行了\n\n## 二、Nginx配置详解\n\n1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。\n\n2、events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。\n\n3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。\n\n4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。\n\n5、location块：配置请求的路由，以及各种页面的处理情况。\n\n我们来到yum安装后的`/etc/nginx/conf.d/default.conf`文件中\n\n```\nserver {\n    listen       80 default_server;\n   # listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n```\n\n在server块中\n\n| 名称 | 作用 |\n| --- | --- |\n| listen | nginx监听端口 |\n| root | nginx资源路径根目录 |\n| location | url访问的本地资源路径配置(支持通配符) |\n|  |\n| error_page | 跳转报错页面 |\n\n其中nginx会在资源目录中去找默认的index.html页面，我们进入/usr/share/nginx/html中看一下\n\n```\n[root@VM_239_130_centos conf.d]# cd /usr/share/nginx/html\n\n[root@VM_239_130_centos html]# ls\n\n404.html  50x.html  index.html  nginx-logo.png  poweredby.png\n\n```\n\n我们在这个文件夹中创建一个test.html\n\n```\n[root@VM_239_130_centos html]# touch test.html\n\n[root@VM_239_130_centos html]# ls\n\n404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png test.html  world\n\n```\n\nhtml页面内容\n\n```\n<html>\n        <head>\n                <title>test</title>\n        </head>\n        <body>  \n                <h1>hello world</h1>\n        </body>\n</html>\n\n```\n\n然后我们在浏览器上去访问test.html\n\n成功~\n\n然后我们修改一下default.conf的配置，增加一个location\n\n```\n[root@VM_239_130_centos html]# vim /etc/nginx/conf.d/default.conf\n\n```\n\n```\n#\n# The default server\n#\n\nserver {\n    listen       80 default_server;\n   # listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n\n    }\n\n    location /test{\n        #root /;\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n}\n\n```\n\n保存退出然后关闭nginx后重新运行\n\n```\n[root@VM_239_130_centos html]# pkill -9 nginx\n[root@VM_239_130_centos html]# /usr/sbin/nginx\n\n```\n\n然后我们访问test/test.html\n\n![Clipboard Image.png](http://nginx.ikuvn.com/images/261498318719617.jpg)\n\n不料却报错了，找不到网页，这是因为我们新添加了一个location资源路径的配置，他会自动找到root，然后在去找root下面是否有test这个文件夹，有的话就去test文件夹中去找我们访问的test.html，可想而知，我们并没有建立test文件夹\n\n回到 /usr/share/nginx/html，然后建立test文件夹，将test.html移动到test文件夹中\n\n```\n[root@VM_239_130_centos html]# mkdir test\n[root@VM_239_130_centos html]# mv test.html test/test.html\n[root@VM_239_130_centos html]# ls\n404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png  test  world\n[root@VM_239_130_centos html]# cd test\n[root@VM_239_130_centos test]# ls\ntest.html\n\n```\n\n\n这里要注意一下，我增加的location配置是这样的\n\n```\nlocation /test{\n        #root /;\n    }\n```\n\n如果这个root配置不注释的话将会覆盖server块下的root路径哦，到这里nginx基本配置应该就写完了，大家可以去亲自试一试~","source":"_posts/Linux平台Nginx的安装及使用.md","raw":"title: Linux平台Nginx的安装及使用\nauthor: Nico\ntags: []\ncategories: []\ndate: 2018-11-06 12:49:00\n---\n这几天因为需要部署静态资源服务器，所以就找了个vps部署一下Nginx，顺带将vsftpd配置好了，下面就给大家讲一下如何在CentOS上部署Nginx及vsftpd！\n\n如果大家不知道Nginx和vsftpd的用处，请自行百度，这里就不过多介绍，废话少说，进入正题。\n\n## 一、在CentOS上下载Nginx和vsftpd\n\n常用的Nginx下载方式有两种，一种是使用CentOS上自带的yum下载，第二种是从网上下载后在通过make进行编译安装，下面我将会向大家介绍一下这两种安装方式\n\n### 1、yum安装方式\n\n首先我们更新一下yum软件库\n\n```\nyum update\n\n```\n\n然后我们搜索一下yum库关于nginx的rpm包\n\n```\nyum list | grep nginx\n\n```\n\n可以看到下面的列表\n\n```\n[root@VM_239_130_centos html]# yum list | grep nginx\nnginx-filesystem.noarch                     1.10.2-1.el6                 @epel  \ncollectd-nginx.x86_64                       4.10.9-4.el6                 epel   \nmunin-nginx.noarch                          2.0.33-1.el6                 epel   \nnginx.x86_64                                1.10.2-1.el6                 epel   \nnginx-all-modules.noarch                    1.10.2-1.el6                 epel   \nnginx-mod-http-geoip.x86_64                 1.10.2-1.el6                 epel   \nnginx-mod-http-image-filter.x86_64          1.10.2-1.el6                 epel   \nnginx-mod-http-perl.x86_64                  1.10.2-1.el6                 epel   \nnginx-mod-http-xslt-filter.x86_64           1.10.2-1.el6                 epel   \nnginx-mod-mail.x86_64                       1.10.2-1.el6                 epel   \nnginx-mod-stream.x86_64                     1.10.2-1.el6                 epel   \npcp-pmda-nginx.x86_64                       3.10.9-9.el6                 os\n\n```\n\n接下来我们选择使用yum安装`nginx.x86_64 1.10.2-1.el6 epel`\n\n```\nyum install nginx\n\n```\n\n中间会提示我们一次是否确认安装\n\n```\n=======================================================================================================================\n Package                                   Arch                 Version                       Repository          Size\n=======================================================================================================================\nInstalling:\n nginx                                     x86_64               1.10.2-1.el6                  epel               462 k\nInstalling for dependencies:\n nginx-all-modules                         noarch               1.10.2-1.el6                  epel               7.7 k\n nginx-mod-http-geoip                      x86_64               1.10.2-1.el6                  epel                14 k\n nginx-mod-http-image-filter               x86_64               1.10.2-1.el6                  epel                16 k\n nginx-mod-http-perl                       x86_64               1.10.2-1.el6                  epel                26 k\n nginx-mod-http-xslt-filter                x86_64               1.10.2-1.el6                  epel                16 k\n nginx-mod-mail                            x86_64               1.10.2-1.el6                  epel                43 k\n nginx-mod-stream                          x86_64               1.10.2-1.el6                  epel                36 k\n\nTransaction Summary\n=======================================================================================================================\nInstall       8 Package(s)\n\nTotal download size: 620 k\nInstalled size: 1.6 M\nIs this ok [y/N]:\n\n```\n\n输入`y`继续\n\n```\nInstalled:\n  nginx.x86_64 0:1.10.2-1.el6                                                                                          \n\nDependency Installed:\n  nginx-all-modules.noarch 0:1.10.2-1.el6                       nginx-mod-http-geoip.x86_64 0:1.10.2-1.el6            \n  nginx-mod-http-image-filter.x86_64 0:1.10.2-1.el6             nginx-mod-http-perl.x86_64 0:1.10.2-1.el6             \n  nginx-mod-http-xslt-filter.x86_64 0:1.10.2-1.el6              nginx-mod-mail.x86_64 0:1.10.2-1.el6                  \n  nginx-mod-stream.x86_64 0:1.10.2-1.el6                       \n\nComplete!\n\n```\n\n安装完毕！！接下来我们来看一下nginx的文件分布\n\n```\nwhereis nginx\n\n```\n\n```\n[root@VM_239_130_centos html]# whereis nginx\nnginx: /usr/sbin/nginx /etc/nginx /usr/lib64/nginx /usr/local/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz\n\n```\n\n其中三个文件（夹）比较重要：\n\n| 路径 | 作用 |\n| --- | --- |\n| /usr/sbin/nginx | nginx启动路径 |\n| /etc/nginx | 存放nginx的配置文件 |\n| /usr/share/nginx | 默认的nginx资源库 |\n\n我们首先进入`/etc/nginx/`中看一下nginx到底有哪些配置文件\n\n```\n[root@VM_239_130_centos html]# cd /etc/nginx\n[root@VM_239_130_centos nginx]# ls\nconf.d        fastcgi.conf.default    koi-utf     mime.types.default  scgi_params          uwsgi_params.default\ndefault.d     fastcgi_params          koi-win     nginx.conf          scgi_params.default  win-utf\nfastcgi.conf  fastcgi_params.default  mime.types  nginx.conf.default  uwsgi_params\n\n```\n\n哇，看到这么多配置文件是不是吓了一跳，其实我们只需要在意nginx.conf就行了，其他的涉及到了再百度，接下来我们进入nginx.conf(这里我们使用vim，系统没有vim的小伙伴可以使用`yum install vim`进行下载安装)\n\n```\nvim nginx.conf\n\n```\n\n```\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '  #日志格式\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;                                                  #操作成功记录日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n}\n\n```\n\n上面的配置不要动，我们跟踪到这一行`include /etc/nginx/conf.d/*.conf`主要作用就是加载更多的配置文件，我们退出vim编辑`ESC+:q`进入到conf.d文件夹来看一下\n\n```\n[root@VM_239_130_centos nginx]# cd /etc/nginx/conf.d\n[root@VM_239_130_centos conf.d]# ls\ndefault.conf  default.conf.rpmsave  ssl.conf  virtual.conf\n\n```\n\n然后进入default.conf\n\n```\nvim default.conf\n\n```\n\n```\n#\n# The default server\n#\n\nserver {\n    listen       80 default_server;\n    listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n}\n\n```\n\n我们发现这个文件配置的是server{}，server的配置就是我们nginx的核心配置，这里先不过多的讲，下面会详细介绍server的配置，但是此时如果我们运行nginx的话将会报错\n\n```\n Address family not supported by protocol\n\n```\n\n我们需要将上面的\n\n```\n listen       [::]:80 default_server;\n\n```\n\n注释掉\n\n```\n   # listen       [::]:80 default_server;\n\n```\n\n退出vim编辑，使用`/usr/sbin/nginx`启动nginx\n\n```\n[root@VM_239_130_centos conf.d]# /usr/sbin/nginx\n\n```\n\n关闭nginx\n\n```\npkill -9 nginx\n\n```\n\n### 2、编译安装\n\n这里借鉴了腾讯云论坛上的一个帖子： [CentOS 7中Nginx1.9.5编译安装教程systemctl启动](http://bbs.qcloud.com/thread-10429-1-1.html)\n\n<font color=\"#555555\">先安装gcc 等</font>\n\n```\nyum -y install gcc gcc-c++ wget\n\n```\n\n<font>.然后装一些库</font>\n\n```\nyum -y install gcc wget automake autoconf libtool libxml2-devel libxslt-devel perl-devel perl-ExtUtils-Embed pcre-devel openssl-devel\n\n```\n\n<font color=\"#555555\">进入默认的软件目录</font>\n\n```\ncd /usr/local/src/\n\n```\n\n<font color=\"#555555\">下载 nginx软件</font>\n\n```\nwget http://nginx.org/download/nginx-1.9.5.tar.gz\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">如果这个下载太慢可以在这里下载</span><font>[http://nginx.org/download/nginx-1.9.5.tar.gz](http://nginx.org/download/nginx-1.9.5.tar.gz) 下载完后yum -y intall lrzsz 装好上传工具</font>\n\n<font>然后用rz上传到服务器</font> <font color=\"#555555\">然后解压文件.</font>\n\n```\ntar zxvf nginx-1.9.5.tar.gz\n\n```\n\n<font color=\"#555555\">进入 nginx1.9.5的源码 如果想改版本号 可以进入源码目录</font><font color=\"#555555\">src/core/nginx.h</font><font color=\"#555555\">更改</font>\n\n```\ncd nginx-1.9.5/\n\n```\n\n<font color=\"#555555\">创建一个nginx目录用来存放运行的临时文件夹</font>\n\n```\nmkdir -p /var/cache/nginx\n\n```\n\n<font color=\"#555555\">开始configure</font>\n\n```\n./configure \\\n--prefix=/usr/local/nginx \\\n--sbin-path=/usr/sbin/nginx \\\n--conf-path=/etc/nginx/nginx.conf \\\n--error-log-path=/var/log/nginx/error.log \\\n--http-log-path=/var/log/nginx/access.log \\\n--pid-path=/var/run/nginx.pid \\\n--lock-path=/var/run/nginx.lock \\\n--http-client-body-temp-path=/var/cache/nginx/client_temp \\\n--http-proxy-temp-path=/var/cache/nginx/proxy_temp \\\n--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \\\n--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \\\n--http-scgi-temp-path=/var/cache/nginx/scgi_temp \\\n--user=nobody \\\n--group=nobody \\\n--with-pcre \\\n--with-http_v2_module \\\n--with-http_ssl_module \\\n--with-http_realip_module \\\n--with-http_addition_module \\\n--with-http_sub_module \\\n--with-http_dav_module \\\n--with-http_flv_module \\\n--with-http_mp4_module \\\n--with-http_gunzip_module \\\n--with-http_gzip_static_module \\\n--with-http_random_index_module \\\n--with-http_secure_link_module \\\n--with-http_stub_status_module \\\n--with-http_auth_request_module \\\n--with-mail \\\n--with-mail_ssl_module \\\n--with-file-aio \\\n--with-ipv6 \\\n--with-http_v2_module \\\n--with-threads \\\n--with-stream \\\n--with-stream_ssl_module\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">接着 编译</span>\n\n```\nmake\n\n```\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">安装</span>\n\n```\nmake install\n\n```\n\n<font color=\"#555555\">启动nginx</font>\n\n```\n/usr/sbin/nginx\n\n```\n\n<font color=\"#555555\">用ps aux来查看nginx是否启动</font>\n\n```\nps aux|grep nginx\n\n```\n\n<span style=\"font-size: 12px;\">复制代码</span>\n\n<span style=\"color: rgb(68, 68, 68); font-size: 14px;\">然后配置服务</span>\n\n```\nvim /usr/lib/systemd/system/nginx.service\n\n```\n\n<font color=\"#555555\">按i输入以下内容</font>\n\n```\n[Unit]\nDescription=nginx - high performance web server \nDocumentation=http://nginx.org/en/docs/\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/var/run/nginx.pid\nExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf\nExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf\nExecReload=/bin/kill -s HUP $MAINPID\nExecStop=/bin/kill -s QUIT $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n\n```\n\n<font color=\"#555555\">编辑好后保存</font><font color=\"#555555\">然后开启开机启动</font>\n\n```\nsystemctl enable nginx.service\n\n```\n\n<font color=\"#555555\">用命令关掉nginx</font>\n\n```\npkill -9 nginx\n\n```\n\n<font color=\"#555555\">后面可以用systemctl来操作nginx.service</font>\n\n```\nsystemctl start nginx.service\n\n```\n\n这里值得一提的是nginx编译安装后的文件夹和yum安装的文件夹类似，nginx.conf文件都在/etc/nginx下，不过编译安装后的nginx.conf文件内部配置与yum安装略有差异\n\n编译安装后的nginx.conf内部直接配置server，所以编译安装的小伙伴配置server就不用去改/etc/nginx/conf.d下的default.conf文件配置了，直接到nginx.conf文件中改server配置就行了\n\n## 二、Nginx配置详解\n\n1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。\n\n2、events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。\n\n3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。\n\n4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。\n\n5、location块：配置请求的路由，以及各种页面的处理情况。\n\n我们来到yum安装后的`/etc/nginx/conf.d/default.conf`文件中\n\n```\nserver {\n    listen       80 default_server;\n   # listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n```\n\n在server块中\n\n| 名称 | 作用 |\n| --- | --- |\n| listen | nginx监听端口 |\n| root | nginx资源路径根目录 |\n| location | url访问的本地资源路径配置(支持通配符) |\n|  |\n| error_page | 跳转报错页面 |\n\n其中nginx会在资源目录中去找默认的index.html页面，我们进入/usr/share/nginx/html中看一下\n\n```\n[root@VM_239_130_centos conf.d]# cd /usr/share/nginx/html\n\n[root@VM_239_130_centos html]# ls\n\n404.html  50x.html  index.html  nginx-logo.png  poweredby.png\n\n```\n\n我们在这个文件夹中创建一个test.html\n\n```\n[root@VM_239_130_centos html]# touch test.html\n\n[root@VM_239_130_centos html]# ls\n\n404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png test.html  world\n\n```\n\nhtml页面内容\n\n```\n<html>\n        <head>\n                <title>test</title>\n        </head>\n        <body>  \n                <h1>hello world</h1>\n        </body>\n</html>\n\n```\n\n然后我们在浏览器上去访问test.html\n\n成功~\n\n然后我们修改一下default.conf的配置，增加一个location\n\n```\n[root@VM_239_130_centos html]# vim /etc/nginx/conf.d/default.conf\n\n```\n\n```\n#\n# The default server\n#\n\nserver {\n    listen       80 default_server;\n   # listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    location / {\n\n    }\n\n    location /test{\n        #root /;\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n\n}\n\n```\n\n保存退出然后关闭nginx后重新运行\n\n```\n[root@VM_239_130_centos html]# pkill -9 nginx\n[root@VM_239_130_centos html]# /usr/sbin/nginx\n\n```\n\n然后我们访问test/test.html\n\n![Clipboard Image.png](http://nginx.ikuvn.com/images/261498318719617.jpg)\n\n不料却报错了，找不到网页，这是因为我们新添加了一个location资源路径的配置，他会自动找到root，然后在去找root下面是否有test这个文件夹，有的话就去test文件夹中去找我们访问的test.html，可想而知，我们并没有建立test文件夹\n\n回到 /usr/share/nginx/html，然后建立test文件夹，将test.html移动到test文件夹中\n\n```\n[root@VM_239_130_centos html]# mkdir test\n[root@VM_239_130_centos html]# mv test.html test/test.html\n[root@VM_239_130_centos html]# ls\n404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png  test  world\n[root@VM_239_130_centos html]# cd test\n[root@VM_239_130_centos test]# ls\ntest.html\n\n```\n\n\n这里要注意一下，我增加的location配置是这样的\n\n```\nlocation /test{\n        #root /;\n    }\n```\n\n如果这个root配置不注释的话将会覆盖server块下的root路径哦，到这里nginx基本配置应该就写完了，大家可以去亲自试一试~","slug":"Linux平台Nginx的安装及使用","published":1,"updated":"2021-03-21T17:43:05.066Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy5000cb0tzbay869la","content":"<p>这几天因为需要部署静态资源服务器，所以就找了个vps部署一下Nginx，顺带将vsftpd配置好了，下面就给大家讲一下如何在CentOS上部署Nginx及vsftpd！</p>\n<p>如果大家不知道Nginx和vsftpd的用处，请自行百度，这里就不过多介绍，废话少说，进入正题。</p>\n<h2 id=\"一-在centos上下载nginx和vsftpd\"><a class=\"header-anchor\" href=\"#一-在centos上下载nginx和vsftpd\">¶</a>一、在CentOS上下载Nginx和vsftpd</h2>\n<p>常用的Nginx下载方式有两种，一种是使用CentOS上自带的yum下载，第二种是从网上下载后在通过make进行编译安装，下面我将会向大家介绍一下这两种安装方式</p>\n<h3 id=\"1-yum安装方式\"><a class=\"header-anchor\" href=\"#1-yum安装方式\">¶</a>1、yum安装方式</h3>\n<p>首先我们更新一下yum软件库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum update</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们搜索一下yum库关于nginx的rpm包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list | grep nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到下面的列表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# yum list | grep nginx</span><br><span class=\"line\">nginx-filesystem.noarch                     1.10.2-1.el6                 @epel  </span><br><span class=\"line\">collectd-nginx.x86_64                       4.10.9-4.el6                 epel   </span><br><span class=\"line\">munin-nginx.noarch                          2.0.33-1.el6                 epel   </span><br><span class=\"line\">nginx.x86_64                                1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-all-modules.noarch                    1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-geoip.x86_64                 1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-image-filter.x86_64          1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-perl.x86_64                  1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-xslt-filter.x86_64           1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-mail.x86_64                       1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-stream.x86_64                     1.10.2-1.el6                 epel   </span><br><span class=\"line\">pcp-pmda-nginx.x86_64                       3.10.9-9.el6                 os</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>接下来我们选择使用yum安装<code>nginx.x86_64 1.10.2-1.el6 epel</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>中间会提示我们一次是否确认安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\"> Package                                   Arch                 Version                       Repository          Size</span><br><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\">Installing:</span><br><span class=\"line\"> nginx                                     x86_64               1.10.2-1.el6                  epel               462 k</span><br><span class=\"line\">Installing for dependencies:</span><br><span class=\"line\"> nginx-all-modules                         noarch               1.10.2-1.el6                  epel               7.7 k</span><br><span class=\"line\"> nginx-mod-http-geoip                      x86_64               1.10.2-1.el6                  epel                14 k</span><br><span class=\"line\"> nginx-mod-http-image-filter               x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class=\"line\"> nginx-mod-http-perl                       x86_64               1.10.2-1.el6                  epel                26 k</span><br><span class=\"line\"> nginx-mod-http-xslt-filter                x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class=\"line\"> nginx-mod-mail                            x86_64               1.10.2-1.el6                  epel                43 k</span><br><span class=\"line\"> nginx-mod-stream                          x86_64               1.10.2-1.el6                  epel                36 k</span><br><span class=\"line\"></span><br><span class=\"line\">Transaction Summary</span><br><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\">Install       8 Package(s)</span><br><span class=\"line\"></span><br><span class=\"line\">Total download size: 620 k</span><br><span class=\"line\">Installed size: 1.6 M</span><br><span class=\"line\">Is this ok [y/N]:</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>输入<code>y</code>继续</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Installed:</span><br><span class=\"line\">  nginx.x86_64 0:1.10.2-1.el6                                                                                          </span><br><span class=\"line\"></span><br><span class=\"line\">Dependency Installed:</span><br><span class=\"line\">  nginx-all-modules.noarch 0:1.10.2-1.el6                       nginx-mod-http-geoip.x86_64 0:1.10.2-1.el6            </span><br><span class=\"line\">  nginx-mod-http-image-filter.x86_64 0:1.10.2-1.el6             nginx-mod-http-perl.x86_64 0:1.10.2-1.el6             </span><br><span class=\"line\">  nginx-mod-http-xslt-filter.x86_64 0:1.10.2-1.el6              nginx-mod-mail.x86_64 0:1.10.2-1.el6                  </span><br><span class=\"line\">  nginx-mod-stream.x86_64 0:1.10.2-1.el6                       </span><br><span class=\"line\"></span><br><span class=\"line\">Complete!</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>安装完毕！！接下来我们来看一下nginx的文件分布</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whereis nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# whereis nginx</span><br><span class=\"line\">nginx: /usr/sbin/nginx /etc/nginx /usr/lib64/nginx /usr/local/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中三个文件（夹）比较重要：</p>\n<table>\n<thead>\n<tr>\n<th>路径</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/usr/sbin/nginx</td>\n<td>nginx启动路径</td>\n</tr>\n<tr>\n<td>/etc/nginx</td>\n<td>存放nginx的配置文件</td>\n</tr>\n<tr>\n<td>/usr/share/nginx</td>\n<td>默认的nginx资源库</td>\n</tr>\n</tbody>\n</table>\n<p>我们首先进入<code>/etc/nginx/</code>中看一下nginx到底有哪些配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# cd /etc/nginx</span><br><span class=\"line\">[root@VM_239_130_centos nginx]# ls</span><br><span class=\"line\">conf.d        fastcgi.conf.default    koi-utf     mime.types.default  scgi_params          uwsgi_params.default</span><br><span class=\"line\">default.d     fastcgi_params          koi-win     nginx.conf          scgi_params.default  win-utf</span><br><span class=\"line\">fastcgi.conf  fastcgi_params.default  mime.types  nginx.conf.default  uwsgi_params</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>哇，看到这么多配置文件是不是吓了一跳，其实我们只需要在意nginx.conf就行了，其他的涉及到了再百度，接下来我们进入nginx.conf(这里我们使用vim，系统没有vim的小伙伴可以使用<code>yum install vim</code>进行下载安装)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim nginx.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;  #日志格式</span><br><span class=\"line\">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class=\"line\">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;                                                  #操作成功记录日志</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">    include             /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type        application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class=\"line\">    # for more information.</span><br><span class=\"line\">    include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>上面的配置不要动，我们跟踪到这一行<code>include /etc/nginx/conf.d/*.conf</code>主要作用就是加载更多的配置文件，我们退出vim编辑<code>ESC+:q</code>进入到conf.d文件夹来看一下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos nginx]# cd /etc/nginx/conf.d</span><br><span class=\"line\">[root@VM_239_130_centos conf.d]# ls</span><br><span class=\"line\">default.conf  default.conf.rpmsave  ssl.conf  virtual.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后进入default.conf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim default.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#</span><br><span class=\"line\"># The default server</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">    listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们发现这个文件配置的是server{}，server的配置就是我们nginx的核心配置，这里先不过多的讲，下面会详细介绍server的配置，但是此时如果我们运行nginx的话将会报错</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Address family not supported by protocol</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们需要将上面的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen       [::]:80 default_server;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>注释掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># listen       [::]:80 default_server;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>退出vim编辑，使用<code>/usr/sbin/nginx</code>启动nginx</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos conf.d]# /usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>关闭nginx</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pkill -9 nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"2-编译安装\"><a class=\"header-anchor\" href=\"#2-编译安装\">¶</a>2、编译安装</h3>\n<p>这里借鉴了腾讯云论坛上的一个帖子： <a href=\"http://bbs.qcloud.com/thread-10429-1-1.html\">CentOS 7中Nginx1.9.5编译安装教程systemctl启动</a></p>\n<p><font color=\"#555555\">先安装gcc 等</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc gcc-c++ wget</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font>.然后装一些库</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc wget automake autoconf libtool libxml2-devel libxslt-devel perl-devel perl-ExtUtils-Embed pcre-devel openssl-devel</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">进入默认的软件目录</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /usr/local/src/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">下载 nginx软件</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://nginx.org/download/nginx-1.9.5.tar.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">如果这个下载太慢可以在这里下载</span><font><a href=\"http://nginx.org/download/nginx-1.9.5.tar.gz\">http://nginx.org/download/nginx-1.9.5.tar.gz</a> 下载完后yum -y intall lrzsz 装好上传工具</font></p>\n<p><font>然后用rz上传到服务器</font> <font color=\"#555555\">然后解压文件.</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf nginx-1.9.5.tar.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">进入 nginx1.9.5的源码 如果想改版本号 可以进入源码目录</font><font color=\"#555555\">src/core/nginx.h</font><font color=\"#555555\">更改</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd nginx-1.9.5/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">创建一个nginx目录用来存放运行的临时文件夹</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /var/cache/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">开始configure</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure \\</span><br><span class=\"line\">--prefix=/usr/local/nginx \\</span><br><span class=\"line\">--sbin-path=/usr/sbin/nginx \\</span><br><span class=\"line\">--conf-path=/etc/nginx/nginx.conf \\</span><br><span class=\"line\">--error-log-path=/var/log/nginx/error.log \\</span><br><span class=\"line\">--http-log-path=/var/log/nginx/access.log \\</span><br><span class=\"line\">--pid-path=/var/run/nginx.pid \\</span><br><span class=\"line\">--lock-path=/var/run/nginx.lock \\</span><br><span class=\"line\">--http-client-body-temp-path=/var/cache/nginx/client_temp \\</span><br><span class=\"line\">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \\</span><br><span class=\"line\">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \\</span><br><span class=\"line\">--user=nobody \\</span><br><span class=\"line\">--group=nobody \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module \\</span><br><span class=\"line\">--with-http_dav_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_gunzip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_random_index_module \\</span><br><span class=\"line\">--with-http_secure_link_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_auth_request_module \\</span><br><span class=\"line\">--with-mail \\</span><br><span class=\"line\">--with-mail_ssl_module \\</span><br><span class=\"line\">--with-file-aio \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-threads \\</span><br><span class=\"line\">--with-stream \\</span><br><span class=\"line\">--with-stream_ssl_module</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">接着 编译</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">安装</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make install</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">启动nginx</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">用ps aux来查看nginx是否启动</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps aux|grep nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"font-size: 12px;\">复制代码</span></p>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">然后配置服务</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /usr/lib/systemd/system/nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">按i输入以下内容</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=nginx - high performance web server </span><br><span class=\"line\">Documentation=http://nginx.org/en/docs/</span><br><span class=\"line\">After=network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/nginx.pid</span><br><span class=\"line\">ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf</span><br><span class=\"line\">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class=\"line\">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class=\"line\">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class=\"line\">PrivateTmp=true</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">编辑好后保存</font><font color=\"#555555\">然后开启开机启动</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl enable nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">用命令关掉nginx</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pkill -9 nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">后面可以用systemctl来操作nginx.service</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里值得一提的是nginx编译安装后的文件夹和yum安装的文件夹类似，nginx.conf文件都在/etc/nginx下，不过编译安装后的nginx.conf文件内部配置与yum安装略有差异</p>\n<p>编译安装后的nginx.conf内部直接配置server，所以编译安装的小伙伴配置server就不用去改/etc/nginx/conf.d下的default.conf文件配置了，直接到nginx.conf文件中改server配置就行了</p>\n<h2 id=\"二-nginx配置详解\"><a class=\"header-anchor\" href=\"#二-nginx配置详解\">¶</a>二、Nginx配置详解</h2>\n<p>1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</p>\n<p>2、events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</p>\n<p>3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</p>\n<p>4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。</p>\n<p>5、location块：配置请求的路由，以及各种页面的处理情况。</p>\n<p>我们来到yum安装后的<code>/etc/nginx/conf.d/default.conf</code>文件中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">   # listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在server块中</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>listen</td>\n<td>nginx监听端口</td>\n</tr>\n<tr>\n<td>root</td>\n<td>nginx资源路径根目录</td>\n</tr>\n<tr>\n<td>location</td>\n<td>url访问的本地资源路径配置(支持通配符)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>error_page</td>\n<td>跳转报错页面</td>\n</tr>\n</tbody>\n</table>\n<p>其中nginx会在资源目录中去找默认的index.html页面，我们进入/usr/share/nginx/html中看一下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos conf.d]# cd /usr/share/nginx/html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\"></span><br><span class=\"line\">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们在这个文件夹中创建一个test.html</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# touch test.html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\"></span><br><span class=\"line\">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png test.html  world</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>html页面内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">        &lt;head&gt;</span><br><span class=\"line\">                &lt;title&gt;test&lt;/title&gt;</span><br><span class=\"line\">        &lt;/head&gt;</span><br><span class=\"line\">        &lt;body&gt;  </span><br><span class=\"line\">                &lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class=\"line\">        &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们在浏览器上去访问test.html</p>\n<p>成功~</p>\n<p>然后我们修改一下default.conf的配置，增加一个location</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# vim /etc/nginx/conf.d/default.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#</span><br><span class=\"line\"># The default server</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">   # listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /test&#123;</span><br><span class=\"line\">        #root /;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>保存退出然后关闭nginx后重新运行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# pkill -9 nginx</span><br><span class=\"line\">[root@VM_239_130_centos html]# /usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们访问test/test.html</p>\n<p><img src=\"http://nginx.ikuvn.com/images/261498318719617.jpg\" alt=\"Clipboard Image.png\"></p>\n<p>不料却报错了，找不到网页，这是因为我们新添加了一个location资源路径的配置，他会自动找到root，然后在去找root下面是否有test这个文件夹，有的话就去test文件夹中去找我们访问的test.html，可想而知，我们并没有建立test文件夹</p>\n<p>回到 /usr/share/nginx/html，然后建立test文件夹，将test.html移动到test文件夹中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# mkdir test</span><br><span class=\"line\">[root@VM_239_130_centos html]# mv test.html test/test.html</span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png  test  world</span><br><span class=\"line\">[root@VM_239_130_centos html]# cd test</span><br><span class=\"line\">[root@VM_239_130_centos test]# ls</span><br><span class=\"line\">test.html</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里要注意一下，我增加的location配置是这样的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /test&#123;</span><br><span class=\"line\">        #root /;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>如果这个root配置不注释的话将会覆盖server块下的root路径哦，到这里nginx基本配置应该就写完了，大家可以去亲自试一试~</p>\n","site":{"data":{}},"excerpt":"","more":"<p>这几天因为需要部署静态资源服务器，所以就找了个vps部署一下Nginx，顺带将vsftpd配置好了，下面就给大家讲一下如何在CentOS上部署Nginx及vsftpd！</p>\n<p>如果大家不知道Nginx和vsftpd的用处，请自行百度，这里就不过多介绍，废话少说，进入正题。</p>\n<h2 id=\"一-在centos上下载nginx和vsftpd\"><a class=\"header-anchor\" href=\"#一-在centos上下载nginx和vsftpd\">¶</a>一、在CentOS上下载Nginx和vsftpd</h2>\n<p>常用的Nginx下载方式有两种，一种是使用CentOS上自带的yum下载，第二种是从网上下载后在通过make进行编译安装，下面我将会向大家介绍一下这两种安装方式</p>\n<h3 id=\"1-yum安装方式\"><a class=\"header-anchor\" href=\"#1-yum安装方式\">¶</a>1、yum安装方式</h3>\n<p>首先我们更新一下yum软件库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum update</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们搜索一下yum库关于nginx的rpm包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list | grep nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到下面的列表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# yum list | grep nginx</span><br><span class=\"line\">nginx-filesystem.noarch                     1.10.2-1.el6                 @epel  </span><br><span class=\"line\">collectd-nginx.x86_64                       4.10.9-4.el6                 epel   </span><br><span class=\"line\">munin-nginx.noarch                          2.0.33-1.el6                 epel   </span><br><span class=\"line\">nginx.x86_64                                1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-all-modules.noarch                    1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-geoip.x86_64                 1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-image-filter.x86_64          1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-perl.x86_64                  1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-http-xslt-filter.x86_64           1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-mail.x86_64                       1.10.2-1.el6                 epel   </span><br><span class=\"line\">nginx-mod-stream.x86_64                     1.10.2-1.el6                 epel   </span><br><span class=\"line\">pcp-pmda-nginx.x86_64                       3.10.9-9.el6                 os</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>接下来我们选择使用yum安装<code>nginx.x86_64 1.10.2-1.el6 epel</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>中间会提示我们一次是否确认安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\"> Package                                   Arch                 Version                       Repository          Size</span><br><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\">Installing:</span><br><span class=\"line\"> nginx                                     x86_64               1.10.2-1.el6                  epel               462 k</span><br><span class=\"line\">Installing for dependencies:</span><br><span class=\"line\"> nginx-all-modules                         noarch               1.10.2-1.el6                  epel               7.7 k</span><br><span class=\"line\"> nginx-mod-http-geoip                      x86_64               1.10.2-1.el6                  epel                14 k</span><br><span class=\"line\"> nginx-mod-http-image-filter               x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class=\"line\"> nginx-mod-http-perl                       x86_64               1.10.2-1.el6                  epel                26 k</span><br><span class=\"line\"> nginx-mod-http-xslt-filter                x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class=\"line\"> nginx-mod-mail                            x86_64               1.10.2-1.el6                  epel                43 k</span><br><span class=\"line\"> nginx-mod-stream                          x86_64               1.10.2-1.el6                  epel                36 k</span><br><span class=\"line\"></span><br><span class=\"line\">Transaction Summary</span><br><span class=\"line\">=======================================================================================================================</span><br><span class=\"line\">Install       8 Package(s)</span><br><span class=\"line\"></span><br><span class=\"line\">Total download size: 620 k</span><br><span class=\"line\">Installed size: 1.6 M</span><br><span class=\"line\">Is this ok [y/N]:</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>输入<code>y</code>继续</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Installed:</span><br><span class=\"line\">  nginx.x86_64 0:1.10.2-1.el6                                                                                          </span><br><span class=\"line\"></span><br><span class=\"line\">Dependency Installed:</span><br><span class=\"line\">  nginx-all-modules.noarch 0:1.10.2-1.el6                       nginx-mod-http-geoip.x86_64 0:1.10.2-1.el6            </span><br><span class=\"line\">  nginx-mod-http-image-filter.x86_64 0:1.10.2-1.el6             nginx-mod-http-perl.x86_64 0:1.10.2-1.el6             </span><br><span class=\"line\">  nginx-mod-http-xslt-filter.x86_64 0:1.10.2-1.el6              nginx-mod-mail.x86_64 0:1.10.2-1.el6                  </span><br><span class=\"line\">  nginx-mod-stream.x86_64 0:1.10.2-1.el6                       </span><br><span class=\"line\"></span><br><span class=\"line\">Complete!</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>安装完毕！！接下来我们来看一下nginx的文件分布</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whereis nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# whereis nginx</span><br><span class=\"line\">nginx: /usr/sbin/nginx /etc/nginx /usr/lib64/nginx /usr/local/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中三个文件（夹）比较重要：</p>\n<table>\n<thead>\n<tr>\n<th>路径</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/usr/sbin/nginx</td>\n<td>nginx启动路径</td>\n</tr>\n<tr>\n<td>/etc/nginx</td>\n<td>存放nginx的配置文件</td>\n</tr>\n<tr>\n<td>/usr/share/nginx</td>\n<td>默认的nginx资源库</td>\n</tr>\n</tbody>\n</table>\n<p>我们首先进入<code>/etc/nginx/</code>中看一下nginx到底有哪些配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# cd /etc/nginx</span><br><span class=\"line\">[root@VM_239_130_centos nginx]# ls</span><br><span class=\"line\">conf.d        fastcgi.conf.default    koi-utf     mime.types.default  scgi_params          uwsgi_params.default</span><br><span class=\"line\">default.d     fastcgi_params          koi-win     nginx.conf          scgi_params.default  win-utf</span><br><span class=\"line\">fastcgi.conf  fastcgi_params.default  mime.types  nginx.conf.default  uwsgi_params</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>哇，看到这么多配置文件是不是吓了一跳，其实我们只需要在意nginx.conf就行了，其他的涉及到了再百度，接下来我们进入nginx.conf(这里我们使用vim，系统没有vim的小伙伴可以使用<code>yum install vim</code>进行下载安装)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim nginx.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;  #日志格式</span><br><span class=\"line\">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class=\"line\">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;                                                  #操作成功记录日志</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">    include             /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type        application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class=\"line\">    # for more information.</span><br><span class=\"line\">    include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>上面的配置不要动，我们跟踪到这一行<code>include /etc/nginx/conf.d/*.conf</code>主要作用就是加载更多的配置文件，我们退出vim编辑<code>ESC+:q</code>进入到conf.d文件夹来看一下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos nginx]# cd /etc/nginx/conf.d</span><br><span class=\"line\">[root@VM_239_130_centos conf.d]# ls</span><br><span class=\"line\">default.conf  default.conf.rpmsave  ssl.conf  virtual.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后进入default.conf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim default.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#</span><br><span class=\"line\"># The default server</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">    listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们发现这个文件配置的是server{}，server的配置就是我们nginx的核心配置，这里先不过多的讲，下面会详细介绍server的配置，但是此时如果我们运行nginx的话将会报错</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Address family not supported by protocol</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们需要将上面的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen       [::]:80 default_server;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>注释掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># listen       [::]:80 default_server;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>退出vim编辑，使用<code>/usr/sbin/nginx</code>启动nginx</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos conf.d]# /usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>关闭nginx</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pkill -9 nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"2-编译安装\"><a class=\"header-anchor\" href=\"#2-编译安装\">¶</a>2、编译安装</h3>\n<p>这里借鉴了腾讯云论坛上的一个帖子： <a href=\"http://bbs.qcloud.com/thread-10429-1-1.html\">CentOS 7中Nginx1.9.5编译安装教程systemctl启动</a></p>\n<p><font color=\"#555555\">先安装gcc 等</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc gcc-c++ wget</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font>.然后装一些库</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc wget automake autoconf libtool libxml2-devel libxslt-devel perl-devel perl-ExtUtils-Embed pcre-devel openssl-devel</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">进入默认的软件目录</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /usr/local/src/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">下载 nginx软件</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://nginx.org/download/nginx-1.9.5.tar.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">如果这个下载太慢可以在这里下载</span><font><a href=\"http://nginx.org/download/nginx-1.9.5.tar.gz\">http://nginx.org/download/nginx-1.9.5.tar.gz</a> 下载完后yum -y intall lrzsz 装好上传工具</font></p>\n<p><font>然后用rz上传到服务器</font> <font color=\"#555555\">然后解压文件.</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf nginx-1.9.5.tar.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">进入 nginx1.9.5的源码 如果想改版本号 可以进入源码目录</font><font color=\"#555555\">src/core/nginx.h</font><font color=\"#555555\">更改</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd nginx-1.9.5/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">创建一个nginx目录用来存放运行的临时文件夹</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /var/cache/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">开始configure</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure \\</span><br><span class=\"line\">--prefix=/usr/local/nginx \\</span><br><span class=\"line\">--sbin-path=/usr/sbin/nginx \\</span><br><span class=\"line\">--conf-path=/etc/nginx/nginx.conf \\</span><br><span class=\"line\">--error-log-path=/var/log/nginx/error.log \\</span><br><span class=\"line\">--http-log-path=/var/log/nginx/access.log \\</span><br><span class=\"line\">--pid-path=/var/run/nginx.pid \\</span><br><span class=\"line\">--lock-path=/var/run/nginx.lock \\</span><br><span class=\"line\">--http-client-body-temp-path=/var/cache/nginx/client_temp \\</span><br><span class=\"line\">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \\</span><br><span class=\"line\">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \\</span><br><span class=\"line\">--user=nobody \\</span><br><span class=\"line\">--group=nobody \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module \\</span><br><span class=\"line\">--with-http_dav_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_gunzip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_random_index_module \\</span><br><span class=\"line\">--with-http_secure_link_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_auth_request_module \\</span><br><span class=\"line\">--with-mail \\</span><br><span class=\"line\">--with-mail_ssl_module \\</span><br><span class=\"line\">--with-file-aio \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-threads \\</span><br><span class=\"line\">--with-stream \\</span><br><span class=\"line\">--with-stream_ssl_module</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">接着 编译</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">安装</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make install</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">启动nginx</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">用ps aux来查看nginx是否启动</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps aux|grep nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span style=\"font-size: 12px;\">复制代码</span></p>\n<p><span style=\"color: rgb(68, 68, 68); font-size: 14px;\">然后配置服务</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /usr/lib/systemd/system/nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">按i输入以下内容</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=nginx - high performance web server </span><br><span class=\"line\">Documentation=http://nginx.org/en/docs/</span><br><span class=\"line\">After=network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/nginx.pid</span><br><span class=\"line\">ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf</span><br><span class=\"line\">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class=\"line\">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class=\"line\">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class=\"line\">PrivateTmp=true</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">编辑好后保存</font><font color=\"#555555\">然后开启开机启动</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl enable nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">用命令关掉nginx</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pkill -9 nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><font color=\"#555555\">后面可以用systemctl来操作nginx.service</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start nginx.service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里值得一提的是nginx编译安装后的文件夹和yum安装的文件夹类似，nginx.conf文件都在/etc/nginx下，不过编译安装后的nginx.conf文件内部配置与yum安装略有差异</p>\n<p>编译安装后的nginx.conf内部直接配置server，所以编译安装的小伙伴配置server就不用去改/etc/nginx/conf.d下的default.conf文件配置了，直接到nginx.conf文件中改server配置就行了</p>\n<h2 id=\"二-nginx配置详解\"><a class=\"header-anchor\" href=\"#二-nginx配置详解\">¶</a>二、Nginx配置详解</h2>\n<p>1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</p>\n<p>2、events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</p>\n<p>3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</p>\n<p>4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。</p>\n<p>5、location块：配置请求的路由，以及各种页面的处理情况。</p>\n<p>我们来到yum安装后的<code>/etc/nginx/conf.d/default.conf</code>文件中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">   # listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在server块中</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>listen</td>\n<td>nginx监听端口</td>\n</tr>\n<tr>\n<td>root</td>\n<td>nginx资源路径根目录</td>\n</tr>\n<tr>\n<td>location</td>\n<td>url访问的本地资源路径配置(支持通配符)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>error_page</td>\n<td>跳转报错页面</td>\n</tr>\n</tbody>\n</table>\n<p>其中nginx会在资源目录中去找默认的index.html页面，我们进入/usr/share/nginx/html中看一下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos conf.d]# cd /usr/share/nginx/html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\"></span><br><span class=\"line\">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们在这个文件夹中创建一个test.html</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# touch test.html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\"></span><br><span class=\"line\">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png test.html  world</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>html页面内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">        &lt;head&gt;</span><br><span class=\"line\">                &lt;title&gt;test&lt;/title&gt;</span><br><span class=\"line\">        &lt;/head&gt;</span><br><span class=\"line\">        &lt;body&gt;  </span><br><span class=\"line\">                &lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class=\"line\">        &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们在浏览器上去访问test.html</p>\n<p>成功~</p>\n<p>然后我们修改一下default.conf的配置，增加一个location</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# vim /etc/nginx/conf.d/default.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#</span><br><span class=\"line\"># The default server</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">   # listen       [::]:80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    root         /usr/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    # Load configuration files for the default server block.</span><br><span class=\"line\">    include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /test&#123;</span><br><span class=\"line\">        #root /;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 404 /404.html;</span><br><span class=\"line\">        location = /40x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_page 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>保存退出然后关闭nginx后重新运行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# pkill -9 nginx</span><br><span class=\"line\">[root@VM_239_130_centos html]# /usr/sbin/nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后我们访问test/test.html</p>\n<p><img src=\"http://nginx.ikuvn.com/images/261498318719617.jpg\" alt=\"Clipboard Image.png\"></p>\n<p>不料却报错了，找不到网页，这是因为我们新添加了一个location资源路径的配置，他会自动找到root，然后在去找root下面是否有test这个文件夹，有的话就去test文件夹中去找我们访问的test.html，可想而知，我们并没有建立test文件夹</p>\n<p>回到 /usr/share/nginx/html，然后建立test文件夹，将test.html移动到test文件夹中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_239_130_centos html]# mkdir test</span><br><span class=\"line\">[root@VM_239_130_centos html]# mv test.html test/test.html</span><br><span class=\"line\">[root@VM_239_130_centos html]# ls</span><br><span class=\"line\">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png  test  world</span><br><span class=\"line\">[root@VM_239_130_centos html]# cd test</span><br><span class=\"line\">[root@VM_239_130_centos test]# ls</span><br><span class=\"line\">test.html</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里要注意一下，我增加的location配置是这样的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /test&#123;</span><br><span class=\"line\">        #root /;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>如果这个root配置不注释的话将会覆盖server块下的root路径哦，到这里nginx基本配置应该就写完了，大家可以去亲自试一试~</p>\n"},{"title":"Round 1C 2021 - Code Jam 2021 -  Closest Pick ","author":"Nico","date":"2021-05-01T11:59:00.000Z","_content":"原题地址: [传送门](https://codingcompetitions.withgoogle.com/codejam/round/00000000004362d7/00000000007c0f00#problem)\n\n### 题解\n从题目中可以得知，要想赢，必须满足以下规则：\n - 1.不能与已选号码重复\n - 2.所选号码周围的其他号码尽可能未被选中\n\n第一个规则很好理解，第二个规则这里解释一下，也是思路的核心。如果要想赢，需要离中奖号码最近，要想使胜率最大化，那么就要尽可能保证所选号码离所有其余未选号码的距离尽可能大于它们到已选号码，故而，当所选号码周围未选号码最多时，就是最大的胜率。\n\n所以，这题的本质为寻找已选号码有序情况下的前两个最大的间隔，再计算分别计算两个间隔中能保证赢的号码数，再除以号码可选范围即为胜率，分情况考虑，记排序后的已选号码集合为arr，号码可选范围为k，已选号码总数为n：\n - 开头间隔1 ~ arr[0]和结尾间隔k - arr[n - 1]可赢号码数为当前间隔长度\n - 两个已选号码之间的间隔如果为i，此时又要分两种情况考虑：\n   - 如果同一个间隔中同时选择两个号码，那么可赢号码数量为当前间隔长度\n   - 如果同一个间隔中只选择一个号码，那么可盈号码数量为interval / 2 + interval % 2\n\n### Golang解决\n```go\nfunc solve() float64{\n\tinputs := readInts()\n\tn, k, arr := inputs[0], inputs[1], readInts()\n\tsort.Ints(arr)\n\tmax1, max2 := arr[0] - 1, k - arr[n - 1]\n\tif max2 > max1 {\n\t\tmax2, max1 = max1, max2\n\t}\n\tmaxInterval := 0\n\tfor i := 1; i < n; i ++ {\n\t\tinterval := arr[i] - arr[i - 1] - 1\n\t\tif interval > 0{\n\t\t\tif interval > maxInterval {\n\t\t\t\tmaxInterval = interval\n\t\t\t}\n\t\t\tinterval = interval / 2 + interval % 2\n\t\t\tif interval > max1 {\n\t\t\t\tmax2, max1 = max1, interval\n\t\t\t}else if interval > max2{\n\t\t\t\tmax2 = interval\n\t\t\t}\n\t\t}\n\t}\n\treturn float64(max(max1 + max2, maxInterval)) / float64(k)\n}\n```","source":"_posts/Round-1C-2021-Code-Jam-2021-Closest-Pick.md","raw":"title: 'Round 1C 2021 - Code Jam 2021 -  Closest Pick '\nauthor: Nico\ntags:\n  - Code Jam\ncategories:\n  - Algorithm\ndate: 2021-05-01 19:59:00\n---\n原题地址: [传送门](https://codingcompetitions.withgoogle.com/codejam/round/00000000004362d7/00000000007c0f00#problem)\n\n### 题解\n从题目中可以得知，要想赢，必须满足以下规则：\n - 1.不能与已选号码重复\n - 2.所选号码周围的其他号码尽可能未被选中\n\n第一个规则很好理解，第二个规则这里解释一下，也是思路的核心。如果要想赢，需要离中奖号码最近，要想使胜率最大化，那么就要尽可能保证所选号码离所有其余未选号码的距离尽可能大于它们到已选号码，故而，当所选号码周围未选号码最多时，就是最大的胜率。\n\n所以，这题的本质为寻找已选号码有序情况下的前两个最大的间隔，再计算分别计算两个间隔中能保证赢的号码数，再除以号码可选范围即为胜率，分情况考虑，记排序后的已选号码集合为arr，号码可选范围为k，已选号码总数为n：\n - 开头间隔1 ~ arr[0]和结尾间隔k - arr[n - 1]可赢号码数为当前间隔长度\n - 两个已选号码之间的间隔如果为i，此时又要分两种情况考虑：\n   - 如果同一个间隔中同时选择两个号码，那么可赢号码数量为当前间隔长度\n   - 如果同一个间隔中只选择一个号码，那么可盈号码数量为interval / 2 + interval % 2\n\n### Golang解决\n```go\nfunc solve() float64{\n\tinputs := readInts()\n\tn, k, arr := inputs[0], inputs[1], readInts()\n\tsort.Ints(arr)\n\tmax1, max2 := arr[0] - 1, k - arr[n - 1]\n\tif max2 > max1 {\n\t\tmax2, max1 = max1, max2\n\t}\n\tmaxInterval := 0\n\tfor i := 1; i < n; i ++ {\n\t\tinterval := arr[i] - arr[i - 1] - 1\n\t\tif interval > 0{\n\t\t\tif interval > maxInterval {\n\t\t\t\tmaxInterval = interval\n\t\t\t}\n\t\t\tinterval = interval / 2 + interval % 2\n\t\t\tif interval > max1 {\n\t\t\t\tmax2, max1 = max1, interval\n\t\t\t}else if interval > max2{\n\t\t\t\tmax2 = interval\n\t\t\t}\n\t\t}\n\t}\n\treturn float64(max(max1 + max2, maxInterval)) / float64(k)\n}\n```","slug":"Round-1C-2021-Code-Jam-2021-Closest-Pick","published":1,"updated":"2021-05-01T12:28:53.192Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy6000eb0tzf4ew5sdj","content":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/codejam/round/00000000004362d7/00000000007c0f00#problem\">传送门</a></p>\n<h3 id=\"题解\"><a class=\"header-anchor\" href=\"#题解\">¶</a>题解</h3>\n<p>从题目中可以得知，要想赢，必须满足以下规则：</p>\n<ul>\n<li>1.不能与已选号码重复</li>\n<li>2.所选号码周围的其他号码尽可能未被选中</li>\n</ul>\n<p>第一个规则很好理解，第二个规则这里解释一下，也是思路的核心。如果要想赢，需要离中奖号码最近，要想使胜率最大化，那么就要尽可能保证所选号码离所有其余未选号码的距离尽可能大于它们到已选号码，故而，当所选号码周围未选号码最多时，就是最大的胜率。</p>\n<p>所以，这题的本质为寻找已选号码有序情况下的前两个最大的间隔，再计算分别计算两个间隔中能保证赢的号码数，再除以号码可选范围即为胜率，分情况考虑，记排序后的已选号码集合为arr，号码可选范围为k，已选号码总数为n：</p>\n<ul>\n<li>开头间隔1 ~ arr[0]和结尾间隔k - arr[n - 1]可赢号码数为当前间隔长度</li>\n<li>两个已选号码之间的间隔如果为i，此时又要分两种情况考虑：\n<ul>\n<li>如果同一个间隔中同时选择两个号码，那么可赢号码数量为当前间隔长度</li>\n<li>如果同一个间隔中只选择一个号码，那么可盈号码数量为interval / 2 + interval % 2</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"golang解决\"><a class=\"header-anchor\" href=\"#golang解决\">¶</a>Golang解决</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span> <span class=\"type\">float64</span>&#123;</span><br><span class=\"line\">\tinputs := readInts()</span><br><span class=\"line\">\tn, k, arr := inputs[<span class=\"number\">0</span>], inputs[<span class=\"number\">1</span>], readInts()</span><br><span class=\"line\">\tsort.Ints(arr)</span><br><span class=\"line\">\tmax1, max2 := arr[<span class=\"number\">0</span>] - <span class=\"number\">1</span>, k - arr[n - <span class=\"number\">1</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> max2 &gt; max1 &#123;</span><br><span class=\"line\">\t\tmax2, max1 = max1, max2</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmaxInterval := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">1</span>; i &lt; n; i ++ &#123;</span><br><span class=\"line\">\t\tinterval := arr[i] - arr[i - <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> interval &gt; <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> interval &gt; maxInterval &#123;</span><br><span class=\"line\">\t\t\t\tmaxInterval = interval</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tinterval = interval / <span class=\"number\">2</span> + interval % <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> interval &gt; max1 &#123;</span><br><span class=\"line\">\t\t\t\tmax2, max1 = max1, interval</span><br><span class=\"line\">\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> interval &gt; max2&#123;</span><br><span class=\"line\">\t\t\t\tmax2 = interval</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">float64</span>(max(max1 + max2, maxInterval)) / <span class=\"type\">float64</span>(k)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>原题地址: <a href=\"https://codingcompetitions.withgoogle.com/codejam/round/00000000004362d7/00000000007c0f00#problem\">传送门</a></p>\n<h3 id=\"题解\"><a class=\"header-anchor\" href=\"#题解\">¶</a>题解</h3>\n<p>从题目中可以得知，要想赢，必须满足以下规则：</p>\n<ul>\n<li>1.不能与已选号码重复</li>\n<li>2.所选号码周围的其他号码尽可能未被选中</li>\n</ul>\n<p>第一个规则很好理解，第二个规则这里解释一下，也是思路的核心。如果要想赢，需要离中奖号码最近，要想使胜率最大化，那么就要尽可能保证所选号码离所有其余未选号码的距离尽可能大于它们到已选号码，故而，当所选号码周围未选号码最多时，就是最大的胜率。</p>\n<p>所以，这题的本质为寻找已选号码有序情况下的前两个最大的间隔，再计算分别计算两个间隔中能保证赢的号码数，再除以号码可选范围即为胜率，分情况考虑，记排序后的已选号码集合为arr，号码可选范围为k，已选号码总数为n：</p>\n<ul>\n<li>开头间隔1 ~ arr[0]和结尾间隔k - arr[n - 1]可赢号码数为当前间隔长度</li>\n<li>两个已选号码之间的间隔如果为i，此时又要分两种情况考虑：\n<ul>\n<li>如果同一个间隔中同时选择两个号码，那么可赢号码数量为当前间隔长度</li>\n<li>如果同一个间隔中只选择一个号码，那么可盈号码数量为interval / 2 + interval % 2</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"golang解决\"><a class=\"header-anchor\" href=\"#golang解决\">¶</a>Golang解决</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">solve</span><span class=\"params\">()</span></span> <span class=\"type\">float64</span>&#123;</span><br><span class=\"line\">\tinputs := readInts()</span><br><span class=\"line\">\tn, k, arr := inputs[<span class=\"number\">0</span>], inputs[<span class=\"number\">1</span>], readInts()</span><br><span class=\"line\">\tsort.Ints(arr)</span><br><span class=\"line\">\tmax1, max2 := arr[<span class=\"number\">0</span>] - <span class=\"number\">1</span>, k - arr[n - <span class=\"number\">1</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> max2 &gt; max1 &#123;</span><br><span class=\"line\">\t\tmax2, max1 = max1, max2</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmaxInterval := <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">1</span>; i &lt; n; i ++ &#123;</span><br><span class=\"line\">\t\tinterval := arr[i] - arr[i - <span class=\"number\">1</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> interval &gt; <span class=\"number\">0</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> interval &gt; maxInterval &#123;</span><br><span class=\"line\">\t\t\t\tmaxInterval = interval</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tinterval = interval / <span class=\"number\">2</span> + interval % <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> interval &gt; max1 &#123;</span><br><span class=\"line\">\t\t\t\tmax2, max1 = max1, interval</span><br><span class=\"line\">\t\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> interval &gt; max2&#123;</span><br><span class=\"line\">\t\t\t\tmax2 = interval</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">float64</span>(max(max1 + max2, maxInterval)) / <span class=\"type\">float64</span>(k)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Spring Cloud Config 入门","author":"Nico","date":"2018-11-06T04:47:00.000Z","_content":"## 一、依赖配置\nMaven依赖配置只是配置中心需要的配置，其他配置自加，本文仅以扩展为目标~\n#### 客户端\nMaven配置\n```\n    <dependency>\n\t\t<groupId>org.springframework.cloud</groupId>\n\t\t<artifactId>spring-cloud-starter-config</artifactId>\n\t</dependency>\n```\nMain\n```\n@SpringBootApplication\n@EnableConfigServer\npublic class ConfigApp {\n\t\n\tpublic static void main(String[] args) throws Exception {\n\t\tSpringApplication.run(ConfigApp.class, args);\n\t}\n}\n```\napplication.yml\n```\nserver:\n  port: 8087\nspring:\n  cloud:\n    config:\n      label: master\n      server:\n        git:\n          uri: git配置仓库http地址\n          username: xxx\n          password: xxx\n```\n#### 配置服务端\nMaven配置\n```\n    <dependency>\n\t\t<groupId>org.springframework.cloud</groupId>\n\t\t<artifactId>spring-cloud-config-server</artifactId>\n\t</dependency>\n```\napplication.yml\n```\nspring:\n  cloud:\n    config:\n      profile: dev\n      label: master\n      uri: http://localhost:8087/\n```\n## 二、映射规则\n```\n/{application}/{profile}[/{label}]\n/{application}-{profile}.yml\n/{application}-{profile}.properties\n/{label}/{application}-{profile}.yml\n/{label}/{application}-{profile}.properties\n```\napplication：服务名\nprofile：环境``dev/test/pro``\nlable：分支\n\n仓库根目录下可以用``application.yml``作为全局配置，所有服务共享","source":"_posts/Spring-Cloud-Config-入门.md","raw":"title: Spring Cloud Config 入门\nauthor: Nico\ntags: []\ncategories: []\ndate: 2018-11-06 12:47:00\n---\n## 一、依赖配置\nMaven依赖配置只是配置中心需要的配置，其他配置自加，本文仅以扩展为目标~\n#### 客户端\nMaven配置\n```\n    <dependency>\n\t\t<groupId>org.springframework.cloud</groupId>\n\t\t<artifactId>spring-cloud-starter-config</artifactId>\n\t</dependency>\n```\nMain\n```\n@SpringBootApplication\n@EnableConfigServer\npublic class ConfigApp {\n\t\n\tpublic static void main(String[] args) throws Exception {\n\t\tSpringApplication.run(ConfigApp.class, args);\n\t}\n}\n```\napplication.yml\n```\nserver:\n  port: 8087\nspring:\n  cloud:\n    config:\n      label: master\n      server:\n        git:\n          uri: git配置仓库http地址\n          username: xxx\n          password: xxx\n```\n#### 配置服务端\nMaven配置\n```\n    <dependency>\n\t\t<groupId>org.springframework.cloud</groupId>\n\t\t<artifactId>spring-cloud-config-server</artifactId>\n\t</dependency>\n```\napplication.yml\n```\nspring:\n  cloud:\n    config:\n      profile: dev\n      label: master\n      uri: http://localhost:8087/\n```\n## 二、映射规则\n```\n/{application}/{profile}[/{label}]\n/{application}-{profile}.yml\n/{application}-{profile}.properties\n/{label}/{application}-{profile}.yml\n/{label}/{application}-{profile}.properties\n```\napplication：服务名\nprofile：环境``dev/test/pro``\nlable：分支\n\n仓库根目录下可以用``application.yml``作为全局配置，所有服务共享","slug":"Spring-Cloud-Config-入门","published":1,"updated":"2021-03-21T17:43:05.237Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy7000ib0tz5vj53bwu","content":"<h2 id=\"一-依赖配置\"><a class=\"header-anchor\" href=\"#一-依赖配置\">¶</a>一、依赖配置</h2>\n<p>Maven依赖配置只是配置中心需要的配置，其他配置自加，本文仅以扩展为目标~</p>\n<h4 id=\"客户端\"><a class=\"header-anchor\" href=\"#客户端\">¶</a>客户端</h4>\n<p>Maven配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>Main</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">@EnableConfigServer</span><br><span class=\"line\">public class ConfigApp &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic static void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(ConfigApp.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server:</span><br><span class=\"line\">  port: 8087</span><br><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    config:</span><br><span class=\"line\">      label: master</span><br><span class=\"line\">      server:</span><br><span class=\"line\">        git:</span><br><span class=\"line\">          uri: git配置仓库http地址</span><br><span class=\"line\">          username: xxx</span><br><span class=\"line\">          password: xxx</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置服务端\"><a class=\"header-anchor\" href=\"#配置服务端\">¶</a>配置服务端</h4>\n<p>Maven配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    config:</span><br><span class=\"line\">      profile: dev</span><br><span class=\"line\">      label: master</span><br><span class=\"line\">      uri: http://localhost:8087/</span><br></pre></td></tr></table></figure>\n<h2 id=\"二-映射规则\"><a class=\"header-anchor\" href=\"#二-映射规则\">¶</a>二、映射规则</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class=\"line\">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class=\"line\">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class=\"line\">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class=\"line\">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure>\n<p>application：服务名<br>\nprofile：环境<code>dev/test/pro</code><br>\nlable：分支</p>\n<p>仓库根目录下可以用<code>application.yml</code>作为全局配置，所有服务共享</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-依赖配置\"><a class=\"header-anchor\" href=\"#一-依赖配置\">¶</a>一、依赖配置</h2>\n<p>Maven依赖配置只是配置中心需要的配置，其他配置自加，本文仅以扩展为目标~</p>\n<h4 id=\"客户端\"><a class=\"header-anchor\" href=\"#客户端\">¶</a>客户端</h4>\n<p>Maven配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>Main</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">@EnableConfigServer</span><br><span class=\"line\">public class ConfigApp &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic static void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(ConfigApp.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server:</span><br><span class=\"line\">  port: 8087</span><br><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    config:</span><br><span class=\"line\">      label: master</span><br><span class=\"line\">      server:</span><br><span class=\"line\">        git:</span><br><span class=\"line\">          uri: git配置仓库http地址</span><br><span class=\"line\">          username: xxx</span><br><span class=\"line\">          password: xxx</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置服务端\"><a class=\"header-anchor\" href=\"#配置服务端\">¶</a>配置服务端</h4>\n<p>Maven配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    config:</span><br><span class=\"line\">      profile: dev</span><br><span class=\"line\">      label: master</span><br><span class=\"line\">      uri: http://localhost:8087/</span><br></pre></td></tr></table></figure>\n<h2 id=\"二-映射规则\"><a class=\"header-anchor\" href=\"#二-映射规则\">¶</a>二、映射规则</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class=\"line\">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class=\"line\">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class=\"line\">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class=\"line\">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure>\n<p>application：服务名<br>\nprofile：环境<code>dev/test/pro</code><br>\nlable：分支</p>\n<p>仓库根目录下可以用<code>application.yml</code>作为全局配置，所有服务共享</p>\n"},{"title":"Spring Cloud Eureka 使用Nginx做路由网关","author":"Nico","date":"2018-11-06T04:46:21.000Z","_content":"## 一、起始\n在分布式系统的体系中，注册中心的作用及其重要，每个服务可以将自己注册到Eureka中，然后通过心跳包去实时获取注册中心的服务列表，因此达到分布式环境下的Rpc调用及负载。\n\n但是如果使用Eureka做负载均衡，那么将会面临着一个问题：\n```\n如果要调整负载均衡方案，例如复杂的加权，那么整个系统就要面临着停服的尴尬。\n```\n那么我们能不能将负载均衡交给系统之外的中间件处理？本文就拿Spring Cloud环境来举例如何将配置Eureka Client以至将负载的主动权交给Nginx！\n## 二、可行性\n各服务注册在Eureka上的可识别HOST默认是本机IP，也就是**ipAddress**这个参数，各个服务从Eureka获取的服务列表大多数情况下是**ipAddress:port**的搭配形式，而Nginx通常通过**server_name**来监听**80**端口去转发各个请求，**server_name**为域名的形式，那么我们只需要想办法将注册列表的搭配变成如下方式即可：\n```\nipAddress = account.xt.org\nport = 80\n```\n也就是说从Eureka上获得的服务列表将会是**account.application.api:80**，那么这个想法到底能不能做到呢？\n\n我们都知道Spring Cloud提供了Eureka的配置方式，配置域有两个，他们分别是**Client**和**Instance**，而关于网络方面的配置大多在后者，其中有两个参数恰好符合我们上述要求：\n - IpAddress：实例IP\n - NonSecurePort：获取该实例应该接收通信的非安全端口，在Spring Cloud中默认为服务的IP\n\n## 三、实现\n\n接下来我们需要将IpAddress配置成我们需要的域名，NonSecurePort配置为80（不配置默认会赋值为当前服务的端口号）\n```\neureka:\n  client:\n    serviceUrl:\n      defaultZone: @serviceUrl@\n    registryFetchIntervalSeconds: 5\n  instance:\n    preferIpAddress: true\n    ipAddress: account.xt.org\n    nonSecurePort: 80\n    lease-renewal-interval-in-seconds: 10\n    lease-expiration-duration-in-seconds: 90\n    instance-id: ${spring.cloud.client.ipAddress}:${spring.application.name}:${server.port}\n```\n至此，我们的服务间便可以通过域名进行RPC调用，我们可以通过Eureka提供的Rest Operations查看方才修改的服务的注册信息：\n```\ncurl GET http://localhost:8089/eureka/apps/SERVICE-XTOKEN-ACCOUNT\nRESPONSE:\n<application>\n    <name>SERVICE-XTOKEN-ACCOUNT</name>\n    <instance>\n        <instanceId>192.168.50.200:service-xtoken-account:8094</instanceId>\n        <hostName>account.xt.org</hostName>\n        <app>SERVICE-XTOKEN-ACCOUNT</app>\n        <ipAddr>account.xt.org</ipAddr>\n        <status>UP</status>\n        <overriddenstatus>UNKNOWN</overriddenstatus>\n        <port enabled=\"true\">80</port>\n        <securePort enabled=\"false\">443</securePort>\n        <countryId>1</countryId>\n        <dataCenterInfo class=\"com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo\">\n            <name>MyOwn</name>\n        </dataCenterInfo>\n        <leaseInfo>\n            <renewalIntervalInSecs>10</renewalIntervalInSecs>\n            <durationInSecs>90</durationInSecs>\n            <registrationTimestamp>1537168990103</registrationTimestamp>\n            <lastRenewalTimestamp>1537171761036</lastRenewalTimestamp>\n            <evictionTimestamp>0</evictionTimestamp>\n            <serviceUpTimestamp>1537168990103</serviceUpTimestamp>\n        </leaseInfo>\n        <metadata>\n            <management.port>8094</management.port>\n        </metadata>\n        <homePageUrl>http://account.xt.org:80/</homePageUrl>\n        <statusPageUrl>http://192.168.50.200:8094/info</statusPageUrl>\n        <healthCheckUrl>http://192.168.50.200:8094/health</healthCheckUrl>\n        <vipAddress>service-xtoken-account</vipAddress>\n        <secureVipAddress>service-xtoken-account</secureVipAddress>\n        <isCoordinatingDiscoveryServer>false</isCoordinatingDiscoveryServer>\n        <lastUpdatedTimestamp>1537168990103</lastUpdatedTimestamp>\n        <lastDirtyTimestamp>1537168990048</lastDirtyTimestamp>\n        <actionType>ADDED</actionType>\n    </instance>\n</application>\n```\n我们发现ipAddr和port两个参数已经变成了我们想要的结果！\n\n不过这时的域名我们的网关是识别不了的，需要我们去本机的Hosts文件中配置一下：\n```\n## 其他配置\n..\n..\n127.0.0.1 account.xt.org\n```\n然后Nginx配置一个代理即可：\n```\nserver {\n        listen       80;\n        server_name  account.xt.org;\n\n        location / {\n            proxy_pass  http://127.0.0.1:8094;\n        }\n    }\n```","source":"_posts/Spring-Cloud-Eureka-使用Nginx做路由网关.md","raw":"title: Spring Cloud Eureka 使用Nginx做路由网关\nauthor: Nico\ndate: 2018-11-06 12:46:21\ntags:\n---\n## 一、起始\n在分布式系统的体系中，注册中心的作用及其重要，每个服务可以将自己注册到Eureka中，然后通过心跳包去实时获取注册中心的服务列表，因此达到分布式环境下的Rpc调用及负载。\n\n但是如果使用Eureka做负载均衡，那么将会面临着一个问题：\n```\n如果要调整负载均衡方案，例如复杂的加权，那么整个系统就要面临着停服的尴尬。\n```\n那么我们能不能将负载均衡交给系统之外的中间件处理？本文就拿Spring Cloud环境来举例如何将配置Eureka Client以至将负载的主动权交给Nginx！\n## 二、可行性\n各服务注册在Eureka上的可识别HOST默认是本机IP，也就是**ipAddress**这个参数，各个服务从Eureka获取的服务列表大多数情况下是**ipAddress:port**的搭配形式，而Nginx通常通过**server_name**来监听**80**端口去转发各个请求，**server_name**为域名的形式，那么我们只需要想办法将注册列表的搭配变成如下方式即可：\n```\nipAddress = account.xt.org\nport = 80\n```\n也就是说从Eureka上获得的服务列表将会是**account.application.api:80**，那么这个想法到底能不能做到呢？\n\n我们都知道Spring Cloud提供了Eureka的配置方式，配置域有两个，他们分别是**Client**和**Instance**，而关于网络方面的配置大多在后者，其中有两个参数恰好符合我们上述要求：\n - IpAddress：实例IP\n - NonSecurePort：获取该实例应该接收通信的非安全端口，在Spring Cloud中默认为服务的IP\n\n## 三、实现\n\n接下来我们需要将IpAddress配置成我们需要的域名，NonSecurePort配置为80（不配置默认会赋值为当前服务的端口号）\n```\neureka:\n  client:\n    serviceUrl:\n      defaultZone: @serviceUrl@\n    registryFetchIntervalSeconds: 5\n  instance:\n    preferIpAddress: true\n    ipAddress: account.xt.org\n    nonSecurePort: 80\n    lease-renewal-interval-in-seconds: 10\n    lease-expiration-duration-in-seconds: 90\n    instance-id: ${spring.cloud.client.ipAddress}:${spring.application.name}:${server.port}\n```\n至此，我们的服务间便可以通过域名进行RPC调用，我们可以通过Eureka提供的Rest Operations查看方才修改的服务的注册信息：\n```\ncurl GET http://localhost:8089/eureka/apps/SERVICE-XTOKEN-ACCOUNT\nRESPONSE:\n<application>\n    <name>SERVICE-XTOKEN-ACCOUNT</name>\n    <instance>\n        <instanceId>192.168.50.200:service-xtoken-account:8094</instanceId>\n        <hostName>account.xt.org</hostName>\n        <app>SERVICE-XTOKEN-ACCOUNT</app>\n        <ipAddr>account.xt.org</ipAddr>\n        <status>UP</status>\n        <overriddenstatus>UNKNOWN</overriddenstatus>\n        <port enabled=\"true\">80</port>\n        <securePort enabled=\"false\">443</securePort>\n        <countryId>1</countryId>\n        <dataCenterInfo class=\"com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo\">\n            <name>MyOwn</name>\n        </dataCenterInfo>\n        <leaseInfo>\n            <renewalIntervalInSecs>10</renewalIntervalInSecs>\n            <durationInSecs>90</durationInSecs>\n            <registrationTimestamp>1537168990103</registrationTimestamp>\n            <lastRenewalTimestamp>1537171761036</lastRenewalTimestamp>\n            <evictionTimestamp>0</evictionTimestamp>\n            <serviceUpTimestamp>1537168990103</serviceUpTimestamp>\n        </leaseInfo>\n        <metadata>\n            <management.port>8094</management.port>\n        </metadata>\n        <homePageUrl>http://account.xt.org:80/</homePageUrl>\n        <statusPageUrl>http://192.168.50.200:8094/info</statusPageUrl>\n        <healthCheckUrl>http://192.168.50.200:8094/health</healthCheckUrl>\n        <vipAddress>service-xtoken-account</vipAddress>\n        <secureVipAddress>service-xtoken-account</secureVipAddress>\n        <isCoordinatingDiscoveryServer>false</isCoordinatingDiscoveryServer>\n        <lastUpdatedTimestamp>1537168990103</lastUpdatedTimestamp>\n        <lastDirtyTimestamp>1537168990048</lastDirtyTimestamp>\n        <actionType>ADDED</actionType>\n    </instance>\n</application>\n```\n我们发现ipAddr和port两个参数已经变成了我们想要的结果！\n\n不过这时的域名我们的网关是识别不了的，需要我们去本机的Hosts文件中配置一下：\n```\n## 其他配置\n..\n..\n127.0.0.1 account.xt.org\n```\n然后Nginx配置一个代理即可：\n```\nserver {\n        listen       80;\n        server_name  account.xt.org;\n\n        location / {\n            proxy_pass  http://127.0.0.1:8094;\n        }\n    }\n```","slug":"Spring-Cloud-Eureka-使用Nginx做路由网关","published":1,"updated":"2021-03-21T17:43:05.956Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy8000lb0tz5wva3tch","content":"<h2 id=\"一-起始\"><a class=\"header-anchor\" href=\"#一-起始\">¶</a>一、起始</h2>\n<p>在分布式系统的体系中，注册中心的作用及其重要，每个服务可以将自己注册到Eureka中，然后通过心跳包去实时获取注册中心的服务列表，因此达到分布式环境下的Rpc调用及负载。</p>\n<p>但是如果使用Eureka做负载均衡，那么将会面临着一个问题：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果要调整负载均衡方案，例如复杂的加权，那么整个系统就要面临着停服的尴尬。</span><br></pre></td></tr></table></figure>\n<p>那么我们能不能将负载均衡交给系统之外的中间件处理？本文就拿Spring Cloud环境来举例如何将配置Eureka Client以至将负载的主动权交给Nginx！</p>\n<h2 id=\"二-可行性\"><a class=\"header-anchor\" href=\"#二-可行性\">¶</a>二、可行性</h2>\n<p>各服务注册在Eureka上的可识别HOST默认是本机IP，也就是<strong>ipAddress</strong>这个参数，各个服务从Eureka获取的服务列表大多数情况下是<strong>ipAddress:port</strong>的搭配形式，而Nginx通常通过<strong>server_name</strong>来监听<strong>80</strong>端口去转发各个请求，<strong>server_name</strong>为域名的形式，那么我们只需要想办法将注册列表的搭配变成如下方式即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipAddress = account.xt.org</span><br><span class=\"line\">port = 80</span><br></pre></td></tr></table></figure>\n<p>也就是说从Eureka上获得的服务列表将会是<strong>account.application.api:80</strong>，那么这个想法到底能不能做到呢？</p>\n<p>我们都知道Spring Cloud提供了Eureka的配置方式，配置域有两个，他们分别是<strong>Client</strong>和<strong>Instance</strong>，而关于网络方面的配置大多在后者，其中有两个参数恰好符合我们上述要求：</p>\n<ul>\n<li>IpAddress：实例IP</li>\n<li>NonSecurePort：获取该实例应该接收通信的非安全端口，在Spring Cloud中默认为服务的IP</li>\n</ul>\n<h2 id=\"三-实现\"><a class=\"header-anchor\" href=\"#三-实现\">¶</a>三、实现</h2>\n<p>接下来我们需要将IpAddress配置成我们需要的域名，NonSecurePort配置为80（不配置默认会赋值为当前服务的端口号）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eureka:</span><br><span class=\"line\">  client:</span><br><span class=\"line\">    serviceUrl:</span><br><span class=\"line\">      defaultZone: @serviceUrl@</span><br><span class=\"line\">    registryFetchIntervalSeconds: 5</span><br><span class=\"line\">  instance:</span><br><span class=\"line\">    preferIpAddress: true</span><br><span class=\"line\">    ipAddress: account.xt.org</span><br><span class=\"line\">    nonSecurePort: 80</span><br><span class=\"line\">    lease-renewal-interval-in-seconds: 10</span><br><span class=\"line\">    lease-expiration-duration-in-seconds: 90</span><br><span class=\"line\">    instance-id: $&#123;spring.cloud.client.ipAddress&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，我们的服务间便可以通过域名进行RPC调用，我们可以通过Eureka提供的Rest Operations查看方才修改的服务的注册信息：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl GET http://localhost:8089/eureka/apps/SERVICE-XTOKEN-ACCOUNT</span><br><span class=\"line\">RESPONSE:</span><br><span class=\"line\">&lt;application&gt;</span><br><span class=\"line\">    &lt;name&gt;SERVICE-XTOKEN-ACCOUNT&lt;/name&gt;</span><br><span class=\"line\">    &lt;instance&gt;</span><br><span class=\"line\">        &lt;instanceId&gt;192.168.50.200:service-xtoken-account:8094&lt;/instanceId&gt;</span><br><span class=\"line\">        &lt;hostName&gt;account.xt.org&lt;/hostName&gt;</span><br><span class=\"line\">        &lt;app&gt;SERVICE-XTOKEN-ACCOUNT&lt;/app&gt;</span><br><span class=\"line\">        &lt;ipAddr&gt;account.xt.org&lt;/ipAddr&gt;</span><br><span class=\"line\">        &lt;status&gt;UP&lt;/status&gt;</span><br><span class=\"line\">        &lt;overriddenstatus&gt;UNKNOWN&lt;/overriddenstatus&gt;</span><br><span class=\"line\">        &lt;port enabled=&quot;true&quot;&gt;80&lt;/port&gt;</span><br><span class=\"line\">        &lt;securePort enabled=&quot;false&quot;&gt;443&lt;/securePort&gt;</span><br><span class=\"line\">        &lt;countryId&gt;1&lt;/countryId&gt;</span><br><span class=\"line\">        &lt;dataCenterInfo class=&quot;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&quot;&gt;</span><br><span class=\"line\">            &lt;name&gt;MyOwn&lt;/name&gt;</span><br><span class=\"line\">        &lt;/dataCenterInfo&gt;</span><br><span class=\"line\">        &lt;leaseInfo&gt;</span><br><span class=\"line\">            &lt;renewalIntervalInSecs&gt;10&lt;/renewalIntervalInSecs&gt;</span><br><span class=\"line\">            &lt;durationInSecs&gt;90&lt;/durationInSecs&gt;</span><br><span class=\"line\">            &lt;registrationTimestamp&gt;1537168990103&lt;/registrationTimestamp&gt;</span><br><span class=\"line\">            &lt;lastRenewalTimestamp&gt;1537171761036&lt;/lastRenewalTimestamp&gt;</span><br><span class=\"line\">            &lt;evictionTimestamp&gt;0&lt;/evictionTimestamp&gt;</span><br><span class=\"line\">            &lt;serviceUpTimestamp&gt;1537168990103&lt;/serviceUpTimestamp&gt;</span><br><span class=\"line\">        &lt;/leaseInfo&gt;</span><br><span class=\"line\">        &lt;metadata&gt;</span><br><span class=\"line\">            &lt;management.port&gt;8094&lt;/management.port&gt;</span><br><span class=\"line\">        &lt;/metadata&gt;</span><br><span class=\"line\">        &lt;homePageUrl&gt;http://account.xt.org:80/&lt;/homePageUrl&gt;</span><br><span class=\"line\">        &lt;statusPageUrl&gt;http://192.168.50.200:8094/info&lt;/statusPageUrl&gt;</span><br><span class=\"line\">        &lt;healthCheckUrl&gt;http://192.168.50.200:8094/health&lt;/healthCheckUrl&gt;</span><br><span class=\"line\">        &lt;vipAddress&gt;service-xtoken-account&lt;/vipAddress&gt;</span><br><span class=\"line\">        &lt;secureVipAddress&gt;service-xtoken-account&lt;/secureVipAddress&gt;</span><br><span class=\"line\">        &lt;isCoordinatingDiscoveryServer&gt;false&lt;/isCoordinatingDiscoveryServer&gt;</span><br><span class=\"line\">        &lt;lastUpdatedTimestamp&gt;1537168990103&lt;/lastUpdatedTimestamp&gt;</span><br><span class=\"line\">        &lt;lastDirtyTimestamp&gt;1537168990048&lt;/lastDirtyTimestamp&gt;</span><br><span class=\"line\">        &lt;actionType&gt;ADDED&lt;/actionType&gt;</span><br><span class=\"line\">    &lt;/instance&gt;</span><br><span class=\"line\">&lt;/application&gt;</span><br></pre></td></tr></table></figure>\n<p>我们发现ipAddr和port两个参数已经变成了我们想要的结果！</p>\n<p>不过这时的域名我们的网关是识别不了的，需要我们去本机的Hosts文件中配置一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## 其他配置</span><br><span class=\"line\">..</span><br><span class=\"line\">..</span><br><span class=\"line\">127.0.0.1 account.xt.org</span><br></pre></td></tr></table></figure>\n<p>然后Nginx配置一个代理即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name  account.xt.org;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy_pass  http://127.0.0.1:8094;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-起始\"><a class=\"header-anchor\" href=\"#一-起始\">¶</a>一、起始</h2>\n<p>在分布式系统的体系中，注册中心的作用及其重要，每个服务可以将自己注册到Eureka中，然后通过心跳包去实时获取注册中心的服务列表，因此达到分布式环境下的Rpc调用及负载。</p>\n<p>但是如果使用Eureka做负载均衡，那么将会面临着一个问题：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果要调整负载均衡方案，例如复杂的加权，那么整个系统就要面临着停服的尴尬。</span><br></pre></td></tr></table></figure>\n<p>那么我们能不能将负载均衡交给系统之外的中间件处理？本文就拿Spring Cloud环境来举例如何将配置Eureka Client以至将负载的主动权交给Nginx！</p>\n<h2 id=\"二-可行性\"><a class=\"header-anchor\" href=\"#二-可行性\">¶</a>二、可行性</h2>\n<p>各服务注册在Eureka上的可识别HOST默认是本机IP，也就是<strong>ipAddress</strong>这个参数，各个服务从Eureka获取的服务列表大多数情况下是<strong>ipAddress:port</strong>的搭配形式，而Nginx通常通过<strong>server_name</strong>来监听<strong>80</strong>端口去转发各个请求，<strong>server_name</strong>为域名的形式，那么我们只需要想办法将注册列表的搭配变成如下方式即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipAddress = account.xt.org</span><br><span class=\"line\">port = 80</span><br></pre></td></tr></table></figure>\n<p>也就是说从Eureka上获得的服务列表将会是<strong>account.application.api:80</strong>，那么这个想法到底能不能做到呢？</p>\n<p>我们都知道Spring Cloud提供了Eureka的配置方式，配置域有两个，他们分别是<strong>Client</strong>和<strong>Instance</strong>，而关于网络方面的配置大多在后者，其中有两个参数恰好符合我们上述要求：</p>\n<ul>\n<li>IpAddress：实例IP</li>\n<li>NonSecurePort：获取该实例应该接收通信的非安全端口，在Spring Cloud中默认为服务的IP</li>\n</ul>\n<h2 id=\"三-实现\"><a class=\"header-anchor\" href=\"#三-实现\">¶</a>三、实现</h2>\n<p>接下来我们需要将IpAddress配置成我们需要的域名，NonSecurePort配置为80（不配置默认会赋值为当前服务的端口号）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eureka:</span><br><span class=\"line\">  client:</span><br><span class=\"line\">    serviceUrl:</span><br><span class=\"line\">      defaultZone: @serviceUrl@</span><br><span class=\"line\">    registryFetchIntervalSeconds: 5</span><br><span class=\"line\">  instance:</span><br><span class=\"line\">    preferIpAddress: true</span><br><span class=\"line\">    ipAddress: account.xt.org</span><br><span class=\"line\">    nonSecurePort: 80</span><br><span class=\"line\">    lease-renewal-interval-in-seconds: 10</span><br><span class=\"line\">    lease-expiration-duration-in-seconds: 90</span><br><span class=\"line\">    instance-id: $&#123;spring.cloud.client.ipAddress&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，我们的服务间便可以通过域名进行RPC调用，我们可以通过Eureka提供的Rest Operations查看方才修改的服务的注册信息：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl GET http://localhost:8089/eureka/apps/SERVICE-XTOKEN-ACCOUNT</span><br><span class=\"line\">RESPONSE:</span><br><span class=\"line\">&lt;application&gt;</span><br><span class=\"line\">    &lt;name&gt;SERVICE-XTOKEN-ACCOUNT&lt;/name&gt;</span><br><span class=\"line\">    &lt;instance&gt;</span><br><span class=\"line\">        &lt;instanceId&gt;192.168.50.200:service-xtoken-account:8094&lt;/instanceId&gt;</span><br><span class=\"line\">        &lt;hostName&gt;account.xt.org&lt;/hostName&gt;</span><br><span class=\"line\">        &lt;app&gt;SERVICE-XTOKEN-ACCOUNT&lt;/app&gt;</span><br><span class=\"line\">        &lt;ipAddr&gt;account.xt.org&lt;/ipAddr&gt;</span><br><span class=\"line\">        &lt;status&gt;UP&lt;/status&gt;</span><br><span class=\"line\">        &lt;overriddenstatus&gt;UNKNOWN&lt;/overriddenstatus&gt;</span><br><span class=\"line\">        &lt;port enabled=&quot;true&quot;&gt;80&lt;/port&gt;</span><br><span class=\"line\">        &lt;securePort enabled=&quot;false&quot;&gt;443&lt;/securePort&gt;</span><br><span class=\"line\">        &lt;countryId&gt;1&lt;/countryId&gt;</span><br><span class=\"line\">        &lt;dataCenterInfo class=&quot;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&quot;&gt;</span><br><span class=\"line\">            &lt;name&gt;MyOwn&lt;/name&gt;</span><br><span class=\"line\">        &lt;/dataCenterInfo&gt;</span><br><span class=\"line\">        &lt;leaseInfo&gt;</span><br><span class=\"line\">            &lt;renewalIntervalInSecs&gt;10&lt;/renewalIntervalInSecs&gt;</span><br><span class=\"line\">            &lt;durationInSecs&gt;90&lt;/durationInSecs&gt;</span><br><span class=\"line\">            &lt;registrationTimestamp&gt;1537168990103&lt;/registrationTimestamp&gt;</span><br><span class=\"line\">            &lt;lastRenewalTimestamp&gt;1537171761036&lt;/lastRenewalTimestamp&gt;</span><br><span class=\"line\">            &lt;evictionTimestamp&gt;0&lt;/evictionTimestamp&gt;</span><br><span class=\"line\">            &lt;serviceUpTimestamp&gt;1537168990103&lt;/serviceUpTimestamp&gt;</span><br><span class=\"line\">        &lt;/leaseInfo&gt;</span><br><span class=\"line\">        &lt;metadata&gt;</span><br><span class=\"line\">            &lt;management.port&gt;8094&lt;/management.port&gt;</span><br><span class=\"line\">        &lt;/metadata&gt;</span><br><span class=\"line\">        &lt;homePageUrl&gt;http://account.xt.org:80/&lt;/homePageUrl&gt;</span><br><span class=\"line\">        &lt;statusPageUrl&gt;http://192.168.50.200:8094/info&lt;/statusPageUrl&gt;</span><br><span class=\"line\">        &lt;healthCheckUrl&gt;http://192.168.50.200:8094/health&lt;/healthCheckUrl&gt;</span><br><span class=\"line\">        &lt;vipAddress&gt;service-xtoken-account&lt;/vipAddress&gt;</span><br><span class=\"line\">        &lt;secureVipAddress&gt;service-xtoken-account&lt;/secureVipAddress&gt;</span><br><span class=\"line\">        &lt;isCoordinatingDiscoveryServer&gt;false&lt;/isCoordinatingDiscoveryServer&gt;</span><br><span class=\"line\">        &lt;lastUpdatedTimestamp&gt;1537168990103&lt;/lastUpdatedTimestamp&gt;</span><br><span class=\"line\">        &lt;lastDirtyTimestamp&gt;1537168990048&lt;/lastDirtyTimestamp&gt;</span><br><span class=\"line\">        &lt;actionType&gt;ADDED&lt;/actionType&gt;</span><br><span class=\"line\">    &lt;/instance&gt;</span><br><span class=\"line\">&lt;/application&gt;</span><br></pre></td></tr></table></figure>\n<p>我们发现ipAddr和port两个参数已经变成了我们想要的结果！</p>\n<p>不过这时的域名我们的网关是识别不了的，需要我们去本机的Hosts文件中配置一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## 其他配置</span><br><span class=\"line\">..</span><br><span class=\"line\">..</span><br><span class=\"line\">127.0.0.1 account.xt.org</span><br></pre></td></tr></table></figure>\n<p>然后Nginx配置一个代理即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name  account.xt.org;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy_pass  http://127.0.0.1:8094;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>"},{"title":"如何使用Defender优雅的管理权限？","author":"Nico","date":"2018-12-11T12:09:51.000Z","_content":"## 何为权限管理\n权限管理已经不知不觉深入到了我们生活的每一个角落，例如地铁进站的闸机，高速公路上的过路费，停车场的杠杆等等等等。\n\n作为一名开发人员，权限二字对我们的映像更加深刻，无论任何系统，都多多少少与权限管理会沾上关系！什么？你的系统和权限不沾边......好吧，你的代码拉取权限总得有吧！如果还没有的话，你登上掘金看到这篇文章并点了一个赞这个过程就需要好多次权限校验。好了扯远了，我们回归正题，这里使用一张图来简单展示web系统的权限是什么样子：\n\n![](https://user-gold-cdn.xitu.io/2018/12/11/1679cf52d7e57736?w=734&h=214&f=png&s=18626)\n\n看完之后，是不是感觉很简单，不错，权限管理并不难，我们只需要将**校验**这一环节进行开发即可，实现方式也有很多种：\n### 方案一：组件封装\n我们可以将权限校验的整个过程组件化，例如组件名为``AuthComponent``，之后再所有需要权限校验的接口对应的方法的开头，调用``AuthComponent``的``verify``方法进行校验，根据结果做不同的业务处理！\n - 优点：貌似能达到主要目的，而且非常灵活~\n - 缺点：代码冗余，低内聚，高耦合，不易于维护。\n\n### 方案二：通用处理\n在方案一的基础上我们稍加改造，例如使用``AOP``对需要校验的接口做个切面，在方法执行前我们使用``AuthComponent``校验一下即可，这样我们的代码就更方便维护了！\n - 优点：弥补了方案一的缺点。\n - 缺点：太过通用化，很难兼容所有的情况，不灵活。\n\n### 方案三：自定义注解\n我们将方案一和方案二结合一下，取一灵活，取二通用，我们自定义一个名为``@Auth``的注解，并且它需要传一个参数，我们这里直径定义为枚举类``Level``，简单结构如下：\n```\npublic enum Level { LOGIN, ADMIN }\n```\n之后我们定义一个注解切面，切向携带``@Auth``的方法，在方法执行前根据value值的内容，也就是``Level``的值去做不同的权限管理即可。\n - 优点：灵活可控，通用性还行。\n - 缺点：缺乏组件化，结构零散，不易复用，对于多种场景下需要制定多个切面，不优雅！\n\n### 方案四：使用框架\n这是最简单的方法，例如优秀的开源``shiro``、``spring-Security``等都可以满足我们的需求，唯一的区别是框架的轻重及使用方式！\n\n## 如何更优雅的管理权限\n想必很多同学都在使用第四种方案，也有不少的小伙伴在使用方案三，对于缺点明显的方案一和二，使用的应该很少。\n\n如果我们的服务并不需要那么重的权限管理框架去解决权限问题，又不想不优雅的自定义注解去实现时，我们该怎么办呢？\n\n不妨试试 [Defender](https://github.com/ainilili/defender)\n### Defender是什么\n``defender``是一款全面拥抱``spring-boot``的轻量级，高灵活，高可用的权限框架。如果日常中我们需要更加便捷的对服务增加权限管理，那么``defender``正合适！\n\n![](https://user-gold-cdn.xitu.io/2018/12/11/1679d0bbcd681a0d?w=871&h=278&f=png&s=13234)\n\n它可以免除我们重复编写自定义注解和切面，只需要调用简单的API即可灵活的指定不同模式的防御网络。\n\n``defender``提供很多种防御模式，我们可以通过调用简单的api是使用构建不同模式的校验器，从而迅速完成权限的管理：\n```\n@Configuration\n@EnableDefender(\"* org.nico.trap.controller..*.*(..)\")\npublic class DefenderTestConfig {\n\t@Bean\n\tpublic Defender init(){\n\t\treturn Defender.getInstance()\n\t\t\t\t.registry(Guarder.builder(GuarderType.URI)\n\t\t\t\t\t\t.pattern(\"POST /user/*\")\n\t\t\t\t\t\t.preventer(caller -> {\n\t\t\t\t\t\t\treturn caller.getRequest().getHeader(\"token\") == null \n\t\t\t\t\t\t\t\t? Result.pass() : Result.notpass(\"error\");\n\t\t\t\t\t\t}))\n\t\t\t\t.ready();\n\t}\n}\n```\n上述代码的作用是对请求符合``POST``类型且URI前缀为``/user/``的所有接口做了权限管理。\n\n另外，我们可以使用``lambda``简单完成权限校验逻辑，又或者使用匿名类实现复杂校验逻辑：\n```\nGuarder.builder(GuarderType.ANNOTATION)\n\t\t.pattern(\"org.nico.trap.controller\")\n\t\t.preventer(new AbstractPreventer() {\n\t\t\t\n\t\t\t@Autowired\n\t\t\tprivate AuthComponent authComponent;\n\t\t\t\n\t\t\t@Override\n\t\t\tpublic Result detection(Caller caller) {\n\t\t\t\tString identity = caller.getAccess().value();\n\t\t\t\tif(! identity.equals(AuthConst.VISITOR)) {\n\t\t\t\t\tUserBo user = authComponent.getUser();\n\t\t\t\t\tif(user != null) {\n\t\t\t\t\t\tif(identity.equals(AuthConst.ADMIN)){\n\t\t\t\t\t\t\tif(user.getRuleType() == null) {\n\t\t\t\t\t\t\t\treturn Result.notpass(new ResponseVo<>(ResponseCode.ERROR_ON_USER_IDENTITY_MISMATCH));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}else {\n\t\t\t\t\t\treturn Result.notpass(new ResponseVo<>(ResponseCode.ERROR_ON_LOGIN_INVALID));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Result.pass();\n\t\t\t}\n\t\t})\n```\n其中``GuarderType.URI``和``GuarderType.ANNOTATION``分别代表URI ANT匹配模式和注解模式，后者是方案三的实现，``defender``提供简单优雅的api将各种模式的权限校验方式集合在一起。\n\n相比``shiro``、``spring-security``，``defender``显得更加轻便灵活，因为它并没有提供一系列权限更具体的管理实现，而是将校验的实现开放一个接口面向开发者，总体代码大小不超过``21k``，显然对于轻量级的权限管理，``defender``更加适合！\n\n``defender``刚刚起步，如果大家有兴趣可以将之集成在您的开发环境尝一下鲜，项目地址如下\n\n > [Defender传送门](https://github.com/ainilili/defender)\n \n官方也提供有简单的使用文档\n\n > [中文文档](https://github.com/ainilili/defender/blob/master/DOC_CN.md)\n \n > [English Document](https://github.com/ainilili/defender/blob/master/DOC_EN.md)\n \n如果您感觉不错，也想参与贡献\n\n > [如何贡献](https://github.com/ainilili/defender/blob/master/CONTRIBUTING.md)\n\n\n","source":"_posts/如何使用Defender优雅的管理权限？.md","raw":"title: 如何使用Defender优雅的管理权限？\nauthor: Nico\ndate: 2018-12-11 20:09:51\ntags:\n---\n## 何为权限管理\n权限管理已经不知不觉深入到了我们生活的每一个角落，例如地铁进站的闸机，高速公路上的过路费，停车场的杠杆等等等等。\n\n作为一名开发人员，权限二字对我们的映像更加深刻，无论任何系统，都多多少少与权限管理会沾上关系！什么？你的系统和权限不沾边......好吧，你的代码拉取权限总得有吧！如果还没有的话，你登上掘金看到这篇文章并点了一个赞这个过程就需要好多次权限校验。好了扯远了，我们回归正题，这里使用一张图来简单展示web系统的权限是什么样子：\n\n![](https://user-gold-cdn.xitu.io/2018/12/11/1679cf52d7e57736?w=734&h=214&f=png&s=18626)\n\n看完之后，是不是感觉很简单，不错，权限管理并不难，我们只需要将**校验**这一环节进行开发即可，实现方式也有很多种：\n### 方案一：组件封装\n我们可以将权限校验的整个过程组件化，例如组件名为``AuthComponent``，之后再所有需要权限校验的接口对应的方法的开头，调用``AuthComponent``的``verify``方法进行校验，根据结果做不同的业务处理！\n - 优点：貌似能达到主要目的，而且非常灵活~\n - 缺点：代码冗余，低内聚，高耦合，不易于维护。\n\n### 方案二：通用处理\n在方案一的基础上我们稍加改造，例如使用``AOP``对需要校验的接口做个切面，在方法执行前我们使用``AuthComponent``校验一下即可，这样我们的代码就更方便维护了！\n - 优点：弥补了方案一的缺点。\n - 缺点：太过通用化，很难兼容所有的情况，不灵活。\n\n### 方案三：自定义注解\n我们将方案一和方案二结合一下，取一灵活，取二通用，我们自定义一个名为``@Auth``的注解，并且它需要传一个参数，我们这里直径定义为枚举类``Level``，简单结构如下：\n```\npublic enum Level { LOGIN, ADMIN }\n```\n之后我们定义一个注解切面，切向携带``@Auth``的方法，在方法执行前根据value值的内容，也就是``Level``的值去做不同的权限管理即可。\n - 优点：灵活可控，通用性还行。\n - 缺点：缺乏组件化，结构零散，不易复用，对于多种场景下需要制定多个切面，不优雅！\n\n### 方案四：使用框架\n这是最简单的方法，例如优秀的开源``shiro``、``spring-Security``等都可以满足我们的需求，唯一的区别是框架的轻重及使用方式！\n\n## 如何更优雅的管理权限\n想必很多同学都在使用第四种方案，也有不少的小伙伴在使用方案三，对于缺点明显的方案一和二，使用的应该很少。\n\n如果我们的服务并不需要那么重的权限管理框架去解决权限问题，又不想不优雅的自定义注解去实现时，我们该怎么办呢？\n\n不妨试试 [Defender](https://github.com/ainilili/defender)\n### Defender是什么\n``defender``是一款全面拥抱``spring-boot``的轻量级，高灵活，高可用的权限框架。如果日常中我们需要更加便捷的对服务增加权限管理，那么``defender``正合适！\n\n![](https://user-gold-cdn.xitu.io/2018/12/11/1679d0bbcd681a0d?w=871&h=278&f=png&s=13234)\n\n它可以免除我们重复编写自定义注解和切面，只需要调用简单的API即可灵活的指定不同模式的防御网络。\n\n``defender``提供很多种防御模式，我们可以通过调用简单的api是使用构建不同模式的校验器，从而迅速完成权限的管理：\n```\n@Configuration\n@EnableDefender(\"* org.nico.trap.controller..*.*(..)\")\npublic class DefenderTestConfig {\n\t@Bean\n\tpublic Defender init(){\n\t\treturn Defender.getInstance()\n\t\t\t\t.registry(Guarder.builder(GuarderType.URI)\n\t\t\t\t\t\t.pattern(\"POST /user/*\")\n\t\t\t\t\t\t.preventer(caller -> {\n\t\t\t\t\t\t\treturn caller.getRequest().getHeader(\"token\") == null \n\t\t\t\t\t\t\t\t? Result.pass() : Result.notpass(\"error\");\n\t\t\t\t\t\t}))\n\t\t\t\t.ready();\n\t}\n}\n```\n上述代码的作用是对请求符合``POST``类型且URI前缀为``/user/``的所有接口做了权限管理。\n\n另外，我们可以使用``lambda``简单完成权限校验逻辑，又或者使用匿名类实现复杂校验逻辑：\n```\nGuarder.builder(GuarderType.ANNOTATION)\n\t\t.pattern(\"org.nico.trap.controller\")\n\t\t.preventer(new AbstractPreventer() {\n\t\t\t\n\t\t\t@Autowired\n\t\t\tprivate AuthComponent authComponent;\n\t\t\t\n\t\t\t@Override\n\t\t\tpublic Result detection(Caller caller) {\n\t\t\t\tString identity = caller.getAccess().value();\n\t\t\t\tif(! identity.equals(AuthConst.VISITOR)) {\n\t\t\t\t\tUserBo user = authComponent.getUser();\n\t\t\t\t\tif(user != null) {\n\t\t\t\t\t\tif(identity.equals(AuthConst.ADMIN)){\n\t\t\t\t\t\t\tif(user.getRuleType() == null) {\n\t\t\t\t\t\t\t\treturn Result.notpass(new ResponseVo<>(ResponseCode.ERROR_ON_USER_IDENTITY_MISMATCH));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}else {\n\t\t\t\t\t\treturn Result.notpass(new ResponseVo<>(ResponseCode.ERROR_ON_LOGIN_INVALID));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Result.pass();\n\t\t\t}\n\t\t})\n```\n其中``GuarderType.URI``和``GuarderType.ANNOTATION``分别代表URI ANT匹配模式和注解模式，后者是方案三的实现，``defender``提供简单优雅的api将各种模式的权限校验方式集合在一起。\n\n相比``shiro``、``spring-security``，``defender``显得更加轻便灵活，因为它并没有提供一系列权限更具体的管理实现，而是将校验的实现开放一个接口面向开发者，总体代码大小不超过``21k``，显然对于轻量级的权限管理，``defender``更加适合！\n\n``defender``刚刚起步，如果大家有兴趣可以将之集成在您的开发环境尝一下鲜，项目地址如下\n\n > [Defender传送门](https://github.com/ainilili/defender)\n \n官方也提供有简单的使用文档\n\n > [中文文档](https://github.com/ainilili/defender/blob/master/DOC_CN.md)\n \n > [English Document](https://github.com/ainilili/defender/blob/master/DOC_EN.md)\n \n如果您感觉不错，也想参与贡献\n\n > [如何贡献](https://github.com/ainilili/defender/blob/master/CONTRIBUTING.md)\n\n\n","slug":"如何使用Defender优雅的管理权限？","published":1,"updated":"2021-03-21T17:43:04.536Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uy9000pb0tz76emakxm","content":"<h2 id=\"何为权限管理\"><a class=\"header-anchor\" href=\"#何为权限管理\">¶</a>何为权限管理</h2>\n<p>权限管理已经不知不觉深入到了我们生活的每一个角落，例如地铁进站的闸机，高速公路上的过路费，停车场的杠杆等等等等。</p>\n<p>作为一名开发人员，权限二字对我们的映像更加深刻，无论任何系统，都多多少少与权限管理会沾上关系！什么？你的系统和权限不沾边…好吧，你的代码拉取权限总得有吧！如果还没有的话，你登上掘金看到这篇文章并点了一个赞这个过程就需要好多次权限校验。好了扯远了，我们回归正题，这里使用一张图来简单展示web系统的权限是什么样子：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/12/11/1679cf52d7e57736?w=734&amp;h=214&amp;f=png&amp;s=18626\" alt=\"\"></p>\n<p>看完之后，是不是感觉很简单，不错，权限管理并不难，我们只需要将<strong>校验</strong>这一环节进行开发即可，实现方式也有很多种：</p>\n<h3 id=\"方案一：组件封装\"><a class=\"header-anchor\" href=\"#方案一：组件封装\">¶</a>方案一：组件封装</h3>\n<p>我们可以将权限校验的整个过程组件化，例如组件名为<code>AuthComponent</code>，之后再所有需要权限校验的接口对应的方法的开头，调用<code>AuthComponent</code>的<code>verify</code>方法进行校验，根据结果做不同的业务处理！</p>\n<ul>\n<li>优点：貌似能达到主要目的，而且非常灵活~</li>\n<li>缺点：代码冗余，低内聚，高耦合，不易于维护。</li>\n</ul>\n<h3 id=\"方案二：通用处理\"><a class=\"header-anchor\" href=\"#方案二：通用处理\">¶</a>方案二：通用处理</h3>\n<p>在方案一的基础上我们稍加改造，例如使用<code>AOP</code>对需要校验的接口做个切面，在方法执行前我们使用<code>AuthComponent</code>校验一下即可，这样我们的代码就更方便维护了！</p>\n<ul>\n<li>优点：弥补了方案一的缺点。</li>\n<li>缺点：太过通用化，很难兼容所有的情况，不灵活。</li>\n</ul>\n<h3 id=\"方案三：自定义注解\"><a class=\"header-anchor\" href=\"#方案三：自定义注解\">¶</a>方案三：自定义注解</h3>\n<p>我们将方案一和方案二结合一下，取一灵活，取二通用，我们自定义一个名为<code>@Auth</code>的注解，并且它需要传一个参数，我们这里直径定义为枚举类<code>Level</code>，简单结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public enum Level &#123; LOGIN, ADMIN &#125;</span><br></pre></td></tr></table></figure>\n<p>之后我们定义一个注解切面，切向携带<code>@Auth</code>的方法，在方法执行前根据value值的内容，也就是<code>Level</code>的值去做不同的权限管理即可。</p>\n<ul>\n<li>优点：灵活可控，通用性还行。</li>\n<li>缺点：缺乏组件化，结构零散，不易复用，对于多种场景下需要制定多个切面，不优雅！</li>\n</ul>\n<h3 id=\"方案四：使用框架\"><a class=\"header-anchor\" href=\"#方案四：使用框架\">¶</a>方案四：使用框架</h3>\n<p>这是最简单的方法，例如优秀的开源<code>shiro</code>、<code>spring-Security</code>等都可以满足我们的需求，唯一的区别是框架的轻重及使用方式！</p>\n<h2 id=\"如何更优雅的管理权限\"><a class=\"header-anchor\" href=\"#如何更优雅的管理权限\">¶</a>如何更优雅的管理权限</h2>\n<p>想必很多同学都在使用第四种方案，也有不少的小伙伴在使用方案三，对于缺点明显的方案一和二，使用的应该很少。</p>\n<p>如果我们的服务并不需要那么重的权限管理框架去解决权限问题，又不想不优雅的自定义注解去实现时，我们该怎么办呢？</p>\n<p>不妨试试 <a href=\"https://github.com/ainilili/defender\">Defender</a></p>\n<h3 id=\"defender是什么\"><a class=\"header-anchor\" href=\"#defender是什么\">¶</a>Defender是什么</h3>\n<p><code>defender</code>是一款全面拥抱<code>spring-boot</code>的轻量级，高灵活，高可用的权限框架。如果日常中我们需要更加便捷的对服务增加权限管理，那么<code>defender</code>正合适！</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/12/11/1679d0bbcd681a0d?w=871&amp;h=278&amp;f=png&amp;s=13234\" alt=\"\"></p>\n<p>它可以免除我们重复编写自定义注解和切面，只需要调用简单的API即可灵活的指定不同模式的防御网络。</p>\n<p><code>defender</code>提供很多种防御模式，我们可以通过调用简单的api是使用构建不同模式的校验器，从而迅速完成权限的管理：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@EnableDefender(&quot;* org.nico.trap.controller..*.*(..)&quot;)</span><br><span class=\"line\">public class DefenderTestConfig &#123;</span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic Defender init()&#123;</span><br><span class=\"line\">\t\treturn Defender.getInstance()</span><br><span class=\"line\">\t\t\t\t.registry(Guarder.builder(GuarderType.URI)</span><br><span class=\"line\">\t\t\t\t\t\t.pattern(&quot;POST /user/*&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.preventer(caller -&gt; &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\treturn caller.getRequest().getHeader(&quot;token&quot;) == null </span><br><span class=\"line\">\t\t\t\t\t\t\t\t? Result.pass() : Result.notpass(&quot;error&quot;);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;))</span><br><span class=\"line\">\t\t\t\t.ready();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的作用是对请求符合<code>POST</code>类型且URI前缀为<code>/user/</code>的所有接口做了权限管理。</p>\n<p>另外，我们可以使用<code>lambda</code>简单完成权限校验逻辑，又或者使用匿名类实现复杂校验逻辑：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Guarder.builder(GuarderType.ANNOTATION)</span><br><span class=\"line\">\t\t.pattern(&quot;org.nico.trap.controller&quot;)</span><br><span class=\"line\">\t\t.preventer(new AbstractPreventer() &#123;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t@Autowired</span><br><span class=\"line\">\t\t\tprivate AuthComponent authComponent;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t@Override</span><br><span class=\"line\">\t\t\tpublic Result detection(Caller caller) &#123;</span><br><span class=\"line\">\t\t\t\tString identity = caller.getAccess().value();</span><br><span class=\"line\">\t\t\t\tif(! identity.equals(AuthConst.VISITOR)) &#123;</span><br><span class=\"line\">\t\t\t\t\tUserBo user = authComponent.getUser();</span><br><span class=\"line\">\t\t\t\t\tif(user != null) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tif(identity.equals(AuthConst.ADMIN))&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tif(user.getRuleType() == null) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\treturn Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_USER_IDENTITY_MISMATCH));</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;else &#123;</span><br><span class=\"line\">\t\t\t\t\t\treturn Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_LOGIN_INVALID));</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\treturn Result.pass();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;)</span><br></pre></td></tr></table></figure>\n<p>其中<code>GuarderType.URI</code>和<code>GuarderType.ANNOTATION</code>分别代表URI ANT匹配模式和注解模式，后者是方案三的实现，<code>defender</code>提供简单优雅的api将各种模式的权限校验方式集合在一起。</p>\n<p>相比<code>shiro</code>、<code>spring-security</code>，<code>defender</code>显得更加轻便灵活，因为它并没有提供一系列权限更具体的管理实现，而是将校验的实现开放一个接口面向开发者，总体代码大小不超过<code>21k</code>，显然对于轻量级的权限管理，<code>defender</code>更加适合！</p>\n<p><code>defender</code>刚刚起步，如果大家有兴趣可以将之集成在您的开发环境尝一下鲜，项目地址如下</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender\">Defender传送门</a></p>\n</blockquote>\n<p>官方也提供有简单的使用文档</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/DOC_CN.md\">中文文档</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/DOC_EN.md\">English Document</a></p>\n</blockquote>\n<p>如果您感觉不错，也想参与贡献</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/CONTRIBUTING.md\">如何贡献</a></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"何为权限管理\"><a class=\"header-anchor\" href=\"#何为权限管理\">¶</a>何为权限管理</h2>\n<p>权限管理已经不知不觉深入到了我们生活的每一个角落，例如地铁进站的闸机，高速公路上的过路费，停车场的杠杆等等等等。</p>\n<p>作为一名开发人员，权限二字对我们的映像更加深刻，无论任何系统，都多多少少与权限管理会沾上关系！什么？你的系统和权限不沾边…好吧，你的代码拉取权限总得有吧！如果还没有的话，你登上掘金看到这篇文章并点了一个赞这个过程就需要好多次权限校验。好了扯远了，我们回归正题，这里使用一张图来简单展示web系统的权限是什么样子：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/12/11/1679cf52d7e57736?w=734&amp;h=214&amp;f=png&amp;s=18626\" alt=\"\"></p>\n<p>看完之后，是不是感觉很简单，不错，权限管理并不难，我们只需要将<strong>校验</strong>这一环节进行开发即可，实现方式也有很多种：</p>\n<h3 id=\"方案一：组件封装\"><a class=\"header-anchor\" href=\"#方案一：组件封装\">¶</a>方案一：组件封装</h3>\n<p>我们可以将权限校验的整个过程组件化，例如组件名为<code>AuthComponent</code>，之后再所有需要权限校验的接口对应的方法的开头，调用<code>AuthComponent</code>的<code>verify</code>方法进行校验，根据结果做不同的业务处理！</p>\n<ul>\n<li>优点：貌似能达到主要目的，而且非常灵活~</li>\n<li>缺点：代码冗余，低内聚，高耦合，不易于维护。</li>\n</ul>\n<h3 id=\"方案二：通用处理\"><a class=\"header-anchor\" href=\"#方案二：通用处理\">¶</a>方案二：通用处理</h3>\n<p>在方案一的基础上我们稍加改造，例如使用<code>AOP</code>对需要校验的接口做个切面，在方法执行前我们使用<code>AuthComponent</code>校验一下即可，这样我们的代码就更方便维护了！</p>\n<ul>\n<li>优点：弥补了方案一的缺点。</li>\n<li>缺点：太过通用化，很难兼容所有的情况，不灵活。</li>\n</ul>\n<h3 id=\"方案三：自定义注解\"><a class=\"header-anchor\" href=\"#方案三：自定义注解\">¶</a>方案三：自定义注解</h3>\n<p>我们将方案一和方案二结合一下，取一灵活，取二通用，我们自定义一个名为<code>@Auth</code>的注解，并且它需要传一个参数，我们这里直径定义为枚举类<code>Level</code>，简单结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public enum Level &#123; LOGIN, ADMIN &#125;</span><br></pre></td></tr></table></figure>\n<p>之后我们定义一个注解切面，切向携带<code>@Auth</code>的方法，在方法执行前根据value值的内容，也就是<code>Level</code>的值去做不同的权限管理即可。</p>\n<ul>\n<li>优点：灵活可控，通用性还行。</li>\n<li>缺点：缺乏组件化，结构零散，不易复用，对于多种场景下需要制定多个切面，不优雅！</li>\n</ul>\n<h3 id=\"方案四：使用框架\"><a class=\"header-anchor\" href=\"#方案四：使用框架\">¶</a>方案四：使用框架</h3>\n<p>这是最简单的方法，例如优秀的开源<code>shiro</code>、<code>spring-Security</code>等都可以满足我们的需求，唯一的区别是框架的轻重及使用方式！</p>\n<h2 id=\"如何更优雅的管理权限\"><a class=\"header-anchor\" href=\"#如何更优雅的管理权限\">¶</a>如何更优雅的管理权限</h2>\n<p>想必很多同学都在使用第四种方案，也有不少的小伙伴在使用方案三，对于缺点明显的方案一和二，使用的应该很少。</p>\n<p>如果我们的服务并不需要那么重的权限管理框架去解决权限问题，又不想不优雅的自定义注解去实现时，我们该怎么办呢？</p>\n<p>不妨试试 <a href=\"https://github.com/ainilili/defender\">Defender</a></p>\n<h3 id=\"defender是什么\"><a class=\"header-anchor\" href=\"#defender是什么\">¶</a>Defender是什么</h3>\n<p><code>defender</code>是一款全面拥抱<code>spring-boot</code>的轻量级，高灵活，高可用的权限框架。如果日常中我们需要更加便捷的对服务增加权限管理，那么<code>defender</code>正合适！</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/12/11/1679d0bbcd681a0d?w=871&amp;h=278&amp;f=png&amp;s=13234\" alt=\"\"></p>\n<p>它可以免除我们重复编写自定义注解和切面，只需要调用简单的API即可灵活的指定不同模式的防御网络。</p>\n<p><code>defender</code>提供很多种防御模式，我们可以通过调用简单的api是使用构建不同模式的校验器，从而迅速完成权限的管理：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@EnableDefender(&quot;* org.nico.trap.controller..*.*(..)&quot;)</span><br><span class=\"line\">public class DefenderTestConfig &#123;</span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic Defender init()&#123;</span><br><span class=\"line\">\t\treturn Defender.getInstance()</span><br><span class=\"line\">\t\t\t\t.registry(Guarder.builder(GuarderType.URI)</span><br><span class=\"line\">\t\t\t\t\t\t.pattern(&quot;POST /user/*&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.preventer(caller -&gt; &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\treturn caller.getRequest().getHeader(&quot;token&quot;) == null </span><br><span class=\"line\">\t\t\t\t\t\t\t\t? Result.pass() : Result.notpass(&quot;error&quot;);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;))</span><br><span class=\"line\">\t\t\t\t.ready();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的作用是对请求符合<code>POST</code>类型且URI前缀为<code>/user/</code>的所有接口做了权限管理。</p>\n<p>另外，我们可以使用<code>lambda</code>简单完成权限校验逻辑，又或者使用匿名类实现复杂校验逻辑：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Guarder.builder(GuarderType.ANNOTATION)</span><br><span class=\"line\">\t\t.pattern(&quot;org.nico.trap.controller&quot;)</span><br><span class=\"line\">\t\t.preventer(new AbstractPreventer() &#123;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t@Autowired</span><br><span class=\"line\">\t\t\tprivate AuthComponent authComponent;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t@Override</span><br><span class=\"line\">\t\t\tpublic Result detection(Caller caller) &#123;</span><br><span class=\"line\">\t\t\t\tString identity = caller.getAccess().value();</span><br><span class=\"line\">\t\t\t\tif(! identity.equals(AuthConst.VISITOR)) &#123;</span><br><span class=\"line\">\t\t\t\t\tUserBo user = authComponent.getUser();</span><br><span class=\"line\">\t\t\t\t\tif(user != null) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tif(identity.equals(AuthConst.ADMIN))&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tif(user.getRuleType() == null) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\treturn Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_USER_IDENTITY_MISMATCH));</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;else &#123;</span><br><span class=\"line\">\t\t\t\t\t\treturn Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_LOGIN_INVALID));</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\treturn Result.pass();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;)</span><br></pre></td></tr></table></figure>\n<p>其中<code>GuarderType.URI</code>和<code>GuarderType.ANNOTATION</code>分别代表URI ANT匹配模式和注解模式，后者是方案三的实现，<code>defender</code>提供简单优雅的api将各种模式的权限校验方式集合在一起。</p>\n<p>相比<code>shiro</code>、<code>spring-security</code>，<code>defender</code>显得更加轻便灵活，因为它并没有提供一系列权限更具体的管理实现，而是将校验的实现开放一个接口面向开发者，总体代码大小不超过<code>21k</code>，显然对于轻量级的权限管理，<code>defender</code>更加适合！</p>\n<p><code>defender</code>刚刚起步，如果大家有兴趣可以将之集成在您的开发环境尝一下鲜，项目地址如下</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender\">Defender传送门</a></p>\n</blockquote>\n<p>官方也提供有简单的使用文档</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/DOC_CN.md\">中文文档</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/DOC_EN.md\">English Document</a></p>\n</blockquote>\n<p>如果您感觉不错，也想参与贡献</p>\n<blockquote>\n<p><a href=\"https://github.com/ainilili/defender/blob/master/CONTRIBUTING.md\">如何贡献</a></p>\n</blockquote>\n"},{"title":"Spring Cloud Gateway深入探究","author":"Nico","date":"2018-11-06T04:41:00.000Z","_content":"## Spring Cloud Gateway介绍\n废话不多说，看官方文档的介绍\n> This project provides an API Gateway built on top of the Spring Ecosystem, including: Spring 5, Spring Boot 2 and Project Reactor. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.\n\n有道翻译一下:\n\n这个项目提供了一个建在Spring生态系统之上的API网关，包括:Spring 5, Spring Boot 2和project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到api，并为它们提供交叉关注，例如:安全性、监视/度量和弹性。\n\n工作原理如下：\n\n![image](https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png)\n\nGateway实际上提供了一个在路由上的控制功能，大体包含两个大功能：\n - Route\n - Filter\n - Forward\n\n我们可以通过Route去匹配请求的uri，而每个Router下可以配置一个Filter Chain，我们可以通过Filter去修饰请求和响应及一些类似鉴权等中间动作，通过Forward可以控制重定向和请求转发（实际上Filter也可以做到，只不过这里分开说清晰一点）。在路由控制上，Gateway表现的非常灵活，它有两种配置方式：\n - Yml or Properties File\n - Code\n\n主要名词如下：\n - **Route**: Route the basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates and a collection of filters. A route is matched if aggregate predicate is true.\n - **Predicate**: This is a Java 8 Function Predicate. The input type is a Spring Framework ServerWebExchange. This allows developers to match on anything from the HTTP request, such as headers or parameters.\n - **Filter**: These are instances Spring Framework GatewayFilter constructed in with a specific factory. Here, requests and responses can be modified before or after sending the downstream request.\n\nRoute 作为Gateway中的基本元素，它有自己的ID、URI和一个Predicate集合、Filter集合。Predicate的作用是判断请求的Uri是否匹配当前的Route，Filter则是匹配通过之后对请求和响应的处理及修饰，那么在Gateway中Route基本结构如下\n```\nGateway{\n    Route1 {\n        String id;\n        String path;\n        List<Predicate> predicates;\n        List<Filter> filters;\n    };\n    Route2 {\n        String id;\n        String path;\n        List<Predicate> predicates;\n        List<Filter> filters;\n    };\n    ...\n    ...\n}\n```\nRoute中的ID作为它的唯一标识，path的作用是正则匹配请求路径，Predicate则是在path匹配的情况下进一步去更加细致的匹配请求路径，如一下例子：\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: before_route\n        uri: http://example.org\n        predicates:\n        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]\n```\n只匹配在``Jan 20, 2017 17:42`` 发起的请求\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: cookie_route\n        uri: http://example.org\n        predicates:\n        - Cookie=chocolate, “”\n```\n只匹配请求中携带``chocolate``且值为``ch.p``的请求\n\n更多例子这里就不一一展开，有兴趣的可以去看下官方文档: [传送门](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-request-predicates-factories)\n\n## Spring Cloud Gateway 配置\n#### Maven\n```\n<dependencyManagement>\n\t\t<dependencies>\n\t\t\t<dependency>\n\t\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t\t<artifactId>spring-cloud-gateway</artifactId>\n\t\t\t\t<version>2.0.2.BUILD-SNAPSHOT</version>\n\t\t\t\t<type>pom</type>\n\t\t\t\t<scope>import</scope>\n\t\t\t</dependency>\n\t\t</dependencies>\n\t</dependencyManagement>\n\t<dependencies>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-gateway</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t    <groupId>org.yaml</groupId>\n\t\t    <artifactId>snakeyaml</artifactId>\n\t\t</dependency>\n\t</dependencies>\n\t<repositories>\n\t\t<repository>\n\t\t\t<id>spring-snapshots</id>\n\t\t\t<name>Spring Snapshots</name>\n\t\t\t<url>https://repo.spring.io/libs-snapshot</url>\n\t\t\t<snapshots>\n\t\t\t\t<enabled>true</enabled>\n\t\t\t</snapshots>\n\t\t</repository>\n\t</repositories>\n```\n#### Yml\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: cookie_route\n        uri: http://example.org\n        predicates:\n        - Cookie=chocolate, ch.p\n```\n#### Java Config\n```\n@Configuration\n@RestController\n@SpringBootApplication\npublic class Application {\n\n\t@Bean\n\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\t\treturn builder.routes()\n\t\t\t\t.route(r -> r.path(\"/request/**\")\n\t\t\t\t\t\t.and()\n\t\t\t\t\t\t.predicate(new Predicate<ServerWebExchange>() {\n\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\tpublic boolean test(ServerWebExchange t) {\n\t\t\t\t\t\t\t\tboolean access = t.getRequest().getCookies().get(\"_9755xjdesxxd_\").get(0).getValue().equals(\"32\");\n\t\t\t\t\t\t\t\treturn access;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.filters(f -> f.stripPrefix(2)\n\t\t\t\t\t\t\t.filter(new GatewayFilter() {\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}, 2)\n\t\t\t\t\t\t\t.filter(new GatewayFilter() {\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}, 1))\n\t\t\t\t\t\t.uri(\"http://localhost:8080/hello\")\n\t\t\t\t\t\t).build();\n\t}\n\t\n\t@GetMapping(\"/hello\")\n\tpublic String hello() {\n\t\treturn \"hello\";\n\t}\n\n\tpublic static void main(String[] args) throws ClassNotFoundException {\n\t\tSpringApplication.run(Application.class, args);\n\t}\n\n}\n```\nYml配置和Java代码配置可以共存，Yml配置的好处是可以直接用自带的一些谓词和Filter，而Java代码配置更加灵活！\n## Spring Cloud Gateway使用\n上文已经说过，Gateway支持两种配置，本文主要以Java Config的方式着重讲解，因为官方文档中对于Yml配置的讲解已经足够深入，如有兴趣可以进入[传送门](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-how-it-works)\n\n#### Route\n一个Route的配置可以足够简单\n```\n@Configuration\n@RestController\n@SpringBootApplication\npublic class Application1 {\n\n\t@Bean\n\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\t\treturn builder.routes()\n\t\t\t\t.route(r -> r.path(\"/user/**\")\n\t\t\t\t\t\t.uri(\"http://localhost:8080/hello\")\n\t\t\t\t\t\t).build();\n\t}\n\t\n\t@GetMapping(\"/hello\")\n\tpublic String hello() {\n\t\treturn \"hello\";\n\t}\n\n\tpublic static void main(String[] args) throws ClassNotFoundException {\n\t\tSpringApplication.run(Application1.class, args);\n\t}\n\n}\n```\n上述Demo定义了一个Route，并且path值为``/**``，意味着匹配多层uri，如果将path改为``/*``则意味着只能匹配一层。所以运行上面的程序，那么所有的请求都将被转发到``http://localhost:8080/hello``\n\n如果uri的配置并没有一个确定的资源，例如``http://ip:port``，那么``/**``所匹配的路径将会自动拼装在uri之后：\n```\nrequest http://当前服务/user/1\nforward http://ip:port/user/1\n```\n这种方式更适合服务之间的转发，我们可以将uri设置为``ip:port``也可以设置为``xxx.com``域名，但是不能自己转发自己的服务，例如\n```\nrequest http://当前服务/user/1\nforward http://当前服务/user/1\n```\n这就导致了HTTP 413的错误，无限转发至自己，也就意味着请求死锁，非常致命！最好的方式如下：\n\n我们拟定开两个服务占用的端口分别是``8080``和``8081``,我们假如要从``8080``服务通过``/user/**``路由匹配转发至``8081``服务，可以这样做：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n工作跟踪：\n```\nrequest http://localhost:8080/user/hello\nforward http://localhost:8081/user/hello\n```\n8081服务接口定义：\n```\n@GetMapping(\"/user/hello\")\npublic String hello() {\n\treturn \"User Say Hello\";\n}\n```\nReponse Body：\n```\nUser Say Hello\n```\n\n当Gateway代替Zuul时，也就是说在服务间的通讯由Zuul转换成Gateway之后，uri的写法将会变成这个样子：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(r -> r.path(\"user/**\")\n\t\t\t\t\t.uri(\"lb://USER_SERVER_NAME\")\n\t\t\t\t\t).build();\n}\n```\n上述代码将``user/**``所匹配的请求全部转发到``USER_SERVER_NAME``服务下：\n```\nrequest /user/1\nforward http://USER_SERVER_HOST:USER_SERVER_PORT/user/1\n```\n其中**lb**的含义其实是``load balance``的意思，我想开发者以lb来区分路由模式可能是负载均衡意味着多服务的环境，因此lb可以表示转发对象从指定的uri转变成了服务！\n#### Predicate\nPredicate是Java 8+新出的一个库，本身作用是进行逻辑运算，支持种类如下：\n- isEqual\n- and\n- negate\n- or\n另外还有一个方法``test(T)``用于触发逻辑计算返回一个Boolean类型值。\n\nGateway使用Predicate来做除path pattern match之外的匹配判断，使用及其简单：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.predicate(e -> e.getClass() != null)\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n输入的**e**代表着``ServerWebExchange``对象，我们可以通过``ServerWebExchange``获取所有请求相关的信息，例如Cookies和Headers。通过Lambda语法去编写判断逻辑，如果一个Route中所有的Predicate返回的结果都是TRUE则匹配成功，否则匹配失败。\n\n> Tp：path和predicate需要使用and链接，也可以使用or链接，分别代表不同的逻辑运算！\n\n#### Filter\nFilter的作用类似于Predicate，区别在于，Predicate可以做请求中断，Filter也可以做，Filter可以做Reponse的修饰，Predicate并做不到，也就是说Filter最为最后一道拦截，可以做的事情有很多，例如修改响应报文，增加个Header或者Cookie，甚至修改响应Body，相比之下，Filter更加全能！\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.predicate(e -> e.getClass() != null)\n\t\t\t\t\t.filters(fn -> fn.addResponseHeader(\"developer\", \"Nico\"))\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n## Spring Cloud Gateway 工作原理\nGateway是基于Spring MVC之上的网关路由控制器，我们可以直接定位到Spring MVC的``org.springframework.web.reactive.DispatcherHandler``类，它的``handle``方法将会处理解析Request之后的``ServerWebExchange``对象。\n\n进入``handle``方法，将会使用Flux遍历``org.springframework.web.reactive.DispatcherHandler.handlerMappings``对``ServerWebExchange``进行处理,``handlerMappings``中包含着一下处理器：\n```\norg.springframework.web.reactive.function.server.support.RouterFunctionMapping@247a29b6, org.springframework.web.reactive.result.method.annotation.RequestMappingHandlerMapping@f6449f4, org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping@535c6b8b,\norg.springframework.web.reactive.handler.SimpleUrlHandlerMapping@5633e9e\n```\n以上只是一个简单请求的处理器，Flux的``concatMap``方法会将每个处理器的Mono合并成一个Flux，然后调用``org.springframework.web.reactive.DispatcherHandler``类中的``invokeHandler``方法开始处理``ServerWebExchange``,处理完毕之后将紧接着处理返回值，这时使用``handleResult``方法，具体实现如下：\n```\n@Override\npublic Mono<Void> handle(ServerWebExchange exchange) {\n\tif (logger.isDebugEnabled()) {\n\t\tServerHttpRequest request = exchange.getRequest();\n\t\tlogger.debug(\"Processing \" + request.getMethodValue() + \" request for [\" + request.getURI() + \"]\");\n\t}\n\tif (this.handlerMappings == null) {\n\t\treturn Mono.error(HANDLER_NOT_FOUND_EXCEPTION);\n\t}\n\treturn Flux.fromIterable(this.handlerMappings)\n\t\t\t.concatMap(mapping -> mapping.getHandler(exchange))\n\t\t\t.next()\n\t\t\t.switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))\n\t\t\t.flatMap(handler -> invokeHandler(exchange, handler))\n\t\t\t.flatMap(result -> handleResult(exchange, result));\n}\n```\n\nGateway起作用的关键在于``invokeHandler``方法中：\n```\nprivate Mono<HandlerResult> invokeHandler(ServerWebExchange exchange, Object handler) {\n\tif (this.handlerAdapters != null) {\n\t\tfor (HandlerAdapter handlerAdapter : this.handlerAdapters) {\n\t\t\tif (handlerAdapter.supports(handler)) {\n\t\t\t\treturn handlerAdapter.handle(exchange, handler);\n\t\t\t}\n\t\t}\n\t}\n\treturn Mono.error(new IllegalStateException(\"No HandlerAdapter: \" + handler));\n}\n```\n\n\n\n\n对应的处理器的适配器匹配到本身之后，将会触发适配器的处理方法，每个处理器都会实现一个对应的接口，他们大致都有一个共同的特点：\n```\npublic interface Handler {\n\n\tMono<Void> handle(ServerWebExchange exchange);\n\n}\n```\n每个适配器的处理方法中都会在穿插入适配逻辑代码之后调用处理器的``handle``方法，Spring Cloud Gateway的所有Handler都在```org.springframework.cloud.gateway.handler```包下：\n```\norg.springframework.cloud.gateway.handler.AsyncPredicate<T>\norg.springframework.cloud.gateway.handler.FilteringWebHandler\norg.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping\n```\n可以看到，上述三个处理器分别处理了Filter和Predicate，有兴趣的朋友可以去看一下这些类内部的具体实现，这里就不一一细说。\n\n总的来讲，Spring Cloud Gateway的原理是在服务加载期间读取自己的配置将信息存放在一个容器中，在Spring Mvc 处理请求的时候取出这些信息进行**逻辑判断**及**过滤**，根据不同的处理结果触发不同的事件！\n\n而请求转发这一块有兴趣的同学可以去研究一下！\n\n> TP: path的匹配其实也是一个Predicate逻辑判断\n\n## Spring Cloud Gateway 总结\n笔者偶然间看到spring-cloud-netflix的issue下的一个回答[传送门](https://github.com/spring-cloud/spring-cloud-netflix/issues/2951)：\n```\nLovnx：Zuul 2.0 has opened sourcing,Do you intend to integrate it in some next version?\nspencergibb：No. We created spring cloud gateway instead.\n```\n这才感觉到Spring Cloud果然霸气，也因此接触到了Spring Cloud Gateway，觉得很有必要学习一下，总体来讲，Spring Cloud Gateway简化了之前过滤器配置的复杂度，也在新的配置方式上增加了微服务的网关配置，可以直接代替掉Zuul，期待着Spring会整出自己的注册中心来。\n\n笔者学艺不精，以上阐述有误的地方，希望批评指出，联系方式：ainililia@163.com\n\n## 相关文档\n[官方文档](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#_glossary)\n[Spring Cloud Gateway 入门](http://ju.outofmemory.cn/entry/346688)\n[响应式编程之Reactor的关于Flux和Mono概念](https://blog.csdn.net/qq_28089993/article/details/79443447)","source":"_posts/Spring-Cloud-Gateway深入探究.md","raw":"title: Spring Cloud Gateway深入探究\nauthor: Nico\ntags: []\ncategories: []\ndate: 2018-11-06 12:41:00\n---\n## Spring Cloud Gateway介绍\n废话不多说，看官方文档的介绍\n> This project provides an API Gateway built on top of the Spring Ecosystem, including: Spring 5, Spring Boot 2 and Project Reactor. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.\n\n有道翻译一下:\n\n这个项目提供了一个建在Spring生态系统之上的API网关，包括:Spring 5, Spring Boot 2和project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到api，并为它们提供交叉关注，例如:安全性、监视/度量和弹性。\n\n工作原理如下：\n\n![image](https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png)\n\nGateway实际上提供了一个在路由上的控制功能，大体包含两个大功能：\n - Route\n - Filter\n - Forward\n\n我们可以通过Route去匹配请求的uri，而每个Router下可以配置一个Filter Chain，我们可以通过Filter去修饰请求和响应及一些类似鉴权等中间动作，通过Forward可以控制重定向和请求转发（实际上Filter也可以做到，只不过这里分开说清晰一点）。在路由控制上，Gateway表现的非常灵活，它有两种配置方式：\n - Yml or Properties File\n - Code\n\n主要名词如下：\n - **Route**: Route the basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates and a collection of filters. A route is matched if aggregate predicate is true.\n - **Predicate**: This is a Java 8 Function Predicate. The input type is a Spring Framework ServerWebExchange. This allows developers to match on anything from the HTTP request, such as headers or parameters.\n - **Filter**: These are instances Spring Framework GatewayFilter constructed in with a specific factory. Here, requests and responses can be modified before or after sending the downstream request.\n\nRoute 作为Gateway中的基本元素，它有自己的ID、URI和一个Predicate集合、Filter集合。Predicate的作用是判断请求的Uri是否匹配当前的Route，Filter则是匹配通过之后对请求和响应的处理及修饰，那么在Gateway中Route基本结构如下\n```\nGateway{\n    Route1 {\n        String id;\n        String path;\n        List<Predicate> predicates;\n        List<Filter> filters;\n    };\n    Route2 {\n        String id;\n        String path;\n        List<Predicate> predicates;\n        List<Filter> filters;\n    };\n    ...\n    ...\n}\n```\nRoute中的ID作为它的唯一标识，path的作用是正则匹配请求路径，Predicate则是在path匹配的情况下进一步去更加细致的匹配请求路径，如一下例子：\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: before_route\n        uri: http://example.org\n        predicates:\n        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]\n```\n只匹配在``Jan 20, 2017 17:42`` 发起的请求\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: cookie_route\n        uri: http://example.org\n        predicates:\n        - Cookie=chocolate, “”\n```\n只匹配请求中携带``chocolate``且值为``ch.p``的请求\n\n更多例子这里就不一一展开，有兴趣的可以去看下官方文档: [传送门](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-request-predicates-factories)\n\n## Spring Cloud Gateway 配置\n#### Maven\n```\n<dependencyManagement>\n\t\t<dependencies>\n\t\t\t<dependency>\n\t\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t\t<artifactId>spring-cloud-gateway</artifactId>\n\t\t\t\t<version>2.0.2.BUILD-SNAPSHOT</version>\n\t\t\t\t<type>pom</type>\n\t\t\t\t<scope>import</scope>\n\t\t\t</dependency>\n\t\t</dependencies>\n\t</dependencyManagement>\n\t<dependencies>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-gateway</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t    <groupId>org.yaml</groupId>\n\t\t    <artifactId>snakeyaml</artifactId>\n\t\t</dependency>\n\t</dependencies>\n\t<repositories>\n\t\t<repository>\n\t\t\t<id>spring-snapshots</id>\n\t\t\t<name>Spring Snapshots</name>\n\t\t\t<url>https://repo.spring.io/libs-snapshot</url>\n\t\t\t<snapshots>\n\t\t\t\t<enabled>true</enabled>\n\t\t\t</snapshots>\n\t\t</repository>\n\t</repositories>\n```\n#### Yml\n```\nspring:\n  cloud:\n    gateway:\n      routes:\n      - id: cookie_route\n        uri: http://example.org\n        predicates:\n        - Cookie=chocolate, ch.p\n```\n#### Java Config\n```\n@Configuration\n@RestController\n@SpringBootApplication\npublic class Application {\n\n\t@Bean\n\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\t\treturn builder.routes()\n\t\t\t\t.route(r -> r.path(\"/request/**\")\n\t\t\t\t\t\t.and()\n\t\t\t\t\t\t.predicate(new Predicate<ServerWebExchange>() {\n\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\tpublic boolean test(ServerWebExchange t) {\n\t\t\t\t\t\t\t\tboolean access = t.getRequest().getCookies().get(\"_9755xjdesxxd_\").get(0).getValue().equals(\"32\");\n\t\t\t\t\t\t\t\treturn access;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.filters(f -> f.stripPrefix(2)\n\t\t\t\t\t\t\t.filter(new GatewayFilter() {\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}, 2)\n\t\t\t\t\t\t\t.filter(new GatewayFilter() {\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}, 1))\n\t\t\t\t\t\t.uri(\"http://localhost:8080/hello\")\n\t\t\t\t\t\t).build();\n\t}\n\t\n\t@GetMapping(\"/hello\")\n\tpublic String hello() {\n\t\treturn \"hello\";\n\t}\n\n\tpublic static void main(String[] args) throws ClassNotFoundException {\n\t\tSpringApplication.run(Application.class, args);\n\t}\n\n}\n```\nYml配置和Java代码配置可以共存，Yml配置的好处是可以直接用自带的一些谓词和Filter，而Java代码配置更加灵活！\n## Spring Cloud Gateway使用\n上文已经说过，Gateway支持两种配置，本文主要以Java Config的方式着重讲解，因为官方文档中对于Yml配置的讲解已经足够深入，如有兴趣可以进入[传送门](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-how-it-works)\n\n#### Route\n一个Route的配置可以足够简单\n```\n@Configuration\n@RestController\n@SpringBootApplication\npublic class Application1 {\n\n\t@Bean\n\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\t\treturn builder.routes()\n\t\t\t\t.route(r -> r.path(\"/user/**\")\n\t\t\t\t\t\t.uri(\"http://localhost:8080/hello\")\n\t\t\t\t\t\t).build();\n\t}\n\t\n\t@GetMapping(\"/hello\")\n\tpublic String hello() {\n\t\treturn \"hello\";\n\t}\n\n\tpublic static void main(String[] args) throws ClassNotFoundException {\n\t\tSpringApplication.run(Application1.class, args);\n\t}\n\n}\n```\n上述Demo定义了一个Route，并且path值为``/**``，意味着匹配多层uri，如果将path改为``/*``则意味着只能匹配一层。所以运行上面的程序，那么所有的请求都将被转发到``http://localhost:8080/hello``\n\n如果uri的配置并没有一个确定的资源，例如``http://ip:port``，那么``/**``所匹配的路径将会自动拼装在uri之后：\n```\nrequest http://当前服务/user/1\nforward http://ip:port/user/1\n```\n这种方式更适合服务之间的转发，我们可以将uri设置为``ip:port``也可以设置为``xxx.com``域名，但是不能自己转发自己的服务，例如\n```\nrequest http://当前服务/user/1\nforward http://当前服务/user/1\n```\n这就导致了HTTP 413的错误，无限转发至自己，也就意味着请求死锁，非常致命！最好的方式如下：\n\n我们拟定开两个服务占用的端口分别是``8080``和``8081``,我们假如要从``8080``服务通过``/user/**``路由匹配转发至``8081``服务，可以这样做：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n工作跟踪：\n```\nrequest http://localhost:8080/user/hello\nforward http://localhost:8081/user/hello\n```\n8081服务接口定义：\n```\n@GetMapping(\"/user/hello\")\npublic String hello() {\n\treturn \"User Say Hello\";\n}\n```\nReponse Body：\n```\nUser Say Hello\n```\n\n当Gateway代替Zuul时，也就是说在服务间的通讯由Zuul转换成Gateway之后，uri的写法将会变成这个样子：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(r -> r.path(\"user/**\")\n\t\t\t\t\t.uri(\"lb://USER_SERVER_NAME\")\n\t\t\t\t\t).build();\n}\n```\n上述代码将``user/**``所匹配的请求全部转发到``USER_SERVER_NAME``服务下：\n```\nrequest /user/1\nforward http://USER_SERVER_HOST:USER_SERVER_PORT/user/1\n```\n其中**lb**的含义其实是``load balance``的意思，我想开发者以lb来区分路由模式可能是负载均衡意味着多服务的环境，因此lb可以表示转发对象从指定的uri转变成了服务！\n#### Predicate\nPredicate是Java 8+新出的一个库，本身作用是进行逻辑运算，支持种类如下：\n- isEqual\n- and\n- negate\n- or\n另外还有一个方法``test(T)``用于触发逻辑计算返回一个Boolean类型值。\n\nGateway使用Predicate来做除path pattern match之外的匹配判断，使用及其简单：\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.predicate(e -> e.getClass() != null)\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n输入的**e**代表着``ServerWebExchange``对象，我们可以通过``ServerWebExchange``获取所有请求相关的信息，例如Cookies和Headers。通过Lambda语法去编写判断逻辑，如果一个Route中所有的Predicate返回的结果都是TRUE则匹配成功，否则匹配失败。\n\n> Tp：path和predicate需要使用and链接，也可以使用or链接，分别代表不同的逻辑运算！\n\n#### Filter\nFilter的作用类似于Predicate，区别在于，Predicate可以做请求中断，Filter也可以做，Filter可以做Reponse的修饰，Predicate并做不到，也就是说Filter最为最后一道拦截，可以做的事情有很多，例如修改响应报文，增加个Header或者Cookie，甚至修改响应Body，相比之下，Filter更加全能！\n```\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\treturn builder.routes()\n\t\t\t.route(\"hello\", r -> r\n\t\t\t\t\t.path(\"/user/**\")\n\t\t\t\t\t.and()\n\t\t\t\t\t.predicate(e -> e.getClass() != null)\n\t\t\t\t\t.filters(fn -> fn.addResponseHeader(\"developer\", \"Nico\"))\n\t\t\t\t\t.uri(\"http://localhost:8081\")\n\t\t\t\t\t).build();\n}\n```\n## Spring Cloud Gateway 工作原理\nGateway是基于Spring MVC之上的网关路由控制器，我们可以直接定位到Spring MVC的``org.springframework.web.reactive.DispatcherHandler``类，它的``handle``方法将会处理解析Request之后的``ServerWebExchange``对象。\n\n进入``handle``方法，将会使用Flux遍历``org.springframework.web.reactive.DispatcherHandler.handlerMappings``对``ServerWebExchange``进行处理,``handlerMappings``中包含着一下处理器：\n```\norg.springframework.web.reactive.function.server.support.RouterFunctionMapping@247a29b6, org.springframework.web.reactive.result.method.annotation.RequestMappingHandlerMapping@f6449f4, org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping@535c6b8b,\norg.springframework.web.reactive.handler.SimpleUrlHandlerMapping@5633e9e\n```\n以上只是一个简单请求的处理器，Flux的``concatMap``方法会将每个处理器的Mono合并成一个Flux，然后调用``org.springframework.web.reactive.DispatcherHandler``类中的``invokeHandler``方法开始处理``ServerWebExchange``,处理完毕之后将紧接着处理返回值，这时使用``handleResult``方法，具体实现如下：\n```\n@Override\npublic Mono<Void> handle(ServerWebExchange exchange) {\n\tif (logger.isDebugEnabled()) {\n\t\tServerHttpRequest request = exchange.getRequest();\n\t\tlogger.debug(\"Processing \" + request.getMethodValue() + \" request for [\" + request.getURI() + \"]\");\n\t}\n\tif (this.handlerMappings == null) {\n\t\treturn Mono.error(HANDLER_NOT_FOUND_EXCEPTION);\n\t}\n\treturn Flux.fromIterable(this.handlerMappings)\n\t\t\t.concatMap(mapping -> mapping.getHandler(exchange))\n\t\t\t.next()\n\t\t\t.switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))\n\t\t\t.flatMap(handler -> invokeHandler(exchange, handler))\n\t\t\t.flatMap(result -> handleResult(exchange, result));\n}\n```\n\nGateway起作用的关键在于``invokeHandler``方法中：\n```\nprivate Mono<HandlerResult> invokeHandler(ServerWebExchange exchange, Object handler) {\n\tif (this.handlerAdapters != null) {\n\t\tfor (HandlerAdapter handlerAdapter : this.handlerAdapters) {\n\t\t\tif (handlerAdapter.supports(handler)) {\n\t\t\t\treturn handlerAdapter.handle(exchange, handler);\n\t\t\t}\n\t\t}\n\t}\n\treturn Mono.error(new IllegalStateException(\"No HandlerAdapter: \" + handler));\n}\n```\n\n\n\n\n对应的处理器的适配器匹配到本身之后，将会触发适配器的处理方法，每个处理器都会实现一个对应的接口，他们大致都有一个共同的特点：\n```\npublic interface Handler {\n\n\tMono<Void> handle(ServerWebExchange exchange);\n\n}\n```\n每个适配器的处理方法中都会在穿插入适配逻辑代码之后调用处理器的``handle``方法，Spring Cloud Gateway的所有Handler都在```org.springframework.cloud.gateway.handler```包下：\n```\norg.springframework.cloud.gateway.handler.AsyncPredicate<T>\norg.springframework.cloud.gateway.handler.FilteringWebHandler\norg.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping\n```\n可以看到，上述三个处理器分别处理了Filter和Predicate，有兴趣的朋友可以去看一下这些类内部的具体实现，这里就不一一细说。\n\n总的来讲，Spring Cloud Gateway的原理是在服务加载期间读取自己的配置将信息存放在一个容器中，在Spring Mvc 处理请求的时候取出这些信息进行**逻辑判断**及**过滤**，根据不同的处理结果触发不同的事件！\n\n而请求转发这一块有兴趣的同学可以去研究一下！\n\n> TP: path的匹配其实也是一个Predicate逻辑判断\n\n## Spring Cloud Gateway 总结\n笔者偶然间看到spring-cloud-netflix的issue下的一个回答[传送门](https://github.com/spring-cloud/spring-cloud-netflix/issues/2951)：\n```\nLovnx：Zuul 2.0 has opened sourcing,Do you intend to integrate it in some next version?\nspencergibb：No. We created spring cloud gateway instead.\n```\n这才感觉到Spring Cloud果然霸气，也因此接触到了Spring Cloud Gateway，觉得很有必要学习一下，总体来讲，Spring Cloud Gateway简化了之前过滤器配置的复杂度，也在新的配置方式上增加了微服务的网关配置，可以直接代替掉Zuul，期待着Spring会整出自己的注册中心来。\n\n笔者学艺不精，以上阐述有误的地方，希望批评指出，联系方式：ainililia@163.com\n\n## 相关文档\n[官方文档](http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#_glossary)\n[Spring Cloud Gateway 入门](http://ju.outofmemory.cn/entry/346688)\n[响应式编程之Reactor的关于Flux和Mono概念](https://blog.csdn.net/qq_28089993/article/details/79443447)","slug":"Spring-Cloud-Gateway深入探究","published":1,"updated":"2021-03-21T17:43:04.421Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uya000sb0tz9wxsd8t7","content":"<h2 id=\"spring-cloud-gateway介绍\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway介绍\">¶</a>Spring Cloud Gateway介绍</h2>\n<p>废话不多说，看官方文档的介绍</p>\n<blockquote>\n<p>This project provides an API Gateway built on top of the Spring Ecosystem, including: Spring 5, Spring Boot 2 and Project Reactor. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.</p>\n</blockquote>\n<p>有道翻译一下:</p>\n<p>这个项目提供了一个建在Spring生态系统之上的API网关，包括:Spring 5, Spring Boot 2和project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到api，并为它们提供交叉关注，例如:安全性、监视/度量和弹性。</p>\n<p>工作原理如下：</p>\n<p><img src=\"https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png\" alt=\"image\"></p>\n<p>Gateway实际上提供了一个在路由上的控制功能，大体包含两个大功能：</p>\n<ul>\n<li>Route</li>\n<li>Filter</li>\n<li>Forward</li>\n</ul>\n<p>我们可以通过Route去匹配请求的uri，而每个Router下可以配置一个Filter Chain，我们可以通过Filter去修饰请求和响应及一些类似鉴权等中间动作，通过Forward可以控制重定向和请求转发（实际上Filter也可以做到，只不过这里分开说清晰一点）。在路由控制上，Gateway表现的非常灵活，它有两种配置方式：</p>\n<ul>\n<li>Yml or Properties File</li>\n<li>Code</li>\n</ul>\n<p>主要名词如下：</p>\n<ul>\n<li><strong>Route</strong>: Route the basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates and a collection of filters. A route is matched if aggregate predicate is true.</li>\n<li><strong>Predicate</strong>: This is a Java 8 Function Predicate. The input type is a Spring Framework ServerWebExchange. This allows developers to match on anything from the HTTP request, such as headers or parameters.</li>\n<li><strong>Filter</strong>: These are instances Spring Framework GatewayFilter constructed in with a specific factory. Here, requests and responses can be modified before or after sending the downstream request.</li>\n</ul>\n<p>Route 作为Gateway中的基本元素，它有自己的ID、URI和一个Predicate集合、Filter集合。Predicate的作用是判断请求的Uri是否匹配当前的Route，Filter则是匹配通过之后对请求和响应的处理及修饰，那么在Gateway中Route基本结构如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Gateway&#123;</span><br><span class=\"line\">    Route1 &#123;</span><br><span class=\"line\">        String id;</span><br><span class=\"line\">        String path;</span><br><span class=\"line\">        List&lt;Predicate&gt; predicates;</span><br><span class=\"line\">        List&lt;Filter&gt; filters;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    Route2 &#123;</span><br><span class=\"line\">        String id;</span><br><span class=\"line\">        String path;</span><br><span class=\"line\">        List&lt;Predicate&gt; predicates;</span><br><span class=\"line\">        List&lt;Filter&gt; filters;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Route中的ID作为它的唯一标识，path的作用是正则匹配请求路径，Predicate则是在path匹配的情况下进一步去更加细致的匹配请求路径，如一下例子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: before_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br></pre></td></tr></table></figure>\n<p>只匹配在<code>Jan 20, 2017 17:42</code> 发起的请求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: cookie_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Cookie=chocolate, “”</span><br></pre></td></tr></table></figure>\n<p>只匹配请求中携带<code>chocolate</code>且值为<code>ch.p</code>的请求</p>\n<p>更多例子这里就不一一展开，有兴趣的可以去看下官方文档: <a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-request-predicates-factories\">传送门</a></p>\n<h2 id=\"spring-cloud-gateway-配置\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-配置\">¶</a>Spring Cloud Gateway 配置</h2>\n<h4 id=\"maven\"><a class=\"header-anchor\" href=\"#maven\">¶</a>Maven</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependencyManagement&gt;</span><br><span class=\"line\">\t\t&lt;dependencies&gt;</span><br><span class=\"line\">\t\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t\t&lt;artifactId&gt;spring-cloud-gateway&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t\t&lt;version&gt;2.0.2.BUILD-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\">\t\t\t\t&lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">\t\t\t\t&lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">\t\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;/dependencies&gt;</span><br><span class=\"line\">\t&lt;/dependencyManagement&gt;</span><br><span class=\"line\">\t&lt;dependencies&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t    &lt;groupId&gt;org.yaml&lt;/groupId&gt;</span><br><span class=\"line\">\t\t    &lt;artifactId&gt;snakeyaml&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t&lt;/dependencies&gt;</span><br><span class=\"line\">\t&lt;repositories&gt;</span><br><span class=\"line\">\t\t&lt;repository&gt;</span><br><span class=\"line\">\t\t\t&lt;id&gt;spring-snapshots&lt;/id&gt;</span><br><span class=\"line\">\t\t\t&lt;name&gt;Spring Snapshots&lt;/name&gt;</span><br><span class=\"line\">\t\t\t&lt;url&gt;https://repo.spring.io/libs-snapshot&lt;/url&gt;</span><br><span class=\"line\">\t\t\t&lt;snapshots&gt;</span><br><span class=\"line\">\t\t\t\t&lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class=\"line\">\t\t\t&lt;/snapshots&gt;</span><br><span class=\"line\">\t\t&lt;/repository&gt;</span><br><span class=\"line\">\t&lt;/repositories&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"yml\"><a class=\"header-anchor\" href=\"#yml\">¶</a>Yml</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: cookie_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Cookie=chocolate, ch.p</span><br></pre></td></tr></table></figure>\n<h4 id=\"java-config\"><a class=\"header-anchor\" href=\"#java-config\">¶</a>Java Config</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@RestController</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class Application &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\t\treturn builder.routes()</span><br><span class=\"line\">\t\t\t\t.route(r -&gt; r.path(&quot;/request/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t\t.predicate(new Predicate&lt;ServerWebExchange&gt;() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\tpublic boolean test(ServerWebExchange t) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tboolean access = t.getRequest().getCookies().get(&quot;_9755xjdesxxd_&quot;).get(0).getValue().equals(&quot;32&quot;);</span><br><span class=\"line\">\t\t\t\t\t\t\t\treturn access;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t\t\t\t.filters(f -&gt; f.stripPrefix(2)</span><br><span class=\"line\">\t\t\t\t\t\t\t.filter(new GatewayFilter() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\t\tpublic Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;, 2)</span><br><span class=\"line\">\t\t\t\t\t\t\t.filter(new GatewayFilter() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\t\tpublic Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;, 1))</span><br><span class=\"line\">\t\t\t\t\t\t.uri(&quot;http://localhost:8080/hello&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t).build();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t@GetMapping(&quot;/hello&quot;)</span><br><span class=\"line\">\tpublic String hello() &#123;</span><br><span class=\"line\">\t\treturn &quot;hello&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(Application.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Yml配置和Java代码配置可以共存，Yml配置的好处是可以直接用自带的一些谓词和Filter，而Java代码配置更加灵活！</p>\n<h2 id=\"spring-cloud-gateway使用\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway使用\">¶</a>Spring Cloud Gateway使用</h2>\n<p>上文已经说过，Gateway支持两种配置，本文主要以Java Config的方式着重讲解，因为官方文档中对于Yml配置的讲解已经足够深入，如有兴趣可以进入<a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-how-it-works\">传送门</a></p>\n<h4 id=\"route\"><a class=\"header-anchor\" href=\"#route\">¶</a>Route</h4>\n<p>一个Route的配置可以足够简单</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@RestController</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class Application1 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\t\treturn builder.routes()</span><br><span class=\"line\">\t\t\t\t.route(r -&gt; r.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.uri(&quot;http://localhost:8080/hello&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t).build();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t@GetMapping(&quot;/hello&quot;)</span><br><span class=\"line\">\tpublic String hello() &#123;</span><br><span class=\"line\">\t\treturn &quot;hello&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(Application1.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述Demo定义了一个Route，并且path值为<code>/**</code>，意味着匹配多层uri，如果将path改为<code>/*</code>则意味着只能匹配一层。所以运行上面的程序，那么所有的请求都将被转发到<code>http://localhost:8080/hello</code></p>\n<p>如果uri的配置并没有一个确定的资源，例如<code>http://ip:port</code>，那么<code>/**</code>所匹配的路径将会自动拼装在uri之后：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://当前服务/user/1</span><br><span class=\"line\">forward http://ip:port/user/1</span><br></pre></td></tr></table></figure>\n<p>这种方式更适合服务之间的转发，我们可以将uri设置为<code>ip:port</code>也可以设置为<code>xxx.com</code>域名，但是不能自己转发自己的服务，例如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://当前服务/user/1</span><br><span class=\"line\">forward http://当前服务/user/1</span><br></pre></td></tr></table></figure>\n<p>这就导致了HTTP 413的错误，无限转发至自己，也就意味着请求死锁，非常致命！最好的方式如下：</p>\n<p>我们拟定开两个服务占用的端口分别是<code>8080</code>和<code>8081</code>,我们假如要从<code>8080</code>服务通过<code>/user/**</code>路由匹配转发至<code>8081</code>服务，可以这样做：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>工作跟踪：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://localhost:8080/user/hello</span><br><span class=\"line\">forward http://localhost:8081/user/hello</span><br></pre></td></tr></table></figure>\n<p>8081服务接口定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@GetMapping(&quot;/user/hello&quot;)</span><br><span class=\"line\">public String hello() &#123;</span><br><span class=\"line\">\treturn &quot;User Say Hello&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reponse Body：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User Say Hello</span><br></pre></td></tr></table></figure>\n<p>当Gateway代替Zuul时，也就是说在服务间的通讯由Zuul转换成Gateway之后，uri的写法将会变成这个样子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(r -&gt; r.path(&quot;user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;lb://USER_SERVER_NAME&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码将<code>user/**</code>所匹配的请求全部转发到<code>USER_SERVER_NAME</code>服务下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request /user/1</span><br><span class=\"line\">forward http://USER_SERVER_HOST:USER_SERVER_PORT/user/1</span><br></pre></td></tr></table></figure>\n<p>其中<strong>lb</strong>的含义其实是<code>load balance</code>的意思，我想开发者以lb来区分路由模式可能是负载均衡意味着多服务的环境，因此lb可以表示转发对象从指定的uri转变成了服务！</p>\n<h4 id=\"predicate\"><a class=\"header-anchor\" href=\"#predicate\">¶</a>Predicate</h4>\n<p>Predicate是Java 8+新出的一个库，本身作用是进行逻辑运算，支持种类如下：</p>\n<ul>\n<li>isEqual</li>\n<li>and</li>\n<li>negate</li>\n<li>or<br>\n另外还有一个方法<code>test(T)</code>用于触发逻辑计算返回一个Boolean类型值。</li>\n</ul>\n<p>Gateway使用Predicate来做除path pattern match之外的匹配判断，使用及其简单：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.predicate(e -&gt; e.getClass() != null)</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输入的<strong>e</strong>代表着<code>ServerWebExchange</code>对象，我们可以通过<code>ServerWebExchange</code>获取所有请求相关的信息，例如Cookies和Headers。通过Lambda语法去编写判断逻辑，如果一个Route中所有的Predicate返回的结果都是TRUE则匹配成功，否则匹配失败。</p>\n<blockquote>\n<p>Tp：path和predicate需要使用and链接，也可以使用or链接，分别代表不同的逻辑运算！</p>\n</blockquote>\n<h4 id=\"filter\"><a class=\"header-anchor\" href=\"#filter\">¶</a>Filter</h4>\n<p>Filter的作用类似于Predicate，区别在于，Predicate可以做请求中断，Filter也可以做，Filter可以做Reponse的修饰，Predicate并做不到，也就是说Filter最为最后一道拦截，可以做的事情有很多，例如修改响应报文，增加个Header或者Cookie，甚至修改响应Body，相比之下，Filter更加全能！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.predicate(e -&gt; e.getClass() != null)</span><br><span class=\"line\">\t\t\t\t\t.filters(fn -&gt; fn.addResponseHeader(&quot;developer&quot;, &quot;Nico&quot;))</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"spring-cloud-gateway-工作原理\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-工作原理\">¶</a>Spring Cloud Gateway 工作原理</h2>\n<p>Gateway是基于Spring MVC之上的网关路由控制器，我们可以直接定位到Spring MVC的<code>org.springframework.web.reactive.DispatcherHandler</code>类，它的<code>handle</code>方法将会处理解析Request之后的<code>ServerWebExchange</code>对象。</p>\n<p>进入<code>handle</code>方法，将会使用Flux遍历<code>org.springframework.web.reactive.DispatcherHandler.handlerMappings</code>对<code>ServerWebExchange</code>进行处理,<code>handlerMappings</code>中包含着一下处理器：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.springframework.web.reactive.function.server.support.RouterFunctionMapping@247a29b6, org.springframework.web.reactive.result.method.annotation.RequestMappingHandlerMapping@f6449f4, org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping@535c6b8b,</span><br><span class=\"line\">org.springframework.web.reactive.handler.SimpleUrlHandlerMapping@5633e9e</span><br></pre></td></tr></table></figure>\n<p>以上只是一个简单请求的处理器，Flux的<code>concatMap</code>方法会将每个处理器的Mono合并成一个Flux，然后调用<code>org.springframework.web.reactive.DispatcherHandler</code>类中的<code>invokeHandler</code>方法开始处理<code>ServerWebExchange</code>,处理完毕之后将紧接着处理返回值，这时使用<code>handleResult</code>方法，具体实现如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">public Mono&lt;Void&gt; handle(ServerWebExchange exchange) &#123;</span><br><span class=\"line\">\tif (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tServerHttpRequest request = exchange.getRequest();</span><br><span class=\"line\">\t\tlogger.debug(&quot;Processing &quot; + request.getMethodValue() + &quot; request for [&quot; + request.getURI() + &quot;]&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (this.handlerMappings == null) &#123;</span><br><span class=\"line\">\t\treturn Mono.error(HANDLER_NOT_FOUND_EXCEPTION);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn Flux.fromIterable(this.handlerMappings)</span><br><span class=\"line\">\t\t\t.concatMap(mapping -&gt; mapping.getHandler(exchange))</span><br><span class=\"line\">\t\t\t.next()</span><br><span class=\"line\">\t\t\t.switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))</span><br><span class=\"line\">\t\t\t.flatMap(handler -&gt; invokeHandler(exchange, handler))</span><br><span class=\"line\">\t\t\t.flatMap(result -&gt; handleResult(exchange, result));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Gateway起作用的关键在于<code>invokeHandler</code>方法中：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private Mono&lt;HandlerResult&gt; invokeHandler(ServerWebExchange exchange, Object handler) &#123;</span><br><span class=\"line\">\tif (this.handlerAdapters != null) &#123;</span><br><span class=\"line\">\t\tfor (HandlerAdapter handlerAdapter : this.handlerAdapters) &#123;</span><br><span class=\"line\">\t\t\tif (handlerAdapter.supports(handler)) &#123;</span><br><span class=\"line\">\t\t\t\treturn handlerAdapter.handle(exchange, handler);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn Mono.error(new IllegalStateException(&quot;No HandlerAdapter: &quot; + handler));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对应的处理器的适配器匹配到本身之后，将会触发适配器的处理方法，每个处理器都会实现一个对应的接口，他们大致都有一个共同的特点：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface Handler &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tMono&lt;Void&gt; handle(ServerWebExchange exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每个适配器的处理方法中都会在穿插入适配逻辑代码之后调用处理器的<code>handle</code>方法，Spring Cloud Gateway的所有Handler都在<code>org.springframework.cloud.gateway.handler</code>包下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.springframework.cloud.gateway.handler.AsyncPredicate&lt;T&gt;</span><br><span class=\"line\">org.springframework.cloud.gateway.handler.FilteringWebHandler</span><br><span class=\"line\">org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</span><br></pre></td></tr></table></figure>\n<p>可以看到，上述三个处理器分别处理了Filter和Predicate，有兴趣的朋友可以去看一下这些类内部的具体实现，这里就不一一细说。</p>\n<p>总的来讲，Spring Cloud Gateway的原理是在服务加载期间读取自己的配置将信息存放在一个容器中，在Spring Mvc 处理请求的时候取出这些信息进行<strong>逻辑判断</strong>及<strong>过滤</strong>，根据不同的处理结果触发不同的事件！</p>\n<p>而请求转发这一块有兴趣的同学可以去研究一下！</p>\n<blockquote>\n<p>TP: path的匹配其实也是一个Predicate逻辑判断</p>\n</blockquote>\n<h2 id=\"spring-cloud-gateway-总结\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-总结\">¶</a>Spring Cloud Gateway 总结</h2>\n<p>笔者偶然间看到spring-cloud-netflix的issue下的一个回答<a href=\"https://github.com/spring-cloud/spring-cloud-netflix/issues/2951\">传送门</a>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Lovnx：Zuul 2.0 has opened sourcing,Do you intend to integrate it in some next version?</span><br><span class=\"line\">spencergibb：No. We created spring cloud gateway instead.</span><br></pre></td></tr></table></figure>\n<p>这才感觉到Spring Cloud果然霸气，也因此接触到了Spring Cloud Gateway，觉得很有必要学习一下，总体来讲，Spring Cloud Gateway简化了之前过滤器配置的复杂度，也在新的配置方式上增加了微服务的网关配置，可以直接代替掉Zuul，期待着Spring会整出自己的注册中心来。</p>\n<p>笔者学艺不精，以上阐述有误的地方，希望批评指出，联系方式：ainililia@163.com</p>\n<h2 id=\"相关文档\"><a class=\"header-anchor\" href=\"#相关文档\">¶</a>相关文档</h2>\n<p><a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#_glossary\">官方文档</a><br>\n<a href=\"http://ju.outofmemory.cn/entry/346688\">Spring Cloud Gateway 入门</a><br>\n<a href=\"https://blog.csdn.net/qq_28089993/article/details/79443447\">响应式编程之Reactor的关于Flux和Mono概念</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"spring-cloud-gateway介绍\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway介绍\">¶</a>Spring Cloud Gateway介绍</h2>\n<p>废话不多说，看官方文档的介绍</p>\n<blockquote>\n<p>This project provides an API Gateway built on top of the Spring Ecosystem, including: Spring 5, Spring Boot 2 and Project Reactor. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.</p>\n</blockquote>\n<p>有道翻译一下:</p>\n<p>这个项目提供了一个建在Spring生态系统之上的API网关，包括:Spring 5, Spring Boot 2和project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到api，并为它们提供交叉关注，例如:安全性、监视/度量和弹性。</p>\n<p>工作原理如下：</p>\n<p><img src=\"https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png\" alt=\"image\"></p>\n<p>Gateway实际上提供了一个在路由上的控制功能，大体包含两个大功能：</p>\n<ul>\n<li>Route</li>\n<li>Filter</li>\n<li>Forward</li>\n</ul>\n<p>我们可以通过Route去匹配请求的uri，而每个Router下可以配置一个Filter Chain，我们可以通过Filter去修饰请求和响应及一些类似鉴权等中间动作，通过Forward可以控制重定向和请求转发（实际上Filter也可以做到，只不过这里分开说清晰一点）。在路由控制上，Gateway表现的非常灵活，它有两种配置方式：</p>\n<ul>\n<li>Yml or Properties File</li>\n<li>Code</li>\n</ul>\n<p>主要名词如下：</p>\n<ul>\n<li><strong>Route</strong>: Route the basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates and a collection of filters. A route is matched if aggregate predicate is true.</li>\n<li><strong>Predicate</strong>: This is a Java 8 Function Predicate. The input type is a Spring Framework ServerWebExchange. This allows developers to match on anything from the HTTP request, such as headers or parameters.</li>\n<li><strong>Filter</strong>: These are instances Spring Framework GatewayFilter constructed in with a specific factory. Here, requests and responses can be modified before or after sending the downstream request.</li>\n</ul>\n<p>Route 作为Gateway中的基本元素，它有自己的ID、URI和一个Predicate集合、Filter集合。Predicate的作用是判断请求的Uri是否匹配当前的Route，Filter则是匹配通过之后对请求和响应的处理及修饰，那么在Gateway中Route基本结构如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Gateway&#123;</span><br><span class=\"line\">    Route1 &#123;</span><br><span class=\"line\">        String id;</span><br><span class=\"line\">        String path;</span><br><span class=\"line\">        List&lt;Predicate&gt; predicates;</span><br><span class=\"line\">        List&lt;Filter&gt; filters;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    Route2 &#123;</span><br><span class=\"line\">        String id;</span><br><span class=\"line\">        String path;</span><br><span class=\"line\">        List&lt;Predicate&gt; predicates;</span><br><span class=\"line\">        List&lt;Filter&gt; filters;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Route中的ID作为它的唯一标识，path的作用是正则匹配请求路径，Predicate则是在path匹配的情况下进一步去更加细致的匹配请求路径，如一下例子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: before_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br></pre></td></tr></table></figure>\n<p>只匹配在<code>Jan 20, 2017 17:42</code> 发起的请求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: cookie_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Cookie=chocolate, “”</span><br></pre></td></tr></table></figure>\n<p>只匹配请求中携带<code>chocolate</code>且值为<code>ch.p</code>的请求</p>\n<p>更多例子这里就不一一展开，有兴趣的可以去看下官方文档: <a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-request-predicates-factories\">传送门</a></p>\n<h2 id=\"spring-cloud-gateway-配置\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-配置\">¶</a>Spring Cloud Gateway 配置</h2>\n<h4 id=\"maven\"><a class=\"header-anchor\" href=\"#maven\">¶</a>Maven</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependencyManagement&gt;</span><br><span class=\"line\">\t\t&lt;dependencies&gt;</span><br><span class=\"line\">\t\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t\t&lt;artifactId&gt;spring-cloud-gateway&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t\t&lt;version&gt;2.0.2.BUILD-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\">\t\t\t\t&lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">\t\t\t\t&lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">\t\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;/dependencies&gt;</span><br><span class=\"line\">\t&lt;/dependencyManagement&gt;</span><br><span class=\"line\">\t&lt;dependencies&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t    &lt;groupId&gt;org.yaml&lt;/groupId&gt;</span><br><span class=\"line\">\t\t    &lt;artifactId&gt;snakeyaml&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">\t&lt;/dependencies&gt;</span><br><span class=\"line\">\t&lt;repositories&gt;</span><br><span class=\"line\">\t\t&lt;repository&gt;</span><br><span class=\"line\">\t\t\t&lt;id&gt;spring-snapshots&lt;/id&gt;</span><br><span class=\"line\">\t\t\t&lt;name&gt;Spring Snapshots&lt;/name&gt;</span><br><span class=\"line\">\t\t\t&lt;url&gt;https://repo.spring.io/libs-snapshot&lt;/url&gt;</span><br><span class=\"line\">\t\t\t&lt;snapshots&gt;</span><br><span class=\"line\">\t\t\t\t&lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class=\"line\">\t\t\t&lt;/snapshots&gt;</span><br><span class=\"line\">\t\t&lt;/repository&gt;</span><br><span class=\"line\">\t&lt;/repositories&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"yml\"><a class=\"header-anchor\" href=\"#yml\">¶</a>Yml</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  cloud:</span><br><span class=\"line\">    gateway:</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - id: cookie_route</span><br><span class=\"line\">        uri: http://example.org</span><br><span class=\"line\">        predicates:</span><br><span class=\"line\">        - Cookie=chocolate, ch.p</span><br></pre></td></tr></table></figure>\n<h4 id=\"java-config\"><a class=\"header-anchor\" href=\"#java-config\">¶</a>Java Config</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@RestController</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class Application &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\t\treturn builder.routes()</span><br><span class=\"line\">\t\t\t\t.route(r -&gt; r.path(&quot;/request/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t\t.predicate(new Predicate&lt;ServerWebExchange&gt;() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\tpublic boolean test(ServerWebExchange t) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tboolean access = t.getRequest().getCookies().get(&quot;_9755xjdesxxd_&quot;).get(0).getValue().equals(&quot;32&quot;);</span><br><span class=\"line\">\t\t\t\t\t\t\t\treturn access;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;)</span><br><span class=\"line\">\t\t\t\t\t\t.filters(f -&gt; f.stripPrefix(2)</span><br><span class=\"line\">\t\t\t\t\t\t\t.filter(new GatewayFilter() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\t\tpublic Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;, 2)</span><br><span class=\"line\">\t\t\t\t\t\t\t.filter(new GatewayFilter() &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t@Override</span><br><span class=\"line\">\t\t\t\t\t\t\t\tpublic Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn chain.filter(exchange);</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;, 1))</span><br><span class=\"line\">\t\t\t\t\t\t.uri(&quot;http://localhost:8080/hello&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t).build();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t@GetMapping(&quot;/hello&quot;)</span><br><span class=\"line\">\tpublic String hello() &#123;</span><br><span class=\"line\">\t\treturn &quot;hello&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(Application.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Yml配置和Java代码配置可以共存，Yml配置的好处是可以直接用自带的一些谓词和Filter，而Java代码配置更加灵活！</p>\n<h2 id=\"spring-cloud-gateway使用\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway使用\">¶</a>Spring Cloud Gateway使用</h2>\n<p>上文已经说过，Gateway支持两种配置，本文主要以Java Config的方式着重讲解，因为官方文档中对于Yml配置的讲解已经足够深入，如有兴趣可以进入<a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#gateway-how-it-works\">传送门</a></p>\n<h4 id=\"route\"><a class=\"header-anchor\" href=\"#route\">¶</a>Route</h4>\n<p>一个Route的配置可以足够简单</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Configuration</span><br><span class=\"line\">@RestController</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class Application1 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Bean</span><br><span class=\"line\">\tpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\t\treturn builder.routes()</span><br><span class=\"line\">\t\t\t\t.route(r -&gt; r.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t.uri(&quot;http://localhost:8080/hello&quot;)</span><br><span class=\"line\">\t\t\t\t\t\t).build();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t@GetMapping(&quot;/hello&quot;)</span><br><span class=\"line\">\tpublic String hello() &#123;</span><br><span class=\"line\">\t\treturn &quot;hello&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(Application1.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述Demo定义了一个Route，并且path值为<code>/**</code>，意味着匹配多层uri，如果将path改为<code>/*</code>则意味着只能匹配一层。所以运行上面的程序，那么所有的请求都将被转发到<code>http://localhost:8080/hello</code></p>\n<p>如果uri的配置并没有一个确定的资源，例如<code>http://ip:port</code>，那么<code>/**</code>所匹配的路径将会自动拼装在uri之后：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://当前服务/user/1</span><br><span class=\"line\">forward http://ip:port/user/1</span><br></pre></td></tr></table></figure>\n<p>这种方式更适合服务之间的转发，我们可以将uri设置为<code>ip:port</code>也可以设置为<code>xxx.com</code>域名，但是不能自己转发自己的服务，例如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://当前服务/user/1</span><br><span class=\"line\">forward http://当前服务/user/1</span><br></pre></td></tr></table></figure>\n<p>这就导致了HTTP 413的错误，无限转发至自己，也就意味着请求死锁，非常致命！最好的方式如下：</p>\n<p>我们拟定开两个服务占用的端口分别是<code>8080</code>和<code>8081</code>,我们假如要从<code>8080</code>服务通过<code>/user/**</code>路由匹配转发至<code>8081</code>服务，可以这样做：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>工作跟踪：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request http://localhost:8080/user/hello</span><br><span class=\"line\">forward http://localhost:8081/user/hello</span><br></pre></td></tr></table></figure>\n<p>8081服务接口定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@GetMapping(&quot;/user/hello&quot;)</span><br><span class=\"line\">public String hello() &#123;</span><br><span class=\"line\">\treturn &quot;User Say Hello&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reponse Body：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User Say Hello</span><br></pre></td></tr></table></figure>\n<p>当Gateway代替Zuul时，也就是说在服务间的通讯由Zuul转换成Gateway之后，uri的写法将会变成这个样子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(r -&gt; r.path(&quot;user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;lb://USER_SERVER_NAME&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码将<code>user/**</code>所匹配的请求全部转发到<code>USER_SERVER_NAME</code>服务下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request /user/1</span><br><span class=\"line\">forward http://USER_SERVER_HOST:USER_SERVER_PORT/user/1</span><br></pre></td></tr></table></figure>\n<p>其中<strong>lb</strong>的含义其实是<code>load balance</code>的意思，我想开发者以lb来区分路由模式可能是负载均衡意味着多服务的环境，因此lb可以表示转发对象从指定的uri转变成了服务！</p>\n<h4 id=\"predicate\"><a class=\"header-anchor\" href=\"#predicate\">¶</a>Predicate</h4>\n<p>Predicate是Java 8+新出的一个库，本身作用是进行逻辑运算，支持种类如下：</p>\n<ul>\n<li>isEqual</li>\n<li>and</li>\n<li>negate</li>\n<li>or<br>\n另外还有一个方法<code>test(T)</code>用于触发逻辑计算返回一个Boolean类型值。</li>\n</ul>\n<p>Gateway使用Predicate来做除path pattern match之外的匹配判断，使用及其简单：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.predicate(e -&gt; e.getClass() != null)</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输入的<strong>e</strong>代表着<code>ServerWebExchange</code>对象，我们可以通过<code>ServerWebExchange</code>获取所有请求相关的信息，例如Cookies和Headers。通过Lambda语法去编写判断逻辑，如果一个Route中所有的Predicate返回的结果都是TRUE则匹配成功，否则匹配失败。</p>\n<blockquote>\n<p>Tp：path和predicate需要使用and链接，也可以使用or链接，分别代表不同的逻辑运算！</p>\n</blockquote>\n<h4 id=\"filter\"><a class=\"header-anchor\" href=\"#filter\">¶</a>Filter</h4>\n<p>Filter的作用类似于Predicate，区别在于，Predicate可以做请求中断，Filter也可以做，Filter可以做Reponse的修饰，Predicate并做不到，也就是说Filter最为最后一道拦截，可以做的事情有很多，例如修改响应报文，增加个Header或者Cookie，甚至修改响应Body，相比之下，Filter更加全能！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean</span><br><span class=\"line\">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class=\"line\">\treturn builder.routes()</span><br><span class=\"line\">\t\t\t.route(&quot;hello&quot;, r -&gt; r</span><br><span class=\"line\">\t\t\t\t\t.path(&quot;/user/**&quot;)</span><br><span class=\"line\">\t\t\t\t\t.and()</span><br><span class=\"line\">\t\t\t\t\t.predicate(e -&gt; e.getClass() != null)</span><br><span class=\"line\">\t\t\t\t\t.filters(fn -&gt; fn.addResponseHeader(&quot;developer&quot;, &quot;Nico&quot;))</span><br><span class=\"line\">\t\t\t\t\t.uri(&quot;http://localhost:8081&quot;)</span><br><span class=\"line\">\t\t\t\t\t).build();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"spring-cloud-gateway-工作原理\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-工作原理\">¶</a>Spring Cloud Gateway 工作原理</h2>\n<p>Gateway是基于Spring MVC之上的网关路由控制器，我们可以直接定位到Spring MVC的<code>org.springframework.web.reactive.DispatcherHandler</code>类，它的<code>handle</code>方法将会处理解析Request之后的<code>ServerWebExchange</code>对象。</p>\n<p>进入<code>handle</code>方法，将会使用Flux遍历<code>org.springframework.web.reactive.DispatcherHandler.handlerMappings</code>对<code>ServerWebExchange</code>进行处理,<code>handlerMappings</code>中包含着一下处理器：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.springframework.web.reactive.function.server.support.RouterFunctionMapping@247a29b6, org.springframework.web.reactive.result.method.annotation.RequestMappingHandlerMapping@f6449f4, org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping@535c6b8b,</span><br><span class=\"line\">org.springframework.web.reactive.handler.SimpleUrlHandlerMapping@5633e9e</span><br></pre></td></tr></table></figure>\n<p>以上只是一个简单请求的处理器，Flux的<code>concatMap</code>方法会将每个处理器的Mono合并成一个Flux，然后调用<code>org.springframework.web.reactive.DispatcherHandler</code>类中的<code>invokeHandler</code>方法开始处理<code>ServerWebExchange</code>,处理完毕之后将紧接着处理返回值，这时使用<code>handleResult</code>方法，具体实现如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">public Mono&lt;Void&gt; handle(ServerWebExchange exchange) &#123;</span><br><span class=\"line\">\tif (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tServerHttpRequest request = exchange.getRequest();</span><br><span class=\"line\">\t\tlogger.debug(&quot;Processing &quot; + request.getMethodValue() + &quot; request for [&quot; + request.getURI() + &quot;]&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (this.handlerMappings == null) &#123;</span><br><span class=\"line\">\t\treturn Mono.error(HANDLER_NOT_FOUND_EXCEPTION);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn Flux.fromIterable(this.handlerMappings)</span><br><span class=\"line\">\t\t\t.concatMap(mapping -&gt; mapping.getHandler(exchange))</span><br><span class=\"line\">\t\t\t.next()</span><br><span class=\"line\">\t\t\t.switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))</span><br><span class=\"line\">\t\t\t.flatMap(handler -&gt; invokeHandler(exchange, handler))</span><br><span class=\"line\">\t\t\t.flatMap(result -&gt; handleResult(exchange, result));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Gateway起作用的关键在于<code>invokeHandler</code>方法中：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private Mono&lt;HandlerResult&gt; invokeHandler(ServerWebExchange exchange, Object handler) &#123;</span><br><span class=\"line\">\tif (this.handlerAdapters != null) &#123;</span><br><span class=\"line\">\t\tfor (HandlerAdapter handlerAdapter : this.handlerAdapters) &#123;</span><br><span class=\"line\">\t\t\tif (handlerAdapter.supports(handler)) &#123;</span><br><span class=\"line\">\t\t\t\treturn handlerAdapter.handle(exchange, handler);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn Mono.error(new IllegalStateException(&quot;No HandlerAdapter: &quot; + handler));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对应的处理器的适配器匹配到本身之后，将会触发适配器的处理方法，每个处理器都会实现一个对应的接口，他们大致都有一个共同的特点：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface Handler &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tMono&lt;Void&gt; handle(ServerWebExchange exchange);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每个适配器的处理方法中都会在穿插入适配逻辑代码之后调用处理器的<code>handle</code>方法，Spring Cloud Gateway的所有Handler都在<code>org.springframework.cloud.gateway.handler</code>包下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">org.springframework.cloud.gateway.handler.AsyncPredicate&lt;T&gt;</span><br><span class=\"line\">org.springframework.cloud.gateway.handler.FilteringWebHandler</span><br><span class=\"line\">org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</span><br></pre></td></tr></table></figure>\n<p>可以看到，上述三个处理器分别处理了Filter和Predicate，有兴趣的朋友可以去看一下这些类内部的具体实现，这里就不一一细说。</p>\n<p>总的来讲，Spring Cloud Gateway的原理是在服务加载期间读取自己的配置将信息存放在一个容器中，在Spring Mvc 处理请求的时候取出这些信息进行<strong>逻辑判断</strong>及<strong>过滤</strong>，根据不同的处理结果触发不同的事件！</p>\n<p>而请求转发这一块有兴趣的同学可以去研究一下！</p>\n<blockquote>\n<p>TP: path的匹配其实也是一个Predicate逻辑判断</p>\n</blockquote>\n<h2 id=\"spring-cloud-gateway-总结\"><a class=\"header-anchor\" href=\"#spring-cloud-gateway-总结\">¶</a>Spring Cloud Gateway 总结</h2>\n<p>笔者偶然间看到spring-cloud-netflix的issue下的一个回答<a href=\"https://github.com/spring-cloud/spring-cloud-netflix/issues/2951\">传送门</a>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Lovnx：Zuul 2.0 has opened sourcing,Do you intend to integrate it in some next version?</span><br><span class=\"line\">spencergibb：No. We created spring cloud gateway instead.</span><br></pre></td></tr></table></figure>\n<p>这才感觉到Spring Cloud果然霸气，也因此接触到了Spring Cloud Gateway，觉得很有必要学习一下，总体来讲，Spring Cloud Gateway简化了之前过滤器配置的复杂度，也在新的配置方式上增加了微服务的网关配置，可以直接代替掉Zuul，期待着Spring会整出自己的注册中心来。</p>\n<p>笔者学艺不精，以上阐述有误的地方，希望批评指出，联系方式：ainililia@163.com</p>\n<h2 id=\"相关文档\"><a class=\"header-anchor\" href=\"#相关文档\">¶</a>相关文档</h2>\n<p><a href=\"http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#_glossary\">官方文档</a><br>\n<a href=\"http://ju.outofmemory.cn/entry/346688\">Spring Cloud Gateway 入门</a><br>\n<a href=\"https://blog.csdn.net/qq_28089993/article/details/79443447\">响应式编程之Reactor的关于Flux和Mono概念</a></p>\n"},{"title":"使用Arthas监控Java进程","author":"Nico","date":"2018-11-06T04:41:00.000Z","_content":"## 一、Arthas简介\n`Arthas` 是Alibaba开源的Java诊断工具，深受开发者喜爱。\n\n当你遇到以下类似问题而束手无策时，`Arthas`可以帮助你解决：\n\n0. 这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？\n0. 我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？\n0. 遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？\n0. 线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！\n0. 是否有一个全局视角来查看系统的运行状况？\n0. 有什么办法可以监控到JVM的实时运行状态？\n\n`Arthas`采用命令行交互模式，同时提供丰富的 `Tab` 自动补全功能，进一步方便进行问题的定位和诊断。\n\n使用说明可以看下官方的文档[https://alibaba.github.io/arthas/](https://alibaba.github.io/arthas/)\n\n## 二、安装及使用\n以下通过CentOS系统举例来安装Arthas\n#### 1.安装Java环境\n首先去Oracle下载JDK，可以通过``wget``或者``curl -O``来下载到Linux主机上。\n\n最方便的就是下载一个tar.gz格式的压缩包，然后通过``tar -zxf``解压，以下是笔者最终存放jdk的物理路径\n```\n[nico@VM_0_17_centos jdk1.8.0_181]$ pwd\n/usr/lib/java-1.8.0/jdk1.8.0_181\n```\n\n接下来配置环境变量，通过``vim /etc/profile``进入编辑操作，并增加以下配置\n```\nexport JAVA_HOME=/usr/lib/java-1.8.0/jdk1.8.0_181\nexport JRE_HOME=$JAVA_HOME/jre\nexport CLASSPATH=$JAVA_HOME/lib/\nexport PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH\n```\n退出并保存，通过执行``source /etc/profile``立即生效\n\n然后分别执行``java``和``javac``验证环境是否生效\n#### 2.安装Arthas\nArthas非常小巧，官方有一个可直接执行的sh脚本供我们使用，可以通过以下指令下载\n```\ncurl -L https://alibaba.github.io/arthas/install.sh | sh\n```\n启动Arthas\n```\n./as.sh\n```\n#### 3.安装ElasticSearch\nArthas启动需要存在至少一个及以上的Java进程，这里我们为了方便测试，直接安装ElasticSearch。\n\n和安装JDK的方式类似，我们去官方下载一个``tar.gz``的压缩包，然后解压\n```\n[nico@VM_0_17_centos elasticsearch]$ ll\ntotal 95612\ndrwxr-xr-x 9 nico root     4096 Sep 19 09:03 elasticsearch-6.4.0\n-rw-r--r-- 1 nico root 97901357 Aug 23 23:21 elasticsearch-6.4.0.tar.gz\n```\nElasticSearch的不允许**root**用户启动，所以笔者用的是**nico**账号，创建账号过程如下\n```\nadduser nico\npasswd nico\n#输入密码\n#将as.sh和elasticsearch的目录权限赋予nico账户\nchown nico as.sh\nchown -R nico elasticsearch\nsu nico\n```\n以上指令请分开到对应的目录执行，执行完毕之后我们进入elasticsearch目录下的bin目录中，启动elasticsearch\n```\n./elasticsearch\n```\n#### 4.使用Arthas监控ElasticSearch\n进入``as.sh``所在目录，启动Arthas\n```\n./as.sh\n```\n```\n[nico@VM_0_17_centos arthas]$ ./as.sh\nArthas script version: 3.0.4\nFound existing java process, please choose one and hit RETURN.\n* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch\n```\n我们看到，当前只有ElasticSearch一个进程，输入1监控ElasticSearch\n```\n[nico@VM_0_17_centos arthas]$ ./as.sh\nArthas script version: 3.0.4\nFound existing java process, please choose one and hit RETURN.\n* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch\n1\nCalculating attach execution time...\nAttaching to 19670 using version 3.0.4...\n\nreal\t0m0.227s\nuser\t0m0.177s\nsys\t0m0.035s\nAttach success.\nConnecting to arthas server... current timestamp is 1537320967\nTrying 127.0.0.1...\nConnected to 127.0.0.1.\nEscape character is '^]'.\n  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           \n /  O  \\ |  .--. ''--.  .--'|  '--'  | /  O  \\ '   .-'                          \n|  .-.  ||  '--'.'   |  |   |  .--.  ||  .-.  |`.  `-.                          \n|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-'    |                         \n`--' `--'`--' '--'   `--'   `--'  `--'`--' `--'`-----'                          \n                                                                                \n\nwiki: https://alibaba.github.io/arthas\nversion: 3.0.4\npid: 19670\ntimestamp: 1537320967728\n\n$ \n```\n启动成功，Arthas提供一个shell的操作模式来供我们去监控Java进程，具体指令可以看下官方的[Wiki](https://alibaba.github.io/arthas/quick-start.html)\n#### 5.安装过程可能遇到的问题\n(1)遇到报错``java.security.AccessControlException: Access Denied ``\n\n官方解决办法\n```\nAdd the permission in client.policy (for the application client), or in server.policy (for EJB/web modules) for the application that needs to set the property. By default, applications only have “read” permission for properties.\n\nFor example, to grant read/write permission for all the files in the codebase directory, add or append the following to client.policy or server.policy:\n\ngrant codeBase \"file:/.../build/sparc_SunOS/sec/-\" {\n   permission java.util.PropertyPermission \"*\", \"read,write\";\n };\n```\njava.policy所在的目录为JDK所在目录下的相对目录``jre/lib/security``\n```\nvim java.policy\n```\n尾部增加一行即可\n```\npermission java.security.AllPermission;\n```","source":"_posts/hello-world.md","raw":"title: 使用Arthas监控Java进程\ntags: []\ncategories:\n  - DevOps\nauthor: Nico\ndate: 2018-11-06 12:41:00\n---\n## 一、Arthas简介\n`Arthas` 是Alibaba开源的Java诊断工具，深受开发者喜爱。\n\n当你遇到以下类似问题而束手无策时，`Arthas`可以帮助你解决：\n\n0. 这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？\n0. 我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？\n0. 遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？\n0. 线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！\n0. 是否有一个全局视角来查看系统的运行状况？\n0. 有什么办法可以监控到JVM的实时运行状态？\n\n`Arthas`采用命令行交互模式，同时提供丰富的 `Tab` 自动补全功能，进一步方便进行问题的定位和诊断。\n\n使用说明可以看下官方的文档[https://alibaba.github.io/arthas/](https://alibaba.github.io/arthas/)\n\n## 二、安装及使用\n以下通过CentOS系统举例来安装Arthas\n#### 1.安装Java环境\n首先去Oracle下载JDK，可以通过``wget``或者``curl -O``来下载到Linux主机上。\n\n最方便的就是下载一个tar.gz格式的压缩包，然后通过``tar -zxf``解压，以下是笔者最终存放jdk的物理路径\n```\n[nico@VM_0_17_centos jdk1.8.0_181]$ pwd\n/usr/lib/java-1.8.0/jdk1.8.0_181\n```\n\n接下来配置环境变量，通过``vim /etc/profile``进入编辑操作，并增加以下配置\n```\nexport JAVA_HOME=/usr/lib/java-1.8.0/jdk1.8.0_181\nexport JRE_HOME=$JAVA_HOME/jre\nexport CLASSPATH=$JAVA_HOME/lib/\nexport PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH\n```\n退出并保存，通过执行``source /etc/profile``立即生效\n\n然后分别执行``java``和``javac``验证环境是否生效\n#### 2.安装Arthas\nArthas非常小巧，官方有一个可直接执行的sh脚本供我们使用，可以通过以下指令下载\n```\ncurl -L https://alibaba.github.io/arthas/install.sh | sh\n```\n启动Arthas\n```\n./as.sh\n```\n#### 3.安装ElasticSearch\nArthas启动需要存在至少一个及以上的Java进程，这里我们为了方便测试，直接安装ElasticSearch。\n\n和安装JDK的方式类似，我们去官方下载一个``tar.gz``的压缩包，然后解压\n```\n[nico@VM_0_17_centos elasticsearch]$ ll\ntotal 95612\ndrwxr-xr-x 9 nico root     4096 Sep 19 09:03 elasticsearch-6.4.0\n-rw-r--r-- 1 nico root 97901357 Aug 23 23:21 elasticsearch-6.4.0.tar.gz\n```\nElasticSearch的不允许**root**用户启动，所以笔者用的是**nico**账号，创建账号过程如下\n```\nadduser nico\npasswd nico\n#输入密码\n#将as.sh和elasticsearch的目录权限赋予nico账户\nchown nico as.sh\nchown -R nico elasticsearch\nsu nico\n```\n以上指令请分开到对应的目录执行，执行完毕之后我们进入elasticsearch目录下的bin目录中，启动elasticsearch\n```\n./elasticsearch\n```\n#### 4.使用Arthas监控ElasticSearch\n进入``as.sh``所在目录，启动Arthas\n```\n./as.sh\n```\n```\n[nico@VM_0_17_centos arthas]$ ./as.sh\nArthas script version: 3.0.4\nFound existing java process, please choose one and hit RETURN.\n* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch\n```\n我们看到，当前只有ElasticSearch一个进程，输入1监控ElasticSearch\n```\n[nico@VM_0_17_centos arthas]$ ./as.sh\nArthas script version: 3.0.4\nFound existing java process, please choose one and hit RETURN.\n* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch\n1\nCalculating attach execution time...\nAttaching to 19670 using version 3.0.4...\n\nreal\t0m0.227s\nuser\t0m0.177s\nsys\t0m0.035s\nAttach success.\nConnecting to arthas server... current timestamp is 1537320967\nTrying 127.0.0.1...\nConnected to 127.0.0.1.\nEscape character is '^]'.\n  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           \n /  O  \\ |  .--. ''--.  .--'|  '--'  | /  O  \\ '   .-'                          \n|  .-.  ||  '--'.'   |  |   |  .--.  ||  .-.  |`.  `-.                          \n|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-'    |                         \n`--' `--'`--' '--'   `--'   `--'  `--'`--' `--'`-----'                          \n                                                                                \n\nwiki: https://alibaba.github.io/arthas\nversion: 3.0.4\npid: 19670\ntimestamp: 1537320967728\n\n$ \n```\n启动成功，Arthas提供一个shell的操作模式来供我们去监控Java进程，具体指令可以看下官方的[Wiki](https://alibaba.github.io/arthas/quick-start.html)\n#### 5.安装过程可能遇到的问题\n(1)遇到报错``java.security.AccessControlException: Access Denied ``\n\n官方解决办法\n```\nAdd the permission in client.policy (for the application client), or in server.policy (for EJB/web modules) for the application that needs to set the property. By default, applications only have “read” permission for properties.\n\nFor example, to grant read/write permission for all the files in the codebase directory, add or append the following to client.policy or server.policy:\n\ngrant codeBase \"file:/.../build/sparc_SunOS/sec/-\" {\n   permission java.util.PropertyPermission \"*\", \"read,write\";\n };\n```\njava.policy所在的目录为JDK所在目录下的相对目录``jre/lib/security``\n```\nvim java.policy\n```\n尾部增加一行即可\n```\npermission java.security.AllPermission;\n```","slug":"hello-world","published":1,"updated":"2021-03-21T17:43:05.797Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyc000vb0tzhy1gel1y","content":"<h2 id=\"一-arthas简介\"><a class=\"header-anchor\" href=\"#一-arthas简介\">¶</a>一、Arthas简介</h2>\n<p><code>Arthas</code> 是Alibaba开源的Java诊断工具，深受开发者喜爱。</p>\n<p>当你遇到以下类似问题而束手无策时，<code>Arthas</code>可以帮助你解决：</p>\n<ol start=\"0\">\n<li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li>\n<li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li>\n<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li>\n<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>\n<li>是否有一个全局视角来查看系统的运行状况？</li>\n<li>有什么办法可以监控到JVM的实时运行状态？</li>\n</ol>\n<p><code>Arthas</code>采用命令行交互模式，同时提供丰富的 <code>Tab</code> 自动补全功能，进一步方便进行问题的定位和诊断。</p>\n<p>使用说明可以看下官方的文档<a href=\"https://alibaba.github.io/arthas/\">https://alibaba.github.io/arthas/</a></p>\n<h2 id=\"二-安装及使用\"><a class=\"header-anchor\" href=\"#二-安装及使用\">¶</a>二、安装及使用</h2>\n<p>以下通过CentOS系统举例来安装Arthas</p>\n<h4 id=\"1-安装java环境\"><a class=\"header-anchor\" href=\"#1-安装java环境\">¶</a>1.安装Java环境</h4>\n<p>首先去Oracle下载JDK，可以通过<code>wget</code>或者<code>curl -O</code>来下载到Linux主机上。</p>\n<p>最方便的就是下载一个tar.gz格式的压缩包，然后通过<code>tar -zxf</code>解压，以下是笔者最终存放jdk的物理路径</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos jdk1.8.0_181]$ pwd</span><br><span class=\"line\">/usr/lib/java-1.8.0/jdk1.8.0_181</span><br></pre></td></tr></table></figure>\n<p>接下来配置环境变量，通过<code>vim /etc/profile</code>进入编辑操作，并增加以下配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export JAVA_HOME=/usr/lib/java-1.8.0/jdk1.8.0_181</span><br><span class=\"line\">export JRE_HOME=$JAVA_HOME/jre</span><br><span class=\"line\">export CLASSPATH=$JAVA_HOME/lib/</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n<p>退出并保存，通过执行<code>source /etc/profile</code>立即生效</p>\n<p>然后分别执行<code>java</code>和<code>javac</code>验证环境是否生效</p>\n<h4 id=\"2-安装arthas\"><a class=\"header-anchor\" href=\"#2-安装arthas\">¶</a>2.安装Arthas</h4>\n<p>Arthas非常小巧，官方有一个可直接执行的sh脚本供我们使用，可以通过以下指令下载</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://alibaba.github.io/arthas/install.sh | sh</span><br></pre></td></tr></table></figure>\n<p>启动Arthas</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./as.sh</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-安装elasticsearch\"><a class=\"header-anchor\" href=\"#3-安装elasticsearch\">¶</a>3.安装ElasticSearch</h4>\n<p>Arthas启动需要存在至少一个及以上的Java进程，这里我们为了方便测试，直接安装ElasticSearch。</p>\n<p>和安装JDK的方式类似，我们去官方下载一个<code>tar.gz</code>的压缩包，然后解压</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos elasticsearch]$ ll</span><br><span class=\"line\">total 95612</span><br><span class=\"line\">drwxr-xr-x 9 nico root     4096 Sep 19 09:03 elasticsearch-6.4.0</span><br><span class=\"line\">-rw-r--r-- 1 nico root 97901357 Aug 23 23:21 elasticsearch-6.4.0.tar.gz</span><br></pre></td></tr></table></figure>\n<p>ElasticSearch的不允许<strong>root</strong>用户启动，所以笔者用的是<strong>nico</strong>账号，创建账号过程如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adduser nico</span><br><span class=\"line\">passwd nico</span><br><span class=\"line\">#输入密码</span><br><span class=\"line\">#将as.sh和elasticsearch的目录权限赋予nico账户</span><br><span class=\"line\">chown nico as.sh</span><br><span class=\"line\">chown -R nico elasticsearch</span><br><span class=\"line\">su nico</span><br></pre></td></tr></table></figure>\n<p>以上指令请分开到对应的目录执行，执行完毕之后我们进入elasticsearch目录下的bin目录中，启动elasticsearch</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./elasticsearch</span><br></pre></td></tr></table></figure>\n<h4 id=\"4-使用arthas监控elasticsearch\"><a class=\"header-anchor\" href=\"#4-使用arthas监控elasticsearch\">¶</a>4.使用Arthas监控ElasticSearch</h4>\n<p>进入<code>as.sh</code>所在目录，启动Arthas</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./as.sh</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos arthas]$ ./as.sh</span><br><span class=\"line\">Arthas script version: 3.0.4</span><br><span class=\"line\">Found existing java process, please choose one and hit RETURN.</span><br><span class=\"line\">* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch</span><br></pre></td></tr></table></figure>\n<p>我们看到，当前只有ElasticSearch一个进程，输入1监控ElasticSearch</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos arthas]$ ./as.sh</span><br><span class=\"line\">Arthas script version: 3.0.4</span><br><span class=\"line\">Found existing java process, please choose one and hit RETURN.</span><br><span class=\"line\">* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch</span><br><span class=\"line\">1</span><br><span class=\"line\">Calculating attach execution time...</span><br><span class=\"line\">Attaching to 19670 using version 3.0.4...</span><br><span class=\"line\"></span><br><span class=\"line\">real\t0m0.227s</span><br><span class=\"line\">user\t0m0.177s</span><br><span class=\"line\">sys\t0m0.035s</span><br><span class=\"line\">Attach success.</span><br><span class=\"line\">Connecting to arthas server... current timestamp is 1537320967</span><br><span class=\"line\">Trying 127.0.0.1...</span><br><span class=\"line\">Connected to 127.0.0.1.</span><br><span class=\"line\">Escape character is &#x27;^]&#x27;.</span><br><span class=\"line\">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class=\"line\"> /  O  \\ |  .--. &#x27;&#x27;--.  .--&#x27;|  &#x27;--&#x27;  | /  O  \\ &#x27;   .-&#x27;                          </span><br><span class=\"line\">|  .-.  ||  &#x27;--&#x27;.&#x27;   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class=\"line\">|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-&#x27;    |                         </span><br><span class=\"line\">`--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27;   `--&#x27;   `--&#x27;  `--&#x27;`--&#x27; `--&#x27;`-----&#x27;                          </span><br><span class=\"line\">                                                                                </span><br><span class=\"line\"></span><br><span class=\"line\">wiki: https://alibaba.github.io/arthas</span><br><span class=\"line\">version: 3.0.4</span><br><span class=\"line\">pid: 19670</span><br><span class=\"line\">timestamp: 1537320967728</span><br><span class=\"line\"></span><br><span class=\"line\">$ </span><br></pre></td></tr></table></figure>\n<p>启动成功，Arthas提供一个shell的操作模式来供我们去监控Java进程，具体指令可以看下官方的<a href=\"https://alibaba.github.io/arthas/quick-start.html\">Wiki</a></p>\n<h4 id=\"5-安装过程可能遇到的问题\"><a class=\"header-anchor\" href=\"#5-安装过程可能遇到的问题\">¶</a>5.安装过程可能遇到的问题</h4>\n<p>(1)遇到报错<code>java.security.AccessControlException: Access Denied</code></p>\n<p>官方解决办法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Add the permission in client.policy (for the application client), or in server.policy (for EJB/web modules) for the application that needs to set the property. By default, applications only have “read” permission for properties.</span><br><span class=\"line\"></span><br><span class=\"line\">For example, to grant read/write permission for all the files in the codebase directory, add or append the following to client.policy or server.policy:</span><br><span class=\"line\"></span><br><span class=\"line\">grant codeBase &quot;file:/.../build/sparc_SunOS/sec/-&quot; &#123;</span><br><span class=\"line\">   permission java.util.PropertyPermission &quot;*&quot;, &quot;read,write&quot;;</span><br><span class=\"line\"> &#125;;</span><br></pre></td></tr></table></figure>\n<p>java.policy所在的目录为JDK所在目录下的相对目录<code>jre/lib/security</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim java.policy</span><br></pre></td></tr></table></figure>\n<p>尾部增加一行即可</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">permission java.security.AllPermission;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-arthas简介\"><a class=\"header-anchor\" href=\"#一-arthas简介\">¶</a>一、Arthas简介</h2>\n<p><code>Arthas</code> 是Alibaba开源的Java诊断工具，深受开发者喜爱。</p>\n<p>当你遇到以下类似问题而束手无策时，<code>Arthas</code>可以帮助你解决：</p>\n<ol start=\"0\">\n<li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li>\n<li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li>\n<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li>\n<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>\n<li>是否有一个全局视角来查看系统的运行状况？</li>\n<li>有什么办法可以监控到JVM的实时运行状态？</li>\n</ol>\n<p><code>Arthas</code>采用命令行交互模式，同时提供丰富的 <code>Tab</code> 自动补全功能，进一步方便进行问题的定位和诊断。</p>\n<p>使用说明可以看下官方的文档<a href=\"https://alibaba.github.io/arthas/\">https://alibaba.github.io/arthas/</a></p>\n<h2 id=\"二-安装及使用\"><a class=\"header-anchor\" href=\"#二-安装及使用\">¶</a>二、安装及使用</h2>\n<p>以下通过CentOS系统举例来安装Arthas</p>\n<h4 id=\"1-安装java环境\"><a class=\"header-anchor\" href=\"#1-安装java环境\">¶</a>1.安装Java环境</h4>\n<p>首先去Oracle下载JDK，可以通过<code>wget</code>或者<code>curl -O</code>来下载到Linux主机上。</p>\n<p>最方便的就是下载一个tar.gz格式的压缩包，然后通过<code>tar -zxf</code>解压，以下是笔者最终存放jdk的物理路径</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos jdk1.8.0_181]$ pwd</span><br><span class=\"line\">/usr/lib/java-1.8.0/jdk1.8.0_181</span><br></pre></td></tr></table></figure>\n<p>接下来配置环境变量，通过<code>vim /etc/profile</code>进入编辑操作，并增加以下配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export JAVA_HOME=/usr/lib/java-1.8.0/jdk1.8.0_181</span><br><span class=\"line\">export JRE_HOME=$JAVA_HOME/jre</span><br><span class=\"line\">export CLASSPATH=$JAVA_HOME/lib/</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n<p>退出并保存，通过执行<code>source /etc/profile</code>立即生效</p>\n<p>然后分别执行<code>java</code>和<code>javac</code>验证环境是否生效</p>\n<h4 id=\"2-安装arthas\"><a class=\"header-anchor\" href=\"#2-安装arthas\">¶</a>2.安装Arthas</h4>\n<p>Arthas非常小巧，官方有一个可直接执行的sh脚本供我们使用，可以通过以下指令下载</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://alibaba.github.io/arthas/install.sh | sh</span><br></pre></td></tr></table></figure>\n<p>启动Arthas</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./as.sh</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-安装elasticsearch\"><a class=\"header-anchor\" href=\"#3-安装elasticsearch\">¶</a>3.安装ElasticSearch</h4>\n<p>Arthas启动需要存在至少一个及以上的Java进程，这里我们为了方便测试，直接安装ElasticSearch。</p>\n<p>和安装JDK的方式类似，我们去官方下载一个<code>tar.gz</code>的压缩包，然后解压</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos elasticsearch]$ ll</span><br><span class=\"line\">total 95612</span><br><span class=\"line\">drwxr-xr-x 9 nico root     4096 Sep 19 09:03 elasticsearch-6.4.0</span><br><span class=\"line\">-rw-r--r-- 1 nico root 97901357 Aug 23 23:21 elasticsearch-6.4.0.tar.gz</span><br></pre></td></tr></table></figure>\n<p>ElasticSearch的不允许<strong>root</strong>用户启动，所以笔者用的是<strong>nico</strong>账号，创建账号过程如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adduser nico</span><br><span class=\"line\">passwd nico</span><br><span class=\"line\">#输入密码</span><br><span class=\"line\">#将as.sh和elasticsearch的目录权限赋予nico账户</span><br><span class=\"line\">chown nico as.sh</span><br><span class=\"line\">chown -R nico elasticsearch</span><br><span class=\"line\">su nico</span><br></pre></td></tr></table></figure>\n<p>以上指令请分开到对应的目录执行，执行完毕之后我们进入elasticsearch目录下的bin目录中，启动elasticsearch</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./elasticsearch</span><br></pre></td></tr></table></figure>\n<h4 id=\"4-使用arthas监控elasticsearch\"><a class=\"header-anchor\" href=\"#4-使用arthas监控elasticsearch\">¶</a>4.使用Arthas监控ElasticSearch</h4>\n<p>进入<code>as.sh</code>所在目录，启动Arthas</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./as.sh</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos arthas]$ ./as.sh</span><br><span class=\"line\">Arthas script version: 3.0.4</span><br><span class=\"line\">Found existing java process, please choose one and hit RETURN.</span><br><span class=\"line\">* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch</span><br></pre></td></tr></table></figure>\n<p>我们看到，当前只有ElasticSearch一个进程，输入1监控ElasticSearch</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[nico@VM_0_17_centos arthas]$ ./as.sh</span><br><span class=\"line\">Arthas script version: 3.0.4</span><br><span class=\"line\">Found existing java process, please choose one and hit RETURN.</span><br><span class=\"line\">* [1]: 19670 org.elasticsearch.bootstrap.Elasticsearch</span><br><span class=\"line\">1</span><br><span class=\"line\">Calculating attach execution time...</span><br><span class=\"line\">Attaching to 19670 using version 3.0.4...</span><br><span class=\"line\"></span><br><span class=\"line\">real\t0m0.227s</span><br><span class=\"line\">user\t0m0.177s</span><br><span class=\"line\">sys\t0m0.035s</span><br><span class=\"line\">Attach success.</span><br><span class=\"line\">Connecting to arthas server... current timestamp is 1537320967</span><br><span class=\"line\">Trying 127.0.0.1...</span><br><span class=\"line\">Connected to 127.0.0.1.</span><br><span class=\"line\">Escape character is &#x27;^]&#x27;.</span><br><span class=\"line\">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class=\"line\"> /  O  \\ |  .--. &#x27;&#x27;--.  .--&#x27;|  &#x27;--&#x27;  | /  O  \\ &#x27;   .-&#x27;                          </span><br><span class=\"line\">|  .-.  ||  &#x27;--&#x27;.&#x27;   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class=\"line\">|  | |  ||  |\\  \\    |  |   |  |  |  ||  | |  |.-&#x27;    |                         </span><br><span class=\"line\">`--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27;   `--&#x27;   `--&#x27;  `--&#x27;`--&#x27; `--&#x27;`-----&#x27;                          </span><br><span class=\"line\">                                                                                </span><br><span class=\"line\"></span><br><span class=\"line\">wiki: https://alibaba.github.io/arthas</span><br><span class=\"line\">version: 3.0.4</span><br><span class=\"line\">pid: 19670</span><br><span class=\"line\">timestamp: 1537320967728</span><br><span class=\"line\"></span><br><span class=\"line\">$ </span><br></pre></td></tr></table></figure>\n<p>启动成功，Arthas提供一个shell的操作模式来供我们去监控Java进程，具体指令可以看下官方的<a href=\"https://alibaba.github.io/arthas/quick-start.html\">Wiki</a></p>\n<h4 id=\"5-安装过程可能遇到的问题\"><a class=\"header-anchor\" href=\"#5-安装过程可能遇到的问题\">¶</a>5.安装过程可能遇到的问题</h4>\n<p>(1)遇到报错<code>java.security.AccessControlException: Access Denied</code></p>\n<p>官方解决办法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Add the permission in client.policy (for the application client), or in server.policy (for EJB/web modules) for the application that needs to set the property. By default, applications only have “read” permission for properties.</span><br><span class=\"line\"></span><br><span class=\"line\">For example, to grant read/write permission for all the files in the codebase directory, add or append the following to client.policy or server.policy:</span><br><span class=\"line\"></span><br><span class=\"line\">grant codeBase &quot;file:/.../build/sparc_SunOS/sec/-&quot; &#123;</span><br><span class=\"line\">   permission java.util.PropertyPermission &quot;*&quot;, &quot;read,write&quot;;</span><br><span class=\"line\"> &#125;;</span><br></pre></td></tr></table></figure>\n<p>java.policy所在的目录为JDK所在目录下的相对目录<code>jre/lib/security</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim java.policy</span><br></pre></td></tr></table></figure>\n<p>尾部增加一行即可</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">permission java.security.AllPermission;</span><br></pre></td></tr></table></figure>"},{"title":"【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计","author":"Nico","date":"2022-02-22T04:25:00.000Z","_content":"## 引子\n\n在一个浑浑噩噩的下午，百无聊赖的我像往常一样点开了划水交流群，细细品味着老哥们关于量子力学的讨论。嬉戏间，平常水不拉几的群友张三忽然发了一张大大的橙图，我啪的一下点开了，很快啊，仔细观摩后发现原来是2021第二届云原生编程挑战赛报名的海报，暗暗的想起了被我鸽掉的前几届，小手不自觉地打开了链接并且一键三连。\n\n每个人的心里都有一个童心未泯的自己，这次比赛就像一场游戏一样让我深陷其中，三岔路口，我选择了存储领域，谁承想这决定会让我在接下来的两个月里减少百分之N的发量。\n\n## 读题\n\n[赛题](https://tianchi.aliyun.com/competition/entrance/531922/information)目的是实现简单的消息读取与存储，程序需要实现`append`和`getRange`方法，并依次通过性能评测与正确性评测，性能评测耗时最少者居高。\n\n### 评测环境\n\nLinux下的4核8G服务器，配置`400G` ESSD PL1云盘，吞吐可达`320MiB/s`，`60G` Intel 傲腾持久内存PMem（Persistent Memory），由参考文档可推测为第一代持久内存，代号为AEP。\n\n赛题编程语言限制为Java8，JVM配置为6G堆内+2G堆外。\n\n### 性能评测\n\n评测程序首先会创建10~50个不等的线程，每个线程随机分配若干个topic进行写入，topic总数量不超过100个。每个topic之下又分为若干个queue，总数量不超过5000个，调用append方法后返回当前数据在queue中的offset，由0开始。每次写入数据大小为100B-17KiB区间随机，当写满75G数据后，会挑选一半的queue由下标0（头）开始读取，另外一半从当前最大下标（尾）开始读取，并保持之前的写入压力继续写入50G数据，最后一条数据读取完毕后停止计时。\n\n### 正确性评测\n\n同样会使用N个线程写入数据，在写入过程中会重启ECS，之后再读取之前写入成功的数据（返回offset即视为成功），要求严格一致。\n\n### 持久内存\n\n本次比赛多了一个比较陌生的存储介质PMem，它结合了内存的读写性能和持久化的特性，可以在延迟可以控制在纳秒级。\n\n目前主流的实现为非易失性双列直插式内存模块NVDIMM（Non-Volatile Dual In-Line Memory Module，NVDIMM），它是持久内存的一种实现，目前有三种实现标准：\n\n-   **NVDIMM-N：** 配置同等容量的DRAM和NAND Flash，另外还有一个超大电容，当主机断电后，PMem设备会使用电容中保留的电量保证DRAM的数据同步到闪存中。\n-   **NVDIMM-F：** 使用了适配DDR规格的NAND Flash，通过多个控制器和桥接器将DDR总线信息转化为SATA协议信息来操作闪存的读写。\n-   **NVDIMM-P：** 同样配置了DRAM和NAND Flash，只不过DRAM容量会比闪存少很多，DRAM在其中作为闪存上层的缓存以优化读写性能，同样使用超大电容来保障断电后的脏数据持久。\n\nIntel傲腾第一代持久内存AEP遵循**NVDIMM-P**标准，实现了非易失性，可以按字节寻址（Byte Addressable）操作，小于1μs的延时，以及集成密度高于或等于DRAM等特性。不同于传统的NAND Flash实现，傲腾持久内存使用了新型非易失性存储器3D-XPoint，其内部是一种全新的存储介质。\n\nIntel傲腾持久内存提供多种操作模式：\n\n-   **内存模式：** 此模式下持久内存被当做超大容量的易失性内存使用，其中DRAM被称为近内存（Near Memory），持久化介质被称为远内存（Far Memory），读写性能取决于读写时命中近内存还是远内存。\n-   **AD模式：** 此模式下持久内存直接暴露给用户态的应用程序直接调用，应用程序通过持久内存感知文件系统（PMEM-Aware File System）将用户态的内存空间直接映射到持久内存设备上，从而应用程序可以直接进行加载（Load）和存储（Store）操作。这种形式也被称作DAX，意为直接访问。目前主流的文件系统ext4, xfs 都支持Direct Access的选项（-o dax)，英特尔也提供了用于在持久内存上进行编程的用户态软件库PMDK。\n\n本次比赛使用AD模式。\n\n## 分析\n\n首先关注的是正确性评测，写入过程会重启ECS，那么就要保证在append方法return之前数据要落盘，也就是说每个写入请求都要fsync刷盘。另外在重启ECS之后，会清理PMem上的数据，所以数据肯定要在ESSD上保存一份。\n\n总写入数据量为125G，而ESSD提供400G容量，正常写入的情况下不用考虑硬盘GC的问题。除了ESSD空间外，我们还有60G的PMem可用，而且文件系统通常会预留一部分文件空间作紧急情况使用，所以PMem可用容量会更高（实测真实容量为62G左右）。DRAM内存也要尽可能利用起来，首选不受JVM限制的2G堆外，剩下的6G堆内如何使用就要在GC和整体性能之间做抉择了。\n\n### 文件写入\n\n**方案1：** 每个queue一个文件，这样可以保证顺序读写，但最坏的情况下需要创建100 * 5000 = 500,000个文件，操作系统默认每个用户进程1024个句柄肯定会超限。\n\n**方案2：** 每个topic一个文件，那么最坏只需要创建100个文件，可以接受，但这意味着多个queue的数据要写入同一个文件中，无法保证顺序读写，不过可以是使用稀疏索引来做块存储。另外因为正确性评测的限制，我们需要在每次写入后手动fsync，所以这种设计下会导致频繁的fsync，也就意味着用户态与内核态之间要频繁的切来切去，另外数据大小范围为100B~17KiB，ESSD在一次写入32K以上数据时才能发挥最优性能，很明显当前设计是打不满ESSD PL1的吞吐的。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7373739442514f56b877687dc35a853b~tplv-k3u1fbpfcp-zoom-1.image)\n\n**方案3：** 所有topic共用一个文件，通过对以上弊端的思考，我们应该尽可能每次fsync时写入更多的数据，由于N个线程并发写同一个文件，所以我们可以将N个线程的数据先写入聚合缓冲中后并挂起，等待将缓冲中的数据刷盘后再取消阻塞。这个方案可以保证顺序写随机读，每次写入数据足够多，并且减少了核态的切换次数，但是刷盘变成了串行，或许能得到一个不错的ESSD吞吐，但是对CPU造成了浪费。\n\n在上一个假设上做优化，因为评测环境配置4核CPU，我们将所有线程分为4组，每组对应一个文件，这样既可以保证ESSD的性能，又可以在无法绑核的情况下尽可能压榨所有CPU的性能。\n\n文件读写的API方面，首先放弃传统的FileWriter/FileRead，相比而言，FileChannel提供双向读写能力且更易操控读写数据精度。MMap是另外一种方案，因为它只在创建的时候需要切态，理论上它的读写速度会比FileChannel更快，但是由于种种原因，MMap映射大小受限，这无疑增加了程序设计上的维护成本，另外最终场景每次写入数据量平均在64KB左右，通过Benchmark，FileChannel在这种场景下性能总是优于MMap。最终选定使用FileChannel进行文件读写，另外为了减少用户与向内核态的内存复制，使用DirectByteBuffer用作写入缓冲。\n\n**最终方案：**将所有线程分为4组，充分利用多核CPU，每组对应一个AOF数据文件，每组线程的数据写入缓冲后并挂起，缓冲刷盘后再取消阻塞，返回offset。\n\n### 缓存利用\n\n首先要明确一点，在本次赛题中，无论是DRAM还是PMem，都不能利用它们用来做数据的持久化（PMem正确性阶段重启后会做数据清理），ESSD是必须要求写入的。因此，缓存的主要利用方向在于提高读性能。\n\n首先是性能最快但是容量最小的DRAM，官方不允许使用`unsafe`来额外分配堆外的堆外内存，所以可供我们使用的DRAM只有2G的堆外以及6G的堆内，又由于JVM的GC机制外加程序本身的业务流程需要一定的内存开销，所以6G的堆内可供我们用来做数据存储的部分大打折扣（实际测下来可以用到3.2G），而堆外内存会有一部分用于文件读写缓冲，所以堆外内存可用量也会小于2G。另外就是62G的持久内存PMem，由于其性能优于ESSD数百倍，容量远大于DRAM，且ext4支持dax模式，可直接用FileChannel操作读写，对于它的合理使用直接决定了最终成绩的好坏。\n\n再回到性能评测上进行分析，我们将整个过程分为是三个阶段（重点，下文要考）：\n\n-   **一阶段：** 先写入`75G`的数据。\n-   **二阶段：** 评测程序随机挑选一半的queue从头开始读，另一半从结尾开始读，并在读的同时，继续写入`50G`的数据。\n-   **三阶段：** 随着时间的推移，最终读取的offset点位会慢慢追赶上当前写入的点位，此阶段中刚写入的数据有可能下一刻被读取。\n\n经过分析，我们需要在一阶段尽可能的将数据写入缓存，这样二阶段读取时可以减少ESSD的命中率。由于二阶段会有一半的queue从结尾开始读数据，这也就意味着这些queue之前的数据可以被淘汰，淘汰后的缓存可以复用于之后写入的数据。另外由于二阶段的过程是边读边写，读后的缓存也可以投入复用。\n\n所以理论上二阶段所有写入的数据全部可以复用到淘汰后的缓存。到了三阶段后，应该尽可能使用性能最高的DRAM来存储热数据。\n\n**最终方案：**一阶段首先将缓存写入大约5G的DRAM中，之后的数据写入62G的PMem中（此过程的ESSD一直保持着写入），每个记录的缓存信息保存在对应的queue中。来到二阶段后，将淘汰的缓存按介质类型及大小放入不同的缓存池，之后写入的数据会优先向DRAM缓存池申请缓存块，其次是PMem缓存池。\n\n当然，前期的分析也只能基于理论，最终方案的背后是无数个日日夜夜的测试和思考（卷就完了。\n\n## 整体方案\n![QQ截图20211206174435.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/868a0b81eaf147598a3159f10c5cebf0~tplv-k3u1fbpfcp-watermark.image?)\n\n一阶段开始，将所有线程随机分为4组，每组对应1个AOF文件，在写入ESSD的同时，异步写入DRAM或PMem中。理论上在写入 `5G + 62G = 67G` 数据后缓存用尽，从此刻开始到写满75G之前都只是单纯写硬盘，所有的异步任务也将在此期间全部执行完毕。\n\n二阶段开始，每次读取都会淘汰失效的缓存并放入缓存池中，写入过程中会优先按照记录大小从缓存池中获取到相应的缓存块，理想情况下每次都能申请到对应的缓存块并写入，Missing时记录数据在ESSD上的位置索引。\n\n每次读取时，根据offset从获取对应的数据索引，到索引指定的介质中读取数据并返回。\n\n### 缓存池\n\n本次赛题一共有DRAM，PMem以及ESSD三种介质，而读写的最小颗粒度为100B-17KiB的数据，我们将多个介质的的操作抽象为 `Data` 类，它提供单条数据读写功能，每种介质单独实现抽象方法，其定义如下：\n\n```java\npublic abstract class Data {\n\t\t// 缓存块大小\n    protected int capacity;\n\t\t// 数据在文件中开始存储的位置\n    protected long position;\n    // 从介质中读取\n    public abstract void get(ByteBuffer buffer);\n\t  // 从介质中写入\n\t\tpublic abstract void set(ByteBuffer buffer);\n    // 从介质中清除\n\t\tpublic abstract void clear();\n}\n\n```\n\n在一阶段中，会按照写入大小创建对应介质的Data，它记录了这条数据在当前介质中的索引信息（如果是DRAM则直接存放ByteBuffer指针），例如当DRAM和PMem写满时，Data记录的是当前数据在ESSD中的position以及capacity。\n\n二阶段开始时，随着queue的读写会淘汰无效的DRAM和PMem Data并放入对应的缓存池中，二阶段过程中的写入会优先从DRAM缓存池中获取闲置的Data，如果获取失败则从PMem缓存池获取，如果依然失败会降级为SSD Data（相当于不走缓存）。如果获取成功，则将数据写入到当前缓存块中并记录在Queue索引中。\n\n由于二阶段中的缓存块都是从缓存池中获取，因此缓存块大小是固定的，会出现块大小 **小于**当前写入数据大小的情况，当发生此类情况时，不足的大小会使用预留的堆外内存补救，这块数据被称为 `ext`，调用clear()方法同时会释放 `ext` 。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d1e2944bff44ce9a3fa82420534cf94~tplv-k3u1fbpfcp-zoom-1.image)\n\n另外，为了减少使用额外的 `ext` ，缓存池会根据 `Data` 的capacity大小将之进行分组，当从缓存池获取闲置缓存块时，会根据写入数据的大小到缓存池分组中进行匹配，取出合适区间中的缓存块进行使用。\n\n```java\n// 17K / 5 五组内存回收池\npublic LinkedBlockingQueue<Data> getReadBuffer(int cap){\n    return cap < Const.K * 3.4 ? null : cap < Const.K * 6.8 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers2 : cap < Const.K * 10.2 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ? readBuffers3 : cap < Const.K * 13.6 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers4: readBuffers5;\n}\n\n```\n\n### 数据索引\n\n程序执行过程中，数据写入后会记录一条索引到具体的queue中，由于offset从0开始并有序的特性，每个queue中会实例化一个 `ArrayList` 来记录该索引，下标即是offset，value的话则为 `Data` ：\n\n```java\nprivate final List<Data> records;\n\n```\n\n### AOF中的数据格式\n\n由于准确性阶段需要数据的recover，所以直接存储在AOF中的数据需要记录一些额外的索引信息：\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47427dbeae444e02867a4ef036b54c57~tplv-k3u1fbpfcp-zoom-1.image)\n\n当recover时，首先会读取9个Byte来获取头信息，当校验通过后，会根据Data Len来继续读取真实的数据，之后根据TopicId，QueueId，Offset等信息找到目标队列预先建立索引。\n\n### 文件预分配\n\n根据官方渠道得知，评测环境使用的文件系统为ext4，在ext4文件系统下，每次创建一个物理文件会子啊系统中注册一个inode来记录文件的元数据信息以及block索引树的根节点。\n\n当我们对文件进行读写时，首先会从extent tree中寻找合适的block逻辑地址，再从block中拿到硬盘设备中的物理地址方可操作。如果找不到合适的extent或block则需要创建，此过程还涉及到inode中元数据的变动，对内核代码简单追踪可知，最终会调用 `ext4_do_update_inode` 方法完成inode的更新。\n\n```lua\next4_write_begin\n    __block_write_begin\n        get_block -> ext4_get_block_unwritten\n            _ext4_get_block\n                ext4_map_blocks\n                    ext4_ext_map_blocks\n                        ext4_ext_insert_extent\n                            ext4_ext_dirty\n                                ext4_mark_inode_dirty\n                                    ext4_mark_iloc_dirty \n                                        ext4_do_update_inode\n\n```\n\n其内部实现过程中会先上文件内全局的自旋锁spin_lock()，在设置完新的block并更新inode元数据后调用spin_unlock()解锁，之后处理脏元数据，这个过程需要记录journal日志。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b39a87dfbd0a44b7a42b2548cfa9efc4~tplv-k3u1fbpfcp-zoom-1.image)\n\n对于一个空文件进行持续的写入，每当 `ext4_map_blocks()` 获取block失败，就会执行复杂的流程来创建新的逻辑空间到物理空间的block映射，这种开销对于性能的影响是非常致命的，对于分秒必争的比赛更是如此。\n\n为了避免这段开销，我们可以在写入空白文件之前预先写入足够多的数据，让inode预热一下，之后再从position 0开始写入。这种方法称为 **预分配** ，Linux中提供 `fallocate` 命令完成这种操作，在Java中可以手动完成：\n\n```java\nvoid fallocate(FileChannel channel, long allocateSize) throws IOException {\n      if (channel.size() == 0){\n          int batch = (int) (Const.K * 4);\n          int size = (int) (allocateSize / batch);\n          ByteBuffer buffer = ByteBuffer.allocateDirect(batch);\n          for (int i = 0; i < batch; i ++){\n              buffer.put((byte) 0);\n          }\n          for (int i = 0; i < size; i ++){\n              buffer.flip();\n              channel.write(buffer);\n          }\n          channel.force(true);\n          channel.position(0);\n          Utils.recycleByteBuffer(buffer);\n      }\n  }\n\n```\n\n当然，预分配不是适用于所有场景，本次赛题的计时从第一次append开始，所以有足够的时间在程序初始化过程中完成预分配。再者就是SSD硬盘空间的容量最好足够大，如果容量与要写入的数据相当，预分配后再进行写入时，会导致SSD内部频繁的Foreground GC，性能下降。\n\n### 4K对齐\n\n传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前`512 * 63 / 1024 = 31.5`KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。\n\n除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，Page 1写满了4KB，而Page2只写入1KB，当再次向文件顺序写入数据时，需要将Page2数据预先读出来，然后与新写入数据在内存中合并后再写入新的Page 3中，之前的Page 2则标记为 `stale` 等待被GC。这种带来的开销被称为写入放大WA（Write Amplification）。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7718674f47284afba5fff121cac804db~tplv-k3u1fbpfcp-zoom-1.image)\n\n为了减小WA，我们可以人工补充缺少的数据。对于本次赛题，当写入缓冲刷盘前，将写入Buffer的position右移至最近的4KB整数倍点位即可。\n\n### 预读取\n\n二阶段中，我们需要做的是从queue中获取请求区间所有的 `Data` ，并根据 `Data` 中的索引信息将真实数据从对应介质中读取出来，而且这个过程通常是批量的，具体数量由入参 `fetchNum` 控制。\n\n最开始我使用 `Semaphore` 对批量数据多线程并发读，并且得到了不错的效果。但是背后却埋着不小的坑，由于每次getRange要频繁的对多个线程阻塞和取消阻塞，线程上下文切换带来开销非常严重，有兴趣的读者可以运行以下测试代码（并把 **我不能接受**打在弹幕里）：\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.Semaphore;\nimport java.util.concurrent.ThreadPoolExecutor;\npublic class Test {\n    public static void main(String[] args) throws InterruptedException {\n        int count = 100 * 10000;\n        int batch = 1;\n        ThreadPoolExecutor pools = \n\t\t\t\t(ThreadPoolExecutor) Executors.newFixedThreadPool(batch);\n        Semaphore semaphore = new Semaphore(0);\n        long start = System.currentTimeMillis();\n        for (int i = 0; i < count; i ++){\n            for (int j = 0; j < batch; j ++){\n                pools.execute(semaphore::release);\n            }\n            semaphore.acquire(batch);\n        }\n        long end = System.currentTimeMillis();\n        System.out.println(end - start);\n    }\n}\n\n```\n\n我不能接受，但是又要保证getRange阶段尽可能并发读取，于是乎我将思路转向了预读取，方法与Page Cache预读类似，举个栗子：当getRange读第0 ~ 10条数据的时候，从线程池中取个线程预读取第10 ~ 20条数据，并将这些数据存储在缓存块中，实际测试中，足够多的PMem缓存块使我们不用担心缓存池匮乏的问题。\n\n### 顺带一提\n\n-   评测阶段线程数量不固定，好在所有线程几乎同时执行，所以在写入时阻塞一段时间获取到线程数量，之后再对其进行分组。\n-   每个线程要持续运行，所以将线程内数据存入ThreadLocal中，并尽可能复用。\n-   数据格式中的offset或许可以拿掉，每条记录可以省去4 Byte的空间。\n-   两个方法的入参中，Topic的类型为String，但是格式固定为TopicN，可以搞个超大switch方法将其转为int类型，方便之后的存储与读取。\n\n## 结束\n\n不知不觉，比赛已经结束，写这篇文章的时候明天就要上交的PPT还未开工，这次比赛收获很多，遗憾也不少，收获了很多卷友，遗憾自己未能如心。\n\n从第一个方案出分的惊喜若狂到优化过程中的绞尽脑汁，每一秒的进步都带来了无与伦比的成就感。从为了给女朋友买个电瓶车代步的决心下定开始，仿佛就以注定要在这条道路上一卷无前。\n\n来年，希望张三再发一次橙图（也不一定是橙色），到时候如果我心有余力，肯定很快点进来，然后一键三连。\n\n仓库地址：[https://github.com/ainilili/tianchi-race-2021](https://github.com/ainilili/tianchi-race-2021)\n\n## 参考\n\n-   [Ext4](https://github.com/torvalds/linux/tree/master/fs/ext4)\n-   [持久内存架构与工程实践](https://item.jd.com/13127464.html)\n-   [深入浅出SSD - 固态存储核心技术原理与实战](https://item.jd.com/12367097.html)","source":"_posts/【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计.md","raw":"title: 【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计\nauthor: Nico\ntags: []\ncategories: []\ndate: 2022-02-22 12:25:00\n---\n## 引子\n\n在一个浑浑噩噩的下午，百无聊赖的我像往常一样点开了划水交流群，细细品味着老哥们关于量子力学的讨论。嬉戏间，平常水不拉几的群友张三忽然发了一张大大的橙图，我啪的一下点开了，很快啊，仔细观摩后发现原来是2021第二届云原生编程挑战赛报名的海报，暗暗的想起了被我鸽掉的前几届，小手不自觉地打开了链接并且一键三连。\n\n每个人的心里都有一个童心未泯的自己，这次比赛就像一场游戏一样让我深陷其中，三岔路口，我选择了存储领域，谁承想这决定会让我在接下来的两个月里减少百分之N的发量。\n\n## 读题\n\n[赛题](https://tianchi.aliyun.com/competition/entrance/531922/information)目的是实现简单的消息读取与存储，程序需要实现`append`和`getRange`方法，并依次通过性能评测与正确性评测，性能评测耗时最少者居高。\n\n### 评测环境\n\nLinux下的4核8G服务器，配置`400G` ESSD PL1云盘，吞吐可达`320MiB/s`，`60G` Intel 傲腾持久内存PMem（Persistent Memory），由参考文档可推测为第一代持久内存，代号为AEP。\n\n赛题编程语言限制为Java8，JVM配置为6G堆内+2G堆外。\n\n### 性能评测\n\n评测程序首先会创建10~50个不等的线程，每个线程随机分配若干个topic进行写入，topic总数量不超过100个。每个topic之下又分为若干个queue，总数量不超过5000个，调用append方法后返回当前数据在queue中的offset，由0开始。每次写入数据大小为100B-17KiB区间随机，当写满75G数据后，会挑选一半的queue由下标0（头）开始读取，另外一半从当前最大下标（尾）开始读取，并保持之前的写入压力继续写入50G数据，最后一条数据读取完毕后停止计时。\n\n### 正确性评测\n\n同样会使用N个线程写入数据，在写入过程中会重启ECS，之后再读取之前写入成功的数据（返回offset即视为成功），要求严格一致。\n\n### 持久内存\n\n本次比赛多了一个比较陌生的存储介质PMem，它结合了内存的读写性能和持久化的特性，可以在延迟可以控制在纳秒级。\n\n目前主流的实现为非易失性双列直插式内存模块NVDIMM（Non-Volatile Dual In-Line Memory Module，NVDIMM），它是持久内存的一种实现，目前有三种实现标准：\n\n-   **NVDIMM-N：** 配置同等容量的DRAM和NAND Flash，另外还有一个超大电容，当主机断电后，PMem设备会使用电容中保留的电量保证DRAM的数据同步到闪存中。\n-   **NVDIMM-F：** 使用了适配DDR规格的NAND Flash，通过多个控制器和桥接器将DDR总线信息转化为SATA协议信息来操作闪存的读写。\n-   **NVDIMM-P：** 同样配置了DRAM和NAND Flash，只不过DRAM容量会比闪存少很多，DRAM在其中作为闪存上层的缓存以优化读写性能，同样使用超大电容来保障断电后的脏数据持久。\n\nIntel傲腾第一代持久内存AEP遵循**NVDIMM-P**标准，实现了非易失性，可以按字节寻址（Byte Addressable）操作，小于1μs的延时，以及集成密度高于或等于DRAM等特性。不同于传统的NAND Flash实现，傲腾持久内存使用了新型非易失性存储器3D-XPoint，其内部是一种全新的存储介质。\n\nIntel傲腾持久内存提供多种操作模式：\n\n-   **内存模式：** 此模式下持久内存被当做超大容量的易失性内存使用，其中DRAM被称为近内存（Near Memory），持久化介质被称为远内存（Far Memory），读写性能取决于读写时命中近内存还是远内存。\n-   **AD模式：** 此模式下持久内存直接暴露给用户态的应用程序直接调用，应用程序通过持久内存感知文件系统（PMEM-Aware File System）将用户态的内存空间直接映射到持久内存设备上，从而应用程序可以直接进行加载（Load）和存储（Store）操作。这种形式也被称作DAX，意为直接访问。目前主流的文件系统ext4, xfs 都支持Direct Access的选项（-o dax)，英特尔也提供了用于在持久内存上进行编程的用户态软件库PMDK。\n\n本次比赛使用AD模式。\n\n## 分析\n\n首先关注的是正确性评测，写入过程会重启ECS，那么就要保证在append方法return之前数据要落盘，也就是说每个写入请求都要fsync刷盘。另外在重启ECS之后，会清理PMem上的数据，所以数据肯定要在ESSD上保存一份。\n\n总写入数据量为125G，而ESSD提供400G容量，正常写入的情况下不用考虑硬盘GC的问题。除了ESSD空间外，我们还有60G的PMem可用，而且文件系统通常会预留一部分文件空间作紧急情况使用，所以PMem可用容量会更高（实测真实容量为62G左右）。DRAM内存也要尽可能利用起来，首选不受JVM限制的2G堆外，剩下的6G堆内如何使用就要在GC和整体性能之间做抉择了。\n\n### 文件写入\n\n**方案1：** 每个queue一个文件，这样可以保证顺序读写，但最坏的情况下需要创建100 * 5000 = 500,000个文件，操作系统默认每个用户进程1024个句柄肯定会超限。\n\n**方案2：** 每个topic一个文件，那么最坏只需要创建100个文件，可以接受，但这意味着多个queue的数据要写入同一个文件中，无法保证顺序读写，不过可以是使用稀疏索引来做块存储。另外因为正确性评测的限制，我们需要在每次写入后手动fsync，所以这种设计下会导致频繁的fsync，也就意味着用户态与内核态之间要频繁的切来切去，另外数据大小范围为100B~17KiB，ESSD在一次写入32K以上数据时才能发挥最优性能，很明显当前设计是打不满ESSD PL1的吞吐的。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7373739442514f56b877687dc35a853b~tplv-k3u1fbpfcp-zoom-1.image)\n\n**方案3：** 所有topic共用一个文件，通过对以上弊端的思考，我们应该尽可能每次fsync时写入更多的数据，由于N个线程并发写同一个文件，所以我们可以将N个线程的数据先写入聚合缓冲中后并挂起，等待将缓冲中的数据刷盘后再取消阻塞。这个方案可以保证顺序写随机读，每次写入数据足够多，并且减少了核态的切换次数，但是刷盘变成了串行，或许能得到一个不错的ESSD吞吐，但是对CPU造成了浪费。\n\n在上一个假设上做优化，因为评测环境配置4核CPU，我们将所有线程分为4组，每组对应一个文件，这样既可以保证ESSD的性能，又可以在无法绑核的情况下尽可能压榨所有CPU的性能。\n\n文件读写的API方面，首先放弃传统的FileWriter/FileRead，相比而言，FileChannel提供双向读写能力且更易操控读写数据精度。MMap是另外一种方案，因为它只在创建的时候需要切态，理论上它的读写速度会比FileChannel更快，但是由于种种原因，MMap映射大小受限，这无疑增加了程序设计上的维护成本，另外最终场景每次写入数据量平均在64KB左右，通过Benchmark，FileChannel在这种场景下性能总是优于MMap。最终选定使用FileChannel进行文件读写，另外为了减少用户与向内核态的内存复制，使用DirectByteBuffer用作写入缓冲。\n\n**最终方案：**将所有线程分为4组，充分利用多核CPU，每组对应一个AOF数据文件，每组线程的数据写入缓冲后并挂起，缓冲刷盘后再取消阻塞，返回offset。\n\n### 缓存利用\n\n首先要明确一点，在本次赛题中，无论是DRAM还是PMem，都不能利用它们用来做数据的持久化（PMem正确性阶段重启后会做数据清理），ESSD是必须要求写入的。因此，缓存的主要利用方向在于提高读性能。\n\n首先是性能最快但是容量最小的DRAM，官方不允许使用`unsafe`来额外分配堆外的堆外内存，所以可供我们使用的DRAM只有2G的堆外以及6G的堆内，又由于JVM的GC机制外加程序本身的业务流程需要一定的内存开销，所以6G的堆内可供我们用来做数据存储的部分大打折扣（实际测下来可以用到3.2G），而堆外内存会有一部分用于文件读写缓冲，所以堆外内存可用量也会小于2G。另外就是62G的持久内存PMem，由于其性能优于ESSD数百倍，容量远大于DRAM，且ext4支持dax模式，可直接用FileChannel操作读写，对于它的合理使用直接决定了最终成绩的好坏。\n\n再回到性能评测上进行分析，我们将整个过程分为是三个阶段（重点，下文要考）：\n\n-   **一阶段：** 先写入`75G`的数据。\n-   **二阶段：** 评测程序随机挑选一半的queue从头开始读，另一半从结尾开始读，并在读的同时，继续写入`50G`的数据。\n-   **三阶段：** 随着时间的推移，最终读取的offset点位会慢慢追赶上当前写入的点位，此阶段中刚写入的数据有可能下一刻被读取。\n\n经过分析，我们需要在一阶段尽可能的将数据写入缓存，这样二阶段读取时可以减少ESSD的命中率。由于二阶段会有一半的queue从结尾开始读数据，这也就意味着这些queue之前的数据可以被淘汰，淘汰后的缓存可以复用于之后写入的数据。另外由于二阶段的过程是边读边写，读后的缓存也可以投入复用。\n\n所以理论上二阶段所有写入的数据全部可以复用到淘汰后的缓存。到了三阶段后，应该尽可能使用性能最高的DRAM来存储热数据。\n\n**最终方案：**一阶段首先将缓存写入大约5G的DRAM中，之后的数据写入62G的PMem中（此过程的ESSD一直保持着写入），每个记录的缓存信息保存在对应的queue中。来到二阶段后，将淘汰的缓存按介质类型及大小放入不同的缓存池，之后写入的数据会优先向DRAM缓存池申请缓存块，其次是PMem缓存池。\n\n当然，前期的分析也只能基于理论，最终方案的背后是无数个日日夜夜的测试和思考（卷就完了。\n\n## 整体方案\n![QQ截图20211206174435.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/868a0b81eaf147598a3159f10c5cebf0~tplv-k3u1fbpfcp-watermark.image?)\n\n一阶段开始，将所有线程随机分为4组，每组对应1个AOF文件，在写入ESSD的同时，异步写入DRAM或PMem中。理论上在写入 `5G + 62G = 67G` 数据后缓存用尽，从此刻开始到写满75G之前都只是单纯写硬盘，所有的异步任务也将在此期间全部执行完毕。\n\n二阶段开始，每次读取都会淘汰失效的缓存并放入缓存池中，写入过程中会优先按照记录大小从缓存池中获取到相应的缓存块，理想情况下每次都能申请到对应的缓存块并写入，Missing时记录数据在ESSD上的位置索引。\n\n每次读取时，根据offset从获取对应的数据索引，到索引指定的介质中读取数据并返回。\n\n### 缓存池\n\n本次赛题一共有DRAM，PMem以及ESSD三种介质，而读写的最小颗粒度为100B-17KiB的数据，我们将多个介质的的操作抽象为 `Data` 类，它提供单条数据读写功能，每种介质单独实现抽象方法，其定义如下：\n\n```java\npublic abstract class Data {\n\t\t// 缓存块大小\n    protected int capacity;\n\t\t// 数据在文件中开始存储的位置\n    protected long position;\n    // 从介质中读取\n    public abstract void get(ByteBuffer buffer);\n\t  // 从介质中写入\n\t\tpublic abstract void set(ByteBuffer buffer);\n    // 从介质中清除\n\t\tpublic abstract void clear();\n}\n\n```\n\n在一阶段中，会按照写入大小创建对应介质的Data，它记录了这条数据在当前介质中的索引信息（如果是DRAM则直接存放ByteBuffer指针），例如当DRAM和PMem写满时，Data记录的是当前数据在ESSD中的position以及capacity。\n\n二阶段开始时，随着queue的读写会淘汰无效的DRAM和PMem Data并放入对应的缓存池中，二阶段过程中的写入会优先从DRAM缓存池中获取闲置的Data，如果获取失败则从PMem缓存池获取，如果依然失败会降级为SSD Data（相当于不走缓存）。如果获取成功，则将数据写入到当前缓存块中并记录在Queue索引中。\n\n由于二阶段中的缓存块都是从缓存池中获取，因此缓存块大小是固定的，会出现块大小 **小于**当前写入数据大小的情况，当发生此类情况时，不足的大小会使用预留的堆外内存补救，这块数据被称为 `ext`，调用clear()方法同时会释放 `ext` 。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d1e2944bff44ce9a3fa82420534cf94~tplv-k3u1fbpfcp-zoom-1.image)\n\n另外，为了减少使用额外的 `ext` ，缓存池会根据 `Data` 的capacity大小将之进行分组，当从缓存池获取闲置缓存块时，会根据写入数据的大小到缓存池分组中进行匹配，取出合适区间中的缓存块进行使用。\n\n```java\n// 17K / 5 五组内存回收池\npublic LinkedBlockingQueue<Data> getReadBuffer(int cap){\n    return cap < Const.K * 3.4 ? null : cap < Const.K * 6.8 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers2 : cap < Const.K * 10.2 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ? readBuffers3 : cap < Const.K * 13.6 \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers4: readBuffers5;\n}\n\n```\n\n### 数据索引\n\n程序执行过程中，数据写入后会记录一条索引到具体的queue中，由于offset从0开始并有序的特性，每个queue中会实例化一个 `ArrayList` 来记录该索引，下标即是offset，value的话则为 `Data` ：\n\n```java\nprivate final List<Data> records;\n\n```\n\n### AOF中的数据格式\n\n由于准确性阶段需要数据的recover，所以直接存储在AOF中的数据需要记录一些额外的索引信息：\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47427dbeae444e02867a4ef036b54c57~tplv-k3u1fbpfcp-zoom-1.image)\n\n当recover时，首先会读取9个Byte来获取头信息，当校验通过后，会根据Data Len来继续读取真实的数据，之后根据TopicId，QueueId，Offset等信息找到目标队列预先建立索引。\n\n### 文件预分配\n\n根据官方渠道得知，评测环境使用的文件系统为ext4，在ext4文件系统下，每次创建一个物理文件会子啊系统中注册一个inode来记录文件的元数据信息以及block索引树的根节点。\n\n当我们对文件进行读写时，首先会从extent tree中寻找合适的block逻辑地址，再从block中拿到硬盘设备中的物理地址方可操作。如果找不到合适的extent或block则需要创建，此过程还涉及到inode中元数据的变动，对内核代码简单追踪可知，最终会调用 `ext4_do_update_inode` 方法完成inode的更新。\n\n```lua\next4_write_begin\n    __block_write_begin\n        get_block -> ext4_get_block_unwritten\n            _ext4_get_block\n                ext4_map_blocks\n                    ext4_ext_map_blocks\n                        ext4_ext_insert_extent\n                            ext4_ext_dirty\n                                ext4_mark_inode_dirty\n                                    ext4_mark_iloc_dirty \n                                        ext4_do_update_inode\n\n```\n\n其内部实现过程中会先上文件内全局的自旋锁spin_lock()，在设置完新的block并更新inode元数据后调用spin_unlock()解锁，之后处理脏元数据，这个过程需要记录journal日志。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b39a87dfbd0a44b7a42b2548cfa9efc4~tplv-k3u1fbpfcp-zoom-1.image)\n\n对于一个空文件进行持续的写入，每当 `ext4_map_blocks()` 获取block失败，就会执行复杂的流程来创建新的逻辑空间到物理空间的block映射，这种开销对于性能的影响是非常致命的，对于分秒必争的比赛更是如此。\n\n为了避免这段开销，我们可以在写入空白文件之前预先写入足够多的数据，让inode预热一下，之后再从position 0开始写入。这种方法称为 **预分配** ，Linux中提供 `fallocate` 命令完成这种操作，在Java中可以手动完成：\n\n```java\nvoid fallocate(FileChannel channel, long allocateSize) throws IOException {\n      if (channel.size() == 0){\n          int batch = (int) (Const.K * 4);\n          int size = (int) (allocateSize / batch);\n          ByteBuffer buffer = ByteBuffer.allocateDirect(batch);\n          for (int i = 0; i < batch; i ++){\n              buffer.put((byte) 0);\n          }\n          for (int i = 0; i < size; i ++){\n              buffer.flip();\n              channel.write(buffer);\n          }\n          channel.force(true);\n          channel.position(0);\n          Utils.recycleByteBuffer(buffer);\n      }\n  }\n\n```\n\n当然，预分配不是适用于所有场景，本次赛题的计时从第一次append开始，所以有足够的时间在程序初始化过程中完成预分配。再者就是SSD硬盘空间的容量最好足够大，如果容量与要写入的数据相当，预分配后再进行写入时，会导致SSD内部频繁的Foreground GC，性能下降。\n\n### 4K对齐\n\n传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前`512 * 63 / 1024 = 31.5`KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。\n\n除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，Page 1写满了4KB，而Page2只写入1KB，当再次向文件顺序写入数据时，需要将Page2数据预先读出来，然后与新写入数据在内存中合并后再写入新的Page 3中，之前的Page 2则标记为 `stale` 等待被GC。这种带来的开销被称为写入放大WA（Write Amplification）。\n\n![enter image description here](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7718674f47284afba5fff121cac804db~tplv-k3u1fbpfcp-zoom-1.image)\n\n为了减小WA，我们可以人工补充缺少的数据。对于本次赛题，当写入缓冲刷盘前，将写入Buffer的position右移至最近的4KB整数倍点位即可。\n\n### 预读取\n\n二阶段中，我们需要做的是从queue中获取请求区间所有的 `Data` ，并根据 `Data` 中的索引信息将真实数据从对应介质中读取出来，而且这个过程通常是批量的，具体数量由入参 `fetchNum` 控制。\n\n最开始我使用 `Semaphore` 对批量数据多线程并发读，并且得到了不错的效果。但是背后却埋着不小的坑，由于每次getRange要频繁的对多个线程阻塞和取消阻塞，线程上下文切换带来开销非常严重，有兴趣的读者可以运行以下测试代码（并把 **我不能接受**打在弹幕里）：\n\n```java\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.Semaphore;\nimport java.util.concurrent.ThreadPoolExecutor;\npublic class Test {\n    public static void main(String[] args) throws InterruptedException {\n        int count = 100 * 10000;\n        int batch = 1;\n        ThreadPoolExecutor pools = \n\t\t\t\t(ThreadPoolExecutor) Executors.newFixedThreadPool(batch);\n        Semaphore semaphore = new Semaphore(0);\n        long start = System.currentTimeMillis();\n        for (int i = 0; i < count; i ++){\n            for (int j = 0; j < batch; j ++){\n                pools.execute(semaphore::release);\n            }\n            semaphore.acquire(batch);\n        }\n        long end = System.currentTimeMillis();\n        System.out.println(end - start);\n    }\n}\n\n```\n\n我不能接受，但是又要保证getRange阶段尽可能并发读取，于是乎我将思路转向了预读取，方法与Page Cache预读类似，举个栗子：当getRange读第0 ~ 10条数据的时候，从线程池中取个线程预读取第10 ~ 20条数据，并将这些数据存储在缓存块中，实际测试中，足够多的PMem缓存块使我们不用担心缓存池匮乏的问题。\n\n### 顺带一提\n\n-   评测阶段线程数量不固定，好在所有线程几乎同时执行，所以在写入时阻塞一段时间获取到线程数量，之后再对其进行分组。\n-   每个线程要持续运行，所以将线程内数据存入ThreadLocal中，并尽可能复用。\n-   数据格式中的offset或许可以拿掉，每条记录可以省去4 Byte的空间。\n-   两个方法的入参中，Topic的类型为String，但是格式固定为TopicN，可以搞个超大switch方法将其转为int类型，方便之后的存储与读取。\n\n## 结束\n\n不知不觉，比赛已经结束，写这篇文章的时候明天就要上交的PPT还未开工，这次比赛收获很多，遗憾也不少，收获了很多卷友，遗憾自己未能如心。\n\n从第一个方案出分的惊喜若狂到优化过程中的绞尽脑汁，每一秒的进步都带来了无与伦比的成就感。从为了给女朋友买个电瓶车代步的决心下定开始，仿佛就以注定要在这条道路上一卷无前。\n\n来年，希望张三再发一次橙图（也不一定是橙色），到时候如果我心有余力，肯定很快点进来，然后一键三连。\n\n仓库地址：[https://github.com/ainilili/tianchi-race-2021](https://github.com/ainilili/tianchi-race-2021)\n\n## 参考\n\n-   [Ext4](https://github.com/torvalds/linux/tree/master/fs/ext4)\n-   [持久内存架构与工程实践](https://item.jd.com/13127464.html)\n-   [深入浅出SSD - 固态存储核心技术原理与实战](https://item.jd.com/12367097.html)","slug":"【参赛总结】第二届云原生编程挑战赛-冷热读写场景的RocketMQ存储系统设计","published":1,"updated":"2022-02-22T04:26:52.166Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyd000wb0tzf4mb0juz","content":"<h2 id=\"引子\"><a class=\"header-anchor\" href=\"#引子\">¶</a>引子</h2>\n<p>在一个浑浑噩噩的下午，百无聊赖的我像往常一样点开了划水交流群，细细品味着老哥们关于量子力学的讨论。嬉戏间，平常水不拉几的群友张三忽然发了一张大大的橙图，我啪的一下点开了，很快啊，仔细观摩后发现原来是2021第二届云原生编程挑战赛报名的海报，暗暗的想起了被我鸽掉的前几届，小手不自觉地打开了链接并且一键三连。</p>\n<p>每个人的心里都有一个童心未泯的自己，这次比赛就像一场游戏一样让我深陷其中，三岔路口，我选择了存储领域，谁承想这决定会让我在接下来的两个月里减少百分之N的发量。</p>\n<h2 id=\"读题\"><a class=\"header-anchor\" href=\"#读题\">¶</a>读题</h2>\n<p><a href=\"https://tianchi.aliyun.com/competition/entrance/531922/information\">赛题</a>目的是实现简单的消息读取与存储，程序需要实现<code>append</code>和<code>getRange</code>方法，并依次通过性能评测与正确性评测，性能评测耗时最少者居高。</p>\n<h3 id=\"评测环境\"><a class=\"header-anchor\" href=\"#评测环境\">¶</a>评测环境</h3>\n<p>Linux下的4核8G服务器，配置<code>400G</code> ESSD PL1云盘，吞吐可达<code>320MiB/s</code>，<code>60G</code> Intel 傲腾持久内存PMem（Persistent Memory），由参考文档可推测为第一代持久内存，代号为AEP。</p>\n<p>赛题编程语言限制为Java8，JVM配置为6G堆内+2G堆外。</p>\n<h3 id=\"性能评测\"><a class=\"header-anchor\" href=\"#性能评测\">¶</a>性能评测</h3>\n<p>评测程序首先会创建10~50个不等的线程，每个线程随机分配若干个topic进行写入，topic总数量不超过100个。每个topic之下又分为若干个queue，总数量不超过5000个，调用append方法后返回当前数据在queue中的offset，由0开始。每次写入数据大小为100B-17KiB区间随机，当写满75G数据后，会挑选一半的queue由下标0（头）开始读取，另外一半从当前最大下标（尾）开始读取，并保持之前的写入压力继续写入50G数据，最后一条数据读取完毕后停止计时。</p>\n<h3 id=\"正确性评测\"><a class=\"header-anchor\" href=\"#正确性评测\">¶</a>正确性评测</h3>\n<p>同样会使用N个线程写入数据，在写入过程中会重启ECS，之后再读取之前写入成功的数据（返回offset即视为成功），要求严格一致。</p>\n<h3 id=\"持久内存\"><a class=\"header-anchor\" href=\"#持久内存\">¶</a>持久内存</h3>\n<p>本次比赛多了一个比较陌生的存储介质PMem，它结合了内存的读写性能和持久化的特性，可以在延迟可以控制在纳秒级。</p>\n<p>目前主流的实现为非易失性双列直插式内存模块NVDIMM（Non-Volatile Dual In-Line Memory Module，NVDIMM），它是持久内存的一种实现，目前有三种实现标准：</p>\n<ul>\n<li><strong>NVDIMM-N：</strong> 配置同等容量的DRAM和NAND Flash，另外还有一个超大电容，当主机断电后，PMem设备会使用电容中保留的电量保证DRAM的数据同步到闪存中。</li>\n<li><strong>NVDIMM-F：</strong> 使用了适配DDR规格的NAND Flash，通过多个控制器和桥接器将DDR总线信息转化为SATA协议信息来操作闪存的读写。</li>\n<li><strong>NVDIMM-P：</strong> 同样配置了DRAM和NAND Flash，只不过DRAM容量会比闪存少很多，DRAM在其中作为闪存上层的缓存以优化读写性能，同样使用超大电容来保障断电后的脏数据持久。</li>\n</ul>\n<p>Intel傲腾第一代持久内存AEP遵循<strong>NVDIMM-P</strong>标准，实现了非易失性，可以按字节寻址（Byte Addressable）操作，小于1μs的延时，以及集成密度高于或等于DRAM等特性。不同于传统的NAND Flash实现，傲腾持久内存使用了新型非易失性存储器3D-XPoint，其内部是一种全新的存储介质。</p>\n<p>Intel傲腾持久内存提供多种操作模式：</p>\n<ul>\n<li><strong>内存模式：</strong> 此模式下持久内存被当做超大容量的易失性内存使用，其中DRAM被称为近内存（Near Memory），持久化介质被称为远内存（Far Memory），读写性能取决于读写时命中近内存还是远内存。</li>\n<li><strong>AD模式：</strong> 此模式下持久内存直接暴露给用户态的应用程序直接调用，应用程序通过持久内存感知文件系统（PMEM-Aware File System）将用户态的内存空间直接映射到持久内存设备上，从而应用程序可以直接进行加载（Load）和存储（Store）操作。这种形式也被称作DAX，意为直接访问。目前主流的文件系统ext4, xfs 都支持Direct Access的选项（-o dax)，英特尔也提供了用于在持久内存上进行编程的用户态软件库PMDK。</li>\n</ul>\n<p>本次比赛使用AD模式。</p>\n<h2 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h2>\n<p>首先关注的是正确性评测，写入过程会重启ECS，那么就要保证在append方法return之前数据要落盘，也就是说每个写入请求都要fsync刷盘。另外在重启ECS之后，会清理PMem上的数据，所以数据肯定要在ESSD上保存一份。</p>\n<p>总写入数据量为125G，而ESSD提供400G容量，正常写入的情况下不用考虑硬盘GC的问题。除了ESSD空间外，我们还有60G的PMem可用，而且文件系统通常会预留一部分文件空间作紧急情况使用，所以PMem可用容量会更高（实测真实容量为62G左右）。DRAM内存也要尽可能利用起来，首选不受JVM限制的2G堆外，剩下的6G堆内如何使用就要在GC和整体性能之间做抉择了。</p>\n<h3 id=\"文件写入\"><a class=\"header-anchor\" href=\"#文件写入\">¶</a>文件写入</h3>\n<p><strong>方案1：</strong> 每个queue一个文件，这样可以保证顺序读写，但最坏的情况下需要创建100 * 5000 = 500,000个文件，操作系统默认每个用户进程1024个句柄肯定会超限。</p>\n<p><strong>方案2：</strong> 每个topic一个文件，那么最坏只需要创建100个文件，可以接受，但这意味着多个queue的数据要写入同一个文件中，无法保证顺序读写，不过可以是使用稀疏索引来做块存储。另外因为正确性评测的限制，我们需要在每次写入后手动fsync，所以这种设计下会导致频繁的fsync，也就意味着用户态与内核态之间要频繁的切来切去，另外数据大小范围为100B~17KiB，ESSD在一次写入32K以上数据时才能发挥最优性能，很明显当前设计是打不满ESSD PL1的吞吐的。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7373739442514f56b877687dc35a853b~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p><strong>方案3：</strong> 所有topic共用一个文件，通过对以上弊端的思考，我们应该尽可能每次fsync时写入更多的数据，由于N个线程并发写同一个文件，所以我们可以将N个线程的数据先写入聚合缓冲中后并挂起，等待将缓冲中的数据刷盘后再取消阻塞。这个方案可以保证顺序写随机读，每次写入数据足够多，并且减少了核态的切换次数，但是刷盘变成了串行，或许能得到一个不错的ESSD吞吐，但是对CPU造成了浪费。</p>\n<p>在上一个假设上做优化，因为评测环境配置4核CPU，我们将所有线程分为4组，每组对应一个文件，这样既可以保证ESSD的性能，又可以在无法绑核的情况下尽可能压榨所有CPU的性能。</p>\n<p>文件读写的API方面，首先放弃传统的FileWriter/FileRead，相比而言，FileChannel提供双向读写能力且更易操控读写数据精度。MMap是另外一种方案，因为它只在创建的时候需要切态，理论上它的读写速度会比FileChannel更快，但是由于种种原因，MMap映射大小受限，这无疑增加了程序设计上的维护成本，另外最终场景每次写入数据量平均在64KB左右，通过Benchmark，FileChannel在这种场景下性能总是优于MMap。最终选定使用FileChannel进行文件读写，另外为了减少用户与向内核态的内存复制，使用DirectByteBuffer用作写入缓冲。</p>\n<p>**最终方案：**将所有线程分为4组，充分利用多核CPU，每组对应一个AOF数据文件，每组线程的数据写入缓冲后并挂起，缓冲刷盘后再取消阻塞，返回offset。</p>\n<h3 id=\"缓存利用\"><a class=\"header-anchor\" href=\"#缓存利用\">¶</a>缓存利用</h3>\n<p>首先要明确一点，在本次赛题中，无论是DRAM还是PMem，都不能利用它们用来做数据的持久化（PMem正确性阶段重启后会做数据清理），ESSD是必须要求写入的。因此，缓存的主要利用方向在于提高读性能。</p>\n<p>首先是性能最快但是容量最小的DRAM，官方不允许使用<code>unsafe</code>来额外分配堆外的堆外内存，所以可供我们使用的DRAM只有2G的堆外以及6G的堆内，又由于JVM的GC机制外加程序本身的业务流程需要一定的内存开销，所以6G的堆内可供我们用来做数据存储的部分大打折扣（实际测下来可以用到3.2G），而堆外内存会有一部分用于文件读写缓冲，所以堆外内存可用量也会小于2G。另外就是62G的持久内存PMem，由于其性能优于ESSD数百倍，容量远大于DRAM，且ext4支持dax模式，可直接用FileChannel操作读写，对于它的合理使用直接决定了最终成绩的好坏。</p>\n<p>再回到性能评测上进行分析，我们将整个过程分为是三个阶段（重点，下文要考）：</p>\n<ul>\n<li><strong>一阶段：</strong> 先写入<code>75G</code>的数据。</li>\n<li><strong>二阶段：</strong> 评测程序随机挑选一半的queue从头开始读，另一半从结尾开始读，并在读的同时，继续写入<code>50G</code>的数据。</li>\n<li><strong>三阶段：</strong> 随着时间的推移，最终读取的offset点位会慢慢追赶上当前写入的点位，此阶段中刚写入的数据有可能下一刻被读取。</li>\n</ul>\n<p>经过分析，我们需要在一阶段尽可能的将数据写入缓存，这样二阶段读取时可以减少ESSD的命中率。由于二阶段会有一半的queue从结尾开始读数据，这也就意味着这些queue之前的数据可以被淘汰，淘汰后的缓存可以复用于之后写入的数据。另外由于二阶段的过程是边读边写，读后的缓存也可以投入复用。</p>\n<p>所以理论上二阶段所有写入的数据全部可以复用到淘汰后的缓存。到了三阶段后，应该尽可能使用性能最高的DRAM来存储热数据。</p>\n<p>**最终方案：**一阶段首先将缓存写入大约5G的DRAM中，之后的数据写入62G的PMem中（此过程的ESSD一直保持着写入），每个记录的缓存信息保存在对应的queue中。来到二阶段后，将淘汰的缓存按介质类型及大小放入不同的缓存池，之后写入的数据会优先向DRAM缓存池申请缓存块，其次是PMem缓存池。</p>\n<p>当然，前期的分析也只能基于理论，最终方案的背后是无数个日日夜夜的测试和思考（卷就完了。</p>\n<h2 id=\"整体方案\"><a class=\"header-anchor\" href=\"#整体方案\">¶</a>整体方案</h2>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/868a0b81eaf147598a3159f10c5cebf0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"QQ截图20211206174435.png\"></p>\n<p>一阶段开始，将所有线程随机分为4组，每组对应1个AOF文件，在写入ESSD的同时，异步写入DRAM或PMem中。理论上在写入 <code>5G + 62G = 67G</code> 数据后缓存用尽，从此刻开始到写满75G之前都只是单纯写硬盘，所有的异步任务也将在此期间全部执行完毕。</p>\n<p>二阶段开始，每次读取都会淘汰失效的缓存并放入缓存池中，写入过程中会优先按照记录大小从缓存池中获取到相应的缓存块，理想情况下每次都能申请到对应的缓存块并写入，Missing时记录数据在ESSD上的位置索引。</p>\n<p>每次读取时，根据offset从获取对应的数据索引，到索引指定的介质中读取数据并返回。</p>\n<h3 id=\"缓存池\"><a class=\"header-anchor\" href=\"#缓存池\">¶</a>缓存池</h3>\n<p>本次赛题一共有DRAM，PMem以及ESSD三种介质，而读写的最小颗粒度为100B-17KiB的数据，我们将多个介质的的操作抽象为 <code>Data</code> 类，它提供单条数据读写功能，每种介质单独实现抽象方法，其定义如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Data</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 缓存块大小</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">int</span> capacity;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 数据在文件中开始存储的位置</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">long</span> position;</span><br><span class=\"line\">    <span class=\"comment\">// 从介质中读取</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">get</span><span class=\"params\">(ByteBuffer buffer)</span>;</span><br><span class=\"line\">\t  <span class=\"comment\">// 从介质中写入</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">set</span><span class=\"params\">(ByteBuffer buffer)</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 从介质中清除</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">clear</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在一阶段中，会按照写入大小创建对应介质的Data，它记录了这条数据在当前介质中的索引信息（如果是DRAM则直接存放ByteBuffer指针），例如当DRAM和PMem写满时，Data记录的是当前数据在ESSD中的position以及capacity。</p>\n<p>二阶段开始时，随着queue的读写会淘汰无效的DRAM和PMem Data并放入对应的缓存池中，二阶段过程中的写入会优先从DRAM缓存池中获取闲置的Data，如果获取失败则从PMem缓存池获取，如果依然失败会降级为SSD Data（相当于不走缓存）。如果获取成功，则将数据写入到当前缓存块中并记录在Queue索引中。</p>\n<p>由于二阶段中的缓存块都是从缓存池中获取，因此缓存块大小是固定的，会出现块大小 <strong>小于</strong>当前写入数据大小的情况，当发生此类情况时，不足的大小会使用预留的堆外内存补救，这块数据被称为 <code>ext</code>，调用clear()方法同时会释放 <code>ext</code> 。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d1e2944bff44ce9a3fa82420534cf94~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>另外，为了减少使用额外的 <code>ext</code> ，缓存池会根据 <code>Data</code> 的capacity大小将之进行分组，当从缓存池获取闲置缓存块时，会根据写入数据的大小到缓存池分组中进行匹配，取出合适区间中的缓存块进行使用。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 17K / 5 五组内存回收池</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> LinkedBlockingQueue&lt;Data&gt; <span class=\"title function_\">getReadBuffer</span><span class=\"params\">(<span class=\"type\">int</span> cap)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cap &lt; Const.K * <span class=\"number\">3.4</span> ? <span class=\"literal\">null</span> : cap &lt; Const.K * <span class=\"number\">6.8</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers2 : cap &lt; Const.K * <span class=\"number\">10.2</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ? readBuffers3 : cap &lt; Const.K * <span class=\"number\">13.6</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers4: readBuffers5;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"数据索引\"><a class=\"header-anchor\" href=\"#数据索引\">¶</a>数据索引</h3>\n<p>程序执行过程中，数据写入后会记录一条索引到具体的queue中，由于offset从0开始并有序的特性，每个queue中会实例化一个 <code>ArrayList</code> 来记录该索引，下标即是offset，value的话则为 <code>Data</code> ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Data&gt; records;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"aof中的数据格式\"><a class=\"header-anchor\" href=\"#aof中的数据格式\">¶</a>AOF中的数据格式</h3>\n<p>由于准确性阶段需要数据的recover，所以直接存储在AOF中的数据需要记录一些额外的索引信息：</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47427dbeae444e02867a4ef036b54c57~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>当recover时，首先会读取9个Byte来获取头信息，当校验通过后，会根据Data Len来继续读取真实的数据，之后根据TopicId，QueueId，Offset等信息找到目标队列预先建立索引。</p>\n<h3 id=\"文件预分配\"><a class=\"header-anchor\" href=\"#文件预分配\">¶</a>文件预分配</h3>\n<p>根据官方渠道得知，评测环境使用的文件系统为ext4，在ext4文件系统下，每次创建一个物理文件会子啊系统中注册一个inode来记录文件的元数据信息以及block索引树的根节点。</p>\n<p>当我们对文件进行读写时，首先会从extent tree中寻找合适的block逻辑地址，再从block中拿到硬盘设备中的物理地址方可操作。如果找不到合适的extent或block则需要创建，此过程还涉及到inode中元数据的变动，对内核代码简单追踪可知，最终会调用 <code>ext4_do_update_inode</code> 方法完成inode的更新。</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ext4_write_begin</span><br><span class=\"line\">    __block_write_begin</span><br><span class=\"line\">        get_block -&gt; ext4_get_block_unwritten</span><br><span class=\"line\">            _ext4_get_block</span><br><span class=\"line\">                ext4_map_blocks</span><br><span class=\"line\">                    ext4_ext_map_blocks</span><br><span class=\"line\">                        ext4_ext_insert_extent</span><br><span class=\"line\">                            ext4_ext_dirty</span><br><span class=\"line\">                                ext4_mark_inode_dirty</span><br><span class=\"line\">                                    ext4_mark_iloc_dirty </span><br><span class=\"line\">                                        ext4_do_update_inode</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其内部实现过程中会先上文件内全局的自旋锁spin_lock()，在设置完新的block并更新inode元数据后调用spin_unlock()解锁，之后处理脏元数据，这个过程需要记录journal日志。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b39a87dfbd0a44b7a42b2548cfa9efc4~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>对于一个空文件进行持续的写入，每当 <code>ext4_map_blocks()</code> 获取block失败，就会执行复杂的流程来创建新的逻辑空间到物理空间的block映射，这种开销对于性能的影响是非常致命的，对于分秒必争的比赛更是如此。</p>\n<p>为了避免这段开销，我们可以在写入空白文件之前预先写入足够多的数据，让inode预热一下，之后再从position 0开始写入。这种方法称为 <strong>预分配</strong> ，Linux中提供 <code>fallocate</code> 命令完成这种操作，在Java中可以手动完成：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">fallocate</span><span class=\"params\">(FileChannel channel, <span class=\"type\">long</span> allocateSize)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (channel.size() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">          <span class=\"type\">int</span> <span class=\"variable\">batch</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (Const.K * <span class=\"number\">4</span>);</span><br><span class=\"line\">          <span class=\"type\">int</span> <span class=\"variable\">size</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (allocateSize / batch);</span><br><span class=\"line\">          <span class=\"type\">ByteBuffer</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> ByteBuffer.allocateDirect(batch);</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; batch; i ++)&#123;</span><br><span class=\"line\">              buffer.put((<span class=\"type\">byte</span>) <span class=\"number\">0</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; size; i ++)&#123;</span><br><span class=\"line\">              buffer.flip();</span><br><span class=\"line\">              channel.write(buffer);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          channel.force(<span class=\"literal\">true</span>);</span><br><span class=\"line\">          channel.position(<span class=\"number\">0</span>);</span><br><span class=\"line\">          Utils.recycleByteBuffer(buffer);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当然，预分配不是适用于所有场景，本次赛题的计时从第一次append开始，所以有足够的时间在程序初始化过程中完成预分配。再者就是SSD硬盘空间的容量最好足够大，如果容量与要写入的数据相当，预分配后再进行写入时，会导致SSD内部频繁的Foreground GC，性能下降。</p>\n<h3 id=\"4k对齐\"><a class=\"header-anchor\" href=\"#4k对齐\">¶</a>4K对齐</h3>\n<p>传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前<code>512 * 63 / 1024 = 31.5</code>KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。</p>\n<p>除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，Page 1写满了4KB，而Page2只写入1KB，当再次向文件顺序写入数据时，需要将Page2数据预先读出来，然后与新写入数据在内存中合并后再写入新的Page 3中，之前的Page 2则标记为 <code>stale</code> 等待被GC。这种带来的开销被称为写入放大WA（Write Amplification）。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7718674f47284afba5fff121cac804db~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>为了减小WA，我们可以人工补充缺少的数据。对于本次赛题，当写入缓冲刷盘前，将写入Buffer的position右移至最近的4KB整数倍点位即可。</p>\n<h3 id=\"预读取\"><a class=\"header-anchor\" href=\"#预读取\">¶</a>预读取</h3>\n<p>二阶段中，我们需要做的是从queue中获取请求区间所有的 <code>Data</code> ，并根据 <code>Data</code> 中的索引信息将真实数据从对应介质中读取出来，而且这个过程通常是批量的，具体数量由入参 <code>fetchNum</code> 控制。</p>\n<p>最开始我使用 <code>Semaphore</code> 对批量数据多线程并发读，并且得到了不错的效果。但是背后却埋着不小的坑，由于每次getRange要频繁的对多个线程阻塞和取消阻塞，线程上下文切换带来开销非常严重，有兴趣的读者可以运行以下测试代码（并把 <strong>我不能接受</strong>打在弹幕里）：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Executors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Semaphore;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">100</span> * <span class=\"number\">10000</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">batch</span> <span class=\"operator\">=</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">pools</span> <span class=\"operator\">=</span> </span><br><span class=\"line\">\t\t\t\t(ThreadPoolExecutor) Executors.newFixedThreadPool(batch);</span><br><span class=\"line\">        <span class=\"type\">Semaphore</span> <span class=\"variable\">semaphore</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Semaphore</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; count; i ++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; batch; j ++)&#123;</span><br><span class=\"line\">                pools.execute(semaphore::release);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            semaphore.acquire(batch);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">end</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        System.out.println(end - start);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我不能接受，但是又要保证getRange阶段尽可能并发读取，于是乎我将思路转向了预读取，方法与Page Cache预读类似，举个栗子：当getRange读第0 ~ 10条数据的时候，从线程池中取个线程预读取第10 ~ 20条数据，并将这些数据存储在缓存块中，实际测试中，足够多的PMem缓存块使我们不用担心缓存池匮乏的问题。</p>\n<h3 id=\"顺带一提\"><a class=\"header-anchor\" href=\"#顺带一提\">¶</a>顺带一提</h3>\n<ul>\n<li>评测阶段线程数量不固定，好在所有线程几乎同时执行，所以在写入时阻塞一段时间获取到线程数量，之后再对其进行分组。</li>\n<li>每个线程要持续运行，所以将线程内数据存入ThreadLocal中，并尽可能复用。</li>\n<li>数据格式中的offset或许可以拿掉，每条记录可以省去4 Byte的空间。</li>\n<li>两个方法的入参中，Topic的类型为String，但是格式固定为TopicN，可以搞个超大switch方法将其转为int类型，方便之后的存储与读取。</li>\n</ul>\n<h2 id=\"结束\"><a class=\"header-anchor\" href=\"#结束\">¶</a>结束</h2>\n<p>不知不觉，比赛已经结束，写这篇文章的时候明天就要上交的PPT还未开工，这次比赛收获很多，遗憾也不少，收获了很多卷友，遗憾自己未能如心。</p>\n<p>从第一个方案出分的惊喜若狂到优化过程中的绞尽脑汁，每一秒的进步都带来了无与伦比的成就感。从为了给女朋友买个电瓶车代步的决心下定开始，仿佛就以注定要在这条道路上一卷无前。</p>\n<p>来年，希望张三再发一次橙图（也不一定是橙色），到时候如果我心有余力，肯定很快点进来，然后一键三连。</p>\n<p>仓库地址：<a href=\"https://github.com/ainilili/tianchi-race-2021\">https://github.com/ainilili/tianchi-race-2021</a></p>\n<h2 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h2>\n<ul>\n<li><a href=\"https://github.com/torvalds/linux/tree/master/fs/ext4\">Ext4</a></li>\n<li><a href=\"https://item.jd.com/13127464.html\">持久内存架构与工程实践</a></li>\n<li><a href=\"https://item.jd.com/12367097.html\">深入浅出SSD - 固态存储核心技术原理与实战</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"引子\"><a class=\"header-anchor\" href=\"#引子\">¶</a>引子</h2>\n<p>在一个浑浑噩噩的下午，百无聊赖的我像往常一样点开了划水交流群，细细品味着老哥们关于量子力学的讨论。嬉戏间，平常水不拉几的群友张三忽然发了一张大大的橙图，我啪的一下点开了，很快啊，仔细观摩后发现原来是2021第二届云原生编程挑战赛报名的海报，暗暗的想起了被我鸽掉的前几届，小手不自觉地打开了链接并且一键三连。</p>\n<p>每个人的心里都有一个童心未泯的自己，这次比赛就像一场游戏一样让我深陷其中，三岔路口，我选择了存储领域，谁承想这决定会让我在接下来的两个月里减少百分之N的发量。</p>\n<h2 id=\"读题\"><a class=\"header-anchor\" href=\"#读题\">¶</a>读题</h2>\n<p><a href=\"https://tianchi.aliyun.com/competition/entrance/531922/information\">赛题</a>目的是实现简单的消息读取与存储，程序需要实现<code>append</code>和<code>getRange</code>方法，并依次通过性能评测与正确性评测，性能评测耗时最少者居高。</p>\n<h3 id=\"评测环境\"><a class=\"header-anchor\" href=\"#评测环境\">¶</a>评测环境</h3>\n<p>Linux下的4核8G服务器，配置<code>400G</code> ESSD PL1云盘，吞吐可达<code>320MiB/s</code>，<code>60G</code> Intel 傲腾持久内存PMem（Persistent Memory），由参考文档可推测为第一代持久内存，代号为AEP。</p>\n<p>赛题编程语言限制为Java8，JVM配置为6G堆内+2G堆外。</p>\n<h3 id=\"性能评测\"><a class=\"header-anchor\" href=\"#性能评测\">¶</a>性能评测</h3>\n<p>评测程序首先会创建10~50个不等的线程，每个线程随机分配若干个topic进行写入，topic总数量不超过100个。每个topic之下又分为若干个queue，总数量不超过5000个，调用append方法后返回当前数据在queue中的offset，由0开始。每次写入数据大小为100B-17KiB区间随机，当写满75G数据后，会挑选一半的queue由下标0（头）开始读取，另外一半从当前最大下标（尾）开始读取，并保持之前的写入压力继续写入50G数据，最后一条数据读取完毕后停止计时。</p>\n<h3 id=\"正确性评测\"><a class=\"header-anchor\" href=\"#正确性评测\">¶</a>正确性评测</h3>\n<p>同样会使用N个线程写入数据，在写入过程中会重启ECS，之后再读取之前写入成功的数据（返回offset即视为成功），要求严格一致。</p>\n<h3 id=\"持久内存\"><a class=\"header-anchor\" href=\"#持久内存\">¶</a>持久内存</h3>\n<p>本次比赛多了一个比较陌生的存储介质PMem，它结合了内存的读写性能和持久化的特性，可以在延迟可以控制在纳秒级。</p>\n<p>目前主流的实现为非易失性双列直插式内存模块NVDIMM（Non-Volatile Dual In-Line Memory Module，NVDIMM），它是持久内存的一种实现，目前有三种实现标准：</p>\n<ul>\n<li><strong>NVDIMM-N：</strong> 配置同等容量的DRAM和NAND Flash，另外还有一个超大电容，当主机断电后，PMem设备会使用电容中保留的电量保证DRAM的数据同步到闪存中。</li>\n<li><strong>NVDIMM-F：</strong> 使用了适配DDR规格的NAND Flash，通过多个控制器和桥接器将DDR总线信息转化为SATA协议信息来操作闪存的读写。</li>\n<li><strong>NVDIMM-P：</strong> 同样配置了DRAM和NAND Flash，只不过DRAM容量会比闪存少很多，DRAM在其中作为闪存上层的缓存以优化读写性能，同样使用超大电容来保障断电后的脏数据持久。</li>\n</ul>\n<p>Intel傲腾第一代持久内存AEP遵循<strong>NVDIMM-P</strong>标准，实现了非易失性，可以按字节寻址（Byte Addressable）操作，小于1μs的延时，以及集成密度高于或等于DRAM等特性。不同于传统的NAND Flash实现，傲腾持久内存使用了新型非易失性存储器3D-XPoint，其内部是一种全新的存储介质。</p>\n<p>Intel傲腾持久内存提供多种操作模式：</p>\n<ul>\n<li><strong>内存模式：</strong> 此模式下持久内存被当做超大容量的易失性内存使用，其中DRAM被称为近内存（Near Memory），持久化介质被称为远内存（Far Memory），读写性能取决于读写时命中近内存还是远内存。</li>\n<li><strong>AD模式：</strong> 此模式下持久内存直接暴露给用户态的应用程序直接调用，应用程序通过持久内存感知文件系统（PMEM-Aware File System）将用户态的内存空间直接映射到持久内存设备上，从而应用程序可以直接进行加载（Load）和存储（Store）操作。这种形式也被称作DAX，意为直接访问。目前主流的文件系统ext4, xfs 都支持Direct Access的选项（-o dax)，英特尔也提供了用于在持久内存上进行编程的用户态软件库PMDK。</li>\n</ul>\n<p>本次比赛使用AD模式。</p>\n<h2 id=\"分析\"><a class=\"header-anchor\" href=\"#分析\">¶</a>分析</h2>\n<p>首先关注的是正确性评测，写入过程会重启ECS，那么就要保证在append方法return之前数据要落盘，也就是说每个写入请求都要fsync刷盘。另外在重启ECS之后，会清理PMem上的数据，所以数据肯定要在ESSD上保存一份。</p>\n<p>总写入数据量为125G，而ESSD提供400G容量，正常写入的情况下不用考虑硬盘GC的问题。除了ESSD空间外，我们还有60G的PMem可用，而且文件系统通常会预留一部分文件空间作紧急情况使用，所以PMem可用容量会更高（实测真实容量为62G左右）。DRAM内存也要尽可能利用起来，首选不受JVM限制的2G堆外，剩下的6G堆内如何使用就要在GC和整体性能之间做抉择了。</p>\n<h3 id=\"文件写入\"><a class=\"header-anchor\" href=\"#文件写入\">¶</a>文件写入</h3>\n<p><strong>方案1：</strong> 每个queue一个文件，这样可以保证顺序读写，但最坏的情况下需要创建100 * 5000 = 500,000个文件，操作系统默认每个用户进程1024个句柄肯定会超限。</p>\n<p><strong>方案2：</strong> 每个topic一个文件，那么最坏只需要创建100个文件，可以接受，但这意味着多个queue的数据要写入同一个文件中，无法保证顺序读写，不过可以是使用稀疏索引来做块存储。另外因为正确性评测的限制，我们需要在每次写入后手动fsync，所以这种设计下会导致频繁的fsync，也就意味着用户态与内核态之间要频繁的切来切去，另外数据大小范围为100B~17KiB，ESSD在一次写入32K以上数据时才能发挥最优性能，很明显当前设计是打不满ESSD PL1的吞吐的。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7373739442514f56b877687dc35a853b~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p><strong>方案3：</strong> 所有topic共用一个文件，通过对以上弊端的思考，我们应该尽可能每次fsync时写入更多的数据，由于N个线程并发写同一个文件，所以我们可以将N个线程的数据先写入聚合缓冲中后并挂起，等待将缓冲中的数据刷盘后再取消阻塞。这个方案可以保证顺序写随机读，每次写入数据足够多，并且减少了核态的切换次数，但是刷盘变成了串行，或许能得到一个不错的ESSD吞吐，但是对CPU造成了浪费。</p>\n<p>在上一个假设上做优化，因为评测环境配置4核CPU，我们将所有线程分为4组，每组对应一个文件，这样既可以保证ESSD的性能，又可以在无法绑核的情况下尽可能压榨所有CPU的性能。</p>\n<p>文件读写的API方面，首先放弃传统的FileWriter/FileRead，相比而言，FileChannel提供双向读写能力且更易操控读写数据精度。MMap是另外一种方案，因为它只在创建的时候需要切态，理论上它的读写速度会比FileChannel更快，但是由于种种原因，MMap映射大小受限，这无疑增加了程序设计上的维护成本，另外最终场景每次写入数据量平均在64KB左右，通过Benchmark，FileChannel在这种场景下性能总是优于MMap。最终选定使用FileChannel进行文件读写，另外为了减少用户与向内核态的内存复制，使用DirectByteBuffer用作写入缓冲。</p>\n<p>**最终方案：**将所有线程分为4组，充分利用多核CPU，每组对应一个AOF数据文件，每组线程的数据写入缓冲后并挂起，缓冲刷盘后再取消阻塞，返回offset。</p>\n<h3 id=\"缓存利用\"><a class=\"header-anchor\" href=\"#缓存利用\">¶</a>缓存利用</h3>\n<p>首先要明确一点，在本次赛题中，无论是DRAM还是PMem，都不能利用它们用来做数据的持久化（PMem正确性阶段重启后会做数据清理），ESSD是必须要求写入的。因此，缓存的主要利用方向在于提高读性能。</p>\n<p>首先是性能最快但是容量最小的DRAM，官方不允许使用<code>unsafe</code>来额外分配堆外的堆外内存，所以可供我们使用的DRAM只有2G的堆外以及6G的堆内，又由于JVM的GC机制外加程序本身的业务流程需要一定的内存开销，所以6G的堆内可供我们用来做数据存储的部分大打折扣（实际测下来可以用到3.2G），而堆外内存会有一部分用于文件读写缓冲，所以堆外内存可用量也会小于2G。另外就是62G的持久内存PMem，由于其性能优于ESSD数百倍，容量远大于DRAM，且ext4支持dax模式，可直接用FileChannel操作读写，对于它的合理使用直接决定了最终成绩的好坏。</p>\n<p>再回到性能评测上进行分析，我们将整个过程分为是三个阶段（重点，下文要考）：</p>\n<ul>\n<li><strong>一阶段：</strong> 先写入<code>75G</code>的数据。</li>\n<li><strong>二阶段：</strong> 评测程序随机挑选一半的queue从头开始读，另一半从结尾开始读，并在读的同时，继续写入<code>50G</code>的数据。</li>\n<li><strong>三阶段：</strong> 随着时间的推移，最终读取的offset点位会慢慢追赶上当前写入的点位，此阶段中刚写入的数据有可能下一刻被读取。</li>\n</ul>\n<p>经过分析，我们需要在一阶段尽可能的将数据写入缓存，这样二阶段读取时可以减少ESSD的命中率。由于二阶段会有一半的queue从结尾开始读数据，这也就意味着这些queue之前的数据可以被淘汰，淘汰后的缓存可以复用于之后写入的数据。另外由于二阶段的过程是边读边写，读后的缓存也可以投入复用。</p>\n<p>所以理论上二阶段所有写入的数据全部可以复用到淘汰后的缓存。到了三阶段后，应该尽可能使用性能最高的DRAM来存储热数据。</p>\n<p>**最终方案：**一阶段首先将缓存写入大约5G的DRAM中，之后的数据写入62G的PMem中（此过程的ESSD一直保持着写入），每个记录的缓存信息保存在对应的queue中。来到二阶段后，将淘汰的缓存按介质类型及大小放入不同的缓存池，之后写入的数据会优先向DRAM缓存池申请缓存块，其次是PMem缓存池。</p>\n<p>当然，前期的分析也只能基于理论，最终方案的背后是无数个日日夜夜的测试和思考（卷就完了。</p>\n<h2 id=\"整体方案\"><a class=\"header-anchor\" href=\"#整体方案\">¶</a>整体方案</h2>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/868a0b81eaf147598a3159f10c5cebf0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"QQ截图20211206174435.png\"></p>\n<p>一阶段开始，将所有线程随机分为4组，每组对应1个AOF文件，在写入ESSD的同时，异步写入DRAM或PMem中。理论上在写入 <code>5G + 62G = 67G</code> 数据后缓存用尽，从此刻开始到写满75G之前都只是单纯写硬盘，所有的异步任务也将在此期间全部执行完毕。</p>\n<p>二阶段开始，每次读取都会淘汰失效的缓存并放入缓存池中，写入过程中会优先按照记录大小从缓存池中获取到相应的缓存块，理想情况下每次都能申请到对应的缓存块并写入，Missing时记录数据在ESSD上的位置索引。</p>\n<p>每次读取时，根据offset从获取对应的数据索引，到索引指定的介质中读取数据并返回。</p>\n<h3 id=\"缓存池\"><a class=\"header-anchor\" href=\"#缓存池\">¶</a>缓存池</h3>\n<p>本次赛题一共有DRAM，PMem以及ESSD三种介质，而读写的最小颗粒度为100B-17KiB的数据，我们将多个介质的的操作抽象为 <code>Data</code> 类，它提供单条数据读写功能，每种介质单独实现抽象方法，其定义如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Data</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 缓存块大小</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">int</span> capacity;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 数据在文件中开始存储的位置</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">long</span> position;</span><br><span class=\"line\">    <span class=\"comment\">// 从介质中读取</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">get</span><span class=\"params\">(ByteBuffer buffer)</span>;</span><br><span class=\"line\">\t  <span class=\"comment\">// 从介质中写入</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">set</span><span class=\"params\">(ByteBuffer buffer)</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 从介质中清除</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">clear</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在一阶段中，会按照写入大小创建对应介质的Data，它记录了这条数据在当前介质中的索引信息（如果是DRAM则直接存放ByteBuffer指针），例如当DRAM和PMem写满时，Data记录的是当前数据在ESSD中的position以及capacity。</p>\n<p>二阶段开始时，随着queue的读写会淘汰无效的DRAM和PMem Data并放入对应的缓存池中，二阶段过程中的写入会优先从DRAM缓存池中获取闲置的Data，如果获取失败则从PMem缓存池获取，如果依然失败会降级为SSD Data（相当于不走缓存）。如果获取成功，则将数据写入到当前缓存块中并记录在Queue索引中。</p>\n<p>由于二阶段中的缓存块都是从缓存池中获取，因此缓存块大小是固定的，会出现块大小 <strong>小于</strong>当前写入数据大小的情况，当发生此类情况时，不足的大小会使用预留的堆外内存补救，这块数据被称为 <code>ext</code>，调用clear()方法同时会释放 <code>ext</code> 。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d1e2944bff44ce9a3fa82420534cf94~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>另外，为了减少使用额外的 <code>ext</code> ，缓存池会根据 <code>Data</code> 的capacity大小将之进行分组，当从缓存池获取闲置缓存块时，会根据写入数据的大小到缓存池分组中进行匹配，取出合适区间中的缓存块进行使用。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 17K / 5 五组内存回收池</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> LinkedBlockingQueue&lt;Data&gt; <span class=\"title function_\">getReadBuffer</span><span class=\"params\">(<span class=\"type\">int</span> cap)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cap &lt; Const.K * <span class=\"number\">3.4</span> ? <span class=\"literal\">null</span> : cap &lt; Const.K * <span class=\"number\">6.8</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers2 : cap &lt; Const.K * <span class=\"number\">10.2</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ? readBuffers3 : cap &lt; Const.K * <span class=\"number\">13.6</span> </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t ? readBuffers4: readBuffers5;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"数据索引\"><a class=\"header-anchor\" href=\"#数据索引\">¶</a>数据索引</h3>\n<p>程序执行过程中，数据写入后会记录一条索引到具体的queue中，由于offset从0开始并有序的特性，每个queue中会实例化一个 <code>ArrayList</code> 来记录该索引，下标即是offset，value的话则为 <code>Data</code> ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Data&gt; records;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"aof中的数据格式\"><a class=\"header-anchor\" href=\"#aof中的数据格式\">¶</a>AOF中的数据格式</h3>\n<p>由于准确性阶段需要数据的recover，所以直接存储在AOF中的数据需要记录一些额外的索引信息：</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47427dbeae444e02867a4ef036b54c57~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>当recover时，首先会读取9个Byte来获取头信息，当校验通过后，会根据Data Len来继续读取真实的数据，之后根据TopicId，QueueId，Offset等信息找到目标队列预先建立索引。</p>\n<h3 id=\"文件预分配\"><a class=\"header-anchor\" href=\"#文件预分配\">¶</a>文件预分配</h3>\n<p>根据官方渠道得知，评测环境使用的文件系统为ext4，在ext4文件系统下，每次创建一个物理文件会子啊系统中注册一个inode来记录文件的元数据信息以及block索引树的根节点。</p>\n<p>当我们对文件进行读写时，首先会从extent tree中寻找合适的block逻辑地址，再从block中拿到硬盘设备中的物理地址方可操作。如果找不到合适的extent或block则需要创建，此过程还涉及到inode中元数据的变动，对内核代码简单追踪可知，最终会调用 <code>ext4_do_update_inode</code> 方法完成inode的更新。</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ext4_write_begin</span><br><span class=\"line\">    __block_write_begin</span><br><span class=\"line\">        get_block -&gt; ext4_get_block_unwritten</span><br><span class=\"line\">            _ext4_get_block</span><br><span class=\"line\">                ext4_map_blocks</span><br><span class=\"line\">                    ext4_ext_map_blocks</span><br><span class=\"line\">                        ext4_ext_insert_extent</span><br><span class=\"line\">                            ext4_ext_dirty</span><br><span class=\"line\">                                ext4_mark_inode_dirty</span><br><span class=\"line\">                                    ext4_mark_iloc_dirty </span><br><span class=\"line\">                                        ext4_do_update_inode</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其内部实现过程中会先上文件内全局的自旋锁spin_lock()，在设置完新的block并更新inode元数据后调用spin_unlock()解锁，之后处理脏元数据，这个过程需要记录journal日志。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b39a87dfbd0a44b7a42b2548cfa9efc4~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>对于一个空文件进行持续的写入，每当 <code>ext4_map_blocks()</code> 获取block失败，就会执行复杂的流程来创建新的逻辑空间到物理空间的block映射，这种开销对于性能的影响是非常致命的，对于分秒必争的比赛更是如此。</p>\n<p>为了避免这段开销，我们可以在写入空白文件之前预先写入足够多的数据，让inode预热一下，之后再从position 0开始写入。这种方法称为 <strong>预分配</strong> ，Linux中提供 <code>fallocate</code> 命令完成这种操作，在Java中可以手动完成：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">fallocate</span><span class=\"params\">(FileChannel channel, <span class=\"type\">long</span> allocateSize)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (channel.size() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">          <span class=\"type\">int</span> <span class=\"variable\">batch</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (Const.K * <span class=\"number\">4</span>);</span><br><span class=\"line\">          <span class=\"type\">int</span> <span class=\"variable\">size</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (allocateSize / batch);</span><br><span class=\"line\">          <span class=\"type\">ByteBuffer</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> ByteBuffer.allocateDirect(batch);</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; batch; i ++)&#123;</span><br><span class=\"line\">              buffer.put((<span class=\"type\">byte</span>) <span class=\"number\">0</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; size; i ++)&#123;</span><br><span class=\"line\">              buffer.flip();</span><br><span class=\"line\">              channel.write(buffer);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          channel.force(<span class=\"literal\">true</span>);</span><br><span class=\"line\">          channel.position(<span class=\"number\">0</span>);</span><br><span class=\"line\">          Utils.recycleByteBuffer(buffer);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当然，预分配不是适用于所有场景，本次赛题的计时从第一次append开始，所以有足够的时间在程序初始化过程中完成预分配。再者就是SSD硬盘空间的容量最好足够大，如果容量与要写入的数据相当，预分配后再进行写入时，会导致SSD内部频繁的Foreground GC，性能下降。</p>\n<h3 id=\"4k对齐\"><a class=\"header-anchor\" href=\"#4k对齐\">¶</a>4K对齐</h3>\n<p>传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前<code>512 * 63 / 1024 = 31.5</code>KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。</p>\n<p>除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，Page 1写满了4KB，而Page2只写入1KB，当再次向文件顺序写入数据时，需要将Page2数据预先读出来，然后与新写入数据在内存中合并后再写入新的Page 3中，之前的Page 2则标记为 <code>stale</code> 等待被GC。这种带来的开销被称为写入放大WA（Write Amplification）。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7718674f47284afba5fff121cac804db~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"enter image description here\"></p>\n<p>为了减小WA，我们可以人工补充缺少的数据。对于本次赛题，当写入缓冲刷盘前，将写入Buffer的position右移至最近的4KB整数倍点位即可。</p>\n<h3 id=\"预读取\"><a class=\"header-anchor\" href=\"#预读取\">¶</a>预读取</h3>\n<p>二阶段中，我们需要做的是从queue中获取请求区间所有的 <code>Data</code> ，并根据 <code>Data</code> 中的索引信息将真实数据从对应介质中读取出来，而且这个过程通常是批量的，具体数量由入参 <code>fetchNum</code> 控制。</p>\n<p>最开始我使用 <code>Semaphore</code> 对批量数据多线程并发读，并且得到了不错的效果。但是背后却埋着不小的坑，由于每次getRange要频繁的对多个线程阻塞和取消阻塞，线程上下文切换带来开销非常严重，有兴趣的读者可以运行以下测试代码（并把 <strong>我不能接受</strong>打在弹幕里）：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Executors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Semaphore;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">100</span> * <span class=\"number\">10000</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">batch</span> <span class=\"operator\">=</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">pools</span> <span class=\"operator\">=</span> </span><br><span class=\"line\">\t\t\t\t(ThreadPoolExecutor) Executors.newFixedThreadPool(batch);</span><br><span class=\"line\">        <span class=\"type\">Semaphore</span> <span class=\"variable\">semaphore</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Semaphore</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; count; i ++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; batch; j ++)&#123;</span><br><span class=\"line\">                pools.execute(semaphore::release);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            semaphore.acquire(batch);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">end</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        System.out.println(end - start);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我不能接受，但是又要保证getRange阶段尽可能并发读取，于是乎我将思路转向了预读取，方法与Page Cache预读类似，举个栗子：当getRange读第0 ~ 10条数据的时候，从线程池中取个线程预读取第10 ~ 20条数据，并将这些数据存储在缓存块中，实际测试中，足够多的PMem缓存块使我们不用担心缓存池匮乏的问题。</p>\n<h3 id=\"顺带一提\"><a class=\"header-anchor\" href=\"#顺带一提\">¶</a>顺带一提</h3>\n<ul>\n<li>评测阶段线程数量不固定，好在所有线程几乎同时执行，所以在写入时阻塞一段时间获取到线程数量，之后再对其进行分组。</li>\n<li>每个线程要持续运行，所以将线程内数据存入ThreadLocal中，并尽可能复用。</li>\n<li>数据格式中的offset或许可以拿掉，每条记录可以省去4 Byte的空间。</li>\n<li>两个方法的入参中，Topic的类型为String，但是格式固定为TopicN，可以搞个超大switch方法将其转为int类型，方便之后的存储与读取。</li>\n</ul>\n<h2 id=\"结束\"><a class=\"header-anchor\" href=\"#结束\">¶</a>结束</h2>\n<p>不知不觉，比赛已经结束，写这篇文章的时候明天就要上交的PPT还未开工，这次比赛收获很多，遗憾也不少，收获了很多卷友，遗憾自己未能如心。</p>\n<p>从第一个方案出分的惊喜若狂到优化过程中的绞尽脑汁，每一秒的进步都带来了无与伦比的成就感。从为了给女朋友买个电瓶车代步的决心下定开始，仿佛就以注定要在这条道路上一卷无前。</p>\n<p>来年，希望张三再发一次橙图（也不一定是橙色），到时候如果我心有余力，肯定很快点进来，然后一键三连。</p>\n<p>仓库地址：<a href=\"https://github.com/ainilili/tianchi-race-2021\">https://github.com/ainilili/tianchi-race-2021</a></p>\n<h2 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h2>\n<ul>\n<li><a href=\"https://github.com/torvalds/linux/tree/master/fs/ext4\">Ext4</a></li>\n<li><a href=\"https://item.jd.com/13127464.html\">持久内存架构与工程实践</a></li>\n<li><a href=\"https://item.jd.com/12367097.html\">深入浅出SSD - 固态存储核心技术原理与实战</a></li>\n</ul>\n"},{"title":"如何设计并实现一个db连接池？","author":"Nico","date":"2019-05-26T05:42:00.000Z","_content":"## 连接池的使命！\n无论是线程池还是db连接池，他们都有一个共同的特性：**资源复用**，在普通的场景中，我们使用一个连接，它的生命周期可能是这样的：\n![](https://user-gold-cdn.xitu.io/2019/5/24/16ae8d822d4ac11e?w=637&h=168&f=png&s=4758)\n一个连接，从创建完毕到销毁，期间只被使用了一次（这里的一次是指在单个作用域内的使用），当周期结束，另外一个调用者仍然需要这个连接去做事，就要重复去经历这种生命周期。因为创建和销毁都是需要对应的服务消耗时间以及系统资源去处理的，这样不仅浪费了大量的系统资源，而且导致业务响应过程中都要花费部分时间去重复的创建和销毁，得不偿失，而连接池便被赋予了解决这种问题的使命！\n## 连接池需要做什么？\n顾名思义，连接池中的**池**字已经很生动形象的阐明了它的用意，它用将所有连接放入一个``\"池子\"``中统一的去控制连接的创建和销毁，和原始生命周期去对比，连接池多了以下特性：\n - 创建并不是真的创建，而是从池子中选出空闲连接。\n - 销毁并不是真的销毁，而是将使用中的连接放回池中（逻辑关闭）。\n - 真正的创建和销毁由线程池的特性机制来决定。\n\n因此，当使用连接池后，我们使用一个连接的生命周期将会演变成这样：\n![](https://user-gold-cdn.xitu.io/2019/5/24/16ae8fb43b0a3d13?w=588&h=377&f=png&s=13088)\n## 分析计划\n通灵之术 - 传送门：[https://github.com/ainilili/honeycomb](https://github.com/ainilili/honeycomb)，DEMO为Java语言实现！\n\n事前，我们需要点支烟分析一下时间一个连接池需要做哪些事情：\n - 保存连接的容器是必不可少的，另外，该容器也要支持连接的添加和移除功能，并保证线程安全。\n - 我们需要因为要对连接的销毁做逻辑调整，我们需要重写它的``close``以及``isClosed``方法。\n - 我们需要有个入口对连接池做管理，例如回收空闲连接。\n\n连接池不仅仅只是对``Connection``生命周期的控制，还应该加入一些特色，例如初始连接数，最大连接数，最小连接数、最大空闲时长以及获取连接的等待时长，这些我们也简单支持一下。\n\n目标以明确，开始动工。\n### 连接池容器选型\n要保证线程安全，我们可以将目标瞄准在``JUC``包下的神通们，设我们想要的容器为``x``，那么``x``不仅需要满足基本的增删改查功能，而且也要提供获取超时功能，这是为了保证当池内长时间没有空闲连接时不会导致业务阻塞，即刻熔断。另外，``x``需要满足双向操作，这是为了连接池可以识别出饱和的空闲连接，方便回收操作。\n\n综上所述，``LinkedBlockingDeque``是最合适的选择，它使用``InterruptibleReentrantLock``来保证线程安全，使用``Condition``来做获取元素的阻塞，另外支持双向操作。\n\n另外，我们可以将连接池拆分为3个类型：\n - **工作池**：存放正在被使用的连接。\n - **空闲池**：存放空闲连接。\n - **回收池**：已经被回收（物理关闭）的连接。\n\n其中，**工作池**和**回收池**大可不必用双向对列，或许用单向队列或者``Set``都可以代替之：\n```java\nprivate LinkedBlockingQueue<HoneycombConnection> workQueue;\nprivate LinkedBlockingDeque<HoneycombConnection> idleQueue;\nprivate LinkedBlockingQueue<HoneycombConnection> freezeQueue;\n```\n### Connection的装饰\n连接池的输出是``Connection``，它代表着一个db连接，上游服务使用它做完操作后，会直接调用它的``close``方法来释放连接，而我们必须做的是在调用者无感知的情况下改变它的关闭逻辑，当调用``close``的方法时，我们将它放回空闲队列中，保证其的可复用性！\n\n因此，我们需要对原来的``Connection``做装饰，其做法很简单，但是很累，这里新建一个类来实现``Connection``接口，通过重写所有的方法来实现一个**\"可编辑\"**的``Connection``，我们称之为``Connection``的装饰者：\n```java\npublic class HoneycombConnectionDecorator implements Connection{\n\n    protected Connection connection;\n    \n    protected HoneycombConnectionDecorator(Connection connection) {\n        this.connection = connection;\n    }\n    \n    此处省略对方法实现的三百行代码...\n}\n```\n之后，我们需要新建一个自己的``Connection``来继承这个装饰者，并重写相应的方法：\n```java\npublic class HoneycombConnection extends HoneycombConnectionDecorator implements HoneycombConnectionSwitcher{\n    @Override\n    public void close() { do some things }\n\n    @Override\n    public boolean isClosed() throws SQLException { do some things }    \n    \n    省略...\n}\n```\n### DataSource的重写\n``DataSource``是JDK为了更好的统合和管理数据源而定义出的一个规范，获取连接的入口，方便我们在这一层更好的扩展数据源（例如增加特殊属性），使我们的连接池的功能更加丰富，我们需要实现一个自己的``DataSource``能：\n```java\npublic class HoneycombWrapperDatasource implements DataSource{\n    protected HoneycombDatasourceConfig config;\n    省略其它方法的实现...\n    @Override\n    public Connection getConnection() throws SQLException {\n        return DriverManager.getConnection(config.getUrl(), config.getUser(), config.getPassword());\n    }\n\n    @Override\n    public Connection getConnection(String username, String password) throws SQLException {\n        return DriverManager.getConnection(config.getUrl(), username, password);\n    }\n    省略其它方法的实现...\n}\n```\n我们完成了对数据源的实现，但是这里获取连接的方式是物理创建，我们需要满足池化的目的，需要重写``HoneycombWrapperDatasource``中的连接获取逻辑，做法是创建一个新的类对父类方法重写：\n```java\npublic class HoneycombDataSource extends HoneycombWrapperDatasource{\n    private HoneycombConnectionPool pool;\n    @Override\n    public Connection getConnection() throws SQLException {\n        这里实现从pool中取出连接的逻辑\n    }\n    省略...\n}\n```\n### 特性扩展\n在当前结构体系下，我们的连接池逐渐浮现出了雏形，但远远不够的是，我们需要在此结构下可以做自由的扩展，使连接池对连接的控制更加灵活，因此我们可以引入**特性**这个概念，它允许我们在其内部访问连接池，并对连接池做一系列的扩展操作：\n```java\npublic abstract class AbstractFeature{\n    public abstract void doing(HoneycombConnectionPool pool);\n}\n```\n``AbstractFeature``抽象父类需要实现``doing``方法，我们可以在方法内部实现对连接池的控制，其中一个典型的例子就是对池中空闲连接左回收：\n```java\npublic class CleanerFeature extends AbstractFeature{\n    @Override\n    public void doing(HoneycombConnectionPool pool) {\n        这里做空闲连接的回收\n    }\n}\n```\n## 落实计划\n经过上述分析，要完成一个连接池，需要这些模块的配合，总体流程如下：\n![](https://user-gold-cdn.xitu.io/2019/5/26/16af28f6f668a3e6?w=754&h=845&f=png&s=66582)\n\n### 第一步：设置数据源属性\n在初始化``DataSource``之前，我们需要将各属性设置进去，这里使用``HoneycombWrapperDatasource``中的``HoneycombDatasourceConfig``来承载各属性：\n```java\npublic class HoneycombDatasourceConfig {\n\n    //db url\n    private String url;\n\n    //db user\n    private String user;\n\n    //db password\n    private String password;\n\n    //driver驱动\n    private String driver;\n\n    //初始化连接数，默认为2\n    private int initialPoolSize = 2;\n\n    //最大连接数，默认为10\n    private int maxPoolSize = 10;\n\n    //最小连接数，默认为2\n    private int minPoolSize = 2;\n    \n    //获取连接时，最大等待时长，默认为60s\n    private long maxWaitTime = 60 * 1000;\n\n    //最大空闲时长，超出要被回收，默认为20s\n    private long maxIdleTime = 20 * 1000;\n    \n    //特性列表\n    private List<AbstractFeature> features;\n    \n    public HoneycombDatasourceConfig() {\n        features = new ArrayList<AbstractFeature>(5);\n    }\n    \n    省略getter、setter....\n```\n### 第二步：初始化连接池\n设置好属性之后，我们需要完成连接池的初始化工作，在``HoneycombDataSource``的``init``方法中实现：\n```java\nprivate void init() throws ClassNotFoundException, SQLException {\n    //阻塞其他线程初始化操作，等待初始化完成\n    if(initialStarted || ! (initialStarted = ! initialStarted)) {\n        if(! initialFinished) {\n            try {\n                INITIAL_LOCK.lock();\n                INITIAL_CONDITION.await();\n            } catch (InterruptedException e) {\n            } finally {\n                INITIAL_LOCK.unlock();\n            }\n        }\n        return;\n    }\n    \n    //config参数校验\n    config.assertSelf();\n    \n    Class.forName(getDriver());\n    \n    //实例化线程池\n    pool = new HoneycombConnectionPool(config);\n    \n    //初始化最小连接\n    Integer index = null;\n    for(int i = 0; i < config.getInitialPoolSize(); i ++) {\n        if((index =  pool.applyIndex()) != null) {\n            pool.putLeisureConnection(createNativeConnection(pool), index);\n        }\n    }\n    \n    //触发特性\n    pool.touchFeatures();\n    \n    //完成初始化并唤醒其他阻塞\n    initialFinished = true;\n    try {\n        INITIAL_LOCK.lock();\n        INITIAL_CONDITION.signalAll();\n    }catch(Exception e) {\n    }finally {\n        INITIAL_LOCK.unlock();\n    }\n}\n```\n### 第三步：创建初始连接\n在``init``的方法中，如果``initialPoolSize``大于0，会去创建指定数量的物理连接放入连接池中，创建数量要小于最大连接数``maxPoolSize``：\n```java\npublic HoneycombConnection createNativeConnection(HoneycombConnectionPool pool) throws SQLException {\n    return new HoneycombConnection(super.getConnection(), pool);\n}\n```\n完成初始化后，下一步就是获取连接。\n### 第四步：从空闲池获取\n我们之前将连接池分成了三个，它们分别是**空闲池**、**工作池**和**回收池**。\n\n我们可以通过``HoneycombDataSource``的``getConnection``方法来获取连接，当我们需要获取时，首先考虑的是空闲池是否有空闲连接，这样可以避免创建和激活新的连接：\n```java\n@Override\npublic Connection getConnection() throws SQLException {\n    try {\n    \t//初始化连接池\n        init();\n    } catch (ClassNotFoundException e) {\n        throw new RuntimeException(e);\n    }\n    \n    HoneycombConnection cn = null;\n    Integer index = null;\n    \n    if(pool.assignable()) {\n    \t//空闲池可分配，从空闲池取出\n        cn = pool.getIdleConnection();\n    }else if(pool.actionable()) {\n    \t//回收池可分配，从回收池取出\n        cn = pool.getFreezeConnection();\n    }else if((index =  pool.applyIndex()) != null) {\n    \t//如果连接数未满，创建新的物理连接\n        cn = pool.putOccupiedConnection(createNativeConnection(pool), index);\n    }\n    \n    if(cn == null) {\n    \t//如果无法获取连接，阻塞等待空闲池连接\n        cn = pool.getIdleConnection();\n    }\n    \n    if(cn.isClosedActive()) {\n    \t//如果物理连接关闭，则获取新的连接\n        cn.setConnection(super.getConnection());\n    }\n    return cn;\n}\n```\n### 第五步：从回收池获取\n如果空闲池不可分配，那么说明连接供不应求，也许之前有些空闲连接已经被回收（物理关闭），那么我们在创建新连接之前，可以到回收池看一下是否存在已回收连接，如果存在直接取出：\n```java\nelse if(pool.actionable()) {\n\t//回收池可分配，从回收池取出\n    cn = pool.getFreezeConnection();\n}\n```\n### 第六步：创建新的连接\n如果回收池也不可分配，此时要判断连接池连接数量是否已经达到最大连接，如果没有达到，创建新的物理连接并直接添加到工作池中：\n```java\nelse if((index =  pool.applyIndex()) != null) {\n\t//如果连接数未满，创建新的物理连接，添加到工作池\n    cn = pool.putOccupiedConnection(createNativeConnection(pool), index);\n}\n```\n### 第七步：等待空闲池的连接\n如果上述三种情况都不满足，那么只能从空闲池等待其他连接的释放：\n```java\nif(cn == null) {\n\t//如果无法获取连接，阻塞等待空闲池连接\n    cn = pool.getIdleConnection();\n}\n```\n具体逻辑封装在``HoneycombConnectionPool``的``getIdleConnection``方法中：\n```java\npublic HoneycombConnection getIdleConnection() {\n    try {\n    \t//获取最大等待时间\n        long waitTime = config.getMaxWaitTime();\n        while(waitTime > 0) {\n            long beginPollNanoTime = System.nanoTime();\n            \n            //设置超时时间，阻塞等待其他连接的释放\n            HoneycombConnection nc = idleQueue.poll(waitTime, TimeUnit.MILLISECONDS);\n            if(nc != null) {\n            \t//状态转换\n                if(nc.isClosed() && nc.switchOccupied() && working(nc)) {\n                    return nc;\n                }\n            }\n            long timeConsuming = (System.nanoTime() - beginPollNanoTime) / (1000 * 1000);\n            \n            //也许在超时时间内获取到了连接，但是状态转换失败，此时刷新超时时间\n            waitTime -= timeConsuming;\n        }\n    } catch (Exception e) {\n        e.printStackTrace();\n    }finally {\n    }\n    throw new RuntimeException(\"获取连接超时\");\n}\n```\n### 第八步：激活连接\n最后，判断一下连接是否被物理关闭，如果是，我们需要打开新的连接替换已经被回收的连接：\n```java\nif(cn.isClosedActive()) {\n\t//如果物理连接关闭，则获取新的连接\n    cn.setConnection(super.getConnection());\n}\n```\n### 连接的回收\n如果在某段时间内我们的业务量剧增，那么需要同时工作的连接将会很多，之后过了不久，我们的业务量下降，那么之前已经创建的连接明显饱和，这时就需要我们对其进行回收，我们可以通过``AbstractFeature``入口操作连接池。\n\n对于回收这个操作，我们通过``CleanerFeature``来实现：\n```java\npublic class CleanerFeature extends AbstractFeature{\n\n    private Logger logger = LoggerFactory.getLogger(CleanerFeature.class);\n\n    public CleanerFeature(boolean enable, long interval) {\n       //enable表示是否启用\n       //interval表示扫描间隔\n       super(enable, interval);\n    }\n\n    @Override\n    public void doing(HoneycombConnectionPool pool) {\n        LinkedBlockingDeque<HoneycombConnection> idleQueue = pool.getIdleQueue();\n        Thread t = new Thread() {\n            @Override\n            public void run() {\n                while(true) {\n                    try {\n                        //回收扫描间隔\n                    \tThread.sleep(interval);\n                        \n                    \t//回收时，空闲池上锁\n                        synchronized (idleQueue) {\n                            logger.debug(\"Cleaner Model To Start {}\", idleQueue.size());\n                            //回收操作\n                            idleQueue.stream().filter(c -> { return c.idleTime() > pool.getConfig().getMaxIdleTime(); }).forEach(c -> {\n                                try {\n                                    if(! c.isClosedActive() && c.idle()) {\n                                        c.closeActive();\n                                        pool.freeze(c);\n                                    }\n                                } catch (SQLException e) {\n                                    e.printStackTrace();\n                                } \n                            });\n                            logger.debug(\"Cleaner Model To Finished {}\", idleQueue.size());\n                        }\n                    }catch(Throwable e) {\n                        logger.error(\"Cleaner happended error\", e);\n                    }\n                }\n            }\n        };\n        t.setDaemon(true);\n        t.start();\n    }\n}\n```\n这里的操作很简单，对空闲池加锁，扫描所有连接，释放空闲时间超过最大空闲时间设置的连接，其实这里只要知道当前连接的空闲时长就一目了然了，我们在连接放入空闲池时候去刷新他的空闲时间点，那么当前的空闲时长就等于当前时间减去空闲开始时间：\n```powershell\nidleTime = nowTime - idleStartTime\n```\n在切换状态为空闲时刷新空闲开始时间：\n```java\n @Override\npublic boolean switchIdle() {\n    return unsafe.compareAndSwapObject(this, statusOffset, status, ConnectionStatus.IDLE) && flushIdleStartTime();\n}\n```\n## 测试一下\n体验成果的最快途径就是投入使用，这里搞一个单元测试体验一下：\n```java\nstatic ThreadPoolExecutor tpe = new ThreadPoolExecutor(1000, 1000, 0, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<Runnable>());\n    \n@Test\npublic void testConcurrence() throws SQLException, InterruptedException{\n    long start = System.currentTimeMillis();\n    HoneycombDataSource dataSource = new HoneycombDataSource();\n    dataSource.setUrl(\"jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=UTF-8&useSSL=false&transformedBitIsBoolean=true&zeroDateTimeBehavior=CONVERT_TO_NULL&serverTimezone=Asia/Shanghai\");\n    dataSource.setUser(\"root\");\n    dataSource.setPassword(\"root\");\n    dataSource.setDriver(\"com.mysql.cj.jdbc.Driver\");\n    dataSource.setMaxPoolSize(50);\n    dataSource.setInitialPoolSize(10);\n    dataSource.setMinPoolSize(10);\n    dataSource.setMaxWaitTime(60 * 1000);\n    dataSource.setMaxIdleTime(10 * 1000);\n    dataSource.addFeature(new CleanerFeature(true, 5 * 1000));\n    \n    test(dataSource, 10000);\n    System.out.println(System.currentTimeMillis() - start + \" ms\");\n}\n\npublic static void test(DataSource dataSource, int count) throws SQLException, InterruptedException {\n    CountDownLatch cdl = new CountDownLatch(count);\n    for(int i = 0; i < count; i ++) {\n        tpe.execute(() -> {\n            try {\n                HoneycombConnection connection = (HoneycombConnection) dataSource.getConnection();\n                Statement s = connection.createStatement();\n                s.executeQuery(\"select * from test limit 1\");\n                connection.close();\n            }catch(Exception e) {\n            }finally {\n                cdl.countDown();\n            }\n        });\n    }\n    cdl.await();\n    tpe.shutdown();\n}\n```\nPC配置：**Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz 2.30 GHz 4核8G 512SSD**\n\n10000次查询，耗时：\n```powershell\n938 ms\n```\n结束语：再次召唤传送门：[https://github.com/ainilili/honeycomb](https://github.com/ainilili/honeycomb)\n\n\n","source":"_posts/如何设计并实现一个db连接池？.md","raw":"title: 如何设计并实现一个db连接池？\nauthor: Nico\ntags:\n  - 连接池\ncategories: []\ndate: 2019-05-26 13:42:00\n---\n## 连接池的使命！\n无论是线程池还是db连接池，他们都有一个共同的特性：**资源复用**，在普通的场景中，我们使用一个连接，它的生命周期可能是这样的：\n![](https://user-gold-cdn.xitu.io/2019/5/24/16ae8d822d4ac11e?w=637&h=168&f=png&s=4758)\n一个连接，从创建完毕到销毁，期间只被使用了一次（这里的一次是指在单个作用域内的使用），当周期结束，另外一个调用者仍然需要这个连接去做事，就要重复去经历这种生命周期。因为创建和销毁都是需要对应的服务消耗时间以及系统资源去处理的，这样不仅浪费了大量的系统资源，而且导致业务响应过程中都要花费部分时间去重复的创建和销毁，得不偿失，而连接池便被赋予了解决这种问题的使命！\n## 连接池需要做什么？\n顾名思义，连接池中的**池**字已经很生动形象的阐明了它的用意，它用将所有连接放入一个``\"池子\"``中统一的去控制连接的创建和销毁，和原始生命周期去对比，连接池多了以下特性：\n - 创建并不是真的创建，而是从池子中选出空闲连接。\n - 销毁并不是真的销毁，而是将使用中的连接放回池中（逻辑关闭）。\n - 真正的创建和销毁由线程池的特性机制来决定。\n\n因此，当使用连接池后，我们使用一个连接的生命周期将会演变成这样：\n![](https://user-gold-cdn.xitu.io/2019/5/24/16ae8fb43b0a3d13?w=588&h=377&f=png&s=13088)\n## 分析计划\n通灵之术 - 传送门：[https://github.com/ainilili/honeycomb](https://github.com/ainilili/honeycomb)，DEMO为Java语言实现！\n\n事前，我们需要点支烟分析一下时间一个连接池需要做哪些事情：\n - 保存连接的容器是必不可少的，另外，该容器也要支持连接的添加和移除功能，并保证线程安全。\n - 我们需要因为要对连接的销毁做逻辑调整，我们需要重写它的``close``以及``isClosed``方法。\n - 我们需要有个入口对连接池做管理，例如回收空闲连接。\n\n连接池不仅仅只是对``Connection``生命周期的控制，还应该加入一些特色，例如初始连接数，最大连接数，最小连接数、最大空闲时长以及获取连接的等待时长，这些我们也简单支持一下。\n\n目标以明确，开始动工。\n### 连接池容器选型\n要保证线程安全，我们可以将目标瞄准在``JUC``包下的神通们，设我们想要的容器为``x``，那么``x``不仅需要满足基本的增删改查功能，而且也要提供获取超时功能，这是为了保证当池内长时间没有空闲连接时不会导致业务阻塞，即刻熔断。另外，``x``需要满足双向操作，这是为了连接池可以识别出饱和的空闲连接，方便回收操作。\n\n综上所述，``LinkedBlockingDeque``是最合适的选择，它使用``InterruptibleReentrantLock``来保证线程安全，使用``Condition``来做获取元素的阻塞，另外支持双向操作。\n\n另外，我们可以将连接池拆分为3个类型：\n - **工作池**：存放正在被使用的连接。\n - **空闲池**：存放空闲连接。\n - **回收池**：已经被回收（物理关闭）的连接。\n\n其中，**工作池**和**回收池**大可不必用双向对列，或许用单向队列或者``Set``都可以代替之：\n```java\nprivate LinkedBlockingQueue<HoneycombConnection> workQueue;\nprivate LinkedBlockingDeque<HoneycombConnection> idleQueue;\nprivate LinkedBlockingQueue<HoneycombConnection> freezeQueue;\n```\n### Connection的装饰\n连接池的输出是``Connection``，它代表着一个db连接，上游服务使用它做完操作后，会直接调用它的``close``方法来释放连接，而我们必须做的是在调用者无感知的情况下改变它的关闭逻辑，当调用``close``的方法时，我们将它放回空闲队列中，保证其的可复用性！\n\n因此，我们需要对原来的``Connection``做装饰，其做法很简单，但是很累，这里新建一个类来实现``Connection``接口，通过重写所有的方法来实现一个**\"可编辑\"**的``Connection``，我们称之为``Connection``的装饰者：\n```java\npublic class HoneycombConnectionDecorator implements Connection{\n\n    protected Connection connection;\n    \n    protected HoneycombConnectionDecorator(Connection connection) {\n        this.connection = connection;\n    }\n    \n    此处省略对方法实现的三百行代码...\n}\n```\n之后，我们需要新建一个自己的``Connection``来继承这个装饰者，并重写相应的方法：\n```java\npublic class HoneycombConnection extends HoneycombConnectionDecorator implements HoneycombConnectionSwitcher{\n    @Override\n    public void close() { do some things }\n\n    @Override\n    public boolean isClosed() throws SQLException { do some things }    \n    \n    省略...\n}\n```\n### DataSource的重写\n``DataSource``是JDK为了更好的统合和管理数据源而定义出的一个规范，获取连接的入口，方便我们在这一层更好的扩展数据源（例如增加特殊属性），使我们的连接池的功能更加丰富，我们需要实现一个自己的``DataSource``能：\n```java\npublic class HoneycombWrapperDatasource implements DataSource{\n    protected HoneycombDatasourceConfig config;\n    省略其它方法的实现...\n    @Override\n    public Connection getConnection() throws SQLException {\n        return DriverManager.getConnection(config.getUrl(), config.getUser(), config.getPassword());\n    }\n\n    @Override\n    public Connection getConnection(String username, String password) throws SQLException {\n        return DriverManager.getConnection(config.getUrl(), username, password);\n    }\n    省略其它方法的实现...\n}\n```\n我们完成了对数据源的实现，但是这里获取连接的方式是物理创建，我们需要满足池化的目的，需要重写``HoneycombWrapperDatasource``中的连接获取逻辑，做法是创建一个新的类对父类方法重写：\n```java\npublic class HoneycombDataSource extends HoneycombWrapperDatasource{\n    private HoneycombConnectionPool pool;\n    @Override\n    public Connection getConnection() throws SQLException {\n        这里实现从pool中取出连接的逻辑\n    }\n    省略...\n}\n```\n### 特性扩展\n在当前结构体系下，我们的连接池逐渐浮现出了雏形，但远远不够的是，我们需要在此结构下可以做自由的扩展，使连接池对连接的控制更加灵活，因此我们可以引入**特性**这个概念，它允许我们在其内部访问连接池，并对连接池做一系列的扩展操作：\n```java\npublic abstract class AbstractFeature{\n    public abstract void doing(HoneycombConnectionPool pool);\n}\n```\n``AbstractFeature``抽象父类需要实现``doing``方法，我们可以在方法内部实现对连接池的控制，其中一个典型的例子就是对池中空闲连接左回收：\n```java\npublic class CleanerFeature extends AbstractFeature{\n    @Override\n    public void doing(HoneycombConnectionPool pool) {\n        这里做空闲连接的回收\n    }\n}\n```\n## 落实计划\n经过上述分析，要完成一个连接池，需要这些模块的配合，总体流程如下：\n![](https://user-gold-cdn.xitu.io/2019/5/26/16af28f6f668a3e6?w=754&h=845&f=png&s=66582)\n\n### 第一步：设置数据源属性\n在初始化``DataSource``之前，我们需要将各属性设置进去，这里使用``HoneycombWrapperDatasource``中的``HoneycombDatasourceConfig``来承载各属性：\n```java\npublic class HoneycombDatasourceConfig {\n\n    //db url\n    private String url;\n\n    //db user\n    private String user;\n\n    //db password\n    private String password;\n\n    //driver驱动\n    private String driver;\n\n    //初始化连接数，默认为2\n    private int initialPoolSize = 2;\n\n    //最大连接数，默认为10\n    private int maxPoolSize = 10;\n\n    //最小连接数，默认为2\n    private int minPoolSize = 2;\n    \n    //获取连接时，最大等待时长，默认为60s\n    private long maxWaitTime = 60 * 1000;\n\n    //最大空闲时长，超出要被回收，默认为20s\n    private long maxIdleTime = 20 * 1000;\n    \n    //特性列表\n    private List<AbstractFeature> features;\n    \n    public HoneycombDatasourceConfig() {\n        features = new ArrayList<AbstractFeature>(5);\n    }\n    \n    省略getter、setter....\n```\n### 第二步：初始化连接池\n设置好属性之后，我们需要完成连接池的初始化工作，在``HoneycombDataSource``的``init``方法中实现：\n```java\nprivate void init() throws ClassNotFoundException, SQLException {\n    //阻塞其他线程初始化操作，等待初始化完成\n    if(initialStarted || ! (initialStarted = ! initialStarted)) {\n        if(! initialFinished) {\n            try {\n                INITIAL_LOCK.lock();\n                INITIAL_CONDITION.await();\n            } catch (InterruptedException e) {\n            } finally {\n                INITIAL_LOCK.unlock();\n            }\n        }\n        return;\n    }\n    \n    //config参数校验\n    config.assertSelf();\n    \n    Class.forName(getDriver());\n    \n    //实例化线程池\n    pool = new HoneycombConnectionPool(config);\n    \n    //初始化最小连接\n    Integer index = null;\n    for(int i = 0; i < config.getInitialPoolSize(); i ++) {\n        if((index =  pool.applyIndex()) != null) {\n            pool.putLeisureConnection(createNativeConnection(pool), index);\n        }\n    }\n    \n    //触发特性\n    pool.touchFeatures();\n    \n    //完成初始化并唤醒其他阻塞\n    initialFinished = true;\n    try {\n        INITIAL_LOCK.lock();\n        INITIAL_CONDITION.signalAll();\n    }catch(Exception e) {\n    }finally {\n        INITIAL_LOCK.unlock();\n    }\n}\n```\n### 第三步：创建初始连接\n在``init``的方法中，如果``initialPoolSize``大于0，会去创建指定数量的物理连接放入连接池中，创建数量要小于最大连接数``maxPoolSize``：\n```java\npublic HoneycombConnection createNativeConnection(HoneycombConnectionPool pool) throws SQLException {\n    return new HoneycombConnection(super.getConnection(), pool);\n}\n```\n完成初始化后，下一步就是获取连接。\n### 第四步：从空闲池获取\n我们之前将连接池分成了三个，它们分别是**空闲池**、**工作池**和**回收池**。\n\n我们可以通过``HoneycombDataSource``的``getConnection``方法来获取连接，当我们需要获取时，首先考虑的是空闲池是否有空闲连接，这样可以避免创建和激活新的连接：\n```java\n@Override\npublic Connection getConnection() throws SQLException {\n    try {\n    \t//初始化连接池\n        init();\n    } catch (ClassNotFoundException e) {\n        throw new RuntimeException(e);\n    }\n    \n    HoneycombConnection cn = null;\n    Integer index = null;\n    \n    if(pool.assignable()) {\n    \t//空闲池可分配，从空闲池取出\n        cn = pool.getIdleConnection();\n    }else if(pool.actionable()) {\n    \t//回收池可分配，从回收池取出\n        cn = pool.getFreezeConnection();\n    }else if((index =  pool.applyIndex()) != null) {\n    \t//如果连接数未满，创建新的物理连接\n        cn = pool.putOccupiedConnection(createNativeConnection(pool), index);\n    }\n    \n    if(cn == null) {\n    \t//如果无法获取连接，阻塞等待空闲池连接\n        cn = pool.getIdleConnection();\n    }\n    \n    if(cn.isClosedActive()) {\n    \t//如果物理连接关闭，则获取新的连接\n        cn.setConnection(super.getConnection());\n    }\n    return cn;\n}\n```\n### 第五步：从回收池获取\n如果空闲池不可分配，那么说明连接供不应求，也许之前有些空闲连接已经被回收（物理关闭），那么我们在创建新连接之前，可以到回收池看一下是否存在已回收连接，如果存在直接取出：\n```java\nelse if(pool.actionable()) {\n\t//回收池可分配，从回收池取出\n    cn = pool.getFreezeConnection();\n}\n```\n### 第六步：创建新的连接\n如果回收池也不可分配，此时要判断连接池连接数量是否已经达到最大连接，如果没有达到，创建新的物理连接并直接添加到工作池中：\n```java\nelse if((index =  pool.applyIndex()) != null) {\n\t//如果连接数未满，创建新的物理连接，添加到工作池\n    cn = pool.putOccupiedConnection(createNativeConnection(pool), index);\n}\n```\n### 第七步：等待空闲池的连接\n如果上述三种情况都不满足，那么只能从空闲池等待其他连接的释放：\n```java\nif(cn == null) {\n\t//如果无法获取连接，阻塞等待空闲池连接\n    cn = pool.getIdleConnection();\n}\n```\n具体逻辑封装在``HoneycombConnectionPool``的``getIdleConnection``方法中：\n```java\npublic HoneycombConnection getIdleConnection() {\n    try {\n    \t//获取最大等待时间\n        long waitTime = config.getMaxWaitTime();\n        while(waitTime > 0) {\n            long beginPollNanoTime = System.nanoTime();\n            \n            //设置超时时间，阻塞等待其他连接的释放\n            HoneycombConnection nc = idleQueue.poll(waitTime, TimeUnit.MILLISECONDS);\n            if(nc != null) {\n            \t//状态转换\n                if(nc.isClosed() && nc.switchOccupied() && working(nc)) {\n                    return nc;\n                }\n            }\n            long timeConsuming = (System.nanoTime() - beginPollNanoTime) / (1000 * 1000);\n            \n            //也许在超时时间内获取到了连接，但是状态转换失败，此时刷新超时时间\n            waitTime -= timeConsuming;\n        }\n    } catch (Exception e) {\n        e.printStackTrace();\n    }finally {\n    }\n    throw new RuntimeException(\"获取连接超时\");\n}\n```\n### 第八步：激活连接\n最后，判断一下连接是否被物理关闭，如果是，我们需要打开新的连接替换已经被回收的连接：\n```java\nif(cn.isClosedActive()) {\n\t//如果物理连接关闭，则获取新的连接\n    cn.setConnection(super.getConnection());\n}\n```\n### 连接的回收\n如果在某段时间内我们的业务量剧增，那么需要同时工作的连接将会很多，之后过了不久，我们的业务量下降，那么之前已经创建的连接明显饱和，这时就需要我们对其进行回收，我们可以通过``AbstractFeature``入口操作连接池。\n\n对于回收这个操作，我们通过``CleanerFeature``来实现：\n```java\npublic class CleanerFeature extends AbstractFeature{\n\n    private Logger logger = LoggerFactory.getLogger(CleanerFeature.class);\n\n    public CleanerFeature(boolean enable, long interval) {\n       //enable表示是否启用\n       //interval表示扫描间隔\n       super(enable, interval);\n    }\n\n    @Override\n    public void doing(HoneycombConnectionPool pool) {\n        LinkedBlockingDeque<HoneycombConnection> idleQueue = pool.getIdleQueue();\n        Thread t = new Thread() {\n            @Override\n            public void run() {\n                while(true) {\n                    try {\n                        //回收扫描间隔\n                    \tThread.sleep(interval);\n                        \n                    \t//回收时，空闲池上锁\n                        synchronized (idleQueue) {\n                            logger.debug(\"Cleaner Model To Start {}\", idleQueue.size());\n                            //回收操作\n                            idleQueue.stream().filter(c -> { return c.idleTime() > pool.getConfig().getMaxIdleTime(); }).forEach(c -> {\n                                try {\n                                    if(! c.isClosedActive() && c.idle()) {\n                                        c.closeActive();\n                                        pool.freeze(c);\n                                    }\n                                } catch (SQLException e) {\n                                    e.printStackTrace();\n                                } \n                            });\n                            logger.debug(\"Cleaner Model To Finished {}\", idleQueue.size());\n                        }\n                    }catch(Throwable e) {\n                        logger.error(\"Cleaner happended error\", e);\n                    }\n                }\n            }\n        };\n        t.setDaemon(true);\n        t.start();\n    }\n}\n```\n这里的操作很简单，对空闲池加锁，扫描所有连接，释放空闲时间超过最大空闲时间设置的连接，其实这里只要知道当前连接的空闲时长就一目了然了，我们在连接放入空闲池时候去刷新他的空闲时间点，那么当前的空闲时长就等于当前时间减去空闲开始时间：\n```powershell\nidleTime = nowTime - idleStartTime\n```\n在切换状态为空闲时刷新空闲开始时间：\n```java\n @Override\npublic boolean switchIdle() {\n    return unsafe.compareAndSwapObject(this, statusOffset, status, ConnectionStatus.IDLE) && flushIdleStartTime();\n}\n```\n## 测试一下\n体验成果的最快途径就是投入使用，这里搞一个单元测试体验一下：\n```java\nstatic ThreadPoolExecutor tpe = new ThreadPoolExecutor(1000, 1000, 0, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<Runnable>());\n    \n@Test\npublic void testConcurrence() throws SQLException, InterruptedException{\n    long start = System.currentTimeMillis();\n    HoneycombDataSource dataSource = new HoneycombDataSource();\n    dataSource.setUrl(\"jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=UTF-8&useSSL=false&transformedBitIsBoolean=true&zeroDateTimeBehavior=CONVERT_TO_NULL&serverTimezone=Asia/Shanghai\");\n    dataSource.setUser(\"root\");\n    dataSource.setPassword(\"root\");\n    dataSource.setDriver(\"com.mysql.cj.jdbc.Driver\");\n    dataSource.setMaxPoolSize(50);\n    dataSource.setInitialPoolSize(10);\n    dataSource.setMinPoolSize(10);\n    dataSource.setMaxWaitTime(60 * 1000);\n    dataSource.setMaxIdleTime(10 * 1000);\n    dataSource.addFeature(new CleanerFeature(true, 5 * 1000));\n    \n    test(dataSource, 10000);\n    System.out.println(System.currentTimeMillis() - start + \" ms\");\n}\n\npublic static void test(DataSource dataSource, int count) throws SQLException, InterruptedException {\n    CountDownLatch cdl = new CountDownLatch(count);\n    for(int i = 0; i < count; i ++) {\n        tpe.execute(() -> {\n            try {\n                HoneycombConnection connection = (HoneycombConnection) dataSource.getConnection();\n                Statement s = connection.createStatement();\n                s.executeQuery(\"select * from test limit 1\");\n                connection.close();\n            }catch(Exception e) {\n            }finally {\n                cdl.countDown();\n            }\n        });\n    }\n    cdl.await();\n    tpe.shutdown();\n}\n```\nPC配置：**Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz 2.30 GHz 4核8G 512SSD**\n\n10000次查询，耗时：\n```powershell\n938 ms\n```\n结束语：再次召唤传送门：[https://github.com/ainilili/honeycomb](https://github.com/ainilili/honeycomb)\n\n\n","slug":"如何设计并实现一个db连接池？","published":1,"updated":"2021-03-21T17:43:05.651Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uye000yb0tz1mwe95pa","content":"<h2 id=\"连接池的使命\"><a class=\"header-anchor\" href=\"#连接池的使命\">¶</a>连接池的使命！</h2>\n<p>无论是线程池还是db连接池，他们都有一个共同的特性：<strong>资源复用</strong>，在普通的场景中，我们使用一个连接，它的生命周期可能是这样的：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/24/16ae8d822d4ac11e?w=637&amp;h=168&amp;f=png&amp;s=4758\" alt=\"\"><br>\n一个连接，从创建完毕到销毁，期间只被使用了一次（这里的一次是指在单个作用域内的使用），当周期结束，另外一个调用者仍然需要这个连接去做事，就要重复去经历这种生命周期。因为创建和销毁都是需要对应的服务消耗时间以及系统资源去处理的，这样不仅浪费了大量的系统资源，而且导致业务响应过程中都要花费部分时间去重复的创建和销毁，得不偿失，而连接池便被赋予了解决这种问题的使命！</p>\n<h2 id=\"连接池需要做什么？\"><a class=\"header-anchor\" href=\"#连接池需要做什么？\">¶</a>连接池需要做什么？</h2>\n<p>顾名思义，连接池中的<strong>池</strong>字已经很生动形象的阐明了它的用意，它用将所有连接放入一个<code>&quot;池子&quot;</code>中统一的去控制连接的创建和销毁，和原始生命周期去对比，连接池多了以下特性：</p>\n<ul>\n<li>创建并不是真的创建，而是从池子中选出空闲连接。</li>\n<li>销毁并不是真的销毁，而是将使用中的连接放回池中（逻辑关闭）。</li>\n<li>真正的创建和销毁由线程池的特性机制来决定。</li>\n</ul>\n<p>因此，当使用连接池后，我们使用一个连接的生命周期将会演变成这样：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/24/16ae8fb43b0a3d13?w=588&amp;h=377&amp;f=png&amp;s=13088\" alt=\"\"></p>\n<h2 id=\"分析计划\"><a class=\"header-anchor\" href=\"#分析计划\">¶</a>分析计划</h2>\n<p>通灵之术 - 传送门：<a href=\"https://github.com/ainilili/honeycomb\">https://github.com/ainilili/honeycomb</a>，DEMO为Java语言实现！</p>\n<p>事前，我们需要点支烟分析一下时间一个连接池需要做哪些事情：</p>\n<ul>\n<li>保存连接的容器是必不可少的，另外，该容器也要支持连接的添加和移除功能，并保证线程安全。</li>\n<li>我们需要因为要对连接的销毁做逻辑调整，我们需要重写它的<code>close</code>以及<code>isClosed</code>方法。</li>\n<li>我们需要有个入口对连接池做管理，例如回收空闲连接。</li>\n</ul>\n<p>连接池不仅仅只是对<code>Connection</code>生命周期的控制，还应该加入一些特色，例如初始连接数，最大连接数，最小连接数、最大空闲时长以及获取连接的等待时长，这些我们也简单支持一下。</p>\n<p>目标以明确，开始动工。</p>\n<h3 id=\"连接池容器选型\"><a class=\"header-anchor\" href=\"#连接池容器选型\">¶</a>连接池容器选型</h3>\n<p>要保证线程安全，我们可以将目标瞄准在<code>JUC</code>包下的神通们，设我们想要的容器为<code>x</code>，那么<code>x</code>不仅需要满足基本的增删改查功能，而且也要提供获取超时功能，这是为了保证当池内长时间没有空闲连接时不会导致业务阻塞，即刻熔断。另外，<code>x</code>需要满足双向操作，这是为了连接池可以识别出饱和的空闲连接，方便回收操作。</p>\n<p>综上所述，<code>LinkedBlockingDeque</code>是最合适的选择，它使用<code>InterruptibleReentrantLock</code>来保证线程安全，使用<code>Condition</code>来做获取元素的阻塞，另外支持双向操作。</p>\n<p>另外，我们可以将连接池拆分为3个类型：</p>\n<ul>\n<li><strong>工作池</strong>：存放正在被使用的连接。</li>\n<li><strong>空闲池</strong>：存放空闲连接。</li>\n<li><strong>回收池</strong>：已经被回收（物理关闭）的连接。</li>\n</ul>\n<p>其中，<strong>工作池</strong>和<strong>回收池</strong>大可不必用双向对列，或许用单向队列或者<code>Set</code>都可以代替之：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; workQueue;</span><br><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue;</span><br><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; freezeQueue;</span><br></pre></td></tr></table></figure>\n<h3 id=\"connection的装饰\"><a class=\"header-anchor\" href=\"#connection的装饰\">¶</a>Connection的装饰</h3>\n<p>连接池的输出是<code>Connection</code>，它代表着一个db连接，上游服务使用它做完操作后，会直接调用它的<code>close</code>方法来释放连接，而我们必须做的是在调用者无感知的情况下改变它的关闭逻辑，当调用<code>close</code>的方法时，我们将它放回空闲队列中，保证其的可复用性！</p>\n<p>因此，我们需要对原来的<code>Connection</code>做装饰，其做法很简单，但是很累，这里新建一个类来实现<code>Connection</code>接口，通过重写所有的方法来实现一个**“可编辑”**的<code>Connection</code>，我们称之为<code>Connection</code>的装饰者：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombConnectionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Connection</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Connection connection;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">HoneycombConnectionDecorator</span><span class=\"params\">(Connection connection)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.connection = connection;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    此处省略对方法实现的三百行代码...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>之后，我们需要新建一个自己的<code>Connection</code>来继承这个装饰者，并重写相应的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombConnection</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HoneycombConnectionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HoneycombConnectionSwitcher</span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">close</span><span class=\"params\">()</span> &#123; <span class=\"keyword\">do</span> some things &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isClosed</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123; <span class=\"keyword\">do</span> some things &#125;    </span><br><span class=\"line\">    </span><br><span class=\"line\">    省略...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"datasource的重写\"><a class=\"header-anchor\" href=\"#datasource的重写\">¶</a>DataSource的重写</h3>\n<p><code>DataSource</code>是JDK为了更好的统合和管理数据源而定义出的一个规范，获取连接的入口，方便我们在这一层更好的扩展数据源（例如增加特殊属性），使我们的连接池的功能更加丰富，我们需要实现一个自己的<code>DataSource</code>能：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombWrapperDatasource</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">DataSource</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> HoneycombDatasourceConfig config;</span><br><span class=\"line\">    省略其它方法的实现...</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> DriverManager.getConnection(config.getUrl(), config.getUser(), config.getPassword());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">(String username, String password)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> DriverManager.getConnection(config.getUrl(), username, password);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    省略其它方法的实现...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们完成了对数据源的实现，但是这里获取连接的方式是物理创建，我们需要满足池化的目的，需要重写<code>HoneycombWrapperDatasource</code>中的连接获取逻辑，做法是创建一个新的类对父类方法重写：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombDataSource</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HoneycombWrapperDatasource</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> HoneycombConnectionPool pool;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        这里实现从pool中取出连接的逻辑</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    省略...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"特性扩展\"><a class=\"header-anchor\" href=\"#特性扩展\">¶</a>特性扩展</h3>\n<p>在当前结构体系下，我们的连接池逐渐浮现出了雏形，但远远不够的是，我们需要在此结构下可以做自由的扩展，使连接池对连接的控制更加灵活，因此我们可以引入<strong>特性</strong>这个概念，它允许我们在其内部访问连接池，并对连接池做一系列的扩展操作：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>AbstractFeature</code>抽象父类需要实现<code>doing</code>方法，我们可以在方法内部实现对连接池的控制，其中一个典型的例子就是对池中空闲连接左回收：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CleanerFeature</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span> &#123;</span><br><span class=\"line\">        这里做空闲连接的回收</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"落实计划\"><a class=\"header-anchor\" href=\"#落实计划\">¶</a>落实计划</h2>\n<p>经过上述分析，要完成一个连接池，需要这些模块的配合，总体流程如下：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/26/16af28f6f668a3e6?w=754&amp;h=845&amp;f=png&amp;s=66582\" alt=\"\"></p>\n<h3 id=\"第一步：设置数据源属性\"><a class=\"header-anchor\" href=\"#第一步：设置数据源属性\">¶</a>第一步：设置数据源属性</h3>\n<p>在初始化<code>DataSource</code>之前，我们需要将各属性设置进去，这里使用<code>HoneycombWrapperDatasource</code>中的<code>HoneycombDatasourceConfig</code>来承载各属性：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombDatasourceConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db url</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String url;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db user</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String user;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db password</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String password;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//driver驱动</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String driver;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化连接数，默认为2</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">initialPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最大连接数，默认为10</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">maxPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最小连接数，默认为2</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">minPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//获取连接时，最大等待时长，默认为60s</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">maxWaitTime</span> <span class=\"operator\">=</span> <span class=\"number\">60</span> * <span class=\"number\">1000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最大空闲时长，超出要被回收，默认为20s</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">maxIdleTime</span> <span class=\"operator\">=</span> <span class=\"number\">20</span> * <span class=\"number\">1000</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//特性列表</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;AbstractFeature&gt; features;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">HoneycombDatasourceConfig</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        features = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;AbstractFeature&gt;(<span class=\"number\">5</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    省略getter、setter....</span><br></pre></td></tr></table></figure>\n<h3 id=\"第二步：初始化连接池\"><a class=\"header-anchor\" href=\"#第二步：初始化连接池\">¶</a>第二步：初始化连接池</h3>\n<p>设置好属性之后，我们需要完成连接池的初始化工作，在<code>HoneycombDataSource</code>的<code>init</code>方法中实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class=\"line\">    <span class=\"comment\">//阻塞其他线程初始化操作，等待初始化完成</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(initialStarted || ! (initialStarted = ! initialStarted)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(! initialFinished) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                INITIAL_LOCK.lock();</span><br><span class=\"line\">                INITIAL_CONDITION.await();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                INITIAL_LOCK.unlock();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//config参数校验</span></span><br><span class=\"line\">    config.assertSelf();</span><br><span class=\"line\">    </span><br><span class=\"line\">    Class.forName(getDriver());</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//实例化线程池</span></span><br><span class=\"line\">    pool = <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombConnectionPool</span>(config);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//初始化最小连接</span></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; config.getInitialPoolSize(); i ++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            pool.putLeisureConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//触发特性</span></span><br><span class=\"line\">    pool.touchFeatures();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//完成初始化并唤醒其他阻塞</span></span><br><span class=\"line\">    initialFinished = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        INITIAL_LOCK.lock();</span><br><span class=\"line\">        INITIAL_CONDITION.signalAll();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception e) &#123;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        INITIAL_LOCK.unlock();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第三步：创建初始连接\"><a class=\"header-anchor\" href=\"#第三步：创建初始连接\">¶</a>第三步：创建初始连接</h3>\n<p>在<code>init</code>的方法中，如果<code>initialPoolSize</code>大于0，会去创建指定数量的物理连接放入连接池中，创建数量要小于最大连接数<code>maxPoolSize</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> HoneycombConnection <span class=\"title function_\">createNativeConnection</span><span class=\"params\">(HoneycombConnectionPool pool)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombConnection</span>(<span class=\"built_in\">super</span>.getConnection(), pool);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>完成初始化后，下一步就是获取连接。</p>\n<h3 id=\"第四步：从空闲池获取\"><a class=\"header-anchor\" href=\"#第四步：从空闲池获取\">¶</a>第四步：从空闲池获取</h3>\n<p>我们之前将连接池分成了三个，它们分别是<strong>空闲池</strong>、<strong>工作池</strong>和<strong>回收池</strong>。</p>\n<p>我们可以通过<code>HoneycombDataSource</code>的<code>getConnection</code>方法来获取连接，当我们需要获取时，首先考虑的是空闲池是否有空闲连接，这样可以避免创建和激活新的连接：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//初始化连接池</span></span><br><span class=\"line\">        init();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">cn</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(pool.assignable()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//空闲池可分配，从空闲池取出</span></span><br><span class=\"line\">        cn = pool.getIdleConnection();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(pool.actionable()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//回收池可分配，从回收池取出</span></span><br><span class=\"line\">        cn = pool.getFreezeConnection();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果连接数未满，创建新的物理连接</span></span><br><span class=\"line\">        cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cn == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class=\"line\">        cn = pool.getIdleConnection();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cn.isClosedActive()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果物理连接关闭，则获取新的连接</span></span><br><span class=\"line\">        cn.setConnection(<span class=\"built_in\">super</span>.getConnection());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cn;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第五步：从回收池获取\"><a class=\"header-anchor\" href=\"#第五步：从回收池获取\">¶</a>第五步：从回收池获取</h3>\n<p>如果空闲池不可分配，那么说明连接供不应求，也许之前有些空闲连接已经被回收（物理关闭），那么我们在创建新连接之前，可以到回收池看一下是否存在已回收连接，如果存在直接取出：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(pool.actionable()) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//回收池可分配，从回收池取出</span></span><br><span class=\"line\">    cn = pool.getFreezeConnection();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第六步：创建新的连接\"><a class=\"header-anchor\" href=\"#第六步：创建新的连接\">¶</a>第六步：创建新的连接</h3>\n<p>如果回收池也不可分配，此时要判断连接池连接数量是否已经达到最大连接，如果没有达到，创建新的物理连接并直接添加到工作池中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果连接数未满，创建新的物理连接，添加到工作池</span></span><br><span class=\"line\">    cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第七步：等待空闲池的连接\"><a class=\"header-anchor\" href=\"#第七步：等待空闲池的连接\">¶</a>第七步：等待空闲池的连接</h3>\n<p>如果上述三种情况都不满足，那么只能从空闲池等待其他连接的释放：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(cn == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class=\"line\">    cn = pool.getIdleConnection();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>具体逻辑封装在<code>HoneycombConnectionPool</code>的<code>getIdleConnection</code>方法中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> HoneycombConnection <span class=\"title function_\">getIdleConnection</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//获取最大等待时间</span></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">waitTime</span> <span class=\"operator\">=</span> config.getMaxWaitTime();</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(waitTime &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">beginPollNanoTime</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//设置超时时间，阻塞等待其他连接的释放</span></span><br><span class=\"line\">            <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">nc</span> <span class=\"operator\">=</span> idleQueue.poll(waitTime, TimeUnit.MILLISECONDS);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(nc != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \t<span class=\"comment\">//状态转换</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(nc.isClosed() &amp;&amp; nc.switchOccupied() &amp;&amp; working(nc)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> nc;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">timeConsuming</span> <span class=\"operator\">=</span> (System.nanoTime() - beginPollNanoTime) / (<span class=\"number\">1000</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//也许在超时时间内获取到了连接，但是状态转换失败，此时刷新超时时间</span></span><br><span class=\"line\">            waitTime -= timeConsuming;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;获取连接超时&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第八步：激活连接\"><a class=\"header-anchor\" href=\"#第八步：激活连接\">¶</a>第八步：激活连接</h3>\n<p>最后，判断一下连接是否被物理关闭，如果是，我们需要打开新的连接替换已经被回收的连接：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(cn.isClosedActive()) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果物理连接关闭，则获取新的连接</span></span><br><span class=\"line\">    cn.setConnection(<span class=\"built_in\">super</span>.getConnection());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"连接的回收\"><a class=\"header-anchor\" href=\"#连接的回收\">¶</a>连接的回收</h3>\n<p>如果在某段时间内我们的业务量剧增，那么需要同时工作的连接将会很多，之后过了不久，我们的业务量下降，那么之前已经创建的连接明显饱和，这时就需要我们对其进行回收，我们可以通过<code>AbstractFeature</code>入口操作连接池。</p>\n<p>对于回收这个操作，我们通过<code>CleanerFeature</code>来实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CleanerFeature</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(CleanerFeature.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">CleanerFeature</span><span class=\"params\">(<span class=\"type\">boolean</span> enable, <span class=\"type\">long</span> interval)</span> &#123;</span><br><span class=\"line\">       <span class=\"comment\">//enable表示是否启用</span></span><br><span class=\"line\">       <span class=\"comment\">//interval表示扫描间隔</span></span><br><span class=\"line\">       <span class=\"built_in\">super</span>(enable, interval);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span> &#123;</span><br><span class=\"line\">        LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue = pool.getIdleQueue();</span><br><span class=\"line\">        <span class=\"type\">Thread</span> <span class=\"variable\">t</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//回收扫描间隔</span></span><br><span class=\"line\">                    \tThread.sleep(interval);</span><br><span class=\"line\">                        </span><br><span class=\"line\">                    \t<span class=\"comment\">//回收时，空闲池上锁</span></span><br><span class=\"line\">                        <span class=\"keyword\">synchronized</span> (idleQueue) &#123;</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">&quot;Cleaner Model To Start &#123;&#125;&quot;</span>, idleQueue.size());</span><br><span class=\"line\">                            <span class=\"comment\">//回收操作</span></span><br><span class=\"line\">                            idleQueue.stream().filter(c -&gt; &#123; <span class=\"keyword\">return</span> c.idleTime() &gt; pool.getConfig().getMaxIdleTime(); &#125;).forEach(c -&gt; &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span>(! c.isClosedActive() &amp;&amp; c.idle()) &#123;</span><br><span class=\"line\">                                        c.closeActive();</span><br><span class=\"line\">                                        pool.freeze(c);</span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">                                    e.printStackTrace();</span><br><span class=\"line\">                                &#125; </span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">&quot;Cleaner Model To Finished &#123;&#125;&quot;</span>, idleQueue.size());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;<span class=\"keyword\">catch</span>(Throwable e) &#123;</span><br><span class=\"line\">                        logger.error(<span class=\"string\">&quot;Cleaner happended error&quot;</span>, e);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        t.setDaemon(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        t.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的操作很简单，对空闲池加锁，扫描所有连接，释放空闲时间超过最大空闲时间设置的连接，其实这里只要知道当前连接的空闲时长就一目了然了，我们在连接放入空闲池时候去刷新他的空闲时间点，那么当前的空闲时长就等于当前时间减去空闲开始时间：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idleTime = nowTime - idleStartTime</span><br></pre></td></tr></table></figure>\n<p>在切换状态为空闲时刷新空闲开始时间：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">switchIdle</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> unsafe.compareAndSwapObject(<span class=\"built_in\">this</span>, statusOffset, status, ConnectionStatus.IDLE) &amp;&amp; flushIdleStartTime();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试一下\"><a class=\"header-anchor\" href=\"#测试一下\">¶</a>测试一下</h2>\n<p>体验成果的最快途径就是投入使用，这里搞一个单元测试体验一下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">tpe</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(<span class=\"number\">1000</span>, <span class=\"number\">1000</span>, <span class=\"number\">0</span>, TimeUnit.MILLISECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testConcurrence</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException, InterruptedException&#123;</span><br><span class=\"line\">    <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">    <span class=\"type\">HoneycombDataSource</span> <span class=\"variable\">dataSource</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombDataSource</span>();</span><br><span class=\"line\">    dataSource.setUrl(<span class=\"string\">&quot;jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;transformedBitIsBoolean=true&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=Asia/Shanghai&quot;</span>);</span><br><span class=\"line\">    dataSource.setUser(<span class=\"string\">&quot;root&quot;</span>);</span><br><span class=\"line\">    dataSource.setPassword(<span class=\"string\">&quot;root&quot;</span>);</span><br><span class=\"line\">    dataSource.setDriver(<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class=\"line\">    dataSource.setMaxPoolSize(<span class=\"number\">50</span>);</span><br><span class=\"line\">    dataSource.setInitialPoolSize(<span class=\"number\">10</span>);</span><br><span class=\"line\">    dataSource.setMinPoolSize(<span class=\"number\">10</span>);</span><br><span class=\"line\">    dataSource.setMaxWaitTime(<span class=\"number\">60</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">    dataSource.setMaxIdleTime(<span class=\"number\">10</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">    dataSource.addFeature(<span class=\"keyword\">new</span> <span class=\"title class_\">CleanerFeature</span>(<span class=\"literal\">true</span>, <span class=\"number\">5</span> * <span class=\"number\">1000</span>));</span><br><span class=\"line\">    </span><br><span class=\"line\">    test(dataSource, <span class=\"number\">10000</span>);</span><br><span class=\"line\">    System.out.println(System.currentTimeMillis() - start + <span class=\"string\">&quot; ms&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test</span><span class=\"params\">(DataSource dataSource, <span class=\"type\">int</span> count)</span> <span class=\"keyword\">throws</span> SQLException, InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"type\">CountDownLatch</span> <span class=\"variable\">cdl</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CountDownLatch</span>(count);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; count; i ++) &#123;</span><br><span class=\"line\">        tpe.execute(() -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">connection</span> <span class=\"operator\">=</span> (HoneycombConnection) dataSource.getConnection();</span><br><span class=\"line\">                <span class=\"type\">Statement</span> <span class=\"variable\">s</span> <span class=\"operator\">=</span> connection.createStatement();</span><br><span class=\"line\">                s.executeQuery(<span class=\"string\">&quot;select * from test limit 1&quot;</span>);</span><br><span class=\"line\">                connection.close();</span><br><span class=\"line\">            &#125;<span class=\"keyword\">catch</span>(Exception e) &#123;</span><br><span class=\"line\">            &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                cdl.countDown();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    cdl.await();</span><br><span class=\"line\">    tpe.shutdown();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PC配置：<strong>Intel® Core™ i5-8300H CPU @ 2.30GHz 2.30 GHz 4核8G 512SSD</strong></p>\n<p>10000次查询，耗时：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">938</span> ms</span><br></pre></td></tr></table></figure>\n<p>结束语：再次召唤传送门：<a href=\"https://github.com/ainilili/honeycomb\">https://github.com/ainilili/honeycomb</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"连接池的使命\"><a class=\"header-anchor\" href=\"#连接池的使命\">¶</a>连接池的使命！</h2>\n<p>无论是线程池还是db连接池，他们都有一个共同的特性：<strong>资源复用</strong>，在普通的场景中，我们使用一个连接，它的生命周期可能是这样的：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/24/16ae8d822d4ac11e?w=637&amp;h=168&amp;f=png&amp;s=4758\" alt=\"\"><br>\n一个连接，从创建完毕到销毁，期间只被使用了一次（这里的一次是指在单个作用域内的使用），当周期结束，另外一个调用者仍然需要这个连接去做事，就要重复去经历这种生命周期。因为创建和销毁都是需要对应的服务消耗时间以及系统资源去处理的，这样不仅浪费了大量的系统资源，而且导致业务响应过程中都要花费部分时间去重复的创建和销毁，得不偿失，而连接池便被赋予了解决这种问题的使命！</p>\n<h2 id=\"连接池需要做什么？\"><a class=\"header-anchor\" href=\"#连接池需要做什么？\">¶</a>连接池需要做什么？</h2>\n<p>顾名思义，连接池中的<strong>池</strong>字已经很生动形象的阐明了它的用意，它用将所有连接放入一个<code>&quot;池子&quot;</code>中统一的去控制连接的创建和销毁，和原始生命周期去对比，连接池多了以下特性：</p>\n<ul>\n<li>创建并不是真的创建，而是从池子中选出空闲连接。</li>\n<li>销毁并不是真的销毁，而是将使用中的连接放回池中（逻辑关闭）。</li>\n<li>真正的创建和销毁由线程池的特性机制来决定。</li>\n</ul>\n<p>因此，当使用连接池后，我们使用一个连接的生命周期将会演变成这样：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/24/16ae8fb43b0a3d13?w=588&amp;h=377&amp;f=png&amp;s=13088\" alt=\"\"></p>\n<h2 id=\"分析计划\"><a class=\"header-anchor\" href=\"#分析计划\">¶</a>分析计划</h2>\n<p>通灵之术 - 传送门：<a href=\"https://github.com/ainilili/honeycomb\">https://github.com/ainilili/honeycomb</a>，DEMO为Java语言实现！</p>\n<p>事前，我们需要点支烟分析一下时间一个连接池需要做哪些事情：</p>\n<ul>\n<li>保存连接的容器是必不可少的，另外，该容器也要支持连接的添加和移除功能，并保证线程安全。</li>\n<li>我们需要因为要对连接的销毁做逻辑调整，我们需要重写它的<code>close</code>以及<code>isClosed</code>方法。</li>\n<li>我们需要有个入口对连接池做管理，例如回收空闲连接。</li>\n</ul>\n<p>连接池不仅仅只是对<code>Connection</code>生命周期的控制，还应该加入一些特色，例如初始连接数，最大连接数，最小连接数、最大空闲时长以及获取连接的等待时长，这些我们也简单支持一下。</p>\n<p>目标以明确，开始动工。</p>\n<h3 id=\"连接池容器选型\"><a class=\"header-anchor\" href=\"#连接池容器选型\">¶</a>连接池容器选型</h3>\n<p>要保证线程安全，我们可以将目标瞄准在<code>JUC</code>包下的神通们，设我们想要的容器为<code>x</code>，那么<code>x</code>不仅需要满足基本的增删改查功能，而且也要提供获取超时功能，这是为了保证当池内长时间没有空闲连接时不会导致业务阻塞，即刻熔断。另外，<code>x</code>需要满足双向操作，这是为了连接池可以识别出饱和的空闲连接，方便回收操作。</p>\n<p>综上所述，<code>LinkedBlockingDeque</code>是最合适的选择，它使用<code>InterruptibleReentrantLock</code>来保证线程安全，使用<code>Condition</code>来做获取元素的阻塞，另外支持双向操作。</p>\n<p>另外，我们可以将连接池拆分为3个类型：</p>\n<ul>\n<li><strong>工作池</strong>：存放正在被使用的连接。</li>\n<li><strong>空闲池</strong>：存放空闲连接。</li>\n<li><strong>回收池</strong>：已经被回收（物理关闭）的连接。</li>\n</ul>\n<p>其中，<strong>工作池</strong>和<strong>回收池</strong>大可不必用双向对列，或许用单向队列或者<code>Set</code>都可以代替之：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; workQueue;</span><br><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue;</span><br><span class=\"line\"><span class=\"keyword\">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; freezeQueue;</span><br></pre></td></tr></table></figure>\n<h3 id=\"connection的装饰\"><a class=\"header-anchor\" href=\"#connection的装饰\">¶</a>Connection的装饰</h3>\n<p>连接池的输出是<code>Connection</code>，它代表着一个db连接，上游服务使用它做完操作后，会直接调用它的<code>close</code>方法来释放连接，而我们必须做的是在调用者无感知的情况下改变它的关闭逻辑，当调用<code>close</code>的方法时，我们将它放回空闲队列中，保证其的可复用性！</p>\n<p>因此，我们需要对原来的<code>Connection</code>做装饰，其做法很简单，但是很累，这里新建一个类来实现<code>Connection</code>接口，通过重写所有的方法来实现一个**“可编辑”**的<code>Connection</code>，我们称之为<code>Connection</code>的装饰者：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombConnectionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Connection</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Connection connection;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">HoneycombConnectionDecorator</span><span class=\"params\">(Connection connection)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.connection = connection;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    此处省略对方法实现的三百行代码...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>之后，我们需要新建一个自己的<code>Connection</code>来继承这个装饰者，并重写相应的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombConnection</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HoneycombConnectionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HoneycombConnectionSwitcher</span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">close</span><span class=\"params\">()</span> &#123; <span class=\"keyword\">do</span> some things &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isClosed</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123; <span class=\"keyword\">do</span> some things &#125;    </span><br><span class=\"line\">    </span><br><span class=\"line\">    省略...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"datasource的重写\"><a class=\"header-anchor\" href=\"#datasource的重写\">¶</a>DataSource的重写</h3>\n<p><code>DataSource</code>是JDK为了更好的统合和管理数据源而定义出的一个规范，获取连接的入口，方便我们在这一层更好的扩展数据源（例如增加特殊属性），使我们的连接池的功能更加丰富，我们需要实现一个自己的<code>DataSource</code>能：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombWrapperDatasource</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">DataSource</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> HoneycombDatasourceConfig config;</span><br><span class=\"line\">    省略其它方法的实现...</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> DriverManager.getConnection(config.getUrl(), config.getUser(), config.getPassword());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">(String username, String password)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> DriverManager.getConnection(config.getUrl(), username, password);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    省略其它方法的实现...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们完成了对数据源的实现，但是这里获取连接的方式是物理创建，我们需要满足池化的目的，需要重写<code>HoneycombWrapperDatasource</code>中的连接获取逻辑，做法是创建一个新的类对父类方法重写：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombDataSource</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HoneycombWrapperDatasource</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> HoneycombConnectionPool pool;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">        这里实现从pool中取出连接的逻辑</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    省略...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"特性扩展\"><a class=\"header-anchor\" href=\"#特性扩展\">¶</a>特性扩展</h3>\n<p>在当前结构体系下，我们的连接池逐渐浮现出了雏形，但远远不够的是，我们需要在此结构下可以做自由的扩展，使连接池对连接的控制更加灵活，因此我们可以引入<strong>特性</strong>这个概念，它允许我们在其内部访问连接池，并对连接池做一系列的扩展操作：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>AbstractFeature</code>抽象父类需要实现<code>doing</code>方法，我们可以在方法内部实现对连接池的控制，其中一个典型的例子就是对池中空闲连接左回收：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CleanerFeature</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span> &#123;</span><br><span class=\"line\">        这里做空闲连接的回收</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"落实计划\"><a class=\"header-anchor\" href=\"#落实计划\">¶</a>落实计划</h2>\n<p>经过上述分析，要完成一个连接池，需要这些模块的配合，总体流程如下：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2019/5/26/16af28f6f668a3e6?w=754&amp;h=845&amp;f=png&amp;s=66582\" alt=\"\"></p>\n<h3 id=\"第一步：设置数据源属性\"><a class=\"header-anchor\" href=\"#第一步：设置数据源属性\">¶</a>第一步：设置数据源属性</h3>\n<p>在初始化<code>DataSource</code>之前，我们需要将各属性设置进去，这里使用<code>HoneycombWrapperDatasource</code>中的<code>HoneycombDatasourceConfig</code>来承载各属性：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HoneycombDatasourceConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db url</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String url;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db user</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String user;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//db password</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String password;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//driver驱动</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String driver;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化连接数，默认为2</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">initialPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最大连接数，默认为10</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">maxPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最小连接数，默认为2</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">minPoolSize</span> <span class=\"operator\">=</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//获取连接时，最大等待时长，默认为60s</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">maxWaitTime</span> <span class=\"operator\">=</span> <span class=\"number\">60</span> * <span class=\"number\">1000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//最大空闲时长，超出要被回收，默认为20s</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">maxIdleTime</span> <span class=\"operator\">=</span> <span class=\"number\">20</span> * <span class=\"number\">1000</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//特性列表</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;AbstractFeature&gt; features;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">HoneycombDatasourceConfig</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        features = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;AbstractFeature&gt;(<span class=\"number\">5</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    省略getter、setter....</span><br></pre></td></tr></table></figure>\n<h3 id=\"第二步：初始化连接池\"><a class=\"header-anchor\" href=\"#第二步：初始化连接池\">¶</a>第二步：初始化连接池</h3>\n<p>设置好属性之后，我们需要完成连接池的初始化工作，在<code>HoneycombDataSource</code>的<code>init</code>方法中实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class=\"line\">    <span class=\"comment\">//阻塞其他线程初始化操作，等待初始化完成</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(initialStarted || ! (initialStarted = ! initialStarted)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(! initialFinished) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                INITIAL_LOCK.lock();</span><br><span class=\"line\">                INITIAL_CONDITION.await();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                INITIAL_LOCK.unlock();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//config参数校验</span></span><br><span class=\"line\">    config.assertSelf();</span><br><span class=\"line\">    </span><br><span class=\"line\">    Class.forName(getDriver());</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//实例化线程池</span></span><br><span class=\"line\">    pool = <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombConnectionPool</span>(config);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//初始化最小连接</span></span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; config.getInitialPoolSize(); i ++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            pool.putLeisureConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//触发特性</span></span><br><span class=\"line\">    pool.touchFeatures();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//完成初始化并唤醒其他阻塞</span></span><br><span class=\"line\">    initialFinished = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        INITIAL_LOCK.lock();</span><br><span class=\"line\">        INITIAL_CONDITION.signalAll();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception e) &#123;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        INITIAL_LOCK.unlock();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第三步：创建初始连接\"><a class=\"header-anchor\" href=\"#第三步：创建初始连接\">¶</a>第三步：创建初始连接</h3>\n<p>在<code>init</code>的方法中，如果<code>initialPoolSize</code>大于0，会去创建指定数量的物理连接放入连接池中，创建数量要小于最大连接数<code>maxPoolSize</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> HoneycombConnection <span class=\"title function_\">createNativeConnection</span><span class=\"params\">(HoneycombConnectionPool pool)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombConnection</span>(<span class=\"built_in\">super</span>.getConnection(), pool);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>完成初始化后，下一步就是获取连接。</p>\n<h3 id=\"第四步：从空闲池获取\"><a class=\"header-anchor\" href=\"#第四步：从空闲池获取\">¶</a>第四步：从空闲池获取</h3>\n<p>我们之前将连接池分成了三个，它们分别是<strong>空闲池</strong>、<strong>工作池</strong>和<strong>回收池</strong>。</p>\n<p>我们可以通过<code>HoneycombDataSource</code>的<code>getConnection</code>方法来获取连接，当我们需要获取时，首先考虑的是空闲池是否有空闲连接，这样可以避免创建和激活新的连接：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> Connection <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//初始化连接池</span></span><br><span class=\"line\">        init();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">cn</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"type\">Integer</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(pool.assignable()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//空闲池可分配，从空闲池取出</span></span><br><span class=\"line\">        cn = pool.getIdleConnection();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(pool.actionable()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//回收池可分配，从回收池取出</span></span><br><span class=\"line\">        cn = pool.getFreezeConnection();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果连接数未满，创建新的物理连接</span></span><br><span class=\"line\">        cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cn == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class=\"line\">        cn = pool.getIdleConnection();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cn.isClosedActive()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//如果物理连接关闭，则获取新的连接</span></span><br><span class=\"line\">        cn.setConnection(<span class=\"built_in\">super</span>.getConnection());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cn;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第五步：从回收池获取\"><a class=\"header-anchor\" href=\"#第五步：从回收池获取\">¶</a>第五步：从回收池获取</h3>\n<p>如果空闲池不可分配，那么说明连接供不应求，也许之前有些空闲连接已经被回收（物理关闭），那么我们在创建新连接之前，可以到回收池看一下是否存在已回收连接，如果存在直接取出：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(pool.actionable()) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//回收池可分配，从回收池取出</span></span><br><span class=\"line\">    cn = pool.getFreezeConnection();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第六步：创建新的连接\"><a class=\"header-anchor\" href=\"#第六步：创建新的连接\">¶</a>第六步：创建新的连接</h3>\n<p>如果回收池也不可分配，此时要判断连接池连接数量是否已经达到最大连接，如果没有达到，创建新的物理连接并直接添加到工作池中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>((index =  pool.applyIndex()) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果连接数未满，创建新的物理连接，添加到工作池</span></span><br><span class=\"line\">    cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第七步：等待空闲池的连接\"><a class=\"header-anchor\" href=\"#第七步：等待空闲池的连接\">¶</a>第七步：等待空闲池的连接</h3>\n<p>如果上述三种情况都不满足，那么只能从空闲池等待其他连接的释放：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(cn == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class=\"line\">    cn = pool.getIdleConnection();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>具体逻辑封装在<code>HoneycombConnectionPool</code>的<code>getIdleConnection</code>方法中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> HoneycombConnection <span class=\"title function_\">getIdleConnection</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">//获取最大等待时间</span></span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">waitTime</span> <span class=\"operator\">=</span> config.getMaxWaitTime();</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(waitTime &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">beginPollNanoTime</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//设置超时时间，阻塞等待其他连接的释放</span></span><br><span class=\"line\">            <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">nc</span> <span class=\"operator\">=</span> idleQueue.poll(waitTime, TimeUnit.MILLISECONDS);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(nc != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \t<span class=\"comment\">//状态转换</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(nc.isClosed() &amp;&amp; nc.switchOccupied() &amp;&amp; working(nc)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> nc;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">timeConsuming</span> <span class=\"operator\">=</span> (System.nanoTime() - beginPollNanoTime) / (<span class=\"number\">1000</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//也许在超时时间内获取到了连接，但是状态转换失败，此时刷新超时时间</span></span><br><span class=\"line\">            waitTime -= timeConsuming;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;获取连接超时&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"第八步：激活连接\"><a class=\"header-anchor\" href=\"#第八步：激活连接\">¶</a>第八步：激活连接</h3>\n<p>最后，判断一下连接是否被物理关闭，如果是，我们需要打开新的连接替换已经被回收的连接：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(cn.isClosedActive()) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//如果物理连接关闭，则获取新的连接</span></span><br><span class=\"line\">    cn.setConnection(<span class=\"built_in\">super</span>.getConnection());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"连接的回收\"><a class=\"header-anchor\" href=\"#连接的回收\">¶</a>连接的回收</h3>\n<p>如果在某段时间内我们的业务量剧增，那么需要同时工作的连接将会很多，之后过了不久，我们的业务量下降，那么之前已经创建的连接明显饱和，这时就需要我们对其进行回收，我们可以通过<code>AbstractFeature</code>入口操作连接池。</p>\n<p>对于回收这个操作，我们通过<code>CleanerFeature</code>来实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CleanerFeature</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractFeature</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(CleanerFeature.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">CleanerFeature</span><span class=\"params\">(<span class=\"type\">boolean</span> enable, <span class=\"type\">long</span> interval)</span> &#123;</span><br><span class=\"line\">       <span class=\"comment\">//enable表示是否启用</span></span><br><span class=\"line\">       <span class=\"comment\">//interval表示扫描间隔</span></span><br><span class=\"line\">       <span class=\"built_in\">super</span>(enable, interval);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doing</span><span class=\"params\">(HoneycombConnectionPool pool)</span> &#123;</span><br><span class=\"line\">        LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue = pool.getIdleQueue();</span><br><span class=\"line\">        <span class=\"type\">Thread</span> <span class=\"variable\">t</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//回收扫描间隔</span></span><br><span class=\"line\">                    \tThread.sleep(interval);</span><br><span class=\"line\">                        </span><br><span class=\"line\">                    \t<span class=\"comment\">//回收时，空闲池上锁</span></span><br><span class=\"line\">                        <span class=\"keyword\">synchronized</span> (idleQueue) &#123;</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">&quot;Cleaner Model To Start &#123;&#125;&quot;</span>, idleQueue.size());</span><br><span class=\"line\">                            <span class=\"comment\">//回收操作</span></span><br><span class=\"line\">                            idleQueue.stream().filter(c -&gt; &#123; <span class=\"keyword\">return</span> c.idleTime() &gt; pool.getConfig().getMaxIdleTime(); &#125;).forEach(c -&gt; &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span>(! c.isClosedActive() &amp;&amp; c.idle()) &#123;</span><br><span class=\"line\">                                        c.closeActive();</span><br><span class=\"line\">                                        pool.freeze(c);</span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">                                    e.printStackTrace();</span><br><span class=\"line\">                                &#125; </span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">&quot;Cleaner Model To Finished &#123;&#125;&quot;</span>, idleQueue.size());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;<span class=\"keyword\">catch</span>(Throwable e) &#123;</span><br><span class=\"line\">                        logger.error(<span class=\"string\">&quot;Cleaner happended error&quot;</span>, e);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        t.setDaemon(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        t.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的操作很简单，对空闲池加锁，扫描所有连接，释放空闲时间超过最大空闲时间设置的连接，其实这里只要知道当前连接的空闲时长就一目了然了，我们在连接放入空闲池时候去刷新他的空闲时间点，那么当前的空闲时长就等于当前时间减去空闲开始时间：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idleTime = nowTime - idleStartTime</span><br></pre></td></tr></table></figure>\n<p>在切换状态为空闲时刷新空闲开始时间：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">switchIdle</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> unsafe.compareAndSwapObject(<span class=\"built_in\">this</span>, statusOffset, status, ConnectionStatus.IDLE) &amp;&amp; flushIdleStartTime();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试一下\"><a class=\"header-anchor\" href=\"#测试一下\">¶</a>测试一下</h2>\n<p>体验成果的最快途径就是投入使用，这里搞一个单元测试体验一下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"type\">ThreadPoolExecutor</span> <span class=\"variable\">tpe</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ThreadPoolExecutor</span>(<span class=\"number\">1000</span>, <span class=\"number\">1000</span>, <span class=\"number\">0</span>, TimeUnit.MILLISECONDS, <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testConcurrence</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException, InterruptedException&#123;</span><br><span class=\"line\">    <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">    <span class=\"type\">HoneycombDataSource</span> <span class=\"variable\">dataSource</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HoneycombDataSource</span>();</span><br><span class=\"line\">    dataSource.setUrl(<span class=\"string\">&quot;jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;transformedBitIsBoolean=true&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=Asia/Shanghai&quot;</span>);</span><br><span class=\"line\">    dataSource.setUser(<span class=\"string\">&quot;root&quot;</span>);</span><br><span class=\"line\">    dataSource.setPassword(<span class=\"string\">&quot;root&quot;</span>);</span><br><span class=\"line\">    dataSource.setDriver(<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class=\"line\">    dataSource.setMaxPoolSize(<span class=\"number\">50</span>);</span><br><span class=\"line\">    dataSource.setInitialPoolSize(<span class=\"number\">10</span>);</span><br><span class=\"line\">    dataSource.setMinPoolSize(<span class=\"number\">10</span>);</span><br><span class=\"line\">    dataSource.setMaxWaitTime(<span class=\"number\">60</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">    dataSource.setMaxIdleTime(<span class=\"number\">10</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">    dataSource.addFeature(<span class=\"keyword\">new</span> <span class=\"title class_\">CleanerFeature</span>(<span class=\"literal\">true</span>, <span class=\"number\">5</span> * <span class=\"number\">1000</span>));</span><br><span class=\"line\">    </span><br><span class=\"line\">    test(dataSource, <span class=\"number\">10000</span>);</span><br><span class=\"line\">    System.out.println(System.currentTimeMillis() - start + <span class=\"string\">&quot; ms&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test</span><span class=\"params\">(DataSource dataSource, <span class=\"type\">int</span> count)</span> <span class=\"keyword\">throws</span> SQLException, InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"type\">CountDownLatch</span> <span class=\"variable\">cdl</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CountDownLatch</span>(count);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; count; i ++) &#123;</span><br><span class=\"line\">        tpe.execute(() -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">HoneycombConnection</span> <span class=\"variable\">connection</span> <span class=\"operator\">=</span> (HoneycombConnection) dataSource.getConnection();</span><br><span class=\"line\">                <span class=\"type\">Statement</span> <span class=\"variable\">s</span> <span class=\"operator\">=</span> connection.createStatement();</span><br><span class=\"line\">                s.executeQuery(<span class=\"string\">&quot;select * from test limit 1&quot;</span>);</span><br><span class=\"line\">                connection.close();</span><br><span class=\"line\">            &#125;<span class=\"keyword\">catch</span>(Exception e) &#123;</span><br><span class=\"line\">            &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                cdl.countDown();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    cdl.await();</span><br><span class=\"line\">    tpe.shutdown();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PC配置：<strong>Intel® Core™ i5-8300H CPU @ 2.30GHz 2.30 GHz 4核8G 512SSD</strong></p>\n<p>10000次查询，耗时：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">938</span> ms</span><br></pre></td></tr></table></figure>\n<p>结束语：再次召唤传送门：<a href=\"https://github.com/ainilili/honeycomb\">https://github.com/ainilili/honeycomb</a></p>\n"},{"title":"使Mybatis开发变得更加轻松的增强工具 — Ourbatis","date":"2018-11-06T02:11:36.000Z","_content":"## 一、Mybatis的不足之处\nMybatis是一款优秀的及其灵活的持久层框架，通过XML配置并映射到Mapper接口为Service层提供基础数据操作入口。\n\n这么优秀的框架竟然还有不足之处？ \n\n俗话说人无完人，因为Mybatis实在是太灵活了，灵活到每个Mapper接口都需要定制对应的XML，所以就会引发一些问题。\n\n### 问题一：配置文件繁多\n假如一个系统中DB中涉及100张表，我们就需要写``100``个Mapper接口，还没完，最可怕的是，我们要为这``100``个Mapper接口定制与之对应的``100``套XML。而每个Mapper都必不可少的需要增删改查功能，我们就要写``100``遍增删改查，作为高贵的Java开发工程师，这是不能容忍的，于是``Mybatis Generator``诞生了，然而又会引发另一个问题！\n\n### 问题二：维护困难\n我们使用``Mybatis Generator``解决了问题一，再多的文件生成就是了，简单粗暴，貌似解决了所有的问题，Mybatis完美了！\n\n不要高兴的太早，在系统刚刚建立起来时，我们使用``Mybatis Generator``生成了一堆XML，在开发过程中，产品忽然提了一个新的需求，项目经理根据这个需求在某张表中增加或变动了一个字段，这时，我猜你的操作是这样：\n - 1、找到对应表的XML\n - 2、将该XML中自定义的一段标签复制出来，保存在本地\n - 3、使用``Mybatis Generator``重新生成该表的XML\n - 4、将之覆盖当前的XML\n - 5、将自定义的一段标签再粘贴进新的XML中\n\n在这个过程中，如果我们在第2步时漏复制了一段标签，等整个操作完成之后，又别是一番滋味在心头~\n\n### 问题三：编写XML困难\n假如肝不错，问题二也是小CASE，那么问题又来了，我们如何在繁长的XML中去编写和修改我们的XML呢。\n\n当我们打开要编辑的XML，映入眼帘的就是1000多行的XML，其中900行都是通用的增删改查操作，要新增一个标签，我们需要拉至文件底部编写新的数据操作，要更新一个标签，我们需要通过``Ctrl + F``寻找目标标签再进行修改。\n\n如何避免这些问题呢？\n\n如何让Mybatis增强通用性又不失灵活呢？\n\n## 二、使用Ourbatis辅助Mybatis\nOurbatis是一款Mybatis开发增强工具，小巧简洁，项目地址：\n - Github：[https://github.com/ainilili/ourbatis](https://github.com/ainilili/ourbatis)\n - Gitee：[https://gitee.com/ainilili/ourbatis](https://gitee.com/ainilili/ourbatis)\n - Wiki：[https://github.com/ainilili/ourbatis/wiki](https://github.com/ainilili/ourbatis/wiki)\n - Demo：[https://github.com/ainilili/ourbatis-simple](https://github.com/ainilili/ourbatis-simple)\n \n特性：\n - **1**、简洁方便，可以让Mybatis无XML化开发。\n - **2**、优雅解耦，通用和自定义的SQL标签完全隔离，让维护更加轻松。\n - **3**、无侵入性，Mybatis和Ourbatis可同时使用，配置简洁。\n - **4**、灵活可控，通用模板可自定义及扩展。\n - **5**、部署快捷，只需要一个依赖，两个配置，即可直接运行。\n - **6**、多数据源，在多数据源环境下也可以照常使用。\n\n### 关于Ourbatis使用的一个小Demo\n环境：\n - Spring Boot 2.0.5.RELEASE\n - Ourbatis 1.0.5\n - JAVA 8\n - Mysql\n\n 以``Spring Boot 2.0.5.RELEASE``版本为例，在可以正常使用Mybatis的项目中，``pom.xml``添加如下依赖：\n```\n    <dependency>\n        \t<groupId>com.smallnico</groupId>\n        \t<artifactId>ourbatis-spring-boot-starter</artifactId>\n        \t<version>1.0.5</version>\n\t</dependency>\n```\n在配置文件中增加一下配置：\n```\nourbatis.domain-locations=实体类所在包名\n```\n接下来，Mapper接口只需要继承``SimpleMapper``即可：\n```\nimport org.nico.ourbatis.domain.User;\npublic interface UserMapper extends SimpleMapper<User, Integer>{\n}\n```\n至此，一个使用Ourbatis的简单应用已经部署起来了，之后，你就可以使用一些Ourbatis默认的通用操作方法：\n```\n\tpublic T selectById(K key);\n\t\n\tpublic T selectEntity(T condition);\n\t\n\tpublic List<T> selectList(T condition);\n\t\n\tpublic long selectCount(Object condition);\n\t\n\tpublic List<T> selectPage(Page<Object> page);\n\t\n\tdefault PageResult<T> selectPageResult(Page<Object> page){\n\t\tlong total = selectCount(page.getEntity());\n\t\tList<T> results = null;\n\t\tif(total > 0) {\n\t\t\tresults = selectPage(page);\n\t\t}\n\t\treturn new PageResult<>(total, results);\n\t}\n\t\n\tpublic K selectId(T condition);\n\t\n\tpublic List<K> selectIds(T condition);\n\t\n\tpublic int insert(T entity);\n\t\n\tpublic int insertSelective(T entity);\n\t\n\tpublic int insertBatch(List<T> list);\n\t\n\tpublic int update(T entity);\n\t\n\tpublic int updateSelective(T entity);\n\t\n\tpublic int updateBatch(List<T> list);\n\t\n\tpublic int delete(T condition);\n\t\n\tpublic int deleteById(K key);\n\t\n\tpublic int deleteBatch(List<K> list);\n\t\n```\n### Mapper自定义方法\n在很多场景中，我们使用以上的自带的通用方法远远不能满足我们的需求，我们往往需要额外扩展新的Mapper方法、XML标签，我们使用了Ourbatis之后该如何实现呢？\n\n首先看一下我们的需求，在上述Demo中，我们在UserMapper中增加一个方法``selectNameById``：\n```\nimport org.nico.ourbatis.domain.User;\npublic interface UserMapper extends SimpleMapper<User, Integer>{\n    public String selectNameById(Integer userId);\n}\n```\n和Mybatis一样，需要在``resources``资源目录下新建一个文件夹``ourbatis-mappers``，然后在其中新建一个XML文件，命名规则为：\n```\nDomainClassSimpleName + Mapper.xml\n```\n其中``DomainClassSimpleName``就是我们实体类的类名，这里是为``User``，那么新建的XML名为``UserMapper.xml``。\n```\nsrc/main/resources\n - ourbatis-mappers\n   - UserMapper.xml\n```\n之后，打开``UserMapper.xml``，开始编写Mapper中``selectNameById``方法对应的标签：\n```\n<select id=\"selectNameById\" resultType=\"java.lang.String\">\n    select name from user where id = #{userId}\n</select>\n```\n注意，整个文件中只需要写标签就行了，其他的什么都不需要，这是为什么呢？深入之后你就会明白，这里先不多说！\n\n接下来，就没有接下来了，可以直接使用``selectNameById``方法了。\n### 深入了解Ourbatis\n![ourbatis 流程图](https://user-gold-cdn.xitu.io/2018/10/18/1668605ac4cc678d?w=540&h=816&f=png&s=22436)\n\n当服务启动的时候，Ourbatis首先会扫描``ourbatis.domain-locations``配置包下的所有实体类，将之映射为与之对应的表结构数据：\n![ourbatis Mapping](https://user-gold-cdn.xitu.io/2018/10/18/166865c063369ef6?w=741&h=270&f=png&s=10672)\n\n然后通过``ourbatis.xml``的渲染，生成一个又一个的XML文件，最后将之重新Build到Mybatis容器中！\n\n整个过程分为两个核心点：\n - 1、映射实体类为元数据\n - 2、使用``ourbatis.xml``渲染元数据为XML文件\n\n我会一一介绍之~\n#### 映射实体类为元数据\n在映射时，我们要根据自己数据库字段命名的风格去调整映射规则，就需要在第1个核心点中去做处理，Ourbatis使用包装器来完成：\n```\npublic interface Wrapper<T> {\n\tpublic String wrapping(T value);\n}\n```\n对于需要映射的字段，如**表名**和**表字段名**，它们都将会经过一个包装器链条的处理之后再投入到``ourbatis.xml``中做渲染，这样就使得我们可以自定义包装器出更换映射的字段格式，具体方式可以参考官方Wiki：[Wrapper包装器](https://github.com/ainilili/ourbatis/wiki/Wrapper%E5%8C%85%E8%A3%85%E5%99%A8)\n\n#### 使用``ourbatis.xml``渲染元数据为XML文件\n而在于第2个核心点中，Ourbatis通过自定义标签做模板渲染，我们可以先看一下官方默认的``ourbatis.xml``内部构造：\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"@{mapperClassName}\">\n\t<resultMap id=\"BaseResultMap\" type=\"@{domainClassName}\">\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t<id column=\"@{elem.jdbcName}\" property=\"@{elem.javaName}\" />\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<result column=\"@{elem.jdbcName}\" property=\"@{elem.javaName}\" />\n\t\t</ourbatis:foreach>\n\t</resultMap>\n\n\t<sql id=\"Base_Column_List\">\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t</sql>\n\n\t<select id=\"selectById\" parameterType=\"java.lang.Object\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<select id=\"selectEntity\" parameterType=\"@{domainClassName}\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectCount\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"long\">\n\t\tselect count(0)\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectPage\"\n\t\tparameterType=\"org.nico.ourbatis.entity.Page\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<if test=\"entity != null\">\n\t\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t\t<if test=\"entity.@{elem.javaName} != null\">\n\t\t\t\t\tand `@{elem.jdbcName}` = #{entity.@{elem.javaName}}\n\t\t\t\t</if>\n\t\t\t</ourbatis:foreach>\n\t\t</if>\n\t\t<if test=\"orderBy != null\">\n\t\t\torder by ${orderBy}\n\t\t</if>\n\t\t<if test=\"start != null and end != null\">\n\t\t\tlimit ${start},${end}\n\t\t</if>\n\t</select>\n\n\t<select id=\"selectList\" parameterType=\"@{domainClassName}\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<select id=\"selectId\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"java.lang.Object\">\n\t\tselect\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectIds\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"java.lang.Object\">\n\t\tselect\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<delete id=\"deleteById\" parameterType=\"java.lang.Object\">\n\t\tdelete\n\t\tfrom @{tableName}\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</delete>\n\n\t<insert id=\"insert\" keyProperty=\"@{primaryColumns.0.jdbcName}\"\n\t\tuseGeneratedKeys=\"true\" parameterType=\"@{domainClassName}\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<include refid=\"Base_Column_List\" />\n\t\t)\n\t\tvalues (\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t#{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t\t)\n\t</insert>\n\n\t<insert id=\"insertSelective\"\n\t\tkeyProperty=\"@{primaryColumns.0.jdbcName}\" useGeneratedKeys=\"true\"\n\t\tparameterType=\"@{domainClassName}\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t,`@{elem.jdbcName}`\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\t)\n\t\tvalues (\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t#{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t, #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\t)\n\t</insert>\n\n\t<insert id=\"insertBatch\"\n\t\tkeyProperty=\"@{primaryColumns.0.jdbcName}\" useGeneratedKeys=\"true\"\n\t\tparameterType=\"java.util.List\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<include refid=\"Base_Column_List\" />\n\t\t)\n\t\tvalues\n\t\t<foreach collection=\"list\" index=\"index\" item=\"item\"\n\t\t\tseparator=\",\">\n\t\t\t(\n\t\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t#{item.@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t\t)\n\t\t</foreach>\n\t</insert>\n\n\t<update id=\"update\" parameterType=\"@{domainClassName}\">\n\t\tupdate @{tableName}\n\t\t<set>\n\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t</set>\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</update>\n\n\t<update id=\"updateSelective\" parameterType=\"@{domainClassName}\">\n\t\tupdate @{tableName}\n\t\t<set>\n\t\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t\t,`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t\t</if>\n\t\t\t</ourbatis:foreach>\n\t\t</set>\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</update>\n\n\t<update id=\"updateBatch\" parameterType=\"java.util.List\">\n\t\t<foreach collection=\"list\" index=\"index\" item=\"item\"\n\t\t\tseparator=\";\">\n\t\t\tupdate @{tableName}\n\t\t\t<set>\n\t\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\"\n\t\t\t\t\tsplit=\",\">\n\t\t\t\t\t`@{elem.jdbcName}` = #{item.@{elem.javaName}}\n\t\t\t\t</ourbatis:foreach>\n\t\t\t</set>\n\t\t\twhere 1=1\n\t\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t\tand `@{elem.jdbcName}` = #{item.@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t</foreach>\n\t</update>\n\n\t<delete id=\"deleteBatch\" parameterType=\"java.util.List\">\n\t\tdelete from @{tableName} where @{primaryColumns.0.jdbcName} in\n\t\t<foreach close=\")\" collection=\"list\" index=\"index\" item=\"item\"\n\t\t\topen=\"(\" separator=\",\">\n\t\t\t#{item}\n\t\t</foreach>\n\t</delete>\n\n\t<delete id=\"delete\" parameterType=\"@{domainClassName}\">\n\t\tdelete from @{tableName} where 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</delete>\n\n\t<ourbatis:ref path=\"classpath:ourbatis-mappers/@{domainSimpleClassName}Mapper.xml\" />\n</mapper>\n```\n可以看出来，``ourbatis.xml``内容类似于原生的Mybatis的XML，不同的是，有两个陌生的标签：\n - ourbatis:foreach 对元数据中的列表进行循环渲染\n - ourbatis:ref 引入外界文件内容\n\n这是Ourbatis中独有的标签，Ourbatis也提供着对应的入口让我们去自定义标签：\n```\nClass: org.nico.ourbatis.Ourbatis\nField: \npublic static final Map<String, AssistAdapter> ASSIST_ADAPTERS = new HashMap<String, AssistAdapter>(){\n\t\tprivate static final long serialVersionUID = 1L;\n\t\t{\n\t\t\tput(\"ourbatis:foreach\", new ForeachAdapter());\n\t\t\tput(\"ourbatis:ref\", new RefAdapter());\n\t\t}\n\t};\n```\n我们可以修改``org.nico.ourbatis.Ourbatis``类中的静态参数``ASSIST_ADAPTERS``去删除、更新和添加自定义标签，需要实现一个标签适配器，我们可以看一下最简单的``RefAdapter``适配器的实现：\n```\npublic class RefAdapter extends AssistAdapter{\n\t@Override\n\tpublic String adapter(Map<String, Object> datas, NoelRender render, Document document) {\n\t\tString path = render.rending(datas, document.getParameter(\"path\"), \"domainSimpleClassName\");\n\t\tString result =  StreamUtils.convertToString(path.replaceAll(\"classpath:\", \"\"));\n\t\treturn result == null ? \"\" : result.trim();\n\t}\n}\n```\nOurbatis中只定义了上述两个自定义标签已足够满足需求，通过``foreach``标签，将元数据中的集合遍历渲染，通过``ref``标签引入外界资源，也就是我们之前所说的对Mapper接口中方法的扩展！\n```\n<ourbatis:ref path=\"classpath:ourbatis-mappers/@{domainSimpleClassName}Mapper.xml\" />\n```\n其中的path就是当前项目classpath路径的相对路径，而``@{domainSimpleClassName}``就代表着实体类的类名，更多的系统参数可以参考Wiki：[元数据映射](https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84)\n\n通过这种模板渲染的机制，Ourbatis是相当灵活的，我们不仅可以通过引入外部文件进行扩展，当我们需要添加或修改通用方法时，我们可以可以自定义``ourbatis.xml``的内容，如何做到呢？复制一份将之放在资源目录下就可以了！\n\n看到这里，相信大家已经知道Ourbatis的基本原理已经使用方式，我就再次不多说了，更多细节可以去官方Wiki中阅读：[Ourbatis Wiki](https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84)","source":"_posts/测试，hexo.md","raw":"title: 使Mybatis开发变得更加轻松的增强工具 — Ourbatis\ndate: 2018-11-06 10:11:36\ntags:\n---\n## 一、Mybatis的不足之处\nMybatis是一款优秀的及其灵活的持久层框架，通过XML配置并映射到Mapper接口为Service层提供基础数据操作入口。\n\n这么优秀的框架竟然还有不足之处？ \n\n俗话说人无完人，因为Mybatis实在是太灵活了，灵活到每个Mapper接口都需要定制对应的XML，所以就会引发一些问题。\n\n### 问题一：配置文件繁多\n假如一个系统中DB中涉及100张表，我们就需要写``100``个Mapper接口，还没完，最可怕的是，我们要为这``100``个Mapper接口定制与之对应的``100``套XML。而每个Mapper都必不可少的需要增删改查功能，我们就要写``100``遍增删改查，作为高贵的Java开发工程师，这是不能容忍的，于是``Mybatis Generator``诞生了，然而又会引发另一个问题！\n\n### 问题二：维护困难\n我们使用``Mybatis Generator``解决了问题一，再多的文件生成就是了，简单粗暴，貌似解决了所有的问题，Mybatis完美了！\n\n不要高兴的太早，在系统刚刚建立起来时，我们使用``Mybatis Generator``生成了一堆XML，在开发过程中，产品忽然提了一个新的需求，项目经理根据这个需求在某张表中增加或变动了一个字段，这时，我猜你的操作是这样：\n - 1、找到对应表的XML\n - 2、将该XML中自定义的一段标签复制出来，保存在本地\n - 3、使用``Mybatis Generator``重新生成该表的XML\n - 4、将之覆盖当前的XML\n - 5、将自定义的一段标签再粘贴进新的XML中\n\n在这个过程中，如果我们在第2步时漏复制了一段标签，等整个操作完成之后，又别是一番滋味在心头~\n\n### 问题三：编写XML困难\n假如肝不错，问题二也是小CASE，那么问题又来了，我们如何在繁长的XML中去编写和修改我们的XML呢。\n\n当我们打开要编辑的XML，映入眼帘的就是1000多行的XML，其中900行都是通用的增删改查操作，要新增一个标签，我们需要拉至文件底部编写新的数据操作，要更新一个标签，我们需要通过``Ctrl + F``寻找目标标签再进行修改。\n\n如何避免这些问题呢？\n\n如何让Mybatis增强通用性又不失灵活呢？\n\n## 二、使用Ourbatis辅助Mybatis\nOurbatis是一款Mybatis开发增强工具，小巧简洁，项目地址：\n - Github：[https://github.com/ainilili/ourbatis](https://github.com/ainilili/ourbatis)\n - Gitee：[https://gitee.com/ainilili/ourbatis](https://gitee.com/ainilili/ourbatis)\n - Wiki：[https://github.com/ainilili/ourbatis/wiki](https://github.com/ainilili/ourbatis/wiki)\n - Demo：[https://github.com/ainilili/ourbatis-simple](https://github.com/ainilili/ourbatis-simple)\n \n特性：\n - **1**、简洁方便，可以让Mybatis无XML化开发。\n - **2**、优雅解耦，通用和自定义的SQL标签完全隔离，让维护更加轻松。\n - **3**、无侵入性，Mybatis和Ourbatis可同时使用，配置简洁。\n - **4**、灵活可控，通用模板可自定义及扩展。\n - **5**、部署快捷，只需要一个依赖，两个配置，即可直接运行。\n - **6**、多数据源，在多数据源环境下也可以照常使用。\n\n### 关于Ourbatis使用的一个小Demo\n环境：\n - Spring Boot 2.0.5.RELEASE\n - Ourbatis 1.0.5\n - JAVA 8\n - Mysql\n\n 以``Spring Boot 2.0.5.RELEASE``版本为例，在可以正常使用Mybatis的项目中，``pom.xml``添加如下依赖：\n```\n    <dependency>\n        \t<groupId>com.smallnico</groupId>\n        \t<artifactId>ourbatis-spring-boot-starter</artifactId>\n        \t<version>1.0.5</version>\n\t</dependency>\n```\n在配置文件中增加一下配置：\n```\nourbatis.domain-locations=实体类所在包名\n```\n接下来，Mapper接口只需要继承``SimpleMapper``即可：\n```\nimport org.nico.ourbatis.domain.User;\npublic interface UserMapper extends SimpleMapper<User, Integer>{\n}\n```\n至此，一个使用Ourbatis的简单应用已经部署起来了，之后，你就可以使用一些Ourbatis默认的通用操作方法：\n```\n\tpublic T selectById(K key);\n\t\n\tpublic T selectEntity(T condition);\n\t\n\tpublic List<T> selectList(T condition);\n\t\n\tpublic long selectCount(Object condition);\n\t\n\tpublic List<T> selectPage(Page<Object> page);\n\t\n\tdefault PageResult<T> selectPageResult(Page<Object> page){\n\t\tlong total = selectCount(page.getEntity());\n\t\tList<T> results = null;\n\t\tif(total > 0) {\n\t\t\tresults = selectPage(page);\n\t\t}\n\t\treturn new PageResult<>(total, results);\n\t}\n\t\n\tpublic K selectId(T condition);\n\t\n\tpublic List<K> selectIds(T condition);\n\t\n\tpublic int insert(T entity);\n\t\n\tpublic int insertSelective(T entity);\n\t\n\tpublic int insertBatch(List<T> list);\n\t\n\tpublic int update(T entity);\n\t\n\tpublic int updateSelective(T entity);\n\t\n\tpublic int updateBatch(List<T> list);\n\t\n\tpublic int delete(T condition);\n\t\n\tpublic int deleteById(K key);\n\t\n\tpublic int deleteBatch(List<K> list);\n\t\n```\n### Mapper自定义方法\n在很多场景中，我们使用以上的自带的通用方法远远不能满足我们的需求，我们往往需要额外扩展新的Mapper方法、XML标签，我们使用了Ourbatis之后该如何实现呢？\n\n首先看一下我们的需求，在上述Demo中，我们在UserMapper中增加一个方法``selectNameById``：\n```\nimport org.nico.ourbatis.domain.User;\npublic interface UserMapper extends SimpleMapper<User, Integer>{\n    public String selectNameById(Integer userId);\n}\n```\n和Mybatis一样，需要在``resources``资源目录下新建一个文件夹``ourbatis-mappers``，然后在其中新建一个XML文件，命名规则为：\n```\nDomainClassSimpleName + Mapper.xml\n```\n其中``DomainClassSimpleName``就是我们实体类的类名，这里是为``User``，那么新建的XML名为``UserMapper.xml``。\n```\nsrc/main/resources\n - ourbatis-mappers\n   - UserMapper.xml\n```\n之后，打开``UserMapper.xml``，开始编写Mapper中``selectNameById``方法对应的标签：\n```\n<select id=\"selectNameById\" resultType=\"java.lang.String\">\n    select name from user where id = #{userId}\n</select>\n```\n注意，整个文件中只需要写标签就行了，其他的什么都不需要，这是为什么呢？深入之后你就会明白，这里先不多说！\n\n接下来，就没有接下来了，可以直接使用``selectNameById``方法了。\n### 深入了解Ourbatis\n![ourbatis 流程图](https://user-gold-cdn.xitu.io/2018/10/18/1668605ac4cc678d?w=540&h=816&f=png&s=22436)\n\n当服务启动的时候，Ourbatis首先会扫描``ourbatis.domain-locations``配置包下的所有实体类，将之映射为与之对应的表结构数据：\n![ourbatis Mapping](https://user-gold-cdn.xitu.io/2018/10/18/166865c063369ef6?w=741&h=270&f=png&s=10672)\n\n然后通过``ourbatis.xml``的渲染，生成一个又一个的XML文件，最后将之重新Build到Mybatis容器中！\n\n整个过程分为两个核心点：\n - 1、映射实体类为元数据\n - 2、使用``ourbatis.xml``渲染元数据为XML文件\n\n我会一一介绍之~\n#### 映射实体类为元数据\n在映射时，我们要根据自己数据库字段命名的风格去调整映射规则，就需要在第1个核心点中去做处理，Ourbatis使用包装器来完成：\n```\npublic interface Wrapper<T> {\n\tpublic String wrapping(T value);\n}\n```\n对于需要映射的字段，如**表名**和**表字段名**，它们都将会经过一个包装器链条的处理之后再投入到``ourbatis.xml``中做渲染，这样就使得我们可以自定义包装器出更换映射的字段格式，具体方式可以参考官方Wiki：[Wrapper包装器](https://github.com/ainilili/ourbatis/wiki/Wrapper%E5%8C%85%E8%A3%85%E5%99%A8)\n\n#### 使用``ourbatis.xml``渲染元数据为XML文件\n而在于第2个核心点中，Ourbatis通过自定义标签做模板渲染，我们可以先看一下官方默认的``ourbatis.xml``内部构造：\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"@{mapperClassName}\">\n\t<resultMap id=\"BaseResultMap\" type=\"@{domainClassName}\">\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t<id column=\"@{elem.jdbcName}\" property=\"@{elem.javaName}\" />\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<result column=\"@{elem.jdbcName}\" property=\"@{elem.javaName}\" />\n\t\t</ourbatis:foreach>\n\t</resultMap>\n\n\t<sql id=\"Base_Column_List\">\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t</sql>\n\n\t<select id=\"selectById\" parameterType=\"java.lang.Object\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<select id=\"selectEntity\" parameterType=\"@{domainClassName}\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectCount\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"long\">\n\t\tselect count(0)\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectPage\"\n\t\tparameterType=\"org.nico.ourbatis.entity.Page\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<if test=\"entity != null\">\n\t\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t\t<if test=\"entity.@{elem.javaName} != null\">\n\t\t\t\t\tand `@{elem.jdbcName}` = #{entity.@{elem.javaName}}\n\t\t\t\t</if>\n\t\t\t</ourbatis:foreach>\n\t\t</if>\n\t\t<if test=\"orderBy != null\">\n\t\t\torder by ${orderBy}\n\t\t</if>\n\t\t<if test=\"start != null and end != null\">\n\t\t\tlimit ${start},${end}\n\t\t</if>\n\t</select>\n\n\t<select id=\"selectList\" parameterType=\"@{domainClassName}\"\n\t\tresultMap=\"BaseResultMap\">\n\t\tselect\n\t\t<include refid=\"Base_Column_List\" />\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<select id=\"selectId\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"java.lang.Object\">\n\t\tselect\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\tlimit 1\n\t</select>\n\n\t<select id=\"selectIds\" parameterType=\"@{domainClassName}\"\n\t\tresultType=\"java.lang.Object\">\n\t\tselect\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\tfrom @{tableName}\n\t\twhere 1 = 1\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</select>\n\n\t<delete id=\"deleteById\" parameterType=\"java.lang.Object\">\n\t\tdelete\n\t\tfrom @{tableName}\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</delete>\n\n\t<insert id=\"insert\" keyProperty=\"@{primaryColumns.0.jdbcName}\"\n\t\tuseGeneratedKeys=\"true\" parameterType=\"@{domainClassName}\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<include refid=\"Base_Column_List\" />\n\t\t)\n\t\tvalues (\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t#{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t\t)\n\t</insert>\n\n\t<insert id=\"insertSelective\"\n\t\tkeyProperty=\"@{primaryColumns.0.jdbcName}\" useGeneratedKeys=\"true\"\n\t\tparameterType=\"@{domainClassName}\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\tsplit=\",\">\n\t\t\t`@{elem.jdbcName}`\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t,`@{elem.jdbcName}`\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\t)\n\t\tvalues (\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t#{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t, #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t\t)\n\t</insert>\n\n\t<insert id=\"insertBatch\"\n\t\tkeyProperty=\"@{primaryColumns.0.jdbcName}\" useGeneratedKeys=\"true\"\n\t\tparameterType=\"java.util.List\">\n\t\tinsert into @{tableName}\n\t\t(\n\t\t<include refid=\"Base_Column_List\" />\n\t\t)\n\t\tvalues\n\t\t<foreach collection=\"list\" index=\"index\" item=\"item\"\n\t\t\tseparator=\",\">\n\t\t\t(\n\t\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t#{item.@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t\t)\n\t\t</foreach>\n\t</insert>\n\n\t<update id=\"update\" parameterType=\"@{domainClassName}\">\n\t\tupdate @{tableName}\n\t\t<set>\n\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t</set>\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</update>\n\n\t<update id=\"updateSelective\" parameterType=\"@{domainClassName}\">\n\t\tupdate @{tableName}\n\t\t<set>\n\t\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\"\n\t\t\t\tsplit=\",\">\n\t\t\t\t`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\">\n\t\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\t\t,`@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t\t</if>\n\t\t\t</ourbatis:foreach>\n\t\t</set>\n\t\twhere 1=1\n\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t</ourbatis:foreach>\n\t</update>\n\n\t<update id=\"updateBatch\" parameterType=\"java.util.List\">\n\t\t<foreach collection=\"list\" index=\"index\" item=\"item\"\n\t\t\tseparator=\";\">\n\t\t\tupdate @{tableName}\n\t\t\t<set>\n\t\t\t\t<ourbatis:foreach list=\"normalColumns\" var=\"elem\"\n\t\t\t\t\tsplit=\",\">\n\t\t\t\t\t`@{elem.jdbcName}` = #{item.@{elem.javaName}}\n\t\t\t\t</ourbatis:foreach>\n\t\t\t</set>\n\t\t\twhere 1=1\n\t\t\t<ourbatis:foreach list=\"primaryColumns\" var=\"elem\">\n\t\t\t\tand `@{elem.jdbcName}` = #{item.@{elem.javaName}}\n\t\t\t</ourbatis:foreach>\n\t\t</foreach>\n\t</update>\n\n\t<delete id=\"deleteBatch\" parameterType=\"java.util.List\">\n\t\tdelete from @{tableName} where @{primaryColumns.0.jdbcName} in\n\t\t<foreach close=\")\" collection=\"list\" index=\"index\" item=\"item\"\n\t\t\topen=\"(\" separator=\",\">\n\t\t\t#{item}\n\t\t</foreach>\n\t</delete>\n\n\t<delete id=\"delete\" parameterType=\"@{domainClassName}\">\n\t\tdelete from @{tableName} where 1 = 1\n\t\t<ourbatis:foreach list=\"allColumns\" var=\"elem\">\n\t\t\t<if test=\"@{elem.javaName} != null\">\n\t\t\t\tand `@{elem.jdbcName}` = #{@{elem.javaName}}\n\t\t\t</if>\n\t\t</ourbatis:foreach>\n\t</delete>\n\n\t<ourbatis:ref path=\"classpath:ourbatis-mappers/@{domainSimpleClassName}Mapper.xml\" />\n</mapper>\n```\n可以看出来，``ourbatis.xml``内容类似于原生的Mybatis的XML，不同的是，有两个陌生的标签：\n - ourbatis:foreach 对元数据中的列表进行循环渲染\n - ourbatis:ref 引入外界文件内容\n\n这是Ourbatis中独有的标签，Ourbatis也提供着对应的入口让我们去自定义标签：\n```\nClass: org.nico.ourbatis.Ourbatis\nField: \npublic static final Map<String, AssistAdapter> ASSIST_ADAPTERS = new HashMap<String, AssistAdapter>(){\n\t\tprivate static final long serialVersionUID = 1L;\n\t\t{\n\t\t\tput(\"ourbatis:foreach\", new ForeachAdapter());\n\t\t\tput(\"ourbatis:ref\", new RefAdapter());\n\t\t}\n\t};\n```\n我们可以修改``org.nico.ourbatis.Ourbatis``类中的静态参数``ASSIST_ADAPTERS``去删除、更新和添加自定义标签，需要实现一个标签适配器，我们可以看一下最简单的``RefAdapter``适配器的实现：\n```\npublic class RefAdapter extends AssistAdapter{\n\t@Override\n\tpublic String adapter(Map<String, Object> datas, NoelRender render, Document document) {\n\t\tString path = render.rending(datas, document.getParameter(\"path\"), \"domainSimpleClassName\");\n\t\tString result =  StreamUtils.convertToString(path.replaceAll(\"classpath:\", \"\"));\n\t\treturn result == null ? \"\" : result.trim();\n\t}\n}\n```\nOurbatis中只定义了上述两个自定义标签已足够满足需求，通过``foreach``标签，将元数据中的集合遍历渲染，通过``ref``标签引入外界资源，也就是我们之前所说的对Mapper接口中方法的扩展！\n```\n<ourbatis:ref path=\"classpath:ourbatis-mappers/@{domainSimpleClassName}Mapper.xml\" />\n```\n其中的path就是当前项目classpath路径的相对路径，而``@{domainSimpleClassName}``就代表着实体类的类名，更多的系统参数可以参考Wiki：[元数据映射](https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84)\n\n通过这种模板渲染的机制，Ourbatis是相当灵活的，我们不仅可以通过引入外部文件进行扩展，当我们需要添加或修改通用方法时，我们可以可以自定义``ourbatis.xml``的内容，如何做到呢？复制一份将之放在资源目录下就可以了！\n\n看到这里，相信大家已经知道Ourbatis的基本原理已经使用方式，我就再次不多说了，更多细节可以去官方Wiki中阅读：[Ourbatis Wiki](https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84)","slug":"测试，hexo","published":1,"updated":"2021-03-21T17:43:04.893Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyf0010b0tz7jwr0tyl","content":"<h2 id=\"一-mybatis的不足之处\"><a class=\"header-anchor\" href=\"#一-mybatis的不足之处\">¶</a>一、Mybatis的不足之处</h2>\n<p>Mybatis是一款优秀的及其灵活的持久层框架，通过XML配置并映射到Mapper接口为Service层提供基础数据操作入口。</p>\n<p>这么优秀的框架竟然还有不足之处？</p>\n<p>俗话说人无完人，因为Mybatis实在是太灵活了，灵活到每个Mapper接口都需要定制对应的XML，所以就会引发一些问题。</p>\n<h3 id=\"问题一：配置文件繁多\"><a class=\"header-anchor\" href=\"#问题一：配置文件繁多\">¶</a>问题一：配置文件繁多</h3>\n<p>假如一个系统中DB中涉及100张表，我们就需要写<code>100</code>个Mapper接口，还没完，最可怕的是，我们要为这<code>100</code>个Mapper接口定制与之对应的<code>100</code>套XML。而每个Mapper都必不可少的需要增删改查功能，我们就要写<code>100</code>遍增删改查，作为高贵的Java开发工程师，这是不能容忍的，于是<code>Mybatis Generator</code>诞生了，然而又会引发另一个问题！</p>\n<h3 id=\"问题二：维护困难\"><a class=\"header-anchor\" href=\"#问题二：维护困难\">¶</a>问题二：维护困难</h3>\n<p>我们使用<code>Mybatis Generator</code>解决了问题一，再多的文件生成就是了，简单粗暴，貌似解决了所有的问题，Mybatis完美了！</p>\n<p>不要高兴的太早，在系统刚刚建立起来时，我们使用<code>Mybatis Generator</code>生成了一堆XML，在开发过程中，产品忽然提了一个新的需求，项目经理根据这个需求在某张表中增加或变动了一个字段，这时，我猜你的操作是这样：</p>\n<ul>\n<li>1、找到对应表的XML</li>\n<li>2、将该XML中自定义的一段标签复制出来，保存在本地</li>\n<li>3、使用<code>Mybatis Generator</code>重新生成该表的XML</li>\n<li>4、将之覆盖当前的XML</li>\n<li>5、将自定义的一段标签再粘贴进新的XML中</li>\n</ul>\n<p>在这个过程中，如果我们在第2步时漏复制了一段标签，等整个操作完成之后，又别是一番滋味在心头~</p>\n<h3 id=\"问题三：编写xml困难\"><a class=\"header-anchor\" href=\"#问题三：编写xml困难\">¶</a>问题三：编写XML困难</h3>\n<p>假如肝不错，问题二也是小CASE，那么问题又来了，我们如何在繁长的XML中去编写和修改我们的XML呢。</p>\n<p>当我们打开要编辑的XML，映入眼帘的就是1000多行的XML，其中900行都是通用的增删改查操作，要新增一个标签，我们需要拉至文件底部编写新的数据操作，要更新一个标签，我们需要通过<code>Ctrl + F</code>寻找目标标签再进行修改。</p>\n<p>如何避免这些问题呢？</p>\n<p>如何让Mybatis增强通用性又不失灵活呢？</p>\n<h2 id=\"二-使用ourbatis辅助mybatis\"><a class=\"header-anchor\" href=\"#二-使用ourbatis辅助mybatis\">¶</a>二、使用Ourbatis辅助Mybatis</h2>\n<p>Ourbatis是一款Mybatis开发增强工具，小巧简洁，项目地址：</p>\n<ul>\n<li>Github：<a href=\"https://github.com/ainilili/ourbatis\">https://github.com/ainilili/ourbatis</a></li>\n<li>Gitee：<a href=\"https://gitee.com/ainilili/ourbatis\">https://gitee.com/ainilili/ourbatis</a></li>\n<li>Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki\">https://github.com/ainilili/ourbatis/wiki</a></li>\n<li>Demo：<a href=\"https://github.com/ainilili/ourbatis-simple\">https://github.com/ainilili/ourbatis-simple</a></li>\n</ul>\n<p>特性：</p>\n<ul>\n<li><strong>1</strong>、简洁方便，可以让Mybatis无XML化开发。</li>\n<li><strong>2</strong>、优雅解耦，通用和自定义的SQL标签完全隔离，让维护更加轻松。</li>\n<li><strong>3</strong>、无侵入性，Mybatis和Ourbatis可同时使用，配置简洁。</li>\n<li><strong>4</strong>、灵活可控，通用模板可自定义及扩展。</li>\n<li><strong>5</strong>、部署快捷，只需要一个依赖，两个配置，即可直接运行。</li>\n<li><strong>6</strong>、多数据源，在多数据源环境下也可以照常使用。</li>\n</ul>\n<h3 id=\"关于ourbatis使用的一个小demo\"><a class=\"header-anchor\" href=\"#关于ourbatis使用的一个小demo\">¶</a>关于Ourbatis使用的一个小Demo</h3>\n<p>环境：</p>\n<ul>\n<li>Spring Boot 2.0.5.RELEASE</li>\n<li>Ourbatis 1.0.5</li>\n<li>JAVA 8</li>\n<li>Mysql</li>\n</ul>\n<p>以<code>Spring Boot 2.0.5.RELEASE</code>版本为例，在可以正常使用Mybatis的项目中，<code>pom.xml</code>添加如下依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">       \t&lt;groupId&gt;com.smallnico&lt;/groupId&gt;</span><br><span class=\"line\">       \t&lt;artifactId&gt;ourbatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class=\"line\">       \t&lt;version&gt;1.0.5&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>在配置文件中增加一下配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ourbatis.domain-locations=实体类所在包名</span><br></pre></td></tr></table></figure>\n<p>接下来，Mapper接口只需要继承<code>SimpleMapper</code>即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.nico.ourbatis.domain.User;</span><br><span class=\"line\">public interface UserMapper extends SimpleMapper&lt;User, Integer&gt;&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，一个使用Ourbatis的简单应用已经部署起来了，之后，你就可以使用一些Ourbatis默认的通用操作方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public T selectById(K key);</span><br><span class=\"line\"></span><br><span class=\"line\">public T selectEntity(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;T&gt; selectList(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public long selectCount(Object condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;T&gt; selectPage(Page&lt;Object&gt; page);</span><br><span class=\"line\"></span><br><span class=\"line\">default PageResult&lt;T&gt; selectPageResult(Page&lt;Object&gt; page)&#123;</span><br><span class=\"line\">\tlong total = selectCount(page.getEntity());</span><br><span class=\"line\">\tList&lt;T&gt; results = null;</span><br><span class=\"line\">\tif(total &gt; 0) &#123;</span><br><span class=\"line\">\t\tresults = selectPage(page);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn new PageResult&lt;&gt;(total, results);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public K selectId(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;K&gt; selectIds(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insert(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insertSelective(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insertBatch(List&lt;T&gt; list);</span><br><span class=\"line\"></span><br><span class=\"line\">public int update(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int updateSelective(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int updateBatch(List&lt;T&gt; list);</span><br><span class=\"line\"></span><br><span class=\"line\">public int delete(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public int deleteById(K key);</span><br><span class=\"line\"></span><br><span class=\"line\">public int deleteBatch(List&lt;K&gt; list);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"mapper自定义方法\"><a class=\"header-anchor\" href=\"#mapper自定义方法\">¶</a>Mapper自定义方法</h3>\n<p>在很多场景中，我们使用以上的自带的通用方法远远不能满足我们的需求，我们往往需要额外扩展新的Mapper方法、XML标签，我们使用了Ourbatis之后该如何实现呢？</p>\n<p>首先看一下我们的需求，在上述Demo中，我们在UserMapper中增加一个方法<code>selectNameById</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.nico.ourbatis.domain.User;</span><br><span class=\"line\">public interface UserMapper extends SimpleMapper&lt;User, Integer&gt;&#123;</span><br><span class=\"line\">    public String selectNameById(Integer userId);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>和Mybatis一样，需要在<code>resources</code>资源目录下新建一个文件夹<code>ourbatis-mappers</code>，然后在其中新建一个XML文件，命名规则为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DomainClassSimpleName + Mapper.xml</span><br></pre></td></tr></table></figure>\n<p>其中<code>DomainClassSimpleName</code>就是我们实体类的类名，这里是为<code>User</code>，那么新建的XML名为<code>UserMapper.xml</code>。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src/main/resources</span><br><span class=\"line\"> - ourbatis-mappers</span><br><span class=\"line\">   - UserMapper.xml</span><br></pre></td></tr></table></figure>\n<p>之后，打开<code>UserMapper.xml</code>，开始编写Mapper中<code>selectNameById</code>方法对应的标签：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;select id=&quot;selectNameById&quot; resultType=&quot;java.lang.String&quot;&gt;</span><br><span class=\"line\">    select name from user where id = #&#123;userId&#125;</span><br><span class=\"line\">&lt;/select&gt;</span><br></pre></td></tr></table></figure>\n<p>注意，整个文件中只需要写标签就行了，其他的什么都不需要，这是为什么呢？深入之后你就会明白，这里先不多说！</p>\n<p>接下来，就没有接下来了，可以直接使用<code>selectNameById</code>方法了。</p>\n<h3 id=\"深入了解ourbatis\"><a class=\"header-anchor\" href=\"#深入了解ourbatis\">¶</a>深入了解Ourbatis</h3>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/10/18/1668605ac4cc678d?w=540&amp;h=816&amp;f=png&amp;s=22436\" alt=\"ourbatis 流程图\"></p>\n<p>当服务启动的时候，Ourbatis首先会扫描<code>ourbatis.domain-locations</code>配置包下的所有实体类，将之映射为与之对应的表结构数据：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/10/18/166865c063369ef6?w=741&amp;h=270&amp;f=png&amp;s=10672\" alt=\"ourbatis Mapping\"></p>\n<p>然后通过<code>ourbatis.xml</code>的渲染，生成一个又一个的XML文件，最后将之重新Build到Mybatis容器中！</p>\n<p>整个过程分为两个核心点：</p>\n<ul>\n<li>1、映射实体类为元数据</li>\n<li>2、使用<code>ourbatis.xml</code>渲染元数据为XML文件</li>\n</ul>\n<p>我会一一介绍之~</p>\n<h4 id=\"映射实体类为元数据\"><a class=\"header-anchor\" href=\"#映射实体类为元数据\">¶</a>映射实体类为元数据</h4>\n<p>在映射时，我们要根据自己数据库字段命名的风格去调整映射规则，就需要在第1个核心点中去做处理，Ourbatis使用包装器来完成：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface Wrapper&lt;T&gt; &#123;</span><br><span class=\"line\">\tpublic String wrapping(T value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于需要映射的字段，如<strong>表名</strong>和<strong>表字段名</strong>，它们都将会经过一个包装器链条的处理之后再投入到<code>ourbatis.xml</code>中做渲染，这样就使得我们可以自定义包装器出更换映射的字段格式，具体方式可以参考官方Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki/Wrapper%E5%8C%85%E8%A3%85%E5%99%A8\">Wrapper包装器</a></p>\n<h4 id=\"使用ourbatis-xml渲染元数据为xml文件\"><a class=\"header-anchor\" href=\"#使用ourbatis-xml渲染元数据为xml文件\">¶</a>使用<code>ourbatis.xml</code>渲染元数据为XML文件</h4>\n<p>而在于第2个核心点中，Ourbatis通过自定义标签做模板渲染，我们可以先看一下官方默认的<code>ourbatis.xml</code>内部构造：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class=\"line\">&lt;mapper namespace=&quot;@&#123;mapperClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t&lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;id column=&quot;@&#123;elem.jdbcName&#125;&quot; property=&quot;@&#123;elem.javaName&#125;&quot; /&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;result column=&quot;@&#123;elem.jdbcName&#125;&quot; property=&quot;@&#123;elem.javaName&#125;&quot; /&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/resultMap&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;sql id=&quot;Base_Column_List&quot;&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/sql&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectById&quot; parameterType=&quot;java.lang.Object&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectEntity&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectCount&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;long&quot;&gt;</span><br><span class=\"line\">\t\tselect count(0)</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectPage&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;org.nico.ourbatis.entity.Page&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;if test=&quot;entity != null&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;if test=&quot;entity.@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;entity.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;if test=&quot;orderBy != null&quot;&gt;</span><br><span class=\"line\">\t\t\torder by $&#123;orderBy&#125;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;if test=&quot;start != null and end != null&quot;&gt;</span><br><span class=\"line\">\t\t\tlimit $&#123;start&#125;,$&#123;end&#125;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectList&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectId&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectIds&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;deleteById&quot; parameterType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tdelete</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insert&quot; keyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot;</span><br><span class=\"line\">\t\tuseGeneratedKeys=&quot;true&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues (</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insertSelective&quot;</span><br><span class=\"line\">\t\tkeyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot; useGeneratedKeys=&quot;true&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t,`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues (</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t, #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insertBatch&quot;</span><br><span class=\"line\">\t\tkeyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot; useGeneratedKeys=&quot;true&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues</span><br><span class=\"line\">\t\t&lt;foreach collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\tseparator=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t(</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t#&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t)</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;update&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;updateSelective&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\t,`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;updateBatch&quot; parameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\t&lt;foreach collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\tseparator=&quot;;&quot;&gt;</span><br><span class=\"line\">\t\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\t\twhere 1=1</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;deleteBatch&quot; parameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\tdelete from @&#123;tableName&#125; where @&#123;primaryColumns.0.jdbcName&#125; in</span><br><span class=\"line\">\t\t&lt;foreach close=&quot;)&quot; collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\topen=&quot;(&quot; separator=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;item&#125;</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;delete&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tdelete from @&#123;tableName&#125; where 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;ourbatis:ref path=&quot;classpath:ourbatis-mappers/@&#123;domainSimpleClassName&#125;Mapper.xml&quot; /&gt;</span><br><span class=\"line\">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>\n<p>可以看出来，<code>ourbatis.xml</code>内容类似于原生的Mybatis的XML，不同的是，有两个陌生的标签：</p>\n<ul>\n<li>ourbatis:foreach 对元数据中的列表进行循环渲染</li>\n<li>ourbatis:ref 引入外界文件内容</li>\n</ul>\n<p>这是Ourbatis中独有的标签，Ourbatis也提供着对应的入口让我们去自定义标签：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class: org.nico.ourbatis.Ourbatis</span><br><span class=\"line\">Field: </span><br><span class=\"line\">public static final Map&lt;String, AssistAdapter&gt; ASSIST_ADAPTERS = new HashMap&lt;String, AssistAdapter&gt;()&#123;</span><br><span class=\"line\">\t\tprivate static final long serialVersionUID = 1L;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tput(&quot;ourbatis:foreach&quot;, new ForeachAdapter());</span><br><span class=\"line\">\t\t\tput(&quot;ourbatis:ref&quot;, new RefAdapter());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;;</span><br></pre></td></tr></table></figure>\n<p>我们可以修改<code>org.nico.ourbatis.Ourbatis</code>类中的静态参数<code>ASSIST_ADAPTERS</code>去删除、更新和添加自定义标签，需要实现一个标签适配器，我们可以看一下最简单的<code>RefAdapter</code>适配器的实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class RefAdapter extends AssistAdapter&#123;</span><br><span class=\"line\">\t@Override</span><br><span class=\"line\">\tpublic String adapter(Map&lt;String, Object&gt; datas, NoelRender render, Document document) &#123;</span><br><span class=\"line\">\t\tString path = render.rending(datas, document.getParameter(&quot;path&quot;), &quot;domainSimpleClassName&quot;);</span><br><span class=\"line\">\t\tString result =  StreamUtils.convertToString(path.replaceAll(&quot;classpath:&quot;, &quot;&quot;));</span><br><span class=\"line\">\t\treturn result == null ? &quot;&quot; : result.trim();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Ourbatis中只定义了上述两个自定义标签已足够满足需求，通过<code>foreach</code>标签，将元数据中的集合遍历渲染，通过<code>ref</code>标签引入外界资源，也就是我们之前所说的对Mapper接口中方法的扩展！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;ourbatis:ref path=&quot;classpath:ourbatis-mappers/@&#123;domainSimpleClassName&#125;Mapper.xml&quot; /&gt;</span><br></pre></td></tr></table></figure>\n<p>其中的path就是当前项目classpath路径的相对路径，而<code>@&#123;domainSimpleClassName&#125;</code>就代表着实体类的类名，更多的系统参数可以参考Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84\">元数据映射</a></p>\n<p>通过这种模板渲染的机制，Ourbatis是相当灵活的，我们不仅可以通过引入外部文件进行扩展，当我们需要添加或修改通用方法时，我们可以可以自定义<code>ourbatis.xml</code>的内容，如何做到呢？复制一份将之放在资源目录下就可以了！</p>\n<p>看到这里，相信大家已经知道Ourbatis的基本原理已经使用方式，我就再次不多说了，更多细节可以去官方Wiki中阅读：<a href=\"https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84\">Ourbatis Wiki</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-mybatis的不足之处\"><a class=\"header-anchor\" href=\"#一-mybatis的不足之处\">¶</a>一、Mybatis的不足之处</h2>\n<p>Mybatis是一款优秀的及其灵活的持久层框架，通过XML配置并映射到Mapper接口为Service层提供基础数据操作入口。</p>\n<p>这么优秀的框架竟然还有不足之处？</p>\n<p>俗话说人无完人，因为Mybatis实在是太灵活了，灵活到每个Mapper接口都需要定制对应的XML，所以就会引发一些问题。</p>\n<h3 id=\"问题一：配置文件繁多\"><a class=\"header-anchor\" href=\"#问题一：配置文件繁多\">¶</a>问题一：配置文件繁多</h3>\n<p>假如一个系统中DB中涉及100张表，我们就需要写<code>100</code>个Mapper接口，还没完，最可怕的是，我们要为这<code>100</code>个Mapper接口定制与之对应的<code>100</code>套XML。而每个Mapper都必不可少的需要增删改查功能，我们就要写<code>100</code>遍增删改查，作为高贵的Java开发工程师，这是不能容忍的，于是<code>Mybatis Generator</code>诞生了，然而又会引发另一个问题！</p>\n<h3 id=\"问题二：维护困难\"><a class=\"header-anchor\" href=\"#问题二：维护困难\">¶</a>问题二：维护困难</h3>\n<p>我们使用<code>Mybatis Generator</code>解决了问题一，再多的文件生成就是了，简单粗暴，貌似解决了所有的问题，Mybatis完美了！</p>\n<p>不要高兴的太早，在系统刚刚建立起来时，我们使用<code>Mybatis Generator</code>生成了一堆XML，在开发过程中，产品忽然提了一个新的需求，项目经理根据这个需求在某张表中增加或变动了一个字段，这时，我猜你的操作是这样：</p>\n<ul>\n<li>1、找到对应表的XML</li>\n<li>2、将该XML中自定义的一段标签复制出来，保存在本地</li>\n<li>3、使用<code>Mybatis Generator</code>重新生成该表的XML</li>\n<li>4、将之覆盖当前的XML</li>\n<li>5、将自定义的一段标签再粘贴进新的XML中</li>\n</ul>\n<p>在这个过程中，如果我们在第2步时漏复制了一段标签，等整个操作完成之后，又别是一番滋味在心头~</p>\n<h3 id=\"问题三：编写xml困难\"><a class=\"header-anchor\" href=\"#问题三：编写xml困难\">¶</a>问题三：编写XML困难</h3>\n<p>假如肝不错，问题二也是小CASE，那么问题又来了，我们如何在繁长的XML中去编写和修改我们的XML呢。</p>\n<p>当我们打开要编辑的XML，映入眼帘的就是1000多行的XML，其中900行都是通用的增删改查操作，要新增一个标签，我们需要拉至文件底部编写新的数据操作，要更新一个标签，我们需要通过<code>Ctrl + F</code>寻找目标标签再进行修改。</p>\n<p>如何避免这些问题呢？</p>\n<p>如何让Mybatis增强通用性又不失灵活呢？</p>\n<h2 id=\"二-使用ourbatis辅助mybatis\"><a class=\"header-anchor\" href=\"#二-使用ourbatis辅助mybatis\">¶</a>二、使用Ourbatis辅助Mybatis</h2>\n<p>Ourbatis是一款Mybatis开发增强工具，小巧简洁，项目地址：</p>\n<ul>\n<li>Github：<a href=\"https://github.com/ainilili/ourbatis\">https://github.com/ainilili/ourbatis</a></li>\n<li>Gitee：<a href=\"https://gitee.com/ainilili/ourbatis\">https://gitee.com/ainilili/ourbatis</a></li>\n<li>Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki\">https://github.com/ainilili/ourbatis/wiki</a></li>\n<li>Demo：<a href=\"https://github.com/ainilili/ourbatis-simple\">https://github.com/ainilili/ourbatis-simple</a></li>\n</ul>\n<p>特性：</p>\n<ul>\n<li><strong>1</strong>、简洁方便，可以让Mybatis无XML化开发。</li>\n<li><strong>2</strong>、优雅解耦，通用和自定义的SQL标签完全隔离，让维护更加轻松。</li>\n<li><strong>3</strong>、无侵入性，Mybatis和Ourbatis可同时使用，配置简洁。</li>\n<li><strong>4</strong>、灵活可控，通用模板可自定义及扩展。</li>\n<li><strong>5</strong>、部署快捷，只需要一个依赖，两个配置，即可直接运行。</li>\n<li><strong>6</strong>、多数据源，在多数据源环境下也可以照常使用。</li>\n</ul>\n<h3 id=\"关于ourbatis使用的一个小demo\"><a class=\"header-anchor\" href=\"#关于ourbatis使用的一个小demo\">¶</a>关于Ourbatis使用的一个小Demo</h3>\n<p>环境：</p>\n<ul>\n<li>Spring Boot 2.0.5.RELEASE</li>\n<li>Ourbatis 1.0.5</li>\n<li>JAVA 8</li>\n<li>Mysql</li>\n</ul>\n<p>以<code>Spring Boot 2.0.5.RELEASE</code>版本为例，在可以正常使用Mybatis的项目中，<code>pom.xml</code>添加如下依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   &lt;dependency&gt;</span><br><span class=\"line\">       \t&lt;groupId&gt;com.smallnico&lt;/groupId&gt;</span><br><span class=\"line\">       \t&lt;artifactId&gt;ourbatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class=\"line\">       \t&lt;version&gt;1.0.5&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>在配置文件中增加一下配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ourbatis.domain-locations=实体类所在包名</span><br></pre></td></tr></table></figure>\n<p>接下来，Mapper接口只需要继承<code>SimpleMapper</code>即可：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.nico.ourbatis.domain.User;</span><br><span class=\"line\">public interface UserMapper extends SimpleMapper&lt;User, Integer&gt;&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至此，一个使用Ourbatis的简单应用已经部署起来了，之后，你就可以使用一些Ourbatis默认的通用操作方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public T selectById(K key);</span><br><span class=\"line\"></span><br><span class=\"line\">public T selectEntity(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;T&gt; selectList(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public long selectCount(Object condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;T&gt; selectPage(Page&lt;Object&gt; page);</span><br><span class=\"line\"></span><br><span class=\"line\">default PageResult&lt;T&gt; selectPageResult(Page&lt;Object&gt; page)&#123;</span><br><span class=\"line\">\tlong total = selectCount(page.getEntity());</span><br><span class=\"line\">\tList&lt;T&gt; results = null;</span><br><span class=\"line\">\tif(total &gt; 0) &#123;</span><br><span class=\"line\">\t\tresults = selectPage(page);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn new PageResult&lt;&gt;(total, results);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public K selectId(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public List&lt;K&gt; selectIds(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insert(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insertSelective(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int insertBatch(List&lt;T&gt; list);</span><br><span class=\"line\"></span><br><span class=\"line\">public int update(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int updateSelective(T entity);</span><br><span class=\"line\"></span><br><span class=\"line\">public int updateBatch(List&lt;T&gt; list);</span><br><span class=\"line\"></span><br><span class=\"line\">public int delete(T condition);</span><br><span class=\"line\"></span><br><span class=\"line\">public int deleteById(K key);</span><br><span class=\"line\"></span><br><span class=\"line\">public int deleteBatch(List&lt;K&gt; list);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"mapper自定义方法\"><a class=\"header-anchor\" href=\"#mapper自定义方法\">¶</a>Mapper自定义方法</h3>\n<p>在很多场景中，我们使用以上的自带的通用方法远远不能满足我们的需求，我们往往需要额外扩展新的Mapper方法、XML标签，我们使用了Ourbatis之后该如何实现呢？</p>\n<p>首先看一下我们的需求，在上述Demo中，我们在UserMapper中增加一个方法<code>selectNameById</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.nico.ourbatis.domain.User;</span><br><span class=\"line\">public interface UserMapper extends SimpleMapper&lt;User, Integer&gt;&#123;</span><br><span class=\"line\">    public String selectNameById(Integer userId);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>和Mybatis一样，需要在<code>resources</code>资源目录下新建一个文件夹<code>ourbatis-mappers</code>，然后在其中新建一个XML文件，命名规则为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DomainClassSimpleName + Mapper.xml</span><br></pre></td></tr></table></figure>\n<p>其中<code>DomainClassSimpleName</code>就是我们实体类的类名，这里是为<code>User</code>，那么新建的XML名为<code>UserMapper.xml</code>。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src/main/resources</span><br><span class=\"line\"> - ourbatis-mappers</span><br><span class=\"line\">   - UserMapper.xml</span><br></pre></td></tr></table></figure>\n<p>之后，打开<code>UserMapper.xml</code>，开始编写Mapper中<code>selectNameById</code>方法对应的标签：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;select id=&quot;selectNameById&quot; resultType=&quot;java.lang.String&quot;&gt;</span><br><span class=\"line\">    select name from user where id = #&#123;userId&#125;</span><br><span class=\"line\">&lt;/select&gt;</span><br></pre></td></tr></table></figure>\n<p>注意，整个文件中只需要写标签就行了，其他的什么都不需要，这是为什么呢？深入之后你就会明白，这里先不多说！</p>\n<p>接下来，就没有接下来了，可以直接使用<code>selectNameById</code>方法了。</p>\n<h3 id=\"深入了解ourbatis\"><a class=\"header-anchor\" href=\"#深入了解ourbatis\">¶</a>深入了解Ourbatis</h3>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/10/18/1668605ac4cc678d?w=540&amp;h=816&amp;f=png&amp;s=22436\" alt=\"ourbatis 流程图\"></p>\n<p>当服务启动的时候，Ourbatis首先会扫描<code>ourbatis.domain-locations</code>配置包下的所有实体类，将之映射为与之对应的表结构数据：<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/10/18/166865c063369ef6?w=741&amp;h=270&amp;f=png&amp;s=10672\" alt=\"ourbatis Mapping\"></p>\n<p>然后通过<code>ourbatis.xml</code>的渲染，生成一个又一个的XML文件，最后将之重新Build到Mybatis容器中！</p>\n<p>整个过程分为两个核心点：</p>\n<ul>\n<li>1、映射实体类为元数据</li>\n<li>2、使用<code>ourbatis.xml</code>渲染元数据为XML文件</li>\n</ul>\n<p>我会一一介绍之~</p>\n<h4 id=\"映射实体类为元数据\"><a class=\"header-anchor\" href=\"#映射实体类为元数据\">¶</a>映射实体类为元数据</h4>\n<p>在映射时，我们要根据自己数据库字段命名的风格去调整映射规则，就需要在第1个核心点中去做处理，Ourbatis使用包装器来完成：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface Wrapper&lt;T&gt; &#123;</span><br><span class=\"line\">\tpublic String wrapping(T value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于需要映射的字段，如<strong>表名</strong>和<strong>表字段名</strong>，它们都将会经过一个包装器链条的处理之后再投入到<code>ourbatis.xml</code>中做渲染，这样就使得我们可以自定义包装器出更换映射的字段格式，具体方式可以参考官方Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki/Wrapper%E5%8C%85%E8%A3%85%E5%99%A8\">Wrapper包装器</a></p>\n<h4 id=\"使用ourbatis-xml渲染元数据为xml文件\"><a class=\"header-anchor\" href=\"#使用ourbatis-xml渲染元数据为xml文件\">¶</a>使用<code>ourbatis.xml</code>渲染元数据为XML文件</h4>\n<p>而在于第2个核心点中，Ourbatis通过自定义标签做模板渲染，我们可以先看一下官方默认的<code>ourbatis.xml</code>内部构造：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class=\"line\">&lt;mapper namespace=&quot;@&#123;mapperClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t&lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;id column=&quot;@&#123;elem.jdbcName&#125;&quot; property=&quot;@&#123;elem.javaName&#125;&quot; /&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;result column=&quot;@&#123;elem.jdbcName&#125;&quot; property=&quot;@&#123;elem.javaName&#125;&quot; /&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/resultMap&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;sql id=&quot;Base_Column_List&quot;&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/sql&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectById&quot; parameterType=&quot;java.lang.Object&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectEntity&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectCount&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;long&quot;&gt;</span><br><span class=\"line\">\t\tselect count(0)</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectPage&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;org.nico.ourbatis.entity.Page&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;if test=&quot;entity != null&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;if test=&quot;entity.@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;entity.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;if test=&quot;orderBy != null&quot;&gt;</span><br><span class=\"line\">\t\t\torder by $&#123;orderBy&#125;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;if test=&quot;start != null and end != null&quot;&gt;</span><br><span class=\"line\">\t\t\tlimit $&#123;start&#125;,$&#123;end&#125;</span><br><span class=\"line\">\t\t&lt;/if&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectList&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultMap=&quot;BaseResultMap&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectId&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tlimit 1</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;select id=&quot;selectIds&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;</span><br><span class=\"line\">\t\tresultType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tselect</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/select&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;deleteById&quot; parameterType=&quot;java.lang.Object&quot;&gt;</span><br><span class=\"line\">\t\tdelete</span><br><span class=\"line\">\t\tfrom @&#123;tableName&#125;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insert&quot; keyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot;</span><br><span class=\"line\">\t\tuseGeneratedKeys=&quot;true&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues (</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insertSelective&quot;</span><br><span class=\"line\">\t\tkeyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot; useGeneratedKeys=&quot;true&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t,`@&#123;elem.jdbcName&#125;`</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues (</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t, #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;insert id=&quot;insertBatch&quot;</span><br><span class=\"line\">\t\tkeyProperty=&quot;@&#123;primaryColumns.0.jdbcName&#125;&quot; useGeneratedKeys=&quot;true&quot;</span><br><span class=\"line\">\t\tparameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\tinsert into @&#123;tableName&#125;</span><br><span class=\"line\">\t\t(</span><br><span class=\"line\">\t\t&lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\tvalues</span><br><span class=\"line\">\t\t&lt;foreach collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\tseparator=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t(</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t#&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t)</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/insert&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;update&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;updateSelective&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\t,`@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\twhere 1=1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;update id=&quot;updateBatch&quot; parameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\t&lt;foreach collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\tseparator=&quot;;&quot;&gt;</span><br><span class=\"line\">\t\t\tupdate @&#123;tableName&#125;</span><br><span class=\"line\">\t\t\t&lt;set&gt;</span><br><span class=\"line\">\t\t\t\t&lt;ourbatis:foreach list=&quot;normalColumns&quot; var=&quot;elem&quot;</span><br><span class=\"line\">\t\t\t\t\tsplit=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t\t\t`@&#123;elem.jdbcName&#125;` = #&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t\t&lt;/set&gt;</span><br><span class=\"line\">\t\t\twhere 1=1</span><br><span class=\"line\">\t\t\t&lt;ourbatis:foreach list=&quot;primaryColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;item.@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/update&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;deleteBatch&quot; parameterType=&quot;java.util.List&quot;&gt;</span><br><span class=\"line\">\t\tdelete from @&#123;tableName&#125; where @&#123;primaryColumns.0.jdbcName&#125; in</span><br><span class=\"line\">\t\t&lt;foreach close=&quot;)&quot; collection=&quot;list&quot; index=&quot;index&quot; item=&quot;item&quot;</span><br><span class=\"line\">\t\t\topen=&quot;(&quot; separator=&quot;,&quot;&gt;</span><br><span class=\"line\">\t\t\t#&#123;item&#125;</span><br><span class=\"line\">\t\t&lt;/foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;delete id=&quot;delete&quot; parameterType=&quot;@&#123;domainClassName&#125;&quot;&gt;</span><br><span class=\"line\">\t\tdelete from @&#123;tableName&#125; where 1 = 1</span><br><span class=\"line\">\t\t&lt;ourbatis:foreach list=&quot;allColumns&quot; var=&quot;elem&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;if test=&quot;@&#123;elem.javaName&#125; != null&quot;&gt;</span><br><span class=\"line\">\t\t\t\tand `@&#123;elem.jdbcName&#125;` = #&#123;@&#123;elem.javaName&#125;&#125;</span><br><span class=\"line\">\t\t\t&lt;/if&gt;</span><br><span class=\"line\">\t\t&lt;/ourbatis:foreach&gt;</span><br><span class=\"line\">\t&lt;/delete&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;ourbatis:ref path=&quot;classpath:ourbatis-mappers/@&#123;domainSimpleClassName&#125;Mapper.xml&quot; /&gt;</span><br><span class=\"line\">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>\n<p>可以看出来，<code>ourbatis.xml</code>内容类似于原生的Mybatis的XML，不同的是，有两个陌生的标签：</p>\n<ul>\n<li>ourbatis:foreach 对元数据中的列表进行循环渲染</li>\n<li>ourbatis:ref 引入外界文件内容</li>\n</ul>\n<p>这是Ourbatis中独有的标签，Ourbatis也提供着对应的入口让我们去自定义标签：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class: org.nico.ourbatis.Ourbatis</span><br><span class=\"line\">Field: </span><br><span class=\"line\">public static final Map&lt;String, AssistAdapter&gt; ASSIST_ADAPTERS = new HashMap&lt;String, AssistAdapter&gt;()&#123;</span><br><span class=\"line\">\t\tprivate static final long serialVersionUID = 1L;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tput(&quot;ourbatis:foreach&quot;, new ForeachAdapter());</span><br><span class=\"line\">\t\t\tput(&quot;ourbatis:ref&quot;, new RefAdapter());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;;</span><br></pre></td></tr></table></figure>\n<p>我们可以修改<code>org.nico.ourbatis.Ourbatis</code>类中的静态参数<code>ASSIST_ADAPTERS</code>去删除、更新和添加自定义标签，需要实现一个标签适配器，我们可以看一下最简单的<code>RefAdapter</code>适配器的实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class RefAdapter extends AssistAdapter&#123;</span><br><span class=\"line\">\t@Override</span><br><span class=\"line\">\tpublic String adapter(Map&lt;String, Object&gt; datas, NoelRender render, Document document) &#123;</span><br><span class=\"line\">\t\tString path = render.rending(datas, document.getParameter(&quot;path&quot;), &quot;domainSimpleClassName&quot;);</span><br><span class=\"line\">\t\tString result =  StreamUtils.convertToString(path.replaceAll(&quot;classpath:&quot;, &quot;&quot;));</span><br><span class=\"line\">\t\treturn result == null ? &quot;&quot; : result.trim();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Ourbatis中只定义了上述两个自定义标签已足够满足需求，通过<code>foreach</code>标签，将元数据中的集合遍历渲染，通过<code>ref</code>标签引入外界资源，也就是我们之前所说的对Mapper接口中方法的扩展！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;ourbatis:ref path=&quot;classpath:ourbatis-mappers/@&#123;domainSimpleClassName&#125;Mapper.xml&quot; /&gt;</span><br></pre></td></tr></table></figure>\n<p>其中的path就是当前项目classpath路径的相对路径，而<code>@&#123;domainSimpleClassName&#125;</code>就代表着实体类的类名，更多的系统参数可以参考Wiki：<a href=\"https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84\">元数据映射</a></p>\n<p>通过这种模板渲染的机制，Ourbatis是相当灵活的，我们不仅可以通过引入外部文件进行扩展，当我们需要添加或修改通用方法时，我们可以可以自定义<code>ourbatis.xml</code>的内容，如何做到呢？复制一份将之放在资源目录下就可以了！</p>\n<p>看到这里，相信大家已经知道Ourbatis的基本原理已经使用方式，我就再次不多说了，更多细节可以去官方Wiki中阅读：<a href=\"https://github.com/ainilili/ourbatis/wiki/%E5%85%83%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84\">Ourbatis Wiki</a></p>\n"},{"title":"深入JAVA8的HashMap实现原理","author":"Nico","date":"2018-12-25T11:42:00.000Z","_content":"## 引导\n在了解``HashMap``之前，我们应该先明白两个概念：``Hash``和``Map``，这可以帮助我们更容易了解``HashMap``的运行原理。\n\n那么何为``Hash``，又何为``Map``呢？\n\n### Hash\n之前写过一篇关于Hash的文章 [Hash](/zh-cn/java/data-structure/hash.md)\n\n### Map\nMap是一种``K-V``形式的数据结构，一个唯一的key，会唯一对应一个value。也就是说，在Map容器里不允许两个一模一样的key。\n\n一个简单的Map结构如下：\n```\n{\n  \"key1\":\"value1\",\n  \"key2\":\"value2\",\n  \"key3\":\"value3\"\n}\n```\n对于这种数据结构，并且Map会对外提供一些方法来实现对内部数据的操作：\n```\nV put(K key, V value)\nV get(Object key)\nV remove(Object key)\nboolean containsKey(Object key)\n```\n可见Map对于我们操作``K-V``形式的数据非常方便，实现的方式有很多，最简单粗暴的实现方式是使用``List``来存储每一个``K-V``组对，对于每种方法的实现只需要暴力循环碰撞即可，对于少量数据这种做法未必不可，如果数据量庞大之千万，我们就要换一种更加高效，速度更快的实现方式：``HashMap``。\n## HashMap\nMap在Java中的实现有很多，``HashMap``便是其中之一，在``JDK``漫长的版本更新中，``HashMap``的实现也是在不断的更新着：\n - **<=JDK1.7**：Table数组 + Entry链表\n - **>=JDK1.8**：Table数组 + Entry链表/红黑树\n\n本文我们跳过JDK1.7的实现，来看一下1.8中``HashMap``源码所带来的魅力冲击！\n### 实现原理\n对于各个版本的``HashMap``实现原理，主线流程都是一成不变的：\n\n![hashmap原理流程图](https://github.com/ainilili/snail/blob/master/docs/images/hashmap-1.8-1-1.jpg?raw=true)\n\n这里有两个数据结构需要我们知道：\n - **Table**：哈希表，存放Node元素。\n - **Node**：结点元素，存放``K-V``组对信息，其结构是一个链表/红黑树。\n\n另外，在HashMap内部有一些关键属性我们也要了解一下：\n - **DEFAULT_INITIAL_CAPACITY**：Table数组初始长度，默认为``1 << 4``，``2^4`` = 16。\n - **MAXIMUM_CAPACITY**：Table数组最高长度，默认为``1 << 30``，``2^30`` = 1073741824。\n - **DEFAULT_LOAD_FACTOR**：负载因子，当总元素数 > 数组长度 * 负载因子时，Table数组将会扩容，默认为0.75。\n - **TREEIFY_THRESHOLD**：树化阈值，当单个Table内Node数量超过该值，则会将链表转化为红黑树，默认为8。\n - **UNTREEIFY_THRESHOLD**：链化阈值，当扩容期间单个Table内Entry数量小于该值，则将红黑树转化为链表，默认为6。\n - **MIN_TREEIFY_CAPACITY**：最小树化阈值，当Table所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）。\n - **size**：Table数组当前所有元素数。\n - **threshold**：下次扩容的阈值（数组长度 * 负载因子）\n\nHashMap的内部有着一个Table数组，而这个数组的初始长度为``DEFAULT_INITIAL_CAPACITY``参数值，Table数组存放的元素类型就是Node，它是一个单向链表：\n```java\nstatic class Node<K,V> implements Map.Entry<K,V> {\n  final int hash; //key的hash值\n  final K key;  //key\n  V value;  //value\n  Node<K,V> next; //下一个结点\n}\n```\n每个Table中存的Node元素相当于链表的``header``，``next``指向下一个结点，而这种链式结构的存在正是为了解决``hash冲突``：\n> **hash冲突**：两个元素的经过Hash散列之后分在同一个组内，我们将之解释为Hash冲突\n\n在JDK1.7之前的版本，hash冲突的解决方法是将被冲突的Node结点放于一个链表中，而Table中的元素则是链头，当然在JDK1.8中，当Table中链长超过``TREEIFY_THRESHOLD``阈值后，将会将链表转变为红黑树的实现``TreeNode``：\n```\nstatic final class TreeNode<K,V> extends LinkedHashMap.Entry<K,V> {\n  TreeNode<K,V> parent;  // red-black tree links\n  TreeNode<K,V> left;\n  TreeNode<K,V> right;\n  TreeNode<K,V> prev;    // needed to unlink next upon deletion\n  boolean red;\n}\n```\n当发生hash冲突的Node不断变多，那么这个链将会越来越长，那么遍历碰撞key时的耗时就会不断增加，这也就直接导致了性能的不足，从JDK1.8开始，HashMap对于单个Table中的Node超出某个阈值时，将会开始树化操作（链表转化为红黑树），这对于搜索的性能将会有很大的提升，而插入和删除的操作所带来的性能影响微乎其微。\n\n### put方法\n在``HashMap``的内部会有一个Table数组，这个数组的当前长度就是我们要实现映射的目标范围，当我们执行``put``方法时，``key``和``value``要经历这些事情：\n - 通过``Hash``散列获取到对应的Table\n - 遍历Table下的Node结点，做更新/添加操作\n - 扩容检测\n\n具体实现我们可以根据源码来详细了解一下：\n```java\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,\n                   boolean evict) {\n    Node<K,V>[] tab; Node<K,V> p; int n, i;\n    if ((tab = table) == null || (n = tab.length) == 0)\n        // HashMap的懒加载策略，当执行put操作时检测Table数组初始化。\n        n = (tab = resize()).length;\n    if ((p = tab[i = (n - 1) & hash]) == null)\n        //通过``Hash``函数获取到对应的Table，如果当前Table为空，则直接初始化一个新的Node并放入该Table中。\n        tab[i] = newNode(hash, key, value, null);\n    else {\n        Node<K,V> e; K k;\n        if (p.hash == hash &&\n            ((k = p.key) == key || (key != null && key.equals(k))))\n            //输入的key命中了当前Table的首元素，直接更新。\n            e = p;\n        else if (p instanceof TreeNode)\n            //如果当前Node类型为TreeNode，调用``putTreeVal``方法。\n            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);\n        else {\n            //如果不是TreeNode，则就是链表，遍历并与输入key做命中碰撞。\n            for (int binCount = 0; ; ++binCount) {\n                if ((e = p.next) == null) {\n                    //如果当前Table中不存在当前key，则添加。\n                    p.next = newNode(hash, key, value, null);\n                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                        //超过了``TREEIFY_THRESHOLD``则转化为红黑树。\n                        treeifyBin(tab, hash);\n                    break;\n                }\n                if (e.hash == hash &&\n                    ((k = e.key) == key || (key != null && key.equals(k))))\n                    //做命中碰撞，使用hash、内存和equals同时判断（不同的元素hash可能会一致）。\n                    break;\n                p = e;\n            }\n        }\n        if (e != null) {\n            //如果命中不为空，更新操作。\n            V oldValue = e.value;\n            if (!onlyIfAbsent || oldValue == null)\n                e.value = value;\n            afterNodeAccess(e);\n            return oldValue;\n        }\n    }\n    ++modCount;\n    if (++size > threshold)\n        //扩容检测。\n        resize();\n    afterNodeInsertion(evict);\n    return null;\n}\n```\n对于其过程中的关于Node链表和红黑树的转换过程我们可以暂时屏蔽掉，那么整个流程并不是很绕，那么我们继续深入的来看一下HashMap的扩容实现。\n\n### resize方法\nHashMap的扩容大致的实现是将老Table数组中所有的Entry取出来，重新对其hashcode做``Hash``散列到新的新的Table之中，也就是一个``re-put``的过程，具体还是通过源码来讲解：\n```Java\nfinal Node<K,V>[] resize() {\n    //保留老的hash表\n    Node<K,V>[] oldTab = table;\n    int oldCap = (oldTab == null) ? 0 : oldTab.length;\n    int oldThr = threshold;\n    int newCap, newThr = 0;\n    //如果之前的容量大于0\n    if (oldCap > 0) {\n        //如果超出最大容量\n        if (oldCap >= MAXIMUM_CAPACITY) {\n            //扩容阈值为int最大值\n            threshold = Integer.MAX_VALUE;\n            return oldTab;\n        }\n        //否则计算扩容后的阈值\n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&\n                 oldCap >= DEFAULT_INITIAL_CAPACITY)\n            newThr = oldThr << 1; // double threshold\n    }\n    else if (oldThr > 0)\n        // 如果之前的容量等于0，并且之前的阈值大于零，则新的hash表长度就等于它\n        newCap = oldThr;\n    else {              \n        // 初始阈值为零表示使用默认值\n        newCap = DEFAULT_INITIAL_CAPACITY;\n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n    }\n    //如果新的阈值为 0 ，就得用 新容量*加载因子 重计算一次\n    if (newThr == 0) {\n\n        float ft = (float)newCap * loadFactor;\n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?\n                  (int)ft : Integer.MAX_VALUE);\n    }\n    threshold = newThr;\n    //常见扩容后的hash表\n    @SuppressWarnings({\"rawtypes\",\"unchecked\"})\n        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];\n    table = newTab; //A\n    if (oldTab != null) {\n        //遍历旧的hash表，将之内部元素转移到新的hash表\n        for (int j = 0; j < oldCap; ++j) {\n            Node<K,V> e;\n            if ((e = oldTab[j]) != null) {\n                oldTab[j] = null;\n                if (e.next == null)\n                    //如果当前Table内只有一个元素，重新做hash散列并赋值\n                    newTab[e.hash & (newCap - 1)] = e; //B\n                else if (e instanceof TreeNode)\n                    //如果旧哈希表中这个位置的桶是树形结构，就要把新哈希表里当前桶也变成树形结构\n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);\n                else { //保留旧哈希表桶中链表的顺序\n                    Node<K,V> loHead = null, loTail = null;\n                    Node<K,V> hiHead = null, hiTail = null;\n                    Node<K,V> next;\n                    do {  //遍历当前Table内的Node，赋值给新的Table\n                        next = e.next;\n                        if ((e.hash & oldCap) == 0) {\n                            if (loTail == null)\n                                loHead = e;\n                            else\n                                loTail.next = e;\n                            loTail = e;\n                        }\n                        else {\n                            if (hiTail == null)\n                                hiHead = e;\n                            else\n                                hiTail.next = e;\n                            hiTail = e;\n                        }\n                    } while ((e = next) != null);\n                    if (loTail != null) {\n                        loTail.next = null;\n                        newTab[j] = loHead;\n                    }\n                    if (hiTail != null) {\n                        hiTail.next = null;\n                        newTab[j + oldCap] = hiHead;\n                    }\n                }\n            }\n        }\n    }\n    return newTab;\n}\n```\n### get方法\n在我们看完HashMap对于put方法的实现之后，get方法则显得简单易懂，其代码与put相近无几，主要差别是没有了扩容和添加/更新的操作：\n```java\nfinal Node<K,V> getNode(int hash, Object key) {\n    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;\n    //判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在\n    if ((tab = table) != null && (n = tab.length) > 0 &&\n        (first = tab[(n - 1) & hash]) != null) {\n        if (first.hash == hash &&\n            ((k = first.key) == key || (key != null && key.equals(k))))\n            // 检测第一个Node，命中则不需要在做do...while...循环\n            return first;\n        if ((e = first.next) != null) {\n            if (first instanceof TreeNode)\n                //如果Table内是树形结构，则使用对应的检索方法\n                return ((TreeNode<K,V>)first).getTreeNode(hash, key);\n            do { //如果是链表，则做while循环，直到命中或者遍历结束\n                if (e.hash == hash &&\n                    ((k = e.key) == key || (key != null && key.equals(k))))\n                    return e;\n            } while ((e = e.next) != null);\n        }\n    }\n    return null;\n}\n```\n### containsKey方法\n根据get方法的结果是否为空就可以直到是否包含该key：\n```\npublic boolean containsKey(Object key) {\n    return getNode(hash(key), key) != null;\n}\n```\n### remove方法\n同样类似于put操作，首先会查找对应的key所在位置，如果为空，则不操作，反之，将之移除：\n```java\nfinal Node<K,V> removeNode(int hash, Object key, Object value,\n                               boolean matchValue, boolean movable) {\n    Node<K,V>[] tab; Node<K,V> p; int n, index;\n    //判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在\n    if ((tab = table) != null && (n = tab.length) > 0 &&\n        (p = tab[index = (n - 1) & hash]) != null) {\n        Node<K,V> node = null, e; K k; V v;\n        if (p.hash == hash &&\n            ((k = p.key) == key || (key != null && key.equals(k))))\n            // 第一个Node命中\n            node = p;\n        else if ((e = p.next) != null) {\n            if (p instanceof TreeNode)\n                //如果Table内是树形结构，则使用对应的检索方法\n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);\n            else {\n                do { //如果是链表，则做while循环，直到命中或者遍历结束\n                    if (e.hash == hash &&\n                        ((k = e.key) == key ||\n                         (key != null && key.equals(k)))) {\n                        node = e;\n                        break;\n                    }\n                    p = e;\n                } while ((e = e.next) != null);\n            }\n        }\n        if (node != null && (!matchValue || (v = node.value) == value ||\n                             (value != null && value.equals(v)))) {\n            //如果命中到了对应的Node，则根据Node结构进行对应的移除操作\n            if (node instanceof TreeNode)\n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);\n            else if (node == p)\n                tab[index] = node.next;\n            else\n                p.next = node.next;\n            ++modCount;\n            //修改hash表元素数\n            --size;\n            afterNodeRemoval(node);\n            return node;\n        }\n    }\n    return null;\n}\n```\n## 为何线程不安全？\n看完了HashMap的实现之后，就该谈一谈它为什么存在线程安全问题！\n\n### 数据丢失\n首先，我们将目光放在put方法的实现中，假设有两个线程在同时进行put操作，对应的数据分别为：\n```\nthread-1： put(1, 'abc');\nthread-2： put(1, 'efg');\n```\n假设此时Hash表的长度为10，且已经有两个元素在，负载因子为默认值0.75f，那么操作过程一定不会扩容，并且两个线程put的key都是1，那么它们将会分配到同一个table中，下方代码为put方法中的其中一段，其主要作用是遍历当前表内Node，寻找与当前key一样的Node结点，之后再做添加/更新操作。\n```java\nfor (int binCount = 0; ; ++binCount) {\n   if ((e = p.next) == null) {\n       p.next = newNode(hash, key, value, null); // A\n       if (binCount >= TREEIFY_THRESHOLD - 1)\n           treeifyBin(tab, hash);\n       break;\n   }\n   if (e.hash == hash &&\n       ((k = e.key) == key || (key != null && key.equals(k))))\n       break;\n   p = e;\n}\n```\n假设两个线程同时执行到了``A``这个位置，此时获取到的``p``是统一个对象，下一刻，cpu运转，两个线程同时运行，那么``p.next``的值将会是最后一个线程put的value值，而前一个则会丢失，这就会导致丢数据的情况！\n\n当然该情景同样会发生于``resize``和``remove``操作，至于为什么，大家可以思考一下！\n### size不准确\n这个就很简单了，为什么不准确呢，来看一下size变量在HashMap内部的定义：\n```\ntransient int size;\n```\n内存不可见并且增减操作未加锁，多线程操作下属于非原子操作！\n### 闭环死锁\n这个问题在JDK1.8版本的HashMap中已经不存在了，至于为啥，我要先讲一下在1.8之前的HashMap为什么会存在闭环死锁问题！\n\n从``闭环``这个名词上我们分析一下是什么问题，什么是闭环的，如果链表形成了一个环会不会就是闭环呢？而链表如何才会形成环？带着这些问题，我们在脑海中抽象出一个模型：\n```\ngraph LR\nA-->B\nB-->A\n```\n假设某一个Table中的Node链表发生了上述问题，那么我们在遍历时进行``do{ }while ((e = e.next) != null);``操作就会发生死锁的问题，那么看来我们的猜想方向是正确的，那么我们就具体分析一下HashMap在什么操作之中会产生闭环的问题，不过在此之前，我们要明白因果：\n```\n因：???\n果：闭环\n```\n我们知道，只有当两个结点内部的``next``相互引用对方的时候才会死锁，这种场景只能在两个已经存在同一个链上的结点同时以``相反的方向``被操作``next``引用的时候才会发生，而在HashMap内部，符合这种场景的只有一个方法：``resize``，那我们就来看一下JDK1.7的``resize``方法实现：\n```java\nvoid resize(int newCapacity) {\n    Entry[] oldTable = table;\n    int oldCapacity = oldTable.length;\n    if (oldCapacity == MAXIMUM_CAPACITY) {\n        threshold = Integer.MAX_VALUE;\n        return;\n    }\n\n    Entry[] newTable = new Entry[newCapacity];\n    boolean oldAltHashing = useAltHashing;\n    useAltHashing |= sun.misc.VM.isBooted() &&\n            (newCapacity >= Holder.ALTERNATIVE_HASHING_THRESHOLD);\n    boolean rehash = oldAltHashing ^ useAltHashing;\n    //fu\n    transfer(newTable, rehash);\n    table = newTable;\n    threshold = (int)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + 1);\n}\n```\n进入``transfer``方法中，其内部实现了扩容过程：\n```java\nvoid transfer(Entry[] newTable, boolean rehash) {\n    int newCapacity = newTable.length;\n    for (Entry<K,V> e : table) { // A\n        while(null != e) {\n            Entry<K,V> next = e.next;\n            if (rehash) {\n                e.hash = null == e.key ? 0 : hash(e.key);\n            }\n            int i = indexFor(e.hash, newCapacity);\n            e.next = newTable[i];\n            newTable[i] = e;\n            e = next;\n        }\n    }\n}\n```\n我们发现，在JDK1.7的HashMap的扩容实现中，老的Table中的Node链的顺序赋值给新的Table中时的操作是反置的：\n```java\ne.next = newTable[i];\nnewTable[i] = e;\ne = next;\n```\n上述操作是将当前Node的next指针指向当前Table的头结点，之后当前Node又变为了Table的头结点，此时假设A、B两个线程同时执行到了``transfer``方法中的``A``位置，并且此时的``oldTable``和``newTable``的结构是这样的：\n```\noldTable[]\ntable-1: a -> b -> c -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: null\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n如果很巧，两个线程在同一个CPU上执行，那么就会存在一个抢占时间片的场景，假设A先抢到了时间片，然后执行一番操作之后，``oldTable``和``newTable``的结构如下：\n```\noldTable[]\ntable-1: a -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: c -> b -> a\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n之后还没等它做``oldTable = newTable``操作，B抢到了时间片，并也做了同样一番操作，``oldTable``和``newTable``的结构如下：\n```\noldTable[]\ntable-1: a -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: a -> c -> b -> a\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n此时A或者B谁先``oldTable = newTable``已经无所谓了，因为``newTable``中已经产生了闭环，之后在进行get或者put操作时，如果不小心触发到了while循环，那将会一直死循环：\n```java\ndo{\n  //do some thing\n}while ((e = e.next) != null);  //e = e.next将会永不为空\n```\n从上述场景产生的过程中我们发现，``a -> c -> b -> a``这种闭环问题的罪魁祸首是因为1.7中的HashMap在扩容时为了免去再次遍历链表，很聪明的将当前结点作为新链表的头结点，这就会导致顺序反转，所以无序化导致了闭环的产生，而这种问题不仅仅是在HashMap中体现，Mysql的死锁问题的原因常常也是因为反序加行锁导致的！\n\n而在开头说过，JDK1.8已经避免了这个问题，这是为什么呢？看下代码就知道了：\n```java\nelse { // preserve order\n   Node<K,V> loHead = null, loTail = null;\n   Node<K,V> hiHead = null, hiTail = null;\n   Node<K,V> next;\n   do {\n       next = e.next;\n       if ((e.hash & oldCap) == 0) {\n           if (loTail == null)\n               loHead = e;\n           else\n               loTail.next = e;\n           loTail = e;\n       }\n       else {\n           if (hiTail == null)\n               hiHead = e;\n           else\n               hiTail.next = e;\n           hiTail = e;\n       }\n   } while ((e = next) != null);\n   if (loTail != null) {\n       loTail.next = null;\n       newTab[j] = loHead;  //A\n   }\n   if (hiTail != null) {\n       hiTail.next = null;\n       newTab[j + oldCap] = hiHead; //B\n   }\n}\n```\n同样是扩容的操作，JDK1.8中的HashMap通过两个链分别去存储头结点和尾结点以保证它有序，并且不会频繁的去赋值``newTable``，而是在循环之后直接赋值（请注意A、B标记处），这样就非常简单的避免了产生闭环的陷阱！\n","source":"_posts/深入JAVA8的HashMap实现原理.md","raw":"title: 深入JAVA8的HashMap实现原理\nauthor: Nico\ntags: []\ncategories:\n  - 数据结构\ndate: 2018-12-25 19:42:00\n---\n## 引导\n在了解``HashMap``之前，我们应该先明白两个概念：``Hash``和``Map``，这可以帮助我们更容易了解``HashMap``的运行原理。\n\n那么何为``Hash``，又何为``Map``呢？\n\n### Hash\n之前写过一篇关于Hash的文章 [Hash](/zh-cn/java/data-structure/hash.md)\n\n### Map\nMap是一种``K-V``形式的数据结构，一个唯一的key，会唯一对应一个value。也就是说，在Map容器里不允许两个一模一样的key。\n\n一个简单的Map结构如下：\n```\n{\n  \"key1\":\"value1\",\n  \"key2\":\"value2\",\n  \"key3\":\"value3\"\n}\n```\n对于这种数据结构，并且Map会对外提供一些方法来实现对内部数据的操作：\n```\nV put(K key, V value)\nV get(Object key)\nV remove(Object key)\nboolean containsKey(Object key)\n```\n可见Map对于我们操作``K-V``形式的数据非常方便，实现的方式有很多，最简单粗暴的实现方式是使用``List``来存储每一个``K-V``组对，对于每种方法的实现只需要暴力循环碰撞即可，对于少量数据这种做法未必不可，如果数据量庞大之千万，我们就要换一种更加高效，速度更快的实现方式：``HashMap``。\n## HashMap\nMap在Java中的实现有很多，``HashMap``便是其中之一，在``JDK``漫长的版本更新中，``HashMap``的实现也是在不断的更新着：\n - **<=JDK1.7**：Table数组 + Entry链表\n - **>=JDK1.8**：Table数组 + Entry链表/红黑树\n\n本文我们跳过JDK1.7的实现，来看一下1.8中``HashMap``源码所带来的魅力冲击！\n### 实现原理\n对于各个版本的``HashMap``实现原理，主线流程都是一成不变的：\n\n![hashmap原理流程图](https://github.com/ainilili/snail/blob/master/docs/images/hashmap-1.8-1-1.jpg?raw=true)\n\n这里有两个数据结构需要我们知道：\n - **Table**：哈希表，存放Node元素。\n - **Node**：结点元素，存放``K-V``组对信息，其结构是一个链表/红黑树。\n\n另外，在HashMap内部有一些关键属性我们也要了解一下：\n - **DEFAULT_INITIAL_CAPACITY**：Table数组初始长度，默认为``1 << 4``，``2^4`` = 16。\n - **MAXIMUM_CAPACITY**：Table数组最高长度，默认为``1 << 30``，``2^30`` = 1073741824。\n - **DEFAULT_LOAD_FACTOR**：负载因子，当总元素数 > 数组长度 * 负载因子时，Table数组将会扩容，默认为0.75。\n - **TREEIFY_THRESHOLD**：树化阈值，当单个Table内Node数量超过该值，则会将链表转化为红黑树，默认为8。\n - **UNTREEIFY_THRESHOLD**：链化阈值，当扩容期间单个Table内Entry数量小于该值，则将红黑树转化为链表，默认为6。\n - **MIN_TREEIFY_CAPACITY**：最小树化阈值，当Table所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）。\n - **size**：Table数组当前所有元素数。\n - **threshold**：下次扩容的阈值（数组长度 * 负载因子）\n\nHashMap的内部有着一个Table数组，而这个数组的初始长度为``DEFAULT_INITIAL_CAPACITY``参数值，Table数组存放的元素类型就是Node，它是一个单向链表：\n```java\nstatic class Node<K,V> implements Map.Entry<K,V> {\n  final int hash; //key的hash值\n  final K key;  //key\n  V value;  //value\n  Node<K,V> next; //下一个结点\n}\n```\n每个Table中存的Node元素相当于链表的``header``，``next``指向下一个结点，而这种链式结构的存在正是为了解决``hash冲突``：\n> **hash冲突**：两个元素的经过Hash散列之后分在同一个组内，我们将之解释为Hash冲突\n\n在JDK1.7之前的版本，hash冲突的解决方法是将被冲突的Node结点放于一个链表中，而Table中的元素则是链头，当然在JDK1.8中，当Table中链长超过``TREEIFY_THRESHOLD``阈值后，将会将链表转变为红黑树的实现``TreeNode``：\n```\nstatic final class TreeNode<K,V> extends LinkedHashMap.Entry<K,V> {\n  TreeNode<K,V> parent;  // red-black tree links\n  TreeNode<K,V> left;\n  TreeNode<K,V> right;\n  TreeNode<K,V> prev;    // needed to unlink next upon deletion\n  boolean red;\n}\n```\n当发生hash冲突的Node不断变多，那么这个链将会越来越长，那么遍历碰撞key时的耗时就会不断增加，这也就直接导致了性能的不足，从JDK1.8开始，HashMap对于单个Table中的Node超出某个阈值时，将会开始树化操作（链表转化为红黑树），这对于搜索的性能将会有很大的提升，而插入和删除的操作所带来的性能影响微乎其微。\n\n### put方法\n在``HashMap``的内部会有一个Table数组，这个数组的当前长度就是我们要实现映射的目标范围，当我们执行``put``方法时，``key``和``value``要经历这些事情：\n - 通过``Hash``散列获取到对应的Table\n - 遍历Table下的Node结点，做更新/添加操作\n - 扩容检测\n\n具体实现我们可以根据源码来详细了解一下：\n```java\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,\n                   boolean evict) {\n    Node<K,V>[] tab; Node<K,V> p; int n, i;\n    if ((tab = table) == null || (n = tab.length) == 0)\n        // HashMap的懒加载策略，当执行put操作时检测Table数组初始化。\n        n = (tab = resize()).length;\n    if ((p = tab[i = (n - 1) & hash]) == null)\n        //通过``Hash``函数获取到对应的Table，如果当前Table为空，则直接初始化一个新的Node并放入该Table中。\n        tab[i] = newNode(hash, key, value, null);\n    else {\n        Node<K,V> e; K k;\n        if (p.hash == hash &&\n            ((k = p.key) == key || (key != null && key.equals(k))))\n            //输入的key命中了当前Table的首元素，直接更新。\n            e = p;\n        else if (p instanceof TreeNode)\n            //如果当前Node类型为TreeNode，调用``putTreeVal``方法。\n            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);\n        else {\n            //如果不是TreeNode，则就是链表，遍历并与输入key做命中碰撞。\n            for (int binCount = 0; ; ++binCount) {\n                if ((e = p.next) == null) {\n                    //如果当前Table中不存在当前key，则添加。\n                    p.next = newNode(hash, key, value, null);\n                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                        //超过了``TREEIFY_THRESHOLD``则转化为红黑树。\n                        treeifyBin(tab, hash);\n                    break;\n                }\n                if (e.hash == hash &&\n                    ((k = e.key) == key || (key != null && key.equals(k))))\n                    //做命中碰撞，使用hash、内存和equals同时判断（不同的元素hash可能会一致）。\n                    break;\n                p = e;\n            }\n        }\n        if (e != null) {\n            //如果命中不为空，更新操作。\n            V oldValue = e.value;\n            if (!onlyIfAbsent || oldValue == null)\n                e.value = value;\n            afterNodeAccess(e);\n            return oldValue;\n        }\n    }\n    ++modCount;\n    if (++size > threshold)\n        //扩容检测。\n        resize();\n    afterNodeInsertion(evict);\n    return null;\n}\n```\n对于其过程中的关于Node链表和红黑树的转换过程我们可以暂时屏蔽掉，那么整个流程并不是很绕，那么我们继续深入的来看一下HashMap的扩容实现。\n\n### resize方法\nHashMap的扩容大致的实现是将老Table数组中所有的Entry取出来，重新对其hashcode做``Hash``散列到新的新的Table之中，也就是一个``re-put``的过程，具体还是通过源码来讲解：\n```Java\nfinal Node<K,V>[] resize() {\n    //保留老的hash表\n    Node<K,V>[] oldTab = table;\n    int oldCap = (oldTab == null) ? 0 : oldTab.length;\n    int oldThr = threshold;\n    int newCap, newThr = 0;\n    //如果之前的容量大于0\n    if (oldCap > 0) {\n        //如果超出最大容量\n        if (oldCap >= MAXIMUM_CAPACITY) {\n            //扩容阈值为int最大值\n            threshold = Integer.MAX_VALUE;\n            return oldTab;\n        }\n        //否则计算扩容后的阈值\n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&\n                 oldCap >= DEFAULT_INITIAL_CAPACITY)\n            newThr = oldThr << 1; // double threshold\n    }\n    else if (oldThr > 0)\n        // 如果之前的容量等于0，并且之前的阈值大于零，则新的hash表长度就等于它\n        newCap = oldThr;\n    else {              \n        // 初始阈值为零表示使用默认值\n        newCap = DEFAULT_INITIAL_CAPACITY;\n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n    }\n    //如果新的阈值为 0 ，就得用 新容量*加载因子 重计算一次\n    if (newThr == 0) {\n\n        float ft = (float)newCap * loadFactor;\n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?\n                  (int)ft : Integer.MAX_VALUE);\n    }\n    threshold = newThr;\n    //常见扩容后的hash表\n    @SuppressWarnings({\"rawtypes\",\"unchecked\"})\n        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];\n    table = newTab; //A\n    if (oldTab != null) {\n        //遍历旧的hash表，将之内部元素转移到新的hash表\n        for (int j = 0; j < oldCap; ++j) {\n            Node<K,V> e;\n            if ((e = oldTab[j]) != null) {\n                oldTab[j] = null;\n                if (e.next == null)\n                    //如果当前Table内只有一个元素，重新做hash散列并赋值\n                    newTab[e.hash & (newCap - 1)] = e; //B\n                else if (e instanceof TreeNode)\n                    //如果旧哈希表中这个位置的桶是树形结构，就要把新哈希表里当前桶也变成树形结构\n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);\n                else { //保留旧哈希表桶中链表的顺序\n                    Node<K,V> loHead = null, loTail = null;\n                    Node<K,V> hiHead = null, hiTail = null;\n                    Node<K,V> next;\n                    do {  //遍历当前Table内的Node，赋值给新的Table\n                        next = e.next;\n                        if ((e.hash & oldCap) == 0) {\n                            if (loTail == null)\n                                loHead = e;\n                            else\n                                loTail.next = e;\n                            loTail = e;\n                        }\n                        else {\n                            if (hiTail == null)\n                                hiHead = e;\n                            else\n                                hiTail.next = e;\n                            hiTail = e;\n                        }\n                    } while ((e = next) != null);\n                    if (loTail != null) {\n                        loTail.next = null;\n                        newTab[j] = loHead;\n                    }\n                    if (hiTail != null) {\n                        hiTail.next = null;\n                        newTab[j + oldCap] = hiHead;\n                    }\n                }\n            }\n        }\n    }\n    return newTab;\n}\n```\n### get方法\n在我们看完HashMap对于put方法的实现之后，get方法则显得简单易懂，其代码与put相近无几，主要差别是没有了扩容和添加/更新的操作：\n```java\nfinal Node<K,V> getNode(int hash, Object key) {\n    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;\n    //判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在\n    if ((tab = table) != null && (n = tab.length) > 0 &&\n        (first = tab[(n - 1) & hash]) != null) {\n        if (first.hash == hash &&\n            ((k = first.key) == key || (key != null && key.equals(k))))\n            // 检测第一个Node，命中则不需要在做do...while...循环\n            return first;\n        if ((e = first.next) != null) {\n            if (first instanceof TreeNode)\n                //如果Table内是树形结构，则使用对应的检索方法\n                return ((TreeNode<K,V>)first).getTreeNode(hash, key);\n            do { //如果是链表，则做while循环，直到命中或者遍历结束\n                if (e.hash == hash &&\n                    ((k = e.key) == key || (key != null && key.equals(k))))\n                    return e;\n            } while ((e = e.next) != null);\n        }\n    }\n    return null;\n}\n```\n### containsKey方法\n根据get方法的结果是否为空就可以直到是否包含该key：\n```\npublic boolean containsKey(Object key) {\n    return getNode(hash(key), key) != null;\n}\n```\n### remove方法\n同样类似于put操作，首先会查找对应的key所在位置，如果为空，则不操作，反之，将之移除：\n```java\nfinal Node<K,V> removeNode(int hash, Object key, Object value,\n                               boolean matchValue, boolean movable) {\n    Node<K,V>[] tab; Node<K,V> p; int n, index;\n    //判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在\n    if ((tab = table) != null && (n = tab.length) > 0 &&\n        (p = tab[index = (n - 1) & hash]) != null) {\n        Node<K,V> node = null, e; K k; V v;\n        if (p.hash == hash &&\n            ((k = p.key) == key || (key != null && key.equals(k))))\n            // 第一个Node命中\n            node = p;\n        else if ((e = p.next) != null) {\n            if (p instanceof TreeNode)\n                //如果Table内是树形结构，则使用对应的检索方法\n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);\n            else {\n                do { //如果是链表，则做while循环，直到命中或者遍历结束\n                    if (e.hash == hash &&\n                        ((k = e.key) == key ||\n                         (key != null && key.equals(k)))) {\n                        node = e;\n                        break;\n                    }\n                    p = e;\n                } while ((e = e.next) != null);\n            }\n        }\n        if (node != null && (!matchValue || (v = node.value) == value ||\n                             (value != null && value.equals(v)))) {\n            //如果命中到了对应的Node，则根据Node结构进行对应的移除操作\n            if (node instanceof TreeNode)\n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);\n            else if (node == p)\n                tab[index] = node.next;\n            else\n                p.next = node.next;\n            ++modCount;\n            //修改hash表元素数\n            --size;\n            afterNodeRemoval(node);\n            return node;\n        }\n    }\n    return null;\n}\n```\n## 为何线程不安全？\n看完了HashMap的实现之后，就该谈一谈它为什么存在线程安全问题！\n\n### 数据丢失\n首先，我们将目光放在put方法的实现中，假设有两个线程在同时进行put操作，对应的数据分别为：\n```\nthread-1： put(1, 'abc');\nthread-2： put(1, 'efg');\n```\n假设此时Hash表的长度为10，且已经有两个元素在，负载因子为默认值0.75f，那么操作过程一定不会扩容，并且两个线程put的key都是1，那么它们将会分配到同一个table中，下方代码为put方法中的其中一段，其主要作用是遍历当前表内Node，寻找与当前key一样的Node结点，之后再做添加/更新操作。\n```java\nfor (int binCount = 0; ; ++binCount) {\n   if ((e = p.next) == null) {\n       p.next = newNode(hash, key, value, null); // A\n       if (binCount >= TREEIFY_THRESHOLD - 1)\n           treeifyBin(tab, hash);\n       break;\n   }\n   if (e.hash == hash &&\n       ((k = e.key) == key || (key != null && key.equals(k))))\n       break;\n   p = e;\n}\n```\n假设两个线程同时执行到了``A``这个位置，此时获取到的``p``是统一个对象，下一刻，cpu运转，两个线程同时运行，那么``p.next``的值将会是最后一个线程put的value值，而前一个则会丢失，这就会导致丢数据的情况！\n\n当然该情景同样会发生于``resize``和``remove``操作，至于为什么，大家可以思考一下！\n### size不准确\n这个就很简单了，为什么不准确呢，来看一下size变量在HashMap内部的定义：\n```\ntransient int size;\n```\n内存不可见并且增减操作未加锁，多线程操作下属于非原子操作！\n### 闭环死锁\n这个问题在JDK1.8版本的HashMap中已经不存在了，至于为啥，我要先讲一下在1.8之前的HashMap为什么会存在闭环死锁问题！\n\n从``闭环``这个名词上我们分析一下是什么问题，什么是闭环的，如果链表形成了一个环会不会就是闭环呢？而链表如何才会形成环？带着这些问题，我们在脑海中抽象出一个模型：\n```\ngraph LR\nA-->B\nB-->A\n```\n假设某一个Table中的Node链表发生了上述问题，那么我们在遍历时进行``do{ }while ((e = e.next) != null);``操作就会发生死锁的问题，那么看来我们的猜想方向是正确的，那么我们就具体分析一下HashMap在什么操作之中会产生闭环的问题，不过在此之前，我们要明白因果：\n```\n因：???\n果：闭环\n```\n我们知道，只有当两个结点内部的``next``相互引用对方的时候才会死锁，这种场景只能在两个已经存在同一个链上的结点同时以``相反的方向``被操作``next``引用的时候才会发生，而在HashMap内部，符合这种场景的只有一个方法：``resize``，那我们就来看一下JDK1.7的``resize``方法实现：\n```java\nvoid resize(int newCapacity) {\n    Entry[] oldTable = table;\n    int oldCapacity = oldTable.length;\n    if (oldCapacity == MAXIMUM_CAPACITY) {\n        threshold = Integer.MAX_VALUE;\n        return;\n    }\n\n    Entry[] newTable = new Entry[newCapacity];\n    boolean oldAltHashing = useAltHashing;\n    useAltHashing |= sun.misc.VM.isBooted() &&\n            (newCapacity >= Holder.ALTERNATIVE_HASHING_THRESHOLD);\n    boolean rehash = oldAltHashing ^ useAltHashing;\n    //fu\n    transfer(newTable, rehash);\n    table = newTable;\n    threshold = (int)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + 1);\n}\n```\n进入``transfer``方法中，其内部实现了扩容过程：\n```java\nvoid transfer(Entry[] newTable, boolean rehash) {\n    int newCapacity = newTable.length;\n    for (Entry<K,V> e : table) { // A\n        while(null != e) {\n            Entry<K,V> next = e.next;\n            if (rehash) {\n                e.hash = null == e.key ? 0 : hash(e.key);\n            }\n            int i = indexFor(e.hash, newCapacity);\n            e.next = newTable[i];\n            newTable[i] = e;\n            e = next;\n        }\n    }\n}\n```\n我们发现，在JDK1.7的HashMap的扩容实现中，老的Table中的Node链的顺序赋值给新的Table中时的操作是反置的：\n```java\ne.next = newTable[i];\nnewTable[i] = e;\ne = next;\n```\n上述操作是将当前Node的next指针指向当前Table的头结点，之后当前Node又变为了Table的头结点，此时假设A、B两个线程同时执行到了``transfer``方法中的``A``位置，并且此时的``oldTable``和``newTable``的结构是这样的：\n```\noldTable[]\ntable-1: a -> b -> c -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: null\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n如果很巧，两个线程在同一个CPU上执行，那么就会存在一个抢占时间片的场景，假设A先抢到了时间片，然后执行一番操作之后，``oldTable``和``newTable``的结构如下：\n```\noldTable[]\ntable-1: a -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: c -> b -> a\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n之后还没等它做``oldTable = newTable``操作，B抢到了时间片，并也做了同样一番操作，``oldTable``和``newTable``的结构如下：\n```\noldTable[]\ntable-1: a -> null\ntable-2: null\ntable-3: null\n\nnewTable[]\ntable-1: null\ntable-2: a -> c -> b -> a\ntable-3: null\ntable-4: null\ntable-5: null\ntable-6: null\n```\n此时A或者B谁先``oldTable = newTable``已经无所谓了，因为``newTable``中已经产生了闭环，之后在进行get或者put操作时，如果不小心触发到了while循环，那将会一直死循环：\n```java\ndo{\n  //do some thing\n}while ((e = e.next) != null);  //e = e.next将会永不为空\n```\n从上述场景产生的过程中我们发现，``a -> c -> b -> a``这种闭环问题的罪魁祸首是因为1.7中的HashMap在扩容时为了免去再次遍历链表，很聪明的将当前结点作为新链表的头结点，这就会导致顺序反转，所以无序化导致了闭环的产生，而这种问题不仅仅是在HashMap中体现，Mysql的死锁问题的原因常常也是因为反序加行锁导致的！\n\n而在开头说过，JDK1.8已经避免了这个问题，这是为什么呢？看下代码就知道了：\n```java\nelse { // preserve order\n   Node<K,V> loHead = null, loTail = null;\n   Node<K,V> hiHead = null, hiTail = null;\n   Node<K,V> next;\n   do {\n       next = e.next;\n       if ((e.hash & oldCap) == 0) {\n           if (loTail == null)\n               loHead = e;\n           else\n               loTail.next = e;\n           loTail = e;\n       }\n       else {\n           if (hiTail == null)\n               hiHead = e;\n           else\n               hiTail.next = e;\n           hiTail = e;\n       }\n   } while ((e = next) != null);\n   if (loTail != null) {\n       loTail.next = null;\n       newTab[j] = loHead;  //A\n   }\n   if (hiTail != null) {\n       hiTail.next = null;\n       newTab[j + oldCap] = hiHead; //B\n   }\n}\n```\n同样是扩容的操作，JDK1.8中的HashMap通过两个链分别去存储头结点和尾结点以保证它有序，并且不会频繁的去赋值``newTable``，而是在循环之后直接赋值（请注意A、B标记处），这样就非常简单的避免了产生闭环的陷阱！\n","slug":"深入JAVA8的HashMap实现原理","published":1,"updated":"2021-03-21T17:43:04.770Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyg0013b0tz9n3p1jdi","content":"<h2 id=\"引导\"><a class=\"header-anchor\" href=\"#引导\">¶</a>引导</h2>\n<p>在了解<code>HashMap</code>之前，我们应该先明白两个概念：<code>Hash</code>和<code>Map</code>，这可以帮助我们更容易了解<code>HashMap</code>的运行原理。</p>\n<p>那么何为<code>Hash</code>，又何为<code>Map</code>呢？</p>\n<h3 id=\"hash\"><a class=\"header-anchor\" href=\"#hash\">¶</a>Hash</h3>\n<p>之前写过一篇关于Hash的文章 <a href=\"/zh-cn/java/data-structure/hash.md\">Hash</a></p>\n<h3 id=\"map\"><a class=\"header-anchor\" href=\"#map\">¶</a>Map</h3>\n<p>Map是一种<code>K-V</code>形式的数据结构，一个唯一的key，会唯一对应一个value。也就是说，在Map容器里不允许两个一模一样的key。</p>\n<p>一个简单的Map结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key1&quot;:&quot;value1&quot;,</span><br><span class=\"line\">  &quot;key2&quot;:&quot;value2&quot;,</span><br><span class=\"line\">  &quot;key3&quot;:&quot;value3&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于这种数据结构，并且Map会对外提供一些方法来实现对内部数据的操作：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">V put(K key, V value)</span><br><span class=\"line\">V get(Object key)</span><br><span class=\"line\">V remove(Object key)</span><br><span class=\"line\">boolean containsKey(Object key)</span><br></pre></td></tr></table></figure>\n<p>可见Map对于我们操作<code>K-V</code>形式的数据非常方便，实现的方式有很多，最简单粗暴的实现方式是使用<code>List</code>来存储每一个<code>K-V</code>组对，对于每种方法的实现只需要暴力循环碰撞即可，对于少量数据这种做法未必不可，如果数据量庞大之千万，我们就要换一种更加高效，速度更快的实现方式：<code>HashMap</code>。</p>\n<h2 id=\"hashmap\"><a class=\"header-anchor\" href=\"#hashmap\">¶</a>HashMap</h2>\n<p>Map在Java中的实现有很多，<code>HashMap</code>便是其中之一，在<code>JDK</code>漫长的版本更新中，<code>HashMap</code>的实现也是在不断的更新着：</p>\n<ul>\n<li><strong>&lt;=JDK1.7</strong>：Table数组 + Entry链表</li>\n<li><strong>&gt;=JDK1.8</strong>：Table数组 + Entry链表/红黑树</li>\n</ul>\n<p>本文我们跳过JDK1.7的实现，来看一下1.8中<code>HashMap</code>源码所带来的魅力冲击！</p>\n<h3 id=\"实现原理\"><a class=\"header-anchor\" href=\"#实现原理\">¶</a>实现原理</h3>\n<p>对于各个版本的<code>HashMap</code>实现原理，主线流程都是一成不变的：</p>\n<p><img src=\"https://github.com/ainilili/snail/blob/master/docs/images/hashmap-1.8-1-1.jpg?raw=true\" alt=\"hashmap原理流程图\"></p>\n<p>这里有两个数据结构需要我们知道：</p>\n<ul>\n<li><strong>Table</strong>：哈希表，存放Node元素。</li>\n<li><strong>Node</strong>：结点元素，存放<code>K-V</code>组对信息，其结构是一个链表/红黑树。</li>\n</ul>\n<p>另外，在HashMap内部有一些关键属性我们也要了解一下：</p>\n<ul>\n<li><strong>DEFAULT_INITIAL_CAPACITY</strong>：Table数组初始长度，默认为<code>1 &lt;&lt; 4</code>，<code>2^4</code> = 16。</li>\n<li><strong>MAXIMUM_CAPACITY</strong>：Table数组最高长度，默认为<code>1 &lt;&lt; 30</code>，<code>2^30</code> = 1073741824。</li>\n<li><strong>DEFAULT_LOAD_FACTOR</strong>：负载因子，当总元素数 &gt; 数组长度 * 负载因子时，Table数组将会扩容，默认为0.75。</li>\n<li><strong>TREEIFY_THRESHOLD</strong>：树化阈值，当单个Table内Node数量超过该值，则会将链表转化为红黑树，默认为8。</li>\n<li><strong>UNTREEIFY_THRESHOLD</strong>：链化阈值，当扩容期间单个Table内Entry数量小于该值，则将红黑树转化为链表，默认为6。</li>\n<li><strong>MIN_TREEIFY_CAPACITY</strong>：最小树化阈值，当Table所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）。</li>\n<li><strong>size</strong>：Table数组当前所有元素数。</li>\n<li><strong>threshold</strong>：下次扩容的阈值（数组长度 * 负载因子）</li>\n</ul>\n<p>HashMap的内部有着一个Table数组，而这个数组的初始长度为<code>DEFAULT_INITIAL_CAPACITY</code>参数值，Table数组存放的元素类型就是Node，它是一个单向链表：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Node</span>&lt;K,V&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"type\">int</span> hash; <span class=\"comment\">//key的hash值</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> K key;  <span class=\"comment\">//key</span></span><br><span class=\"line\">  V value;  <span class=\"comment\">//value</span></span><br><span class=\"line\">  Node&lt;K,V&gt; next; <span class=\"comment\">//下一个结点</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每个Table中存的Node元素相当于链表的<code>header</code>，<code>next</code>指向下一个结点，而这种链式结构的存在正是为了解决<code>hash冲突</code>：</p>\n<blockquote>\n<p><strong>hash冲突</strong>：两个元素的经过Hash散列之后分在同一个组内，我们将之解释为Hash冲突</p>\n</blockquote>\n<p>在JDK1.7之前的版本，hash冲突的解决方法是将被冲突的Node结点放于一个链表中，而Table中的元素则是链头，当然在JDK1.8中，当Table中链长超过<code>TREEIFY_THRESHOLD</code>阈值后，将会将链表转变为红黑树的实现<code>TreeNode</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; parent;  // red-black tree links</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; left;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; right;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; prev;    // needed to unlink next upon deletion</span><br><span class=\"line\">  boolean red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当发生hash冲突的Node不断变多，那么这个链将会越来越长，那么遍历碰撞key时的耗时就会不断增加，这也就直接导致了性能的不足，从JDK1.8开始，HashMap对于单个Table中的Node超出某个阈值时，将会开始树化操作（链表转化为红黑树），这对于搜索的性能将会有很大的提升，而插入和删除的操作所带来的性能影响微乎其微。</p>\n<h3 id=\"put方法\"><a class=\"header-anchor\" href=\"#put方法\">¶</a>put方法</h3>\n<p>在<code>HashMap</code>的内部会有一个Table数组，这个数组的当前长度就是我们要实现映射的目标范围，当我们执行<code>put</code>方法时，<code>key</code>和<code>value</code>要经历这些事情：</p>\n<ul>\n<li>通过<code>Hash</code>散列获取到对应的Table</li>\n<li>遍历Table下的Node结点，做更新/添加操作</li>\n<li>扩容检测</li>\n</ul>\n<p>具体实现我们可以根据源码来详细了解一下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> V <span class=\"title function_\">putVal</span><span class=\"params\">(<span class=\"type\">int</span> hash, K key, V value, <span class=\"type\">boolean</span> onlyIfAbsent,</span></span><br><span class=\"line\"><span class=\"params\">                   <span class=\"type\">boolean</span> evict)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) == <span class=\"literal\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// HashMap的懒加载策略，当执行put操作时检测Table数组初始化。</span></span><br><span class=\"line\">        n = (tab = resize()).length;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        <span class=\"comment\">//通过``Hash``函数获取到对应的Table，如果当前Table为空，则直接初始化一个新的Node并放入该Table中。</span></span><br><span class=\"line\">        tab[i] = newNode(hash, key, value, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt; e; K k;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">//输入的key命中了当前Table的首元素，直接更新。</span></span><br><span class=\"line\">            e = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">            <span class=\"comment\">//如果当前Node类型为TreeNode，调用``putTreeVal``方法。</span></span><br><span class=\"line\">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"built_in\">this</span>, tab, hash, key, value);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果不是TreeNode，则就是链表，遍历并与输入key做命中碰撞。</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//如果当前Table中不存在当前key，则添加。</span></span><br><span class=\"line\">                    p.next = newNode(hash, key, value, <span class=\"literal\">null</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st</span></span><br><span class=\"line\">                        <span class=\"comment\">//超过了``TREEIFY_THRESHOLD``则转化为红黑树。</span></span><br><span class=\"line\">                        treeifyBin(tab, hash);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"comment\">//做命中碰撞，使用hash、内存和equals同时判断（不同的元素hash可能会一致）。</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                p = e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果命中不为空，更新操作。</span></span><br><span class=\"line\">            <span class=\"type\">V</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> e.value;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                e.value = value;</span><br><span class=\"line\">            afterNodeAccess(e);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ++modCount;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (++size &gt; threshold)</span><br><span class=\"line\">        <span class=\"comment\">//扩容检测。</span></span><br><span class=\"line\">        resize();</span><br><span class=\"line\">    afterNodeInsertion(evict);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于其过程中的关于Node链表和红黑树的转换过程我们可以暂时屏蔽掉，那么整个流程并不是很绕，那么我们继续深入的来看一下HashMap的扩容实现。</p>\n<h3 id=\"resize方法\"><a class=\"header-anchor\" href=\"#resize方法\">¶</a>resize方法</h3>\n<p>HashMap的扩容大致的实现是将老Table数组中所有的Entry取出来，重新对其hashcode做<code>Hash</code>散列到新的新的Table之中，也就是一个<code>re-put</code>的过程，具体还是通过源码来讲解：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class=\"line\">    <span class=\"comment\">//保留老的hash表</span></span><br><span class=\"line\">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCap</span> <span class=\"operator\">=</span> (oldTab == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldThr</span> <span class=\"operator\">=</span> threshold;</span><br><span class=\"line\">    <span class=\"type\">int</span> newCap, newThr = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">//如果之前的容量大于0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果超出最大容量</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//扩容阈值为int最大值</span></span><br><span class=\"line\">            threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldTab;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//否则计算扩容后的阈值</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class=\"line\">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class=\"line\">            newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 如果之前的容量等于0，并且之前的阈值大于零，则新的hash表长度就等于它</span></span><br><span class=\"line\">        newCap = oldThr;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;              </span><br><span class=\"line\">        <span class=\"comment\">// 初始阈值为零表示使用默认值</span></span><br><span class=\"line\">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class=\"line\">        newThr = (<span class=\"type\">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//如果新的阈值为 0 ，就得用 新容量*加载因子 重计算一次</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">float</span> <span class=\"variable\">ft</span> <span class=\"operator\">=</span> (<span class=\"type\">float</span>)newCap * loadFactor;</span><br><span class=\"line\">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"type\">float</span>)MAXIMUM_CAPACITY ?</span><br><span class=\"line\">                  (<span class=\"type\">int</span>)ft : Integer.MAX_VALUE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    threshold = newThr;</span><br><span class=\"line\">    <span class=\"comment\">//常见扩容后的hash表</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>[newCap];</span><br><span class=\"line\">    table = newTab; <span class=\"comment\">//A</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldTab != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//遍历旧的hash表，将之内部元素转移到新的hash表</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class=\"line\">            Node&lt;K,V&gt; e;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                oldTab[j] = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.next == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                    <span class=\"comment\">//如果当前Table内只有一个元素，重新做hash散列并赋值</span></span><br><span class=\"line\">                    newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e; <span class=\"comment\">//B</span></span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                    <span class=\"comment\">//如果旧哈希表中这个位置的桶是树形结构，就要把新哈希表里当前桶也变成树形结构</span></span><br><span class=\"line\">                    ((TreeNode&lt;K,V&gt;)e).split(<span class=\"built_in\">this</span>, newTab, j, oldCap);</span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//保留旧哈希表桶中链表的顺序</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                    Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                    Node&lt;K,V&gt; next;</span><br><span class=\"line\">                    <span class=\"keyword\">do</span> &#123;  <span class=\"comment\">//遍历当前Table内的Node，赋值给新的Table</span></span><br><span class=\"line\">                        next = e.next;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                                loHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span></span><br><span class=\"line\">                                loTail.next = e;</span><br><span class=\"line\">                            loTail = e;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                                hiHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span></span><br><span class=\"line\">                                hiTail.next = e;</span><br><span class=\"line\">                            hiTail = e;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        loTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                        newTab[j] = loHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        hiTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                        newTab[j + oldCap] = hiHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> newTab;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"get方法\"><a class=\"header-anchor\" href=\"#get方法\">¶</a>get方法</h3>\n<p>在我们看完HashMap对于put方法的实现之后，get方法则显得简单易懂，其代码与put相近无几，主要差别是没有了扩容和添加/更新的操作：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">getNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class=\"type\">int</span> n; K k;</span><br><span class=\"line\">    <span class=\"comment\">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">        (first = tab[(n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = first.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">// 检测第一个Node，命中则不需要在做do...while...循环</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> first;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e = first.next) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (first <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                <span class=\"comment\">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class=\"line\">            <span class=\"keyword\">do</span> &#123; <span class=\"comment\">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"containskey方法\"><a class=\"header-anchor\" href=\"#containskey方法\">¶</a>containsKey方法</h3>\n<p>根据get方法的结果是否为空就可以直到是否包含该key：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public boolean containsKey(Object key) &#123;</span><br><span class=\"line\">    return getNode(hash(key), key) != null;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"remove方法\"><a class=\"header-anchor\" href=\"#remove方法\">¶</a>remove方法</h3>\n<p>同样类似于put操作，首先会查找对应的key所在位置，如果为空，则不操作，反之，将之移除：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">removeNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key, Object value,</span></span><br><span class=\"line\"><span class=\"params\">                               <span class=\"type\">boolean</span> matchValue, <span class=\"type\">boolean</span> movable)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, index;</span><br><span class=\"line\">    <span class=\"comment\">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">        (p = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt; node = <span class=\"literal\">null</span>, e; K k; V v;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">// 第一个Node命中</span></span><br><span class=\"line\">            node = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = p.next) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                <span class=\"comment\">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class=\"line\">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123; <span class=\"comment\">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                        ((k = e.key) == key ||</span><br><span class=\"line\">                         (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class=\"line\">                        node = e;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    p = e;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (node != <span class=\"literal\">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class=\"line\">                             (value != <span class=\"literal\">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果命中到了对应的Node，则根据Node结构进行对应的移除操作</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class=\"built_in\">this</span>, tab, movable);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (node == p)</span><br><span class=\"line\">                tab[index] = node.next;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                p.next = node.next;</span><br><span class=\"line\">            ++modCount;</span><br><span class=\"line\">            <span class=\"comment\">//修改hash表元素数</span></span><br><span class=\"line\">            --size;</span><br><span class=\"line\">            afterNodeRemoval(node);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> node;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"为何线程不安全？\"><a class=\"header-anchor\" href=\"#为何线程不安全？\">¶</a>为何线程不安全？</h2>\n<p>看完了HashMap的实现之后，就该谈一谈它为什么存在线程安全问题！</p>\n<h3 id=\"数据丢失\"><a class=\"header-anchor\" href=\"#数据丢失\">¶</a>数据丢失</h3>\n<p>首先，我们将目光放在put方法的实现中，假设有两个线程在同时进行put操作，对应的数据分别为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">thread-1： put(1, &#x27;abc&#x27;);</span><br><span class=\"line\">thread-2： put(1, &#x27;efg&#x27;);</span><br></pre></td></tr></table></figure>\n<p>假设此时Hash表的长度为10，且已经有两个元素在，负载因子为默认值0.75f，那么操作过程一定不会扩容，并且两个线程put的key都是1，那么它们将会分配到同一个table中，下方代码为put方法中的其中一段，其主要作用是遍历当前表内Node，寻找与当前key一样的Node结点，之后再做添加/更新操作。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       p.next = newNode(hash, key, value, <span class=\"literal\">null</span>); <span class=\"comment\">// A</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>)</span><br><span class=\"line\">           treeifyBin(tab, hash);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">       ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   p = e;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>假设两个线程同时执行到了<code>A</code>这个位置，此时获取到的<code>p</code>是统一个对象，下一刻，cpu运转，两个线程同时运行，那么<code>p.next</code>的值将会是最后一个线程put的value值，而前一个则会丢失，这就会导致丢数据的情况！</p>\n<p>当然该情景同样会发生于<code>resize</code>和<code>remove</code>操作，至于为什么，大家可以思考一下！</p>\n<h3 id=\"size不准确\"><a class=\"header-anchor\" href=\"#size不准确\">¶</a>size不准确</h3>\n<p>这个就很简单了，为什么不准确呢，来看一下size变量在HashMap内部的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">transient int size;</span><br></pre></td></tr></table></figure>\n<p>内存不可见并且增减操作未加锁，多线程操作下属于非原子操作！</p>\n<h3 id=\"闭环死锁\"><a class=\"header-anchor\" href=\"#闭环死锁\">¶</a>闭环死锁</h3>\n<p>这个问题在JDK1.8版本的HashMap中已经不存在了，至于为啥，我要先讲一下在1.8之前的HashMap为什么会存在闭环死锁问题！</p>\n<p>从<code>闭环</code>这个名词上我们分析一下是什么问题，什么是闭环的，如果链表形成了一个环会不会就是闭环呢？而链表如何才会形成环？带着这些问题，我们在脑海中抽象出一个模型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">graph LR</span><br><span class=\"line\">A--&gt;B</span><br><span class=\"line\">B--&gt;A</span><br></pre></td></tr></table></figure>\n<p>假设某一个Table中的Node链表发生了上述问题，那么我们在遍历时进行<code>do&#123; &#125;while ((e = e.next) != null);</code>操作就会发生死锁的问题，那么看来我们的猜想方向是正确的，那么我们就具体分析一下HashMap在什么操作之中会产生闭环的问题，不过在此之前，我们要明白因果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">因：???</span><br><span class=\"line\">果：闭环</span><br></pre></td></tr></table></figure>\n<p>我们知道，只有当两个结点内部的<code>next</code>相互引用对方的时候才会死锁，这种场景只能在两个已经存在同一个链上的结点同时以<code>相反的方向</code>被操作<code>next</code>引用的时候才会发生，而在HashMap内部，符合这种场景的只有一个方法：<code>resize</code>，那我们就来看一下JDK1.7的<code>resize</code>方法实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">resize</span><span class=\"params\">(<span class=\"type\">int</span> newCapacity)</span> &#123;</span><br><span class=\"line\">    Entry[] oldTable = table;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCapacity</span> <span class=\"operator\">=</span> oldTable.length;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">        threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Entry[] newTable = <span class=\"keyword\">new</span> <span class=\"title class_\">Entry</span>[newCapacity];</span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">oldAltHashing</span> <span class=\"operator\">=</span> useAltHashing;</span><br><span class=\"line\">    useAltHashing |= sun.misc.VM.isBooted() &amp;&amp;</span><br><span class=\"line\">            (newCapacity &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD);</span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">rehash</span> <span class=\"operator\">=</span> oldAltHashing ^ useAltHashing;</span><br><span class=\"line\">    <span class=\"comment\">//fu</span></span><br><span class=\"line\">    transfer(newTable, rehash);</span><br><span class=\"line\">    table = newTable;</span><br><span class=\"line\">    threshold = (<span class=\"type\">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>进入<code>transfer</code>方法中，其内部实现了扩容过程：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">transfer</span><span class=\"params\">(Entry[] newTable, <span class=\"type\">boolean</span> rehash)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">newCapacity</span> <span class=\"operator\">=</span> newTable.length;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Entry&lt;K,V&gt; e : table) &#123; <span class=\"comment\">// A</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(<span class=\"literal\">null</span> != e) &#123;</span><br><span class=\"line\">            Entry&lt;K,V&gt; next = e.next;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (rehash) &#123;</span><br><span class=\"line\">                e.hash = <span class=\"literal\">null</span> == e.key ? <span class=\"number\">0</span> : hash(e.key);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> indexFor(e.hash, newCapacity);</span><br><span class=\"line\">            e.next = newTable[i];</span><br><span class=\"line\">            newTable[i] = e;</span><br><span class=\"line\">            e = next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们发现，在JDK1.7的HashMap的扩容实现中，老的Table中的Node链的顺序赋值给新的Table中时的操作是反置的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">e.next = newTable[i];</span><br><span class=\"line\">newTable[i] = e;</span><br><span class=\"line\">e = next;</span><br></pre></td></tr></table></figure>\n<p>上述操作是将当前Node的next指针指向当前Table的头结点，之后当前Node又变为了Table的头结点，此时假设A、B两个线程同时执行到了<code>transfer</code>方法中的<code>A</code>位置，并且此时的<code>oldTable</code>和<code>newTable</code>的结构是这样的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; b -&gt; c -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>如果很巧，两个线程在同一个CPU上执行，那么就会存在一个抢占时间片的场景，假设A先抢到了时间片，然后执行一番操作之后，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: c -&gt; b -&gt; a</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>之后还没等它做<code>oldTable = newTable</code>操作，B抢到了时间片，并也做了同样一番操作，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: a -&gt; c -&gt; b -&gt; a</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>此时A或者B谁先<code>oldTable = newTable</code>已经无所谓了，因为<code>newTable</code>中已经产生了闭环，之后在进行get或者put操作时，如果不小心触发到了while循环，那将会一直死循环：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">do</span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//do some thing</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);  <span class=\"comment\">//e = e.next将会永不为空</span></span><br></pre></td></tr></table></figure>\n<p>从上述场景产生的过程中我们发现，<code>a -&gt; c -&gt; b -&gt; a</code>这种闭环问题的罪魁祸首是因为1.7中的HashMap在扩容时为了免去再次遍历链表，很聪明的将当前结点作为新链表的头结点，这就会导致顺序反转，所以无序化导致了闭环的产生，而这种问题不仅仅是在HashMap中体现，Mysql的死锁问题的原因常常也是因为反序加行锁导致的！</p>\n<p>而在开头说过，JDK1.8已经避免了这个问题，这是为什么呢？看下代码就知道了：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order</span></span><br><span class=\"line\">   Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">   Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">   Node&lt;K,V&gt; next;</span><br><span class=\"line\">   <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">       next = e.next;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">               loHead = e;</span><br><span class=\"line\">           <span class=\"keyword\">else</span></span><br><span class=\"line\">               loTail.next = e;</span><br><span class=\"line\">           loTail = e;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">               hiHead = e;</span><br><span class=\"line\">           <span class=\"keyword\">else</span></span><br><span class=\"line\">               hiTail.next = e;</span><br><span class=\"line\">           hiTail = e;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       loTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">       newTab[j] = loHead;  <span class=\"comment\">//A</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       hiTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">       newTab[j + oldCap] = hiHead; <span class=\"comment\">//B</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同样是扩容的操作，JDK1.8中的HashMap通过两个链分别去存储头结点和尾结点以保证它有序，并且不会频繁的去赋值<code>newTable</code>，而是在循环之后直接赋值（请注意A、B标记处），这样就非常简单的避免了产生闭环的陷阱！</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"引导\"><a class=\"header-anchor\" href=\"#引导\">¶</a>引导</h2>\n<p>在了解<code>HashMap</code>之前，我们应该先明白两个概念：<code>Hash</code>和<code>Map</code>，这可以帮助我们更容易了解<code>HashMap</code>的运行原理。</p>\n<p>那么何为<code>Hash</code>，又何为<code>Map</code>呢？</p>\n<h3 id=\"hash\"><a class=\"header-anchor\" href=\"#hash\">¶</a>Hash</h3>\n<p>之前写过一篇关于Hash的文章 <a href=\"/zh-cn/java/data-structure/hash.md\">Hash</a></p>\n<h3 id=\"map\"><a class=\"header-anchor\" href=\"#map\">¶</a>Map</h3>\n<p>Map是一种<code>K-V</code>形式的数据结构，一个唯一的key，会唯一对应一个value。也就是说，在Map容器里不允许两个一模一样的key。</p>\n<p>一个简单的Map结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key1&quot;:&quot;value1&quot;,</span><br><span class=\"line\">  &quot;key2&quot;:&quot;value2&quot;,</span><br><span class=\"line\">  &quot;key3&quot;:&quot;value3&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于这种数据结构，并且Map会对外提供一些方法来实现对内部数据的操作：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">V put(K key, V value)</span><br><span class=\"line\">V get(Object key)</span><br><span class=\"line\">V remove(Object key)</span><br><span class=\"line\">boolean containsKey(Object key)</span><br></pre></td></tr></table></figure>\n<p>可见Map对于我们操作<code>K-V</code>形式的数据非常方便，实现的方式有很多，最简单粗暴的实现方式是使用<code>List</code>来存储每一个<code>K-V</code>组对，对于每种方法的实现只需要暴力循环碰撞即可，对于少量数据这种做法未必不可，如果数据量庞大之千万，我们就要换一种更加高效，速度更快的实现方式：<code>HashMap</code>。</p>\n<h2 id=\"hashmap\"><a class=\"header-anchor\" href=\"#hashmap\">¶</a>HashMap</h2>\n<p>Map在Java中的实现有很多，<code>HashMap</code>便是其中之一，在<code>JDK</code>漫长的版本更新中，<code>HashMap</code>的实现也是在不断的更新着：</p>\n<ul>\n<li><strong>&lt;=JDK1.7</strong>：Table数组 + Entry链表</li>\n<li><strong>&gt;=JDK1.8</strong>：Table数组 + Entry链表/红黑树</li>\n</ul>\n<p>本文我们跳过JDK1.7的实现，来看一下1.8中<code>HashMap</code>源码所带来的魅力冲击！</p>\n<h3 id=\"实现原理\"><a class=\"header-anchor\" href=\"#实现原理\">¶</a>实现原理</h3>\n<p>对于各个版本的<code>HashMap</code>实现原理，主线流程都是一成不变的：</p>\n<p><img src=\"https://github.com/ainilili/snail/blob/master/docs/images/hashmap-1.8-1-1.jpg?raw=true\" alt=\"hashmap原理流程图\"></p>\n<p>这里有两个数据结构需要我们知道：</p>\n<ul>\n<li><strong>Table</strong>：哈希表，存放Node元素。</li>\n<li><strong>Node</strong>：结点元素，存放<code>K-V</code>组对信息，其结构是一个链表/红黑树。</li>\n</ul>\n<p>另外，在HashMap内部有一些关键属性我们也要了解一下：</p>\n<ul>\n<li><strong>DEFAULT_INITIAL_CAPACITY</strong>：Table数组初始长度，默认为<code>1 &lt;&lt; 4</code>，<code>2^4</code> = 16。</li>\n<li><strong>MAXIMUM_CAPACITY</strong>：Table数组最高长度，默认为<code>1 &lt;&lt; 30</code>，<code>2^30</code> = 1073741824。</li>\n<li><strong>DEFAULT_LOAD_FACTOR</strong>：负载因子，当总元素数 &gt; 数组长度 * 负载因子时，Table数组将会扩容，默认为0.75。</li>\n<li><strong>TREEIFY_THRESHOLD</strong>：树化阈值，当单个Table内Node数量超过该值，则会将链表转化为红黑树，默认为8。</li>\n<li><strong>UNTREEIFY_THRESHOLD</strong>：链化阈值，当扩容期间单个Table内Entry数量小于该值，则将红黑树转化为链表，默认为6。</li>\n<li><strong>MIN_TREEIFY_CAPACITY</strong>：最小树化阈值，当Table所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）。</li>\n<li><strong>size</strong>：Table数组当前所有元素数。</li>\n<li><strong>threshold</strong>：下次扩容的阈值（数组长度 * 负载因子）</li>\n</ul>\n<p>HashMap的内部有着一个Table数组，而这个数组的初始长度为<code>DEFAULT_INITIAL_CAPACITY</code>参数值，Table数组存放的元素类型就是Node，它是一个单向链表：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Node</span>&lt;K,V&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"type\">int</span> hash; <span class=\"comment\">//key的hash值</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> K key;  <span class=\"comment\">//key</span></span><br><span class=\"line\">  V value;  <span class=\"comment\">//value</span></span><br><span class=\"line\">  Node&lt;K,V&gt; next; <span class=\"comment\">//下一个结点</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每个Table中存的Node元素相当于链表的<code>header</code>，<code>next</code>指向下一个结点，而这种链式结构的存在正是为了解决<code>hash冲突</code>：</p>\n<blockquote>\n<p><strong>hash冲突</strong>：两个元素的经过Hash散列之后分在同一个组内，我们将之解释为Hash冲突</p>\n</blockquote>\n<p>在JDK1.7之前的版本，hash冲突的解决方法是将被冲突的Node结点放于一个链表中，而Table中的元素则是链头，当然在JDK1.8中，当Table中链长超过<code>TREEIFY_THRESHOLD</code>阈值后，将会将链表转变为红黑树的实现<code>TreeNode</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; parent;  // red-black tree links</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; left;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; right;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; prev;    // needed to unlink next upon deletion</span><br><span class=\"line\">  boolean red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当发生hash冲突的Node不断变多，那么这个链将会越来越长，那么遍历碰撞key时的耗时就会不断增加，这也就直接导致了性能的不足，从JDK1.8开始，HashMap对于单个Table中的Node超出某个阈值时，将会开始树化操作（链表转化为红黑树），这对于搜索的性能将会有很大的提升，而插入和删除的操作所带来的性能影响微乎其微。</p>\n<h3 id=\"put方法\"><a class=\"header-anchor\" href=\"#put方法\">¶</a>put方法</h3>\n<p>在<code>HashMap</code>的内部会有一个Table数组，这个数组的当前长度就是我们要实现映射的目标范围，当我们执行<code>put</code>方法时，<code>key</code>和<code>value</code>要经历这些事情：</p>\n<ul>\n<li>通过<code>Hash</code>散列获取到对应的Table</li>\n<li>遍历Table下的Node结点，做更新/添加操作</li>\n<li>扩容检测</li>\n</ul>\n<p>具体实现我们可以根据源码来详细了解一下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> V <span class=\"title function_\">putVal</span><span class=\"params\">(<span class=\"type\">int</span> hash, K key, V value, <span class=\"type\">boolean</span> onlyIfAbsent,</span></span><br><span class=\"line\"><span class=\"params\">                   <span class=\"type\">boolean</span> evict)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) == <span class=\"literal\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// HashMap的懒加载策略，当执行put操作时检测Table数组初始化。</span></span><br><span class=\"line\">        n = (tab = resize()).length;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        <span class=\"comment\">//通过``Hash``函数获取到对应的Table，如果当前Table为空，则直接初始化一个新的Node并放入该Table中。</span></span><br><span class=\"line\">        tab[i] = newNode(hash, key, value, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt; e; K k;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">//输入的key命中了当前Table的首元素，直接更新。</span></span><br><span class=\"line\">            e = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">            <span class=\"comment\">//如果当前Node类型为TreeNode，调用``putTreeVal``方法。</span></span><br><span class=\"line\">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"built_in\">this</span>, tab, hash, key, value);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果不是TreeNode，则就是链表，遍历并与输入key做命中碰撞。</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//如果当前Table中不存在当前key，则添加。</span></span><br><span class=\"line\">                    p.next = newNode(hash, key, value, <span class=\"literal\">null</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st</span></span><br><span class=\"line\">                        <span class=\"comment\">//超过了``TREEIFY_THRESHOLD``则转化为红黑树。</span></span><br><span class=\"line\">                        treeifyBin(tab, hash);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"comment\">//做命中碰撞，使用hash、内存和equals同时判断（不同的元素hash可能会一致）。</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                p = e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果命中不为空，更新操作。</span></span><br><span class=\"line\">            <span class=\"type\">V</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> e.value;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                e.value = value;</span><br><span class=\"line\">            afterNodeAccess(e);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ++modCount;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (++size &gt; threshold)</span><br><span class=\"line\">        <span class=\"comment\">//扩容检测。</span></span><br><span class=\"line\">        resize();</span><br><span class=\"line\">    afterNodeInsertion(evict);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于其过程中的关于Node链表和红黑树的转换过程我们可以暂时屏蔽掉，那么整个流程并不是很绕，那么我们继续深入的来看一下HashMap的扩容实现。</p>\n<h3 id=\"resize方法\"><a class=\"header-anchor\" href=\"#resize方法\">¶</a>resize方法</h3>\n<p>HashMap的扩容大致的实现是将老Table数组中所有的Entry取出来，重新对其hashcode做<code>Hash</code>散列到新的新的Table之中，也就是一个<code>re-put</code>的过程，具体还是通过源码来讲解：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class=\"line\">    <span class=\"comment\">//保留老的hash表</span></span><br><span class=\"line\">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCap</span> <span class=\"operator\">=</span> (oldTab == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldThr</span> <span class=\"operator\">=</span> threshold;</span><br><span class=\"line\">    <span class=\"type\">int</span> newCap, newThr = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">//如果之前的容量大于0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果超出最大容量</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//扩容阈值为int最大值</span></span><br><span class=\"line\">            threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldTab;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//否则计算扩容后的阈值</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class=\"line\">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class=\"line\">            newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 如果之前的容量等于0，并且之前的阈值大于零，则新的hash表长度就等于它</span></span><br><span class=\"line\">        newCap = oldThr;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;              </span><br><span class=\"line\">        <span class=\"comment\">// 初始阈值为零表示使用默认值</span></span><br><span class=\"line\">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class=\"line\">        newThr = (<span class=\"type\">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//如果新的阈值为 0 ，就得用 新容量*加载因子 重计算一次</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">float</span> <span class=\"variable\">ft</span> <span class=\"operator\">=</span> (<span class=\"type\">float</span>)newCap * loadFactor;</span><br><span class=\"line\">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"type\">float</span>)MAXIMUM_CAPACITY ?</span><br><span class=\"line\">                  (<span class=\"type\">int</span>)ft : Integer.MAX_VALUE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    threshold = newThr;</span><br><span class=\"line\">    <span class=\"comment\">//常见扩容后的hash表</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>[newCap];</span><br><span class=\"line\">    table = newTab; <span class=\"comment\">//A</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldTab != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//遍历旧的hash表，将之内部元素转移到新的hash表</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class=\"line\">            Node&lt;K,V&gt; e;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                oldTab[j] = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.next == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                    <span class=\"comment\">//如果当前Table内只有一个元素，重新做hash散列并赋值</span></span><br><span class=\"line\">                    newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e; <span class=\"comment\">//B</span></span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                    <span class=\"comment\">//如果旧哈希表中这个位置的桶是树形结构，就要把新哈希表里当前桶也变成树形结构</span></span><br><span class=\"line\">                    ((TreeNode&lt;K,V&gt;)e).split(<span class=\"built_in\">this</span>, newTab, j, oldCap);</span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//保留旧哈希表桶中链表的顺序</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                    Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                    Node&lt;K,V&gt; next;</span><br><span class=\"line\">                    <span class=\"keyword\">do</span> &#123;  <span class=\"comment\">//遍历当前Table内的Node，赋值给新的Table</span></span><br><span class=\"line\">                        next = e.next;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                                loHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span></span><br><span class=\"line\">                                loTail.next = e;</span><br><span class=\"line\">                            loTail = e;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">                                hiHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span></span><br><span class=\"line\">                                hiTail.next = e;</span><br><span class=\"line\">                            hiTail = e;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        loTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                        newTab[j] = loHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        hiTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                        newTab[j + oldCap] = hiHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> newTab;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"get方法\"><a class=\"header-anchor\" href=\"#get方法\">¶</a>get方法</h3>\n<p>在我们看完HashMap对于put方法的实现之后，get方法则显得简单易懂，其代码与put相近无几，主要差别是没有了扩容和添加/更新的操作：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">getNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class=\"type\">int</span> n; K k;</span><br><span class=\"line\">    <span class=\"comment\">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">        (first = tab[(n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = first.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">// 检测第一个Node，命中则不需要在做do...while...循环</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> first;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e = first.next) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (first <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                <span class=\"comment\">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class=\"line\">            <span class=\"keyword\">do</span> &#123; <span class=\"comment\">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"containskey方法\"><a class=\"header-anchor\" href=\"#containskey方法\">¶</a>containsKey方法</h3>\n<p>根据get方法的结果是否为空就可以直到是否包含该key：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public boolean containsKey(Object key) &#123;</span><br><span class=\"line\">    return getNode(hash(key), key) != null;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"remove方法\"><a class=\"header-anchor\" href=\"#remove方法\">¶</a>remove方法</h3>\n<p>同样类似于put操作，首先会查找对应的key所在位置，如果为空，则不操作，反之，将之移除：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">removeNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key, Object value,</span></span><br><span class=\"line\"><span class=\"params\">                               <span class=\"type\">boolean</span> matchValue, <span class=\"type\">boolean</span> movable)</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, index;</span><br><span class=\"line\">    <span class=\"comment\">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">        (p = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt; node = <span class=\"literal\">null</span>, e; K k; V v;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"comment\">// 第一个Node命中</span></span><br><span class=\"line\">            node = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = p.next) != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                <span class=\"comment\">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class=\"line\">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123; <span class=\"comment\">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                        ((k = e.key) == key ||</span><br><span class=\"line\">                         (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class=\"line\">                        node = e;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    p = e;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (node != <span class=\"literal\">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class=\"line\">                             (value != <span class=\"literal\">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//如果命中到了对应的Node，则根据Node结构进行对应的移除操作</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class=\"built_in\">this</span>, tab, movable);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (node == p)</span><br><span class=\"line\">                tab[index] = node.next;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                p.next = node.next;</span><br><span class=\"line\">            ++modCount;</span><br><span class=\"line\">            <span class=\"comment\">//修改hash表元素数</span></span><br><span class=\"line\">            --size;</span><br><span class=\"line\">            afterNodeRemoval(node);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> node;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"为何线程不安全？\"><a class=\"header-anchor\" href=\"#为何线程不安全？\">¶</a>为何线程不安全？</h2>\n<p>看完了HashMap的实现之后，就该谈一谈它为什么存在线程安全问题！</p>\n<h3 id=\"数据丢失\"><a class=\"header-anchor\" href=\"#数据丢失\">¶</a>数据丢失</h3>\n<p>首先，我们将目光放在put方法的实现中，假设有两个线程在同时进行put操作，对应的数据分别为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">thread-1： put(1, &#x27;abc&#x27;);</span><br><span class=\"line\">thread-2： put(1, &#x27;efg&#x27;);</span><br></pre></td></tr></table></figure>\n<p>假设此时Hash表的长度为10，且已经有两个元素在，负载因子为默认值0.75f，那么操作过程一定不会扩容，并且两个线程put的key都是1，那么它们将会分配到同一个table中，下方代码为put方法中的其中一段，其主要作用是遍历当前表内Node，寻找与当前key一样的Node结点，之后再做添加/更新操作。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       p.next = newNode(hash, key, value, <span class=\"literal\">null</span>); <span class=\"comment\">// A</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>)</span><br><span class=\"line\">           treeifyBin(tab, hash);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">       ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   p = e;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>假设两个线程同时执行到了<code>A</code>这个位置，此时获取到的<code>p</code>是统一个对象，下一刻，cpu运转，两个线程同时运行，那么<code>p.next</code>的值将会是最后一个线程put的value值，而前一个则会丢失，这就会导致丢数据的情况！</p>\n<p>当然该情景同样会发生于<code>resize</code>和<code>remove</code>操作，至于为什么，大家可以思考一下！</p>\n<h3 id=\"size不准确\"><a class=\"header-anchor\" href=\"#size不准确\">¶</a>size不准确</h3>\n<p>这个就很简单了，为什么不准确呢，来看一下size变量在HashMap内部的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">transient int size;</span><br></pre></td></tr></table></figure>\n<p>内存不可见并且增减操作未加锁，多线程操作下属于非原子操作！</p>\n<h3 id=\"闭环死锁\"><a class=\"header-anchor\" href=\"#闭环死锁\">¶</a>闭环死锁</h3>\n<p>这个问题在JDK1.8版本的HashMap中已经不存在了，至于为啥，我要先讲一下在1.8之前的HashMap为什么会存在闭环死锁问题！</p>\n<p>从<code>闭环</code>这个名词上我们分析一下是什么问题，什么是闭环的，如果链表形成了一个环会不会就是闭环呢？而链表如何才会形成环？带着这些问题，我们在脑海中抽象出一个模型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">graph LR</span><br><span class=\"line\">A--&gt;B</span><br><span class=\"line\">B--&gt;A</span><br></pre></td></tr></table></figure>\n<p>假设某一个Table中的Node链表发生了上述问题，那么我们在遍历时进行<code>do&#123; &#125;while ((e = e.next) != null);</code>操作就会发生死锁的问题，那么看来我们的猜想方向是正确的，那么我们就具体分析一下HashMap在什么操作之中会产生闭环的问题，不过在此之前，我们要明白因果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">因：???</span><br><span class=\"line\">果：闭环</span><br></pre></td></tr></table></figure>\n<p>我们知道，只有当两个结点内部的<code>next</code>相互引用对方的时候才会死锁，这种场景只能在两个已经存在同一个链上的结点同时以<code>相反的方向</code>被操作<code>next</code>引用的时候才会发生，而在HashMap内部，符合这种场景的只有一个方法：<code>resize</code>，那我们就来看一下JDK1.7的<code>resize</code>方法实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">resize</span><span class=\"params\">(<span class=\"type\">int</span> newCapacity)</span> &#123;</span><br><span class=\"line\">    Entry[] oldTable = table;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCapacity</span> <span class=\"operator\">=</span> oldTable.length;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">        threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Entry[] newTable = <span class=\"keyword\">new</span> <span class=\"title class_\">Entry</span>[newCapacity];</span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">oldAltHashing</span> <span class=\"operator\">=</span> useAltHashing;</span><br><span class=\"line\">    useAltHashing |= sun.misc.VM.isBooted() &amp;&amp;</span><br><span class=\"line\">            (newCapacity &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD);</span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">rehash</span> <span class=\"operator\">=</span> oldAltHashing ^ useAltHashing;</span><br><span class=\"line\">    <span class=\"comment\">//fu</span></span><br><span class=\"line\">    transfer(newTable, rehash);</span><br><span class=\"line\">    table = newTable;</span><br><span class=\"line\">    threshold = (<span class=\"type\">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>进入<code>transfer</code>方法中，其内部实现了扩容过程：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">transfer</span><span class=\"params\">(Entry[] newTable, <span class=\"type\">boolean</span> rehash)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">newCapacity</span> <span class=\"operator\">=</span> newTable.length;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Entry&lt;K,V&gt; e : table) &#123; <span class=\"comment\">// A</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(<span class=\"literal\">null</span> != e) &#123;</span><br><span class=\"line\">            Entry&lt;K,V&gt; next = e.next;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (rehash) &#123;</span><br><span class=\"line\">                e.hash = <span class=\"literal\">null</span> == e.key ? <span class=\"number\">0</span> : hash(e.key);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> indexFor(e.hash, newCapacity);</span><br><span class=\"line\">            e.next = newTable[i];</span><br><span class=\"line\">            newTable[i] = e;</span><br><span class=\"line\">            e = next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们发现，在JDK1.7的HashMap的扩容实现中，老的Table中的Node链的顺序赋值给新的Table中时的操作是反置的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">e.next = newTable[i];</span><br><span class=\"line\">newTable[i] = e;</span><br><span class=\"line\">e = next;</span><br></pre></td></tr></table></figure>\n<p>上述操作是将当前Node的next指针指向当前Table的头结点，之后当前Node又变为了Table的头结点，此时假设A、B两个线程同时执行到了<code>transfer</code>方法中的<code>A</code>位置，并且此时的<code>oldTable</code>和<code>newTable</code>的结构是这样的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; b -&gt; c -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>如果很巧，两个线程在同一个CPU上执行，那么就会存在一个抢占时间片的场景，假设A先抢到了时间片，然后执行一番操作之后，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: c -&gt; b -&gt; a</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>之后还没等它做<code>oldTable = newTable</code>操作，B抢到了时间片，并也做了同样一番操作，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oldTable[]</span><br><span class=\"line\">table-1: a -&gt; null</span><br><span class=\"line\">table-2: null</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\"></span><br><span class=\"line\">newTable[]</span><br><span class=\"line\">table-1: null</span><br><span class=\"line\">table-2: a -&gt; c -&gt; b -&gt; a</span><br><span class=\"line\">table-3: null</span><br><span class=\"line\">table-4: null</span><br><span class=\"line\">table-5: null</span><br><span class=\"line\">table-6: null</span><br></pre></td></tr></table></figure>\n<p>此时A或者B谁先<code>oldTable = newTable</code>已经无所谓了，因为<code>newTable</code>中已经产生了闭环，之后在进行get或者put操作时，如果不小心触发到了while循环，那将会一直死循环：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">do</span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//do some thing</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);  <span class=\"comment\">//e = e.next将会永不为空</span></span><br></pre></td></tr></table></figure>\n<p>从上述场景产生的过程中我们发现，<code>a -&gt; c -&gt; b -&gt; a</code>这种闭环问题的罪魁祸首是因为1.7中的HashMap在扩容时为了免去再次遍历链表，很聪明的将当前结点作为新链表的头结点，这就会导致顺序反转，所以无序化导致了闭环的产生，而这种问题不仅仅是在HashMap中体现，Mysql的死锁问题的原因常常也是因为反序加行锁导致的！</p>\n<p>而在开头说过，JDK1.8已经避免了这个问题，这是为什么呢？看下代码就知道了：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order</span></span><br><span class=\"line\">   Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">   Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;</span><br><span class=\"line\">   Node&lt;K,V&gt; next;</span><br><span class=\"line\">   <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">       next = e.next;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">               loHead = e;</span><br><span class=\"line\">           <span class=\"keyword\">else</span></span><br><span class=\"line\">               loTail.next = e;</span><br><span class=\"line\">           loTail = e;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)</span><br><span class=\"line\">               hiHead = e;</span><br><span class=\"line\">           <span class=\"keyword\">else</span></span><br><span class=\"line\">               hiTail.next = e;</span><br><span class=\"line\">           hiTail = e;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       loTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">       newTab[j] = loHead;  <span class=\"comment\">//A</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">       hiTail.next = <span class=\"literal\">null</span>;</span><br><span class=\"line\">       newTab[j + oldCap] = hiHead; <span class=\"comment\">//B</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同样是扩容的操作，JDK1.8中的HashMap通过两个链分别去存储头结点和尾结点以保证它有序，并且不会频繁的去赋值<code>newTable</code>，而是在循环之后直接赋值（请注意A、B标记处），这样就非常简单的避免了产生闭环的陷阱！</p>\n"},{"title":"存储介质","author":"Nico","date":"2022-02-22T04:35:00.000Z","_content":"# **前言**\n\n开发一个简单的应用，我们只需要掌握mysql的增删改查即可，这看起来是一件非常easy的事情，而事实确实如此，但是前提是我们的目标是冲着**简单**去的。再将小目标强化一下，我们想开发复杂一些的应用，这不得不需要我们进一步加强对mysql的了解，例如索引等调优技术，随着目标的不断加强，我们需要对于整个应用所涉及到的技术拥有更加透彻的认知。\n\n从此刻开始，让我们将思想坠入硬件层，深入但是又不太深入的了解一下各种存储介质的存储原理。\n\n# **HDD**\n\n机械硬盘HDD（Hard Disk Drive）是一款磁物质存储类型的硬盘，它通过磁头转轴带动磁头在磁盘上运动来达到存储的目的，在此过程中，磁头不会与磁盘接触，电机控制磁头的电磁流来影响磁盘上磁极发生正负变化，从而做到存储二进制数据。\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67913aad349540bfbaae1ab58a649c7a~tplv-k3u1fbpfcp-watermark.image?)\n\nHDD的大体结构也并不算复杂。从平面来看，它主要由磁头、盘片、电机、磁头、转轴等组成。从侧面来看，HDD不止一个盘片，每个盘片都有正反两个盘面，每个盘面都配有一个磁头。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4ca819063c047529599f8958f6cbed0~tplv-k3u1fbpfcp-watermark.image?)\n\nHDD在逻辑上又划分为磁道、柱面、扇区。每个盘面上被划分成许多同心圆，每个同心圆的圆周被称为磁道，离转轴最远（最外圈）的磁道为0号磁道，读写将会从0号磁道开始向内圈移动。多个盘面垂直方向同轴磁道组成了柱面。同时，每个盘面又被切分成多个扇形区域，每个扇形区域被称为扇区。扇区是机械硬盘的基本读写单位，每个扇区容量为512Byte，扇面外圈的扇区虽然比内圈看着要大一些，实则磁物质密度会比内圈低很多，最终容量并不会因此而改变。\n\n值得一提的是，因为磁头切换磁道需要臂杆做机械运动，所以效率很低，而切换柱面只需要电控磁头，所以所有磁头同一时刻都是同轴的，读写过程也并不是按照盘面来写，而是先写磁道，磁道满了以后向下写入同一柱面的其它磁道，当整个柱面都写满以后再切换到下一个柱面。由于所有盘片都固定在转轴上，而磁头也只能验证盘片半径方向运动，所以多盘机械硬盘面多多个读写指令，也只能串行处理。\n\n当需要做数据读写时，首先拿到要读数据的盘面号、扇区号和磁头号，然后转轴带动盘片到对应的扇区，机械臂带动对应的磁头移动到对应的柱面，读写完毕之后再进行下一个读写指令的处理。\n\n# **DRAM**\n\n动态随机存储器DRAM（Dynamic Random Access Memory）又简称为内存，相比ROM（Read-Only Memory）的非易失性，DRAM的数据会随着断电而消失，因此，DRAM一般被用于临时存储，而非持久化场景。另外，因为电容存在漏电现象，长时间的断电会导致电荷流失以至于数据失真，所以DRAM会周期性的刷新充电，这也是“动态”的由来。\n\nDRAM的存储的原理是通过电容来存储电荷，通过电荷量来表示二进制中的0和1。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dedc7f6ccda43428c4763c5b0098419~tplv-k3u1fbpfcp-watermark.image?)\n\n上图为DRAM存储电路逻辑图，整个数字电路做的事情只是为了存储1bit的数据，其中电容（Capacitor）用来存储电荷，晶体管（Transistor）用来控制外部对电容的访问，Worldline为字线（行），Bitline为数据线（列），整个电路组成了DRAM存储的最小单元cell，实际应用中，无数个cell以矩阵的形式排列，这种矩阵被称为bank，一个bank中的cell通过行地址和列地址进行唯一标识。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c002802552734bfab4fb42208750e422~tplv-k3u1fbpfcp-watermark.image?)\n\n在数据读写之前，需要先对目标cell进行寻址。首先通过行地址解码器定位到行地址线路并发出行地址选通脉冲RAS（Row Address Strobe）信号，因为Capacitor相比Bitline上的电容值相差太大，当从Capacitor上读取数据时对于Bitline上电压影响非常小，导致无法有效识别具体数据，所以在RAS信号激活后，需要使用读出放大器（Sense Amplifier）将电容充放电信号放大，这个过程称为Activate。\n\n当RAS信号被激活后，通过列地址解码器定位到列地址线路并发出列地址选通脉冲CAS（Column Address Strobe）信号，之后放开Transistor，通过改变外部电压状态来感应或改变Capacitor中的电荷以完成数据读写，这个过程称为Precharge。\n\n在读取过程中，因为Capacitor与Bitline上的电压差，这样会使Capacitor上的电容量发生变化，导致下次读取失真，为了保证每次读取到的数据都是准确的，在读取完毕后需要再次充电操作。\n\n为了更好的描述性能，引入了描述内存性能的四个时序参数：CL、TRCD、TRP和TRAS，单位为时钟周期（ns级），每个参数周期如下：\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d4e91f879041938bb56721cdc4f48f~tplv-k3u1fbpfcp-watermark.image?)\n\n因为DRAM定时充电刷新的特性，性能会受到一定的影响，而静态随机存储器SRAM（Static Random Access Memory）弥补了这个缺陷，它不需要定时刷新，只要存储器保持通电，数据就可以持久保存，当然断电后仍然会丢失。SRAM之所以能做到这一点，是因为它去掉了电容，通过两个耦合的反相器的来锁住输出状态，有兴趣可以私下深究。\n\n# **SSD**\n\n固态硬盘SSD（Solid State Disk或Solid State Drive）是基于半导体闪存（NAND Flash）作为存储介质的硬盘，相比传统的机械硬盘，它去掉了机械固件，引入了主控芯片来代替机械操作，这意味着它的性能、功耗及可靠性会比HDD高出一大截。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7391f8e215614baaa179d807a5fe54d9~tplv-k3u1fbpfcp-watermark.image?)\n\nFlash闪存是一种非易失性的内存，这意味着即使断电也不会丢失数据，使用双层浮栅（Floating Gate）MOS管作为存储单元cell，与DRAM 1T1C（一个Transistor + 一个Capacitor）存储方式不同的是，浮栅晶体管上下被绝缘层包围，可以将电子锁在其中，避免数据因掉电而消失。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b9985ac6c0d4d459525505abb063351~tplv-k3u1fbpfcp-watermark.image?)\n\nSSD目前的存储单元根据存储量的大小分为SLC（Single Level Cell）、MLC（Multiple Level Cell）和TLC（Triple Level Cell），就像名称所蕴含的意思一样，SLC可存储1bit数据，MLC可存储2bit数据，TLC可存储3bit数据。SLC是最简单的，其内部状态只有0和1，而MLC要同时存在2bit数据，其内部状态数量增加到了 2^2 个 ，分别为是00/01/10/11，同理，TLC也可以推出它的内部状态数量为 2^3 个，分别为000/001/010/011/100/101/110/111，可以发现，随着存储量的增加，存储单元内部的状态呈指数倍上升，要识别出具体的状态，就要将电子个数进行更细致的划分，这也就意味着读写时的控制更加精细，如果抛开存储数据量的差异，单纯在性能上作比较的话，SLC是最强的，其次是MLC。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c703ce31bb24125a53f18d073e589f2~tplv-k3u1fbpfcp-watermark.image?)\n\n与DRAM类型，SSD结构上同样分层，主控通过多个通道Channel操作多块Flash闪存颗粒DIE（硅晶片，也被称为逻辑单元LUN），一个DIE由多个Plane组成，一个Plane由多个Block组成，每个Block下包含若干个Page。其中Block是擦除的最小单位，Page是最小的读写单位。每个Plane都有独立的Cache Register和Page Register，大小与Page一样，目的是做主控和存储介质之前的缓冲区。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/586e960c3da540d8ab264b4742359a3a~tplv-k3u1fbpfcp-watermark.image?)\n\nPage大小一般为4KB的整数倍，作为闪存读写最小单位，哪怕读写1byte数据，也要访问整个Page。同时，Page不允许覆盖写，举个例子，先写入1byte数据到Page1，再写入1byte数据时不会因为Page1未满就追加进去，而是先读出Page1中之前的1byte数据并与新数据合并后写入Page2，之后将Page1标记为stale，等待被GC。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa35b26e384043ee9182d7d89be8e857~tplv-k3u1fbpfcp-watermark.image?)\n\n因为闪存不能覆盖写，想要在老地方写数据，只能先擦除，这个过程会对闪存块造成一定的磨损，当闪存块的寿命结束，将会成为坏块，另外闪存块读的次数太多也会导致上面数据失真，所以SSD中的闪存转换层FTL（Flash Translation Layer）至关重要。它通过来维护一张映射表（Map Table）来完成用户逻辑地址到闪存物理地址的转换，另外为了避免上述一系列问题，FTL还做了很多“份外”之事，包括但不仅限于：\n\n-   垃圾回收（Garbage Collection）：当闪存写入达到阈值时，触发GC回收，腾出更多的写入空间。\n-   磨损平衡（Ware Leveling）：为了延长Block寿命，要避免对某些Block高频读写，保证所有块的均衡写入。\n-   消除读干扰（Read Disturb）：当闪存块读取达到阈值时，FTL将这些数据迁移至其它块。\n\n### **映射管理**\n\n用户逻辑地址到闪存物理地址的转换是FTL本职工作，FTL在内部维护了一张映射表，其中维护了用户逻辑空间到闪存空间中Block或Page的映射关系。\n\n在进行读写时，用户通过逻辑地址访问SSD，会先经过映射表的转译来获取闪存物理地址再进行之后的操作，假如是对新块写操作，此时映射表并没有当前映射关系，经过FTL挑选合适的块写入后，映射表中会将当前映射记录下来。\n\n映射表本身也会占用一定的空间用于自身的存储，SSD也都会为此类事情预留一部分空间。由于映射表的访问很频繁，通常会将映射表存储在RAM中，市面上有些SSD的主板上会自带一块小型DRAM用于映射表的缓存，而另外一部分SSD则选择会使用主机内存。\n\n### **垃圾回收**\n\n因为闪存不能覆盖写的特性，每次写入老块之前都要先擦除，这个过程就是先将块数据读出，将有用数据读取出来，然后将当前块擦除，再将**有效数据**和当前数据一起写入目标块中，这个过程做的操作简称为**读擦写**，而这个过程为称为垃圾回收（GC）。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7751428f19184c5b8e799a16b016c193~tplv-k3u1fbpfcp-watermark.image?)\n\n新盘刚开始写入过程中，因为是空盘，所以不会触发GC，当硬盘空间可用量小于某一个阈值时，GC操作将会触发。在GC之前，用户数据会先写入预留空间OP（Over Provisioning）中，这个空间对用户不可见，所以通常我们拿到收的硬盘可用空间往往会比规格容量小一些。\n\n很明显，这种GC会使原本简单的操作变得复杂且低效，并且相比原本要写入的数据，会对块中**有效数据**做额外的写入，这种现象称为写放大WA（Write Amplification），计算公式为：`WA = 实际写入量 / 用户数据量`，其中`实际写入量 = 块有效数据量 + 用户数据量`。可以看出，块中的垃圾密度越大，有效数据就越小，WA也随之而然的跟着变小。\n\n另外，SSD中GC有两种触发方式，一种是前台垃圾回收Foreground GC，它在用户写入数据无可用块时主动触发，另外一种是后台垃圾回收Background GC，它在SSD空闲时由内部控制触发。前者出发时，用户写入需要额外等待GC的完成，后者则尽可能避免前者带来的时间的耗费。\n\n### **4K对齐**\n\n传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前`512 * 63 / 1024 = 31.5`KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。\n\n除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，并且可以写满Page1，而Page2只写入1KB数据，当再次向文件顺序写入数据时，仍然需要读取Page2的数据与新写入数据合并再写入新的Page中，此时额外的开销已经产生了。\n\n对于这种情况我们可以人工补齐4K来避免额外的读开销，当然这个优化不是必须的，同时要结合自己的实际场景来做抉择。\n\n### **读写顺序**\n\n顺序读写和随机读写一直以来都是读写性能优化中最重要的一点，无论HDD还是SSD，读写方式的不同所带来的影响也不同。随机读写意味着要重新寻址，对于HDD来说需要磁头的切换甚至柱面的切换，SSD则需要重新定位行列地址线，相比于HDD，SSD不需要机械运动，因此随机读写带来的影响会小很多，而顺序读写可以免去再次寻址过程，在应用设计允许的情况下，顺序读写都是最优之选。\n\n对于SSD来说，顺序写可以保证数据有序的写在相邻的Page和Block中，当数据或文件删除时，GC垃圾也相对比较集中，可以大大降低WA带来的影响。\n\n主流操作系统都会有预读，顺序读可以提高预读缓存命中率，减少硬件读取次数。所以，如果可以，请尽可能顺序读写。\n\n# **参考**\n\n-   [深入了解机械硬盘的读写原理和碎片的产生](https://www.cnblogs.com/whl320124/articles/10063813.html)\n-   [内存（DRAM）的工作原理及时序介绍](https://blog.csdn.net/wangshouchao/article/details/48606639)\n-   [DRAM 原理 1 ：DRAM Storage Cell](http://www.wowotech.net/basic_tech/307.html)\n-   [Meaning Behind Ram RAS and CAS](http://hardwarehell.com/articles/ras_cas.htm)\n-   [浅聊SRAM和DRAM的区别](https://zhuanlan.zhihu.com/p/52272990)\n-   [SSD 背后的奥秘](https://blog.joway.io/posts/ssd-notes/)\n-   [深入浅出SSD - 固态存储核心技术原理与实战](https://item.jd.com/12367097.html)","source":"_posts/存储介质.md","raw":"title: 存储介质\nauthor: Nico\ntags: []\ncategories: []\ndate: 2022-02-22 12:35:00\n---\n# **前言**\n\n开发一个简单的应用，我们只需要掌握mysql的增删改查即可，这看起来是一件非常easy的事情，而事实确实如此，但是前提是我们的目标是冲着**简单**去的。再将小目标强化一下，我们想开发复杂一些的应用，这不得不需要我们进一步加强对mysql的了解，例如索引等调优技术，随着目标的不断加强，我们需要对于整个应用所涉及到的技术拥有更加透彻的认知。\n\n从此刻开始，让我们将思想坠入硬件层，深入但是又不太深入的了解一下各种存储介质的存储原理。\n\n# **HDD**\n\n机械硬盘HDD（Hard Disk Drive）是一款磁物质存储类型的硬盘，它通过磁头转轴带动磁头在磁盘上运动来达到存储的目的，在此过程中，磁头不会与磁盘接触，电机控制磁头的电磁流来影响磁盘上磁极发生正负变化，从而做到存储二进制数据。\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67913aad349540bfbaae1ab58a649c7a~tplv-k3u1fbpfcp-watermark.image?)\n\nHDD的大体结构也并不算复杂。从平面来看，它主要由磁头、盘片、电机、磁头、转轴等组成。从侧面来看，HDD不止一个盘片，每个盘片都有正反两个盘面，每个盘面都配有一个磁头。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4ca819063c047529599f8958f6cbed0~tplv-k3u1fbpfcp-watermark.image?)\n\nHDD在逻辑上又划分为磁道、柱面、扇区。每个盘面上被划分成许多同心圆，每个同心圆的圆周被称为磁道，离转轴最远（最外圈）的磁道为0号磁道，读写将会从0号磁道开始向内圈移动。多个盘面垂直方向同轴磁道组成了柱面。同时，每个盘面又被切分成多个扇形区域，每个扇形区域被称为扇区。扇区是机械硬盘的基本读写单位，每个扇区容量为512Byte，扇面外圈的扇区虽然比内圈看着要大一些，实则磁物质密度会比内圈低很多，最终容量并不会因此而改变。\n\n值得一提的是，因为磁头切换磁道需要臂杆做机械运动，所以效率很低，而切换柱面只需要电控磁头，所以所有磁头同一时刻都是同轴的，读写过程也并不是按照盘面来写，而是先写磁道，磁道满了以后向下写入同一柱面的其它磁道，当整个柱面都写满以后再切换到下一个柱面。由于所有盘片都固定在转轴上，而磁头也只能验证盘片半径方向运动，所以多盘机械硬盘面多多个读写指令，也只能串行处理。\n\n当需要做数据读写时，首先拿到要读数据的盘面号、扇区号和磁头号，然后转轴带动盘片到对应的扇区，机械臂带动对应的磁头移动到对应的柱面，读写完毕之后再进行下一个读写指令的处理。\n\n# **DRAM**\n\n动态随机存储器DRAM（Dynamic Random Access Memory）又简称为内存，相比ROM（Read-Only Memory）的非易失性，DRAM的数据会随着断电而消失，因此，DRAM一般被用于临时存储，而非持久化场景。另外，因为电容存在漏电现象，长时间的断电会导致电荷流失以至于数据失真，所以DRAM会周期性的刷新充电，这也是“动态”的由来。\n\nDRAM的存储的原理是通过电容来存储电荷，通过电荷量来表示二进制中的0和1。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dedc7f6ccda43428c4763c5b0098419~tplv-k3u1fbpfcp-watermark.image?)\n\n上图为DRAM存储电路逻辑图，整个数字电路做的事情只是为了存储1bit的数据，其中电容（Capacitor）用来存储电荷，晶体管（Transistor）用来控制外部对电容的访问，Worldline为字线（行），Bitline为数据线（列），整个电路组成了DRAM存储的最小单元cell，实际应用中，无数个cell以矩阵的形式排列，这种矩阵被称为bank，一个bank中的cell通过行地址和列地址进行唯一标识。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c002802552734bfab4fb42208750e422~tplv-k3u1fbpfcp-watermark.image?)\n\n在数据读写之前，需要先对目标cell进行寻址。首先通过行地址解码器定位到行地址线路并发出行地址选通脉冲RAS（Row Address Strobe）信号，因为Capacitor相比Bitline上的电容值相差太大，当从Capacitor上读取数据时对于Bitline上电压影响非常小，导致无法有效识别具体数据，所以在RAS信号激活后，需要使用读出放大器（Sense Amplifier）将电容充放电信号放大，这个过程称为Activate。\n\n当RAS信号被激活后，通过列地址解码器定位到列地址线路并发出列地址选通脉冲CAS（Column Address Strobe）信号，之后放开Transistor，通过改变外部电压状态来感应或改变Capacitor中的电荷以完成数据读写，这个过程称为Precharge。\n\n在读取过程中，因为Capacitor与Bitline上的电压差，这样会使Capacitor上的电容量发生变化，导致下次读取失真，为了保证每次读取到的数据都是准确的，在读取完毕后需要再次充电操作。\n\n为了更好的描述性能，引入了描述内存性能的四个时序参数：CL、TRCD、TRP和TRAS，单位为时钟周期（ns级），每个参数周期如下：\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d4e91f879041938bb56721cdc4f48f~tplv-k3u1fbpfcp-watermark.image?)\n\n因为DRAM定时充电刷新的特性，性能会受到一定的影响，而静态随机存储器SRAM（Static Random Access Memory）弥补了这个缺陷，它不需要定时刷新，只要存储器保持通电，数据就可以持久保存，当然断电后仍然会丢失。SRAM之所以能做到这一点，是因为它去掉了电容，通过两个耦合的反相器的来锁住输出状态，有兴趣可以私下深究。\n\n# **SSD**\n\n固态硬盘SSD（Solid State Disk或Solid State Drive）是基于半导体闪存（NAND Flash）作为存储介质的硬盘，相比传统的机械硬盘，它去掉了机械固件，引入了主控芯片来代替机械操作，这意味着它的性能、功耗及可靠性会比HDD高出一大截。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7391f8e215614baaa179d807a5fe54d9~tplv-k3u1fbpfcp-watermark.image?)\n\nFlash闪存是一种非易失性的内存，这意味着即使断电也不会丢失数据，使用双层浮栅（Floating Gate）MOS管作为存储单元cell，与DRAM 1T1C（一个Transistor + 一个Capacitor）存储方式不同的是，浮栅晶体管上下被绝缘层包围，可以将电子锁在其中，避免数据因掉电而消失。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b9985ac6c0d4d459525505abb063351~tplv-k3u1fbpfcp-watermark.image?)\n\nSSD目前的存储单元根据存储量的大小分为SLC（Single Level Cell）、MLC（Multiple Level Cell）和TLC（Triple Level Cell），就像名称所蕴含的意思一样，SLC可存储1bit数据，MLC可存储2bit数据，TLC可存储3bit数据。SLC是最简单的，其内部状态只有0和1，而MLC要同时存在2bit数据，其内部状态数量增加到了 2^2 个 ，分别为是00/01/10/11，同理，TLC也可以推出它的内部状态数量为 2^3 个，分别为000/001/010/011/100/101/110/111，可以发现，随着存储量的增加，存储单元内部的状态呈指数倍上升，要识别出具体的状态，就要将电子个数进行更细致的划分，这也就意味着读写时的控制更加精细，如果抛开存储数据量的差异，单纯在性能上作比较的话，SLC是最强的，其次是MLC。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c703ce31bb24125a53f18d073e589f2~tplv-k3u1fbpfcp-watermark.image?)\n\n与DRAM类型，SSD结构上同样分层，主控通过多个通道Channel操作多块Flash闪存颗粒DIE（硅晶片，也被称为逻辑单元LUN），一个DIE由多个Plane组成，一个Plane由多个Block组成，每个Block下包含若干个Page。其中Block是擦除的最小单位，Page是最小的读写单位。每个Plane都有独立的Cache Register和Page Register，大小与Page一样，目的是做主控和存储介质之前的缓冲区。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/586e960c3da540d8ab264b4742359a3a~tplv-k3u1fbpfcp-watermark.image?)\n\nPage大小一般为4KB的整数倍，作为闪存读写最小单位，哪怕读写1byte数据，也要访问整个Page。同时，Page不允许覆盖写，举个例子，先写入1byte数据到Page1，再写入1byte数据时不会因为Page1未满就追加进去，而是先读出Page1中之前的1byte数据并与新数据合并后写入Page2，之后将Page1标记为stale，等待被GC。\n\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa35b26e384043ee9182d7d89be8e857~tplv-k3u1fbpfcp-watermark.image?)\n\n因为闪存不能覆盖写，想要在老地方写数据，只能先擦除，这个过程会对闪存块造成一定的磨损，当闪存块的寿命结束，将会成为坏块，另外闪存块读的次数太多也会导致上面数据失真，所以SSD中的闪存转换层FTL（Flash Translation Layer）至关重要。它通过来维护一张映射表（Map Table）来完成用户逻辑地址到闪存物理地址的转换，另外为了避免上述一系列问题，FTL还做了很多“份外”之事，包括但不仅限于：\n\n-   垃圾回收（Garbage Collection）：当闪存写入达到阈值时，触发GC回收，腾出更多的写入空间。\n-   磨损平衡（Ware Leveling）：为了延长Block寿命，要避免对某些Block高频读写，保证所有块的均衡写入。\n-   消除读干扰（Read Disturb）：当闪存块读取达到阈值时，FTL将这些数据迁移至其它块。\n\n### **映射管理**\n\n用户逻辑地址到闪存物理地址的转换是FTL本职工作，FTL在内部维护了一张映射表，其中维护了用户逻辑空间到闪存空间中Block或Page的映射关系。\n\n在进行读写时，用户通过逻辑地址访问SSD，会先经过映射表的转译来获取闪存物理地址再进行之后的操作，假如是对新块写操作，此时映射表并没有当前映射关系，经过FTL挑选合适的块写入后，映射表中会将当前映射记录下来。\n\n映射表本身也会占用一定的空间用于自身的存储，SSD也都会为此类事情预留一部分空间。由于映射表的访问很频繁，通常会将映射表存储在RAM中，市面上有些SSD的主板上会自带一块小型DRAM用于映射表的缓存，而另外一部分SSD则选择会使用主机内存。\n\n### **垃圾回收**\n\n因为闪存不能覆盖写的特性，每次写入老块之前都要先擦除，这个过程就是先将块数据读出，将有用数据读取出来，然后将当前块擦除，再将**有效数据**和当前数据一起写入目标块中，这个过程做的操作简称为**读擦写**，而这个过程为称为垃圾回收（GC）。\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7751428f19184c5b8e799a16b016c193~tplv-k3u1fbpfcp-watermark.image?)\n\n新盘刚开始写入过程中，因为是空盘，所以不会触发GC，当硬盘空间可用量小于某一个阈值时，GC操作将会触发。在GC之前，用户数据会先写入预留空间OP（Over Provisioning）中，这个空间对用户不可见，所以通常我们拿到收的硬盘可用空间往往会比规格容量小一些。\n\n很明显，这种GC会使原本简单的操作变得复杂且低效，并且相比原本要写入的数据，会对块中**有效数据**做额外的写入，这种现象称为写放大WA（Write Amplification），计算公式为：`WA = 实际写入量 / 用户数据量`，其中`实际写入量 = 块有效数据量 + 用户数据量`。可以看出，块中的垃圾密度越大，有效数据就越小，WA也随之而然的跟着变小。\n\n另外，SSD中GC有两种触发方式，一种是前台垃圾回收Foreground GC，它在用户写入数据无可用块时主动触发，另外一种是后台垃圾回收Background GC，它在SSD空闲时由内部控制触发。前者出发时，用户写入需要额外等待GC的完成，后者则尽可能避免前者带来的时间的耗费。\n\n### **4K对齐**\n\n传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前`512 * 63 / 1024 = 31.5`KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。\n\n除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，并且可以写满Page1，而Page2只写入1KB数据，当再次向文件顺序写入数据时，仍然需要读取Page2的数据与新写入数据合并再写入新的Page中，此时额外的开销已经产生了。\n\n对于这种情况我们可以人工补齐4K来避免额外的读开销，当然这个优化不是必须的，同时要结合自己的实际场景来做抉择。\n\n### **读写顺序**\n\n顺序读写和随机读写一直以来都是读写性能优化中最重要的一点，无论HDD还是SSD，读写方式的不同所带来的影响也不同。随机读写意味着要重新寻址，对于HDD来说需要磁头的切换甚至柱面的切换，SSD则需要重新定位行列地址线，相比于HDD，SSD不需要机械运动，因此随机读写带来的影响会小很多，而顺序读写可以免去再次寻址过程，在应用设计允许的情况下，顺序读写都是最优之选。\n\n对于SSD来说，顺序写可以保证数据有序的写在相邻的Page和Block中，当数据或文件删除时，GC垃圾也相对比较集中，可以大大降低WA带来的影响。\n\n主流操作系统都会有预读，顺序读可以提高预读缓存命中率，减少硬件读取次数。所以，如果可以，请尽可能顺序读写。\n\n# **参考**\n\n-   [深入了解机械硬盘的读写原理和碎片的产生](https://www.cnblogs.com/whl320124/articles/10063813.html)\n-   [内存（DRAM）的工作原理及时序介绍](https://blog.csdn.net/wangshouchao/article/details/48606639)\n-   [DRAM 原理 1 ：DRAM Storage Cell](http://www.wowotech.net/basic_tech/307.html)\n-   [Meaning Behind Ram RAS and CAS](http://hardwarehell.com/articles/ras_cas.htm)\n-   [浅聊SRAM和DRAM的区别](https://zhuanlan.zhihu.com/p/52272990)\n-   [SSD 背后的奥秘](https://blog.joway.io/posts/ssd-notes/)\n-   [深入浅出SSD - 固态存储核心技术原理与实战](https://item.jd.com/12367097.html)","slug":"存储介质","published":1,"updated":"2022-02-22T04:36:05.296Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyg0014b0tzfwcnb83x","content":"<h1><strong>前言</strong></h1>\n<p>开发一个简单的应用，我们只需要掌握mysql的增删改查即可，这看起来是一件非常easy的事情，而事实确实如此，但是前提是我们的目标是冲着<strong>简单</strong>去的。再将小目标强化一下，我们想开发复杂一些的应用，这不得不需要我们进一步加强对mysql的了解，例如索引等调优技术，随着目标的不断加强，我们需要对于整个应用所涉及到的技术拥有更加透彻的认知。</p>\n<p>从此刻开始，让我们将思想坠入硬件层，深入但是又不太深入的了解一下各种存储介质的存储原理。</p>\n<h1><strong>HDD</strong></h1>\n<p>机械硬盘HDD（Hard Disk Drive）是一款磁物质存储类型的硬盘，它通过磁头转轴带动磁头在磁盘上运动来达到存储的目的，在此过程中，磁头不会与磁盘接触，电机控制磁头的电磁流来影响磁盘上磁极发生正负变化，从而做到存储二进制数据。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67913aad349540bfbaae1ab58a649c7a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>HDD的大体结构也并不算复杂。从平面来看，它主要由磁头、盘片、电机、磁头、转轴等组成。从侧面来看，HDD不止一个盘片，每个盘片都有正反两个盘面，每个盘面都配有一个磁头。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4ca819063c047529599f8958f6cbed0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>HDD在逻辑上又划分为磁道、柱面、扇区。每个盘面上被划分成许多同心圆，每个同心圆的圆周被称为磁道，离转轴最远（最外圈）的磁道为0号磁道，读写将会从0号磁道开始向内圈移动。多个盘面垂直方向同轴磁道组成了柱面。同时，每个盘面又被切分成多个扇形区域，每个扇形区域被称为扇区。扇区是机械硬盘的基本读写单位，每个扇区容量为512Byte，扇面外圈的扇区虽然比内圈看着要大一些，实则磁物质密度会比内圈低很多，最终容量并不会因此而改变。</p>\n<p>值得一提的是，因为磁头切换磁道需要臂杆做机械运动，所以效率很低，而切换柱面只需要电控磁头，所以所有磁头同一时刻都是同轴的，读写过程也并不是按照盘面来写，而是先写磁道，磁道满了以后向下写入同一柱面的其它磁道，当整个柱面都写满以后再切换到下一个柱面。由于所有盘片都固定在转轴上，而磁头也只能验证盘片半径方向运动，所以多盘机械硬盘面多多个读写指令，也只能串行处理。</p>\n<p>当需要做数据读写时，首先拿到要读数据的盘面号、扇区号和磁头号，然后转轴带动盘片到对应的扇区，机械臂带动对应的磁头移动到对应的柱面，读写完毕之后再进行下一个读写指令的处理。</p>\n<h1><strong>DRAM</strong></h1>\n<p>动态随机存储器DRAM（Dynamic Random Access Memory）又简称为内存，相比ROM（Read-Only Memory）的非易失性，DRAM的数据会随着断电而消失，因此，DRAM一般被用于临时存储，而非持久化场景。另外，因为电容存在漏电现象，长时间的断电会导致电荷流失以至于数据失真，所以DRAM会周期性的刷新充电，这也是“动态”的由来。</p>\n<p>DRAM的存储的原理是通过电容来存储电荷，通过电荷量来表示二进制中的0和1。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dedc7f6ccda43428c4763c5b0098419~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>上图为DRAM存储电路逻辑图，整个数字电路做的事情只是为了存储1bit的数据，其中电容（Capacitor）用来存储电荷，晶体管（Transistor）用来控制外部对电容的访问，Worldline为字线（行），Bitline为数据线（列），整个电路组成了DRAM存储的最小单元cell，实际应用中，无数个cell以矩阵的形式排列，这种矩阵被称为bank，一个bank中的cell通过行地址和列地址进行唯一标识。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c002802552734bfab4fb42208750e422~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>在数据读写之前，需要先对目标cell进行寻址。首先通过行地址解码器定位到行地址线路并发出行地址选通脉冲RAS（Row Address Strobe）信号，因为Capacitor相比Bitline上的电容值相差太大，当从Capacitor上读取数据时对于Bitline上电压影响非常小，导致无法有效识别具体数据，所以在RAS信号激活后，需要使用读出放大器（Sense Amplifier）将电容充放电信号放大，这个过程称为Activate。</p>\n<p>当RAS信号被激活后，通过列地址解码器定位到列地址线路并发出列地址选通脉冲CAS（Column Address Strobe）信号，之后放开Transistor，通过改变外部电压状态来感应或改变Capacitor中的电荷以完成数据读写，这个过程称为Precharge。</p>\n<p>在读取过程中，因为Capacitor与Bitline上的电压差，这样会使Capacitor上的电容量发生变化，导致下次读取失真，为了保证每次读取到的数据都是准确的，在读取完毕后需要再次充电操作。</p>\n<p>为了更好的描述性能，引入了描述内存性能的四个时序参数：CL、TRCD、TRP和TRAS，单位为时钟周期（ns级），每个参数周期如下：</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d4e91f879041938bb56721cdc4f48f~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>因为DRAM定时充电刷新的特性，性能会受到一定的影响，而静态随机存储器SRAM（Static Random Access Memory）弥补了这个缺陷，它不需要定时刷新，只要存储器保持通电，数据就可以持久保存，当然断电后仍然会丢失。SRAM之所以能做到这一点，是因为它去掉了电容，通过两个耦合的反相器的来锁住输出状态，有兴趣可以私下深究。</p>\n<h1><strong>SSD</strong></h1>\n<p>固态硬盘SSD（Solid State Disk或Solid State Drive）是基于半导体闪存（NAND Flash）作为存储介质的硬盘，相比传统的机械硬盘，它去掉了机械固件，引入了主控芯片来代替机械操作，这意味着它的性能、功耗及可靠性会比HDD高出一大截。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7391f8e215614baaa179d807a5fe54d9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>Flash闪存是一种非易失性的内存，这意味着即使断电也不会丢失数据，使用双层浮栅（Floating Gate）MOS管作为存储单元cell，与DRAM 1T1C（一个Transistor + 一个Capacitor）存储方式不同的是，浮栅晶体管上下被绝缘层包围，可以将电子锁在其中，避免数据因掉电而消失。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b9985ac6c0d4d459525505abb063351~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>SSD目前的存储单元根据存储量的大小分为SLC（Single Level Cell）、MLC（Multiple Level Cell）和TLC（Triple Level Cell），就像名称所蕴含的意思一样，SLC可存储1bit数据，MLC可存储2bit数据，TLC可存储3bit数据。SLC是最简单的，其内部状态只有0和1，而MLC要同时存在2bit数据，其内部状态数量增加到了 2^2 个 ，分别为是00/01/10/11，同理，TLC也可以推出它的内部状态数量为 2^3 个，分别为000/001/010/011/100/101/110/111，可以发现，随着存储量的增加，存储单元内部的状态呈指数倍上升，要识别出具体的状态，就要将电子个数进行更细致的划分，这也就意味着读写时的控制更加精细，如果抛开存储数据量的差异，单纯在性能上作比较的话，SLC是最强的，其次是MLC。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c703ce31bb24125a53f18d073e589f2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>与DRAM类型，SSD结构上同样分层，主控通过多个通道Channel操作多块Flash闪存颗粒DIE（硅晶片，也被称为逻辑单元LUN），一个DIE由多个Plane组成，一个Plane由多个Block组成，每个Block下包含若干个Page。其中Block是擦除的最小单位，Page是最小的读写单位。每个Plane都有独立的Cache Register和Page Register，大小与Page一样，目的是做主控和存储介质之前的缓冲区。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/586e960c3da540d8ab264b4742359a3a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>Page大小一般为4KB的整数倍，作为闪存读写最小单位，哪怕读写1byte数据，也要访问整个Page。同时，Page不允许覆盖写，举个例子，先写入1byte数据到Page1，再写入1byte数据时不会因为Page1未满就追加进去，而是先读出Page1中之前的1byte数据并与新数据合并后写入Page2，之后将Page1标记为stale，等待被GC。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa35b26e384043ee9182d7d89be8e857~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>因为闪存不能覆盖写，想要在老地方写数据，只能先擦除，这个过程会对闪存块造成一定的磨损，当闪存块的寿命结束，将会成为坏块，另外闪存块读的次数太多也会导致上面数据失真，所以SSD中的闪存转换层FTL（Flash Translation Layer）至关重要。它通过来维护一张映射表（Map Table）来完成用户逻辑地址到闪存物理地址的转换，另外为了避免上述一系列问题，FTL还做了很多“份外”之事，包括但不仅限于：</p>\n<ul>\n<li>垃圾回收（Garbage Collection）：当闪存写入达到阈值时，触发GC回收，腾出更多的写入空间。</li>\n<li>磨损平衡（Ware Leveling）：为了延长Block寿命，要避免对某些Block高频读写，保证所有块的均衡写入。</li>\n<li>消除读干扰（Read Disturb）：当闪存块读取达到阈值时，FTL将这些数据迁移至其它块。</li>\n</ul>\n<h3 id=\"映射管理\"><a class=\"header-anchor\" href=\"#映射管理\">¶</a><strong>映射管理</strong></h3>\n<p>用户逻辑地址到闪存物理地址的转换是FTL本职工作，FTL在内部维护了一张映射表，其中维护了用户逻辑空间到闪存空间中Block或Page的映射关系。</p>\n<p>在进行读写时，用户通过逻辑地址访问SSD，会先经过映射表的转译来获取闪存物理地址再进行之后的操作，假如是对新块写操作，此时映射表并没有当前映射关系，经过FTL挑选合适的块写入后，映射表中会将当前映射记录下来。</p>\n<p>映射表本身也会占用一定的空间用于自身的存储，SSD也都会为此类事情预留一部分空间。由于映射表的访问很频繁，通常会将映射表存储在RAM中，市面上有些SSD的主板上会自带一块小型DRAM用于映射表的缓存，而另外一部分SSD则选择会使用主机内存。</p>\n<h3 id=\"垃圾回收\"><a class=\"header-anchor\" href=\"#垃圾回收\">¶</a><strong>垃圾回收</strong></h3>\n<p>因为闪存不能覆盖写的特性，每次写入老块之前都要先擦除，这个过程就是先将块数据读出，将有用数据读取出来，然后将当前块擦除，再将<strong>有效数据</strong>和当前数据一起写入目标块中，这个过程做的操作简称为<strong>读擦写</strong>，而这个过程为称为垃圾回收（GC）。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7751428f19184c5b8e799a16b016c193~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>新盘刚开始写入过程中，因为是空盘，所以不会触发GC，当硬盘空间可用量小于某一个阈值时，GC操作将会触发。在GC之前，用户数据会先写入预留空间OP（Over Provisioning）中，这个空间对用户不可见，所以通常我们拿到收的硬盘可用空间往往会比规格容量小一些。</p>\n<p>很明显，这种GC会使原本简单的操作变得复杂且低效，并且相比原本要写入的数据，会对块中<strong>有效数据</strong>做额外的写入，这种现象称为写放大WA（Write Amplification），计算公式为：<code>WA = 实际写入量 / 用户数据量</code>，其中<code>实际写入量 = 块有效数据量 + 用户数据量</code>。可以看出，块中的垃圾密度越大，有效数据就越小，WA也随之而然的跟着变小。</p>\n<p>另外，SSD中GC有两种触发方式，一种是前台垃圾回收Foreground GC，它在用户写入数据无可用块时主动触发，另外一种是后台垃圾回收Background GC，它在SSD空闲时由内部控制触发。前者出发时，用户写入需要额外等待GC的完成，后者则尽可能避免前者带来的时间的耗费。</p>\n<h3 id=\"4k对齐\"><a class=\"header-anchor\" href=\"#4k对齐\">¶</a><strong>4K对齐</strong></h3>\n<p>传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前<code>512 * 63 / 1024 = 31.5</code>KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。</p>\n<p>除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，并且可以写满Page1，而Page2只写入1KB数据，当再次向文件顺序写入数据时，仍然需要读取Page2的数据与新写入数据合并再写入新的Page中，此时额外的开销已经产生了。</p>\n<p>对于这种情况我们可以人工补齐4K来避免额外的读开销，当然这个优化不是必须的，同时要结合自己的实际场景来做抉择。</p>\n<h3 id=\"读写顺序\"><a class=\"header-anchor\" href=\"#读写顺序\">¶</a><strong>读写顺序</strong></h3>\n<p>顺序读写和随机读写一直以来都是读写性能优化中最重要的一点，无论HDD还是SSD，读写方式的不同所带来的影响也不同。随机读写意味着要重新寻址，对于HDD来说需要磁头的切换甚至柱面的切换，SSD则需要重新定位行列地址线，相比于HDD，SSD不需要机械运动，因此随机读写带来的影响会小很多，而顺序读写可以免去再次寻址过程，在应用设计允许的情况下，顺序读写都是最优之选。</p>\n<p>对于SSD来说，顺序写可以保证数据有序的写在相邻的Page和Block中，当数据或文件删除时，GC垃圾也相对比较集中，可以大大降低WA带来的影响。</p>\n<p>主流操作系统都会有预读，顺序读可以提高预读缓存命中率，减少硬件读取次数。所以，如果可以，请尽可能顺序读写。</p>\n<h1><strong>参考</strong></h1>\n<ul>\n<li><a href=\"https://www.cnblogs.com/whl320124/articles/10063813.html\">深入了解机械硬盘的读写原理和碎片的产生</a></li>\n<li><a href=\"https://blog.csdn.net/wangshouchao/article/details/48606639\">内存（DRAM）的工作原理及时序介绍</a></li>\n<li><a href=\"http://www.wowotech.net/basic_tech/307.html\">DRAM 原理 1 ：DRAM Storage Cell</a></li>\n<li><a href=\"http://hardwarehell.com/articles/ras_cas.htm\">Meaning Behind Ram RAS and CAS</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/52272990\">浅聊SRAM和DRAM的区别</a></li>\n<li><a href=\"https://blog.joway.io/posts/ssd-notes/\">SSD 背后的奥秘</a></li>\n<li><a href=\"https://item.jd.com/12367097.html\">深入浅出SSD - 固态存储核心技术原理与实战</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1><strong>前言</strong></h1>\n<p>开发一个简单的应用，我们只需要掌握mysql的增删改查即可，这看起来是一件非常easy的事情，而事实确实如此，但是前提是我们的目标是冲着<strong>简单</strong>去的。再将小目标强化一下，我们想开发复杂一些的应用，这不得不需要我们进一步加强对mysql的了解，例如索引等调优技术，随着目标的不断加强，我们需要对于整个应用所涉及到的技术拥有更加透彻的认知。</p>\n<p>从此刻开始，让我们将思想坠入硬件层，深入但是又不太深入的了解一下各种存储介质的存储原理。</p>\n<h1><strong>HDD</strong></h1>\n<p>机械硬盘HDD（Hard Disk Drive）是一款磁物质存储类型的硬盘，它通过磁头转轴带动磁头在磁盘上运动来达到存储的目的，在此过程中，磁头不会与磁盘接触，电机控制磁头的电磁流来影响磁盘上磁极发生正负变化，从而做到存储二进制数据。</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67913aad349540bfbaae1ab58a649c7a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>HDD的大体结构也并不算复杂。从平面来看，它主要由磁头、盘片、电机、磁头、转轴等组成。从侧面来看，HDD不止一个盘片，每个盘片都有正反两个盘面，每个盘面都配有一个磁头。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4ca819063c047529599f8958f6cbed0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>HDD在逻辑上又划分为磁道、柱面、扇区。每个盘面上被划分成许多同心圆，每个同心圆的圆周被称为磁道，离转轴最远（最外圈）的磁道为0号磁道，读写将会从0号磁道开始向内圈移动。多个盘面垂直方向同轴磁道组成了柱面。同时，每个盘面又被切分成多个扇形区域，每个扇形区域被称为扇区。扇区是机械硬盘的基本读写单位，每个扇区容量为512Byte，扇面外圈的扇区虽然比内圈看着要大一些，实则磁物质密度会比内圈低很多，最终容量并不会因此而改变。</p>\n<p>值得一提的是，因为磁头切换磁道需要臂杆做机械运动，所以效率很低，而切换柱面只需要电控磁头，所以所有磁头同一时刻都是同轴的，读写过程也并不是按照盘面来写，而是先写磁道，磁道满了以后向下写入同一柱面的其它磁道，当整个柱面都写满以后再切换到下一个柱面。由于所有盘片都固定在转轴上，而磁头也只能验证盘片半径方向运动，所以多盘机械硬盘面多多个读写指令，也只能串行处理。</p>\n<p>当需要做数据读写时，首先拿到要读数据的盘面号、扇区号和磁头号，然后转轴带动盘片到对应的扇区，机械臂带动对应的磁头移动到对应的柱面，读写完毕之后再进行下一个读写指令的处理。</p>\n<h1><strong>DRAM</strong></h1>\n<p>动态随机存储器DRAM（Dynamic Random Access Memory）又简称为内存，相比ROM（Read-Only Memory）的非易失性，DRAM的数据会随着断电而消失，因此，DRAM一般被用于临时存储，而非持久化场景。另外，因为电容存在漏电现象，长时间的断电会导致电荷流失以至于数据失真，所以DRAM会周期性的刷新充电，这也是“动态”的由来。</p>\n<p>DRAM的存储的原理是通过电容来存储电荷，通过电荷量来表示二进制中的0和1。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dedc7f6ccda43428c4763c5b0098419~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>上图为DRAM存储电路逻辑图，整个数字电路做的事情只是为了存储1bit的数据，其中电容（Capacitor）用来存储电荷，晶体管（Transistor）用来控制外部对电容的访问，Worldline为字线（行），Bitline为数据线（列），整个电路组成了DRAM存储的最小单元cell，实际应用中，无数个cell以矩阵的形式排列，这种矩阵被称为bank，一个bank中的cell通过行地址和列地址进行唯一标识。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c002802552734bfab4fb42208750e422~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>在数据读写之前，需要先对目标cell进行寻址。首先通过行地址解码器定位到行地址线路并发出行地址选通脉冲RAS（Row Address Strobe）信号，因为Capacitor相比Bitline上的电容值相差太大，当从Capacitor上读取数据时对于Bitline上电压影响非常小，导致无法有效识别具体数据，所以在RAS信号激活后，需要使用读出放大器（Sense Amplifier）将电容充放电信号放大，这个过程称为Activate。</p>\n<p>当RAS信号被激活后，通过列地址解码器定位到列地址线路并发出列地址选通脉冲CAS（Column Address Strobe）信号，之后放开Transistor，通过改变外部电压状态来感应或改变Capacitor中的电荷以完成数据读写，这个过程称为Precharge。</p>\n<p>在读取过程中，因为Capacitor与Bitline上的电压差，这样会使Capacitor上的电容量发生变化，导致下次读取失真，为了保证每次读取到的数据都是准确的，在读取完毕后需要再次充电操作。</p>\n<p>为了更好的描述性能，引入了描述内存性能的四个时序参数：CL、TRCD、TRP和TRAS，单位为时钟周期（ns级），每个参数周期如下：</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d4e91f879041938bb56721cdc4f48f~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>因为DRAM定时充电刷新的特性，性能会受到一定的影响，而静态随机存储器SRAM（Static Random Access Memory）弥补了这个缺陷，它不需要定时刷新，只要存储器保持通电，数据就可以持久保存，当然断电后仍然会丢失。SRAM之所以能做到这一点，是因为它去掉了电容，通过两个耦合的反相器的来锁住输出状态，有兴趣可以私下深究。</p>\n<h1><strong>SSD</strong></h1>\n<p>固态硬盘SSD（Solid State Disk或Solid State Drive）是基于半导体闪存（NAND Flash）作为存储介质的硬盘，相比传统的机械硬盘，它去掉了机械固件，引入了主控芯片来代替机械操作，这意味着它的性能、功耗及可靠性会比HDD高出一大截。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7391f8e215614baaa179d807a5fe54d9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>Flash闪存是一种非易失性的内存，这意味着即使断电也不会丢失数据，使用双层浮栅（Floating Gate）MOS管作为存储单元cell，与DRAM 1T1C（一个Transistor + 一个Capacitor）存储方式不同的是，浮栅晶体管上下被绝缘层包围，可以将电子锁在其中，避免数据因掉电而消失。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b9985ac6c0d4d459525505abb063351~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>SSD目前的存储单元根据存储量的大小分为SLC（Single Level Cell）、MLC（Multiple Level Cell）和TLC（Triple Level Cell），就像名称所蕴含的意思一样，SLC可存储1bit数据，MLC可存储2bit数据，TLC可存储3bit数据。SLC是最简单的，其内部状态只有0和1，而MLC要同时存在2bit数据，其内部状态数量增加到了 2^2 个 ，分别为是00/01/10/11，同理，TLC也可以推出它的内部状态数量为 2^3 个，分别为000/001/010/011/100/101/110/111，可以发现，随着存储量的增加，存储单元内部的状态呈指数倍上升，要识别出具体的状态，就要将电子个数进行更细致的划分，这也就意味着读写时的控制更加精细，如果抛开存储数据量的差异，单纯在性能上作比较的话，SLC是最强的，其次是MLC。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c703ce31bb24125a53f18d073e589f2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>与DRAM类型，SSD结构上同样分层，主控通过多个通道Channel操作多块Flash闪存颗粒DIE（硅晶片，也被称为逻辑单元LUN），一个DIE由多个Plane组成，一个Plane由多个Block组成，每个Block下包含若干个Page。其中Block是擦除的最小单位，Page是最小的读写单位。每个Plane都有独立的Cache Register和Page Register，大小与Page一样，目的是做主控和存储介质之前的缓冲区。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/586e960c3da540d8ab264b4742359a3a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>Page大小一般为4KB的整数倍，作为闪存读写最小单位，哪怕读写1byte数据，也要访问整个Page。同时，Page不允许覆盖写，举个例子，先写入1byte数据到Page1，再写入1byte数据时不会因为Page1未满就追加进去，而是先读出Page1中之前的1byte数据并与新数据合并后写入Page2，之后将Page1标记为stale，等待被GC。</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa35b26e384043ee9182d7d89be8e857~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>因为闪存不能覆盖写，想要在老地方写数据，只能先擦除，这个过程会对闪存块造成一定的磨损，当闪存块的寿命结束，将会成为坏块，另外闪存块读的次数太多也会导致上面数据失真，所以SSD中的闪存转换层FTL（Flash Translation Layer）至关重要。它通过来维护一张映射表（Map Table）来完成用户逻辑地址到闪存物理地址的转换，另外为了避免上述一系列问题，FTL还做了很多“份外”之事，包括但不仅限于：</p>\n<ul>\n<li>垃圾回收（Garbage Collection）：当闪存写入达到阈值时，触发GC回收，腾出更多的写入空间。</li>\n<li>磨损平衡（Ware Leveling）：为了延长Block寿命，要避免对某些Block高频读写，保证所有块的均衡写入。</li>\n<li>消除读干扰（Read Disturb）：当闪存块读取达到阈值时，FTL将这些数据迁移至其它块。</li>\n</ul>\n<h3 id=\"映射管理\"><a class=\"header-anchor\" href=\"#映射管理\">¶</a><strong>映射管理</strong></h3>\n<p>用户逻辑地址到闪存物理地址的转换是FTL本职工作，FTL在内部维护了一张映射表，其中维护了用户逻辑空间到闪存空间中Block或Page的映射关系。</p>\n<p>在进行读写时，用户通过逻辑地址访问SSD，会先经过映射表的转译来获取闪存物理地址再进行之后的操作，假如是对新块写操作，此时映射表并没有当前映射关系，经过FTL挑选合适的块写入后，映射表中会将当前映射记录下来。</p>\n<p>映射表本身也会占用一定的空间用于自身的存储，SSD也都会为此类事情预留一部分空间。由于映射表的访问很频繁，通常会将映射表存储在RAM中，市面上有些SSD的主板上会自带一块小型DRAM用于映射表的缓存，而另外一部分SSD则选择会使用主机内存。</p>\n<h3 id=\"垃圾回收\"><a class=\"header-anchor\" href=\"#垃圾回收\">¶</a><strong>垃圾回收</strong></h3>\n<p>因为闪存不能覆盖写的特性，每次写入老块之前都要先擦除，这个过程就是先将块数据读出，将有用数据读取出来，然后将当前块擦除，再将<strong>有效数据</strong>和当前数据一起写入目标块中，这个过程做的操作简称为<strong>读擦写</strong>，而这个过程为称为垃圾回收（GC）。</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7751428f19184c5b8e799a16b016c193~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>新盘刚开始写入过程中，因为是空盘，所以不会触发GC，当硬盘空间可用量小于某一个阈值时，GC操作将会触发。在GC之前，用户数据会先写入预留空间OP（Over Provisioning）中，这个空间对用户不可见，所以通常我们拿到收的硬盘可用空间往往会比规格容量小一些。</p>\n<p>很明显，这种GC会使原本简单的操作变得复杂且低效，并且相比原本要写入的数据，会对块中<strong>有效数据</strong>做额外的写入，这种现象称为写放大WA（Write Amplification），计算公式为：<code>WA = 实际写入量 / 用户数据量</code>，其中<code>实际写入量 = 块有效数据量 + 用户数据量</code>。可以看出，块中的垃圾密度越大，有效数据就越小，WA也随之而然的跟着变小。</p>\n<p>另外，SSD中GC有两种触发方式，一种是前台垃圾回收Foreground GC，它在用户写入数据无可用块时主动触发，另外一种是后台垃圾回收Background GC，它在SSD空闲时由内部控制触发。前者出发时，用户写入需要额外等待GC的完成，后者则尽可能避免前者带来的时间的耗费。</p>\n<h3 id=\"4k对齐\"><a class=\"header-anchor\" href=\"#4k对齐\">¶</a><strong>4K对齐</strong></h3>\n<p>传统HDD扇区单位一直习惯于512Byte，有些文件系统默认保留前63个扇区，也就是前<code>512 * 63 / 1024 = 31.5</code>KB，假设闪存Page和簇（OS读写基本单位）都大小为4KB，那么一个Page对应着8个扇区，用户数据将于第8个Page的第3.5KB位置开始写入，导致之后的每一个簇都会跨两个Page，读写处于超界处，这对于闪存会造成更多的读损及读写开销。</p>\n<p>除了OS层的4K对齐至关重要以外，在文件写入过程中仍然需要关注4K对齐的问题。假设Page大小仍然为4KB，向一个空白文件写入5KB数据，此时需要2个Page来存储数据，并且可以写满Page1，而Page2只写入1KB数据，当再次向文件顺序写入数据时，仍然需要读取Page2的数据与新写入数据合并再写入新的Page中，此时额外的开销已经产生了。</p>\n<p>对于这种情况我们可以人工补齐4K来避免额外的读开销，当然这个优化不是必须的，同时要结合自己的实际场景来做抉择。</p>\n<h3 id=\"读写顺序\"><a class=\"header-anchor\" href=\"#读写顺序\">¶</a><strong>读写顺序</strong></h3>\n<p>顺序读写和随机读写一直以来都是读写性能优化中最重要的一点，无论HDD还是SSD，读写方式的不同所带来的影响也不同。随机读写意味着要重新寻址，对于HDD来说需要磁头的切换甚至柱面的切换，SSD则需要重新定位行列地址线，相比于HDD，SSD不需要机械运动，因此随机读写带来的影响会小很多，而顺序读写可以免去再次寻址过程，在应用设计允许的情况下，顺序读写都是最优之选。</p>\n<p>对于SSD来说，顺序写可以保证数据有序的写在相邻的Page和Block中，当数据或文件删除时，GC垃圾也相对比较集中，可以大大降低WA带来的影响。</p>\n<p>主流操作系统都会有预读，顺序读可以提高预读缓存命中率，减少硬件读取次数。所以，如果可以，请尽可能顺序读写。</p>\n<h1><strong>参考</strong></h1>\n<ul>\n<li><a href=\"https://www.cnblogs.com/whl320124/articles/10063813.html\">深入了解机械硬盘的读写原理和碎片的产生</a></li>\n<li><a href=\"https://blog.csdn.net/wangshouchao/article/details/48606639\">内存（DRAM）的工作原理及时序介绍</a></li>\n<li><a href=\"http://www.wowotech.net/basic_tech/307.html\">DRAM 原理 1 ：DRAM Storage Cell</a></li>\n<li><a href=\"http://hardwarehell.com/articles/ras_cas.htm\">Meaning Behind Ram RAS and CAS</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/52272990\">浅聊SRAM和DRAM的区别</a></li>\n<li><a href=\"https://blog.joway.io/posts/ssd-notes/\">SSD 背后的奥秘</a></li>\n<li><a href=\"https://item.jd.com/12367097.html\">深入浅出SSD - 固态存储核心技术原理与实战</a></li>\n</ul>\n"},{"title":"深入浅说服务如何以Jar包的方式发布","author":"Nico","date":"2018-11-06T04:49:00.000Z","_content":"###### 序言 \n笔者前段时间在使用自研框架NF( [传送门](https://gitee.com/ainilili/No-Framework) )开发一个自动模板生成工具之后，想将他发布到Linux下，之前一直使用IDE直接``run as``运行，在遇到发布的时候考虑过发布为war或者jar，在一番抉择之后最终选择了jar（原因是NF自带服务容器，而war为tomcat而生，所以jar更适合NF），所以特意研究了一番如何将普通项目打包成jar发布。\n\n不出意外，最终我成功了，在兴奋之余，希望能够将自己实现的过程及遇到的坑记录下来，让看到有此需求的同学们少走一些弯路！\n\n#### 一、何为Jar\nJAR 文件格式以流行的 ZIP 文件格式为基础。与 ZIP 文件不同的是，JAR 文件不仅用于压缩和发布，而且还用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。在 JAR 中包含特殊的文件，如 manifests 和部署描述符，用来指示工具如何处理特定的 JAR。\n\n更多详情通过 [传送门](https://www.ibm.com/developerworks/cn/java/j-jar/index.html) 查阅。\n#### 二、发布服务的几种方案\n在web开发完成之后，我们往往想要发布服务到外网服务器中，而外网服务器大多是都是Linux系统，这时我们不能已常规方式直接在IDE中运行，需要特定几种形式去发布。\n\n我们最初最常用的方式就是打包成``.war``的格式发布到Tomcat的服务容器中，这之后Tomcat会帮助我们解压war包，并加载``classes``文件夹下的``.class``到内存中，加载完毕之后，我们的服务就可以在服务器中正常运行，但是``.war``通常只适合配合Tomcat容器，对于其他服务容器，尤其是自研服务容器来讲，适用性非常差，而``Spring Boot``率先打破了常规。\n\nSpring Boot采用jar的方式发布，也就是说，我们可以使用Spring Boot提供的maven插件，通过``mvn package``指令将服务打包成jar的形式发布，这就意味着服务中涉及的所有资源（class文件、依赖jar包、静态资源文件）都将会打包在一个jar包之内，在启动这个层次来讲就异常的简单了，只需要通过``java -jar xxxx.jar``的方式就可以正常启动服务，这对于我们在自己的服务器中去启动服务来说非常的方便，而Spring Boot是怎么做到这一点的呢？\n\n我们来看一下Spring Boot的``pom.xml``依赖插件 ``spring-boot-maven-plugin ``，全配置如下\n```\n<plugin>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-maven-plugin</artifactId>\n    <configuration>\n        <mainClass>${start-class}</mainClass>\n    </configuration>\n</plugin>\n```\n我们通过之前对Jar包的了解已经得知，一个可执行jar的必要因素就是需要一个主函数入口，在上述配置中，我们可以看到很明确的主函数配置``<mainClass>${start-class}</mainClass>``， 而占位符``${start-class}``的值就是我们平常开发中用来启动Spring Boot的主函数入口所在类，继续深入``spring-boot-maven-plugin``中，我们会看到这个插件内部依赖了更多maven自带的原生插件\n\n - maven-failsafe-plugin\n - maven-jar-plugin\n - maven-surefire-plugin\n - maven-war-plugin\n - maven-resources-plugin\n - maven-shade-plugin\n\n另外少部分插件如下\n\n - exec-maven-plugin\n - git-commit-id-plugin\n - spring-boot-maven-plugin 自依赖，为了支持自己的插件\n\n从以上插件列表分析，``spring-boot-maven-plugin``中包含了很多maven原生插件，支持``jar``和 ``war``的格式发布，我们只站在打包可执行jar的角度来分析以上插件的作用，可以这样理解\n\n- maven-jar-plugin \n > 设定``manifest``中的``Main-Class``参数\n\n- maven-shade-plugin \n > 用于把多个jar包，打成1个jar包\n\n- maven-resources-plugin \n > 处理将项目资源（``src/main/``和 ``src/test``）复制到输出目录的操作\n \n- maven-surefire-plugin 和 maven-failsafe-plugin\n> 执行测试用例\n\n依赖插件的同时，``spring-boot-maven-plugin``中还使用``<resources>``标签来重新定义jar包内部结构。\n\n以上信息是否满足将我们的服务打包成可执行jar呢？我们分析一下，如果达到我们想要的效果，我们需要\n\n 1. 自动配置主函数入口\n 2. 静态资源打包\n 3. 依赖打包\n \n对比上述插件，我们需要的功能都有，那么我们是否可以使用上方的插件及标签自己写个打包插件试试呢？ 当然！这里就不带着大家亲自尝试了，因为下面我要讲另一种Spring Boot没有用到的maven插件进行打包！\n\n#### 三、maven-assembly-plugin 插件打包Jar\n\n``maven-assembly-plugin``是一个超灵活maven项目打包工具，提供默认配置和自定义配置，同时提供``Main-Class``的配置、静态文件Copy及依赖打包的功能，这里是官方对于这款插件的介绍\n> The Assembly Plugin for Maven is primarily intended to allow users to aggregate the project output along with its dependencies, modules, site documentation, and other files into a single distributable archive.\n> Your project can build distribution \"assemblies\" easily, using one of the convenient, prefabricated assembly descriptors. These descriptors handle many common operations, such as packaging a project's artifact along with generated documentation into a single zip archive. Alternatively, your project can provide its own descriptor and assume a much higher level of control over how dependencies, modules, file-sets, and individual files are packaged in the assembly.\n\n\n大概意思就是\n\nMaven的组装插件主要是允许用户将项目输出与它的依赖项、模块、站点文档和其他文件一起集成到一个可分发的归档文件中。您的项目可以使用一种方便的预制组装描述符轻松地构建分布“程序集”。这些描述符处理许多常见的操作，例如将项目的工件连同生成的文档打包到一个zip归档文件中。或者，您的项目可以提供自己的描述符，并对依赖项、模块、文件集和各个文件如何在程序集中打包具有更高的控制级别。\n\n通俗一点，你可以自定义你的项目打包格式，``maven-assembly-plugin``更像是多个打包插件的集成，并提供多种打包的文件格式，使用方面也很方便，最简单的一个使用如下\n\n```\n<plugin>\n\t   <artifactId> maven-assembly-plugin </artifactId>\n\t   <configuration>\n\t\t\t<descriptorRefs>\n\t\t\t\t <descriptorRef>jar-with-dependencies</descriptorRef>\n\t\t\t</descriptorRefs>\n\t\t\t<archive>\n\t\t\t\t <manifest>\n\t\t\t\t\t  <mainClass>${main-class}</mainClass>\n\t\t\t\t </manifest>\n\t\t\t</archive>\n\t   </configuration>\n\t   <executions>\n\t\t\t<execution>\n\t\t\t\t <id>make-assembly</id>\n\t\t\t\t <phase>package</phase>\n\t\t\t\t <goals>\n\t\t\t\t\t  <goal>single</goal>\n\t\t\t\t </goals>\n\t\t\t</execution>\n\t   </executions>\n</plugin>\n```\n``descriptorRefs``标签内部可以配置使用官方定制好的打包方式，其中如下可选配置\n - bin\n - jar-with-dependencies\n - src\n - project\n不过官方定制好的有很大的局限性，我们可以将上述改成如下配置，来自定义打包方式\n```\n<plugin>\n\t<artifactId>maven-assembly-plugin</artifactId>\n\t<configuration>\n\t\t<archive>\n\t\t\t<manifest>\n\t\t\t\t<mainClass>${main-class}</mainClass>\n\t\t\t</manifest>\n\t\t</archive>\n\t\t<descriptors>\n            <descriptor>src/main/resource/assembly-fat.xml</descriptor>\n        </descriptors>\n\t</configuration>\n\t<executions>\n         <execution>\n               <id>make-assembly</id>\n               <phase>package</phase>\n               <goals>\n                    <goal>single</goal>\n               </goals>\n          </execution>\n     </executions>\n</plugin>\n```\n可以看出，上述配置去掉了``<descriptorRefs>``标签，增加了``<descriptors>``配置，并且子标签中还指向了``src/main/resource/assembly-fat.xml``这个配置文件，如果你的思路跟着这篇文章走，一定可以猜得到，这个配置文件就是我们自定义打包方式的入口！它的格式如下\n```\n<assembly xmlns=\"http://maven.apache.org/ASSEMBLY/2.0.0\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd\">\n  <id>distribution</id>\n  \n  <formats>\n    <format>jar</format>\n  </formats>\n  \n  <dependencySets>\n\t\t<dependencySet>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<useProjectArtifact>true</useProjectArtifact>\n\t\t\t<unpack>true</unpack>\n\t\t\t<scope>runtime</scope>\n\t\t</dependencySet>\n\t</dependencySets>\n\t\n  <includeBaseDirectory>false</includeBaseDirectory>\n  \n  <fileSets>\n    <fileSet>\n      <directory>${basedir}</directory>\n      <includes>\n        <include>*.txt</include>\n      </includes>\n      <excludes>\n        <exclude>README.txt</exclude>\n        <exclude>NOTICE.txt</exclude>\n      </excludes>\n    </fileSet>\n  </fileSets>\n  \n  <files>\n    <file>\n      <source>README.txt</source>\n      <outputDirectory>/</outputDirectory>\n      <filtered>true</filtered>\n    </file>\n    <file>\n      <source>NOTICE.txt</source>\n      <outputDirectory>/</outputDirectory>\n      <filtered>true</filtered>\n    </file>\n  </files>\n</assembly>\n```\n##### 下面是标签的相关介绍\n - ``<id>`` 生成文件的后缀，如果有，文件名将会是``${artifactId}-${id}.jar``\n - ``<formats>``生成文件的格式，可以同时生成多个格式的目标文件\n - ``dependencySets``依赖jar的打包方式\n - ``includeBaseDirectory``是否将项目目录引入进来，如果是**True**的话，生成的目标文件打开之后将会是项目主目录，我们打包的资源将会被放于这个主目录中（推荐**Fasle**，因为``Main-Class``路径通常直接是类路径）\n - ``<fileSets>``引入静态资源的配置（目录级）\n - ``files``引入静态资源的配置（文件级）\n\n以上是最常用的几种标签，更多的配置大家可以查阅官网 [传送门](maven.apache.org/components/plugins/maven-assembly-plugin/)\n\n配置完成之后可以通过``mvn assembly:assembly``或者``mvn package``指令打包。\n\n介绍完毕，下面会拉取笔者自己用[NF](https://gitee.com/ainilili/No-Framework)框架开发的模板工具来为大家演示一下``maven-assembly-plugin``在实战中的使用！\n\n#### 四、Jar方式发布服务实战\n首先是项目结构\n```\nProject\n│  LICENSE\n│  pom.xml\t\t\t\t\t\t\t\t=》pom文件\n│  README.md\n├─src\n│  └─main\n│      ├─java\t\t\t\t\t\t\t=》源码目录\n│      └─resource\t\t\t\t\t\t=》配置文件目录\n└─web\t\t\t\t\t\t\t\t\t=》UI静态资源\n```\n从结构中可以看出，我们需要手动配置的打包资源是``src/main/resource``和``web``这两个目录，所以我们需要所有配置，将上述两个目录随着我们的``.class``文件一起打包进jar中，首先在原pom.xml保持不变的基础上插入``maven-assembly-plugin``插件\n```\n<plugin>\n\t<artifactId>maven-assembly-plugin</artifactId>\n\t<configuration>\n\t\t<source>1.8</source>\n\t\t<target>1.8</target>\n\t\t<archive>\n\t\t\t<manifest>\n\t\t\t\t<mainClass>org.nico.ct.CtApplication</mainClass>\n\t\t\t</manifest>\n\t\t</archive>\n\t\t<descriptors>\n\t\t\t<descriptor>src/main/resource/assembly-fat.xml</descriptor>\n\t\t</descriptors>\n\t</configuration>\n\t<executions>\n\t\t<execution>\n\t\t\t <id>make-assembly</id>\n\t\t\t <phase>package</phase>\n\t\t\t <goals>\n\t\t\t\t  <goal>single</goal>\n\t\t\t </goals>\n\t\t</execution>\n   </executions>\n</plugin>\n```\n接下来编辑``src/main/resource/assembly-fat.xml``文件配置打包\n```\n<assembly\n\txmlns=\"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3\"\n\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n\txsi:schemaLocation=\"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd\">\n\t<id>RELEASE</id>\n\n\t<formats>\n\t\t<format>jar</format>\n\t</formats>\n\n\t<dependencySets>\n\t\t<dependencySet>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<useProjectArtifact>true</useProjectArtifact>\n\t\t\t<unpack>true</unpack>\n\t\t\t<scope>runtime</scope>\n\t\t</dependencySet>\n\t</dependencySets>\n\t\n\t<includeBaseDirectory>false</includeBaseDirectory>\n\t\n\t<fileSets>\n\t\t<fileSet>\n\t\t\t<directory>src/main/resource</directory>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<includes>\n\t\t\t\t<include>/**</include>\n\t\t\t</includes>\n\t\t</fileSet>\n\t\t<fileSet>\n\t\t\t<directory>web</directory>\n\t\t\t<outputDirectory>/web</outputDirectory>\n\t\t\t<includes>\n\t\t\t\t<include>/**</include>\n\t\t\t</includes>\n\t\t</fileSet>\n\t</fileSets>\n\n\n\t<files>\n\t\t<file>\n\t\t\t<source>README.md</source>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t</file>\n\t</files>\n\n</assembly>\n```\n然后运行``mvn assembly:assembly``，等待maven构建成功\n```\n...\n[INFO] META-INF/ already added, skipping\n[INFO] META-INF/MANIFEST.MF already added, skipping\n[INFO] org/ already added, skipping\n[INFO] org/nico/ already added, skipping\n[INFO] META-INF/maven/ already added, skipping\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 7.627 s\n[INFO] Finished at: 2018-06-30T15:39:47+08:00\n[INFO] Final Memory: 24M/269M\n[INFO] ------------------------------------------------------------------------\n```\n看到``BUILD SUCCESS``之后，你会发现项目target目录中会有两个jar\n\n - CoffeeTime-0.0.1-SNAPSHOT.jar\n - CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar\n\n文件名请忽略，后缀带``RELEASE``的jar就是``maven-assembly-plugin``插件生成的jar，解压看下目录\n```\n│  assembly-fat.xml\n│  cat-mysql-nico.xml\n│  cat-mysql.xml\n│  cat-redis-nico.xml\n│  cat-redis.xml\n│  cat.xml\n│  logno.properties\n│  module-info.class\n│  README.md\n├─com\n│  ├─mchange\n│  │ \n│  └─mysql  \n├─images\n├─META-INF\n│  ├─maven\n│  │ \n│  └─services\n├─net\n│  └─sf    \n├─org\n│  ├─apache\n│  │  \n│  ├─gjt\n│  │ \n│  ├─nico\n│  ├─objectweb\n│  └─slf4j\n│ \n├─redis\n│  └─clients\n│\n└─web\n    ├─images\n    ├─page \n    ├─plugins  \n    ├─script\n    ├─style\n    ├─video\n    └─videojs\n```    \n\n路径没问题，我们试下能不能运行，切到jar包所在的目录，执行``jar -jar CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar``运行之\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e78328722cfc4?w=1389&h=752&f=png&s=66225)\n\nSUCCESS !","source":"_posts/深入浅说服务如何以Jar包的方式发布.md","raw":"title: 深入浅说服务如何以Jar包的方式发布\nauthor: Nico\ntags:\n  - Java\n  - Maven\ncategories: []\ndate: 2018-11-06 12:49:00\n---\n###### 序言 \n笔者前段时间在使用自研框架NF( [传送门](https://gitee.com/ainilili/No-Framework) )开发一个自动模板生成工具之后，想将他发布到Linux下，之前一直使用IDE直接``run as``运行，在遇到发布的时候考虑过发布为war或者jar，在一番抉择之后最终选择了jar（原因是NF自带服务容器，而war为tomcat而生，所以jar更适合NF），所以特意研究了一番如何将普通项目打包成jar发布。\n\n不出意外，最终我成功了，在兴奋之余，希望能够将自己实现的过程及遇到的坑记录下来，让看到有此需求的同学们少走一些弯路！\n\n#### 一、何为Jar\nJAR 文件格式以流行的 ZIP 文件格式为基础。与 ZIP 文件不同的是，JAR 文件不仅用于压缩和发布，而且还用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。在 JAR 中包含特殊的文件，如 manifests 和部署描述符，用来指示工具如何处理特定的 JAR。\n\n更多详情通过 [传送门](https://www.ibm.com/developerworks/cn/java/j-jar/index.html) 查阅。\n#### 二、发布服务的几种方案\n在web开发完成之后，我们往往想要发布服务到外网服务器中，而外网服务器大多是都是Linux系统，这时我们不能已常规方式直接在IDE中运行，需要特定几种形式去发布。\n\n我们最初最常用的方式就是打包成``.war``的格式发布到Tomcat的服务容器中，这之后Tomcat会帮助我们解压war包，并加载``classes``文件夹下的``.class``到内存中，加载完毕之后，我们的服务就可以在服务器中正常运行，但是``.war``通常只适合配合Tomcat容器，对于其他服务容器，尤其是自研服务容器来讲，适用性非常差，而``Spring Boot``率先打破了常规。\n\nSpring Boot采用jar的方式发布，也就是说，我们可以使用Spring Boot提供的maven插件，通过``mvn package``指令将服务打包成jar的形式发布，这就意味着服务中涉及的所有资源（class文件、依赖jar包、静态资源文件）都将会打包在一个jar包之内，在启动这个层次来讲就异常的简单了，只需要通过``java -jar xxxx.jar``的方式就可以正常启动服务，这对于我们在自己的服务器中去启动服务来说非常的方便，而Spring Boot是怎么做到这一点的呢？\n\n我们来看一下Spring Boot的``pom.xml``依赖插件 ``spring-boot-maven-plugin ``，全配置如下\n```\n<plugin>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-maven-plugin</artifactId>\n    <configuration>\n        <mainClass>${start-class}</mainClass>\n    </configuration>\n</plugin>\n```\n我们通过之前对Jar包的了解已经得知，一个可执行jar的必要因素就是需要一个主函数入口，在上述配置中，我们可以看到很明确的主函数配置``<mainClass>${start-class}</mainClass>``， 而占位符``${start-class}``的值就是我们平常开发中用来启动Spring Boot的主函数入口所在类，继续深入``spring-boot-maven-plugin``中，我们会看到这个插件内部依赖了更多maven自带的原生插件\n\n - maven-failsafe-plugin\n - maven-jar-plugin\n - maven-surefire-plugin\n - maven-war-plugin\n - maven-resources-plugin\n - maven-shade-plugin\n\n另外少部分插件如下\n\n - exec-maven-plugin\n - git-commit-id-plugin\n - spring-boot-maven-plugin 自依赖，为了支持自己的插件\n\n从以上插件列表分析，``spring-boot-maven-plugin``中包含了很多maven原生插件，支持``jar``和 ``war``的格式发布，我们只站在打包可执行jar的角度来分析以上插件的作用，可以这样理解\n\n- maven-jar-plugin \n > 设定``manifest``中的``Main-Class``参数\n\n- maven-shade-plugin \n > 用于把多个jar包，打成1个jar包\n\n- maven-resources-plugin \n > 处理将项目资源（``src/main/``和 ``src/test``）复制到输出目录的操作\n \n- maven-surefire-plugin 和 maven-failsafe-plugin\n> 执行测试用例\n\n依赖插件的同时，``spring-boot-maven-plugin``中还使用``<resources>``标签来重新定义jar包内部结构。\n\n以上信息是否满足将我们的服务打包成可执行jar呢？我们分析一下，如果达到我们想要的效果，我们需要\n\n 1. 自动配置主函数入口\n 2. 静态资源打包\n 3. 依赖打包\n \n对比上述插件，我们需要的功能都有，那么我们是否可以使用上方的插件及标签自己写个打包插件试试呢？ 当然！这里就不带着大家亲自尝试了，因为下面我要讲另一种Spring Boot没有用到的maven插件进行打包！\n\n#### 三、maven-assembly-plugin 插件打包Jar\n\n``maven-assembly-plugin``是一个超灵活maven项目打包工具，提供默认配置和自定义配置，同时提供``Main-Class``的配置、静态文件Copy及依赖打包的功能，这里是官方对于这款插件的介绍\n> The Assembly Plugin for Maven is primarily intended to allow users to aggregate the project output along with its dependencies, modules, site documentation, and other files into a single distributable archive.\n> Your project can build distribution \"assemblies\" easily, using one of the convenient, prefabricated assembly descriptors. These descriptors handle many common operations, such as packaging a project's artifact along with generated documentation into a single zip archive. Alternatively, your project can provide its own descriptor and assume a much higher level of control over how dependencies, modules, file-sets, and individual files are packaged in the assembly.\n\n\n大概意思就是\n\nMaven的组装插件主要是允许用户将项目输出与它的依赖项、模块、站点文档和其他文件一起集成到一个可分发的归档文件中。您的项目可以使用一种方便的预制组装描述符轻松地构建分布“程序集”。这些描述符处理许多常见的操作，例如将项目的工件连同生成的文档打包到一个zip归档文件中。或者，您的项目可以提供自己的描述符，并对依赖项、模块、文件集和各个文件如何在程序集中打包具有更高的控制级别。\n\n通俗一点，你可以自定义你的项目打包格式，``maven-assembly-plugin``更像是多个打包插件的集成，并提供多种打包的文件格式，使用方面也很方便，最简单的一个使用如下\n\n```\n<plugin>\n\t   <artifactId> maven-assembly-plugin </artifactId>\n\t   <configuration>\n\t\t\t<descriptorRefs>\n\t\t\t\t <descriptorRef>jar-with-dependencies</descriptorRef>\n\t\t\t</descriptorRefs>\n\t\t\t<archive>\n\t\t\t\t <manifest>\n\t\t\t\t\t  <mainClass>${main-class}</mainClass>\n\t\t\t\t </manifest>\n\t\t\t</archive>\n\t   </configuration>\n\t   <executions>\n\t\t\t<execution>\n\t\t\t\t <id>make-assembly</id>\n\t\t\t\t <phase>package</phase>\n\t\t\t\t <goals>\n\t\t\t\t\t  <goal>single</goal>\n\t\t\t\t </goals>\n\t\t\t</execution>\n\t   </executions>\n</plugin>\n```\n``descriptorRefs``标签内部可以配置使用官方定制好的打包方式，其中如下可选配置\n - bin\n - jar-with-dependencies\n - src\n - project\n不过官方定制好的有很大的局限性，我们可以将上述改成如下配置，来自定义打包方式\n```\n<plugin>\n\t<artifactId>maven-assembly-plugin</artifactId>\n\t<configuration>\n\t\t<archive>\n\t\t\t<manifest>\n\t\t\t\t<mainClass>${main-class}</mainClass>\n\t\t\t</manifest>\n\t\t</archive>\n\t\t<descriptors>\n            <descriptor>src/main/resource/assembly-fat.xml</descriptor>\n        </descriptors>\n\t</configuration>\n\t<executions>\n         <execution>\n               <id>make-assembly</id>\n               <phase>package</phase>\n               <goals>\n                    <goal>single</goal>\n               </goals>\n          </execution>\n     </executions>\n</plugin>\n```\n可以看出，上述配置去掉了``<descriptorRefs>``标签，增加了``<descriptors>``配置，并且子标签中还指向了``src/main/resource/assembly-fat.xml``这个配置文件，如果你的思路跟着这篇文章走，一定可以猜得到，这个配置文件就是我们自定义打包方式的入口！它的格式如下\n```\n<assembly xmlns=\"http://maven.apache.org/ASSEMBLY/2.0.0\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd\">\n  <id>distribution</id>\n  \n  <formats>\n    <format>jar</format>\n  </formats>\n  \n  <dependencySets>\n\t\t<dependencySet>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<useProjectArtifact>true</useProjectArtifact>\n\t\t\t<unpack>true</unpack>\n\t\t\t<scope>runtime</scope>\n\t\t</dependencySet>\n\t</dependencySets>\n\t\n  <includeBaseDirectory>false</includeBaseDirectory>\n  \n  <fileSets>\n    <fileSet>\n      <directory>${basedir}</directory>\n      <includes>\n        <include>*.txt</include>\n      </includes>\n      <excludes>\n        <exclude>README.txt</exclude>\n        <exclude>NOTICE.txt</exclude>\n      </excludes>\n    </fileSet>\n  </fileSets>\n  \n  <files>\n    <file>\n      <source>README.txt</source>\n      <outputDirectory>/</outputDirectory>\n      <filtered>true</filtered>\n    </file>\n    <file>\n      <source>NOTICE.txt</source>\n      <outputDirectory>/</outputDirectory>\n      <filtered>true</filtered>\n    </file>\n  </files>\n</assembly>\n```\n##### 下面是标签的相关介绍\n - ``<id>`` 生成文件的后缀，如果有，文件名将会是``${artifactId}-${id}.jar``\n - ``<formats>``生成文件的格式，可以同时生成多个格式的目标文件\n - ``dependencySets``依赖jar的打包方式\n - ``includeBaseDirectory``是否将项目目录引入进来，如果是**True**的话，生成的目标文件打开之后将会是项目主目录，我们打包的资源将会被放于这个主目录中（推荐**Fasle**，因为``Main-Class``路径通常直接是类路径）\n - ``<fileSets>``引入静态资源的配置（目录级）\n - ``files``引入静态资源的配置（文件级）\n\n以上是最常用的几种标签，更多的配置大家可以查阅官网 [传送门](maven.apache.org/components/plugins/maven-assembly-plugin/)\n\n配置完成之后可以通过``mvn assembly:assembly``或者``mvn package``指令打包。\n\n介绍完毕，下面会拉取笔者自己用[NF](https://gitee.com/ainilili/No-Framework)框架开发的模板工具来为大家演示一下``maven-assembly-plugin``在实战中的使用！\n\n#### 四、Jar方式发布服务实战\n首先是项目结构\n```\nProject\n│  LICENSE\n│  pom.xml\t\t\t\t\t\t\t\t=》pom文件\n│  README.md\n├─src\n│  └─main\n│      ├─java\t\t\t\t\t\t\t=》源码目录\n│      └─resource\t\t\t\t\t\t=》配置文件目录\n└─web\t\t\t\t\t\t\t\t\t=》UI静态资源\n```\n从结构中可以看出，我们需要手动配置的打包资源是``src/main/resource``和``web``这两个目录，所以我们需要所有配置，将上述两个目录随着我们的``.class``文件一起打包进jar中，首先在原pom.xml保持不变的基础上插入``maven-assembly-plugin``插件\n```\n<plugin>\n\t<artifactId>maven-assembly-plugin</artifactId>\n\t<configuration>\n\t\t<source>1.8</source>\n\t\t<target>1.8</target>\n\t\t<archive>\n\t\t\t<manifest>\n\t\t\t\t<mainClass>org.nico.ct.CtApplication</mainClass>\n\t\t\t</manifest>\n\t\t</archive>\n\t\t<descriptors>\n\t\t\t<descriptor>src/main/resource/assembly-fat.xml</descriptor>\n\t\t</descriptors>\n\t</configuration>\n\t<executions>\n\t\t<execution>\n\t\t\t <id>make-assembly</id>\n\t\t\t <phase>package</phase>\n\t\t\t <goals>\n\t\t\t\t  <goal>single</goal>\n\t\t\t </goals>\n\t\t</execution>\n   </executions>\n</plugin>\n```\n接下来编辑``src/main/resource/assembly-fat.xml``文件配置打包\n```\n<assembly\n\txmlns=\"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3\"\n\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n\txsi:schemaLocation=\"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd\">\n\t<id>RELEASE</id>\n\n\t<formats>\n\t\t<format>jar</format>\n\t</formats>\n\n\t<dependencySets>\n\t\t<dependencySet>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<useProjectArtifact>true</useProjectArtifact>\n\t\t\t<unpack>true</unpack>\n\t\t\t<scope>runtime</scope>\n\t\t</dependencySet>\n\t</dependencySets>\n\t\n\t<includeBaseDirectory>false</includeBaseDirectory>\n\t\n\t<fileSets>\n\t\t<fileSet>\n\t\t\t<directory>src/main/resource</directory>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t\t<includes>\n\t\t\t\t<include>/**</include>\n\t\t\t</includes>\n\t\t</fileSet>\n\t\t<fileSet>\n\t\t\t<directory>web</directory>\n\t\t\t<outputDirectory>/web</outputDirectory>\n\t\t\t<includes>\n\t\t\t\t<include>/**</include>\n\t\t\t</includes>\n\t\t</fileSet>\n\t</fileSets>\n\n\n\t<files>\n\t\t<file>\n\t\t\t<source>README.md</source>\n\t\t\t<outputDirectory>/</outputDirectory>\n\t\t</file>\n\t</files>\n\n</assembly>\n```\n然后运行``mvn assembly:assembly``，等待maven构建成功\n```\n...\n[INFO] META-INF/ already added, skipping\n[INFO] META-INF/MANIFEST.MF already added, skipping\n[INFO] org/ already added, skipping\n[INFO] org/nico/ already added, skipping\n[INFO] META-INF/maven/ already added, skipping\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 7.627 s\n[INFO] Finished at: 2018-06-30T15:39:47+08:00\n[INFO] Final Memory: 24M/269M\n[INFO] ------------------------------------------------------------------------\n```\n看到``BUILD SUCCESS``之后，你会发现项目target目录中会有两个jar\n\n - CoffeeTime-0.0.1-SNAPSHOT.jar\n - CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar\n\n文件名请忽略，后缀带``RELEASE``的jar就是``maven-assembly-plugin``插件生成的jar，解压看下目录\n```\n│  assembly-fat.xml\n│  cat-mysql-nico.xml\n│  cat-mysql.xml\n│  cat-redis-nico.xml\n│  cat-redis.xml\n│  cat.xml\n│  logno.properties\n│  module-info.class\n│  README.md\n├─com\n│  ├─mchange\n│  │ \n│  └─mysql  \n├─images\n├─META-INF\n│  ├─maven\n│  │ \n│  └─services\n├─net\n│  └─sf    \n├─org\n│  ├─apache\n│  │  \n│  ├─gjt\n│  │ \n│  ├─nico\n│  ├─objectweb\n│  └─slf4j\n│ \n├─redis\n│  └─clients\n│\n└─web\n    ├─images\n    ├─page \n    ├─plugins  \n    ├─script\n    ├─style\n    ├─video\n    └─videojs\n```    \n\n路径没问题，我们试下能不能运行，切到jar包所在的目录，执行``jar -jar CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar``运行之\n![这里写图片描述](https://user-gold-cdn.xitu.io/2018/11/6/166e78328722cfc4?w=1389&h=752&f=png&s=66225)\n\nSUCCESS !","slug":"深入浅说服务如何以Jar包的方式发布","published":1,"updated":"2021-03-21T17:43:05.559Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyh0016b0tzhvs1001b","content":"<h6 id=\"序言\"><a class=\"header-anchor\" href=\"#序言\">¶</a>序言</h6>\n<p>笔者前段时间在使用自研框架NF( <a href=\"https://gitee.com/ainilili/No-Framework\">传送门</a> )开发一个自动模板生成工具之后，想将他发布到Linux下，之前一直使用IDE直接<code>run as</code>运行，在遇到发布的时候考虑过发布为war或者jar，在一番抉择之后最终选择了jar（原因是NF自带服务容器，而war为tomcat而生，所以jar更适合NF），所以特意研究了一番如何将普通项目打包成jar发布。</p>\n<p>不出意外，最终我成功了，在兴奋之余，希望能够将自己实现的过程及遇到的坑记录下来，让看到有此需求的同学们少走一些弯路！</p>\n<h4 id=\"一-何为jar\"><a class=\"header-anchor\" href=\"#一-何为jar\">¶</a>一、何为Jar</h4>\n<p>JAR 文件格式以流行的 ZIP 文件格式为基础。与 ZIP 文件不同的是，JAR 文件不仅用于压缩和发布，而且还用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。在 JAR 中包含特殊的文件，如 manifests 和部署描述符，用来指示工具如何处理特定的 JAR。</p>\n<p>更多详情通过 <a href=\"https://www.ibm.com/developerworks/cn/java/j-jar/index.html\">传送门</a> 查阅。</p>\n<h4 id=\"二-发布服务的几种方案\"><a class=\"header-anchor\" href=\"#二-发布服务的几种方案\">¶</a>二、发布服务的几种方案</h4>\n<p>在web开发完成之后，我们往往想要发布服务到外网服务器中，而外网服务器大多是都是Linux系统，这时我们不能已常规方式直接在IDE中运行，需要特定几种形式去发布。</p>\n<p>我们最初最常用的方式就是打包成<code>.war</code>的格式发布到Tomcat的服务容器中，这之后Tomcat会帮助我们解压war包，并加载<code>classes</code>文件夹下的<code>.class</code>到内存中，加载完毕之后，我们的服务就可以在服务器中正常运行，但是<code>.war</code>通常只适合配合Tomcat容器，对于其他服务容器，尤其是自研服务容器来讲，适用性非常差，而<code>Spring Boot</code>率先打破了常规。</p>\n<p>Spring Boot采用jar的方式发布，也就是说，我们可以使用Spring Boot提供的maven插件，通过<code>mvn package</code>指令将服务打包成jar的形式发布，这就意味着服务中涉及的所有资源（class文件、依赖jar包、静态资源文件）都将会打包在一个jar包之内，在启动这个层次来讲就异常的简单了，只需要通过<code>java -jar xxxx.jar</code>的方式就可以正常启动服务，这对于我们在自己的服务器中去启动服务来说非常的方便，而Spring Boot是怎么做到这一点的呢？</p>\n<p>我们来看一下Spring Boot的<code>pom.xml</code>依赖插件 <code>spring-boot-maven-plugin</code>，全配置如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>我们通过之前对Jar包的了解已经得知，一个可执行jar的必要因素就是需要一个主函数入口，在上述配置中，我们可以看到很明确的主函数配置<code>&lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</code>， 而占位符<code>$&#123;start-class&#125;</code>的值就是我们平常开发中用来启动Spring Boot的主函数入口所在类，继续深入<code>spring-boot-maven-plugin</code>中，我们会看到这个插件内部依赖了更多maven自带的原生插件</p>\n<ul>\n<li>maven-failsafe-plugin</li>\n<li>maven-jar-plugin</li>\n<li>maven-surefire-plugin</li>\n<li>maven-war-plugin</li>\n<li>maven-resources-plugin</li>\n<li>maven-shade-plugin</li>\n</ul>\n<p>另外少部分插件如下</p>\n<ul>\n<li>exec-maven-plugin</li>\n<li>git-commit-id-plugin</li>\n<li>spring-boot-maven-plugin 自依赖，为了支持自己的插件</li>\n</ul>\n<p>从以上插件列表分析，<code>spring-boot-maven-plugin</code>中包含了很多maven原生插件，支持<code>jar</code>和 <code>war</code>的格式发布，我们只站在打包可执行jar的角度来分析以上插件的作用，可以这样理解</p>\n<ul>\n<li>maven-jar-plugin</li>\n</ul>\n<blockquote>\n<p>设定<code>manifest</code>中的<code>Main-Class</code>参数</p>\n</blockquote>\n<ul>\n<li>maven-shade-plugin</li>\n</ul>\n<blockquote>\n<p>用于把多个jar包，打成1个jar包</p>\n</blockquote>\n<ul>\n<li>maven-resources-plugin</li>\n</ul>\n<blockquote>\n<p>处理将项目资源（<code>src/main/</code>和 <code>src/test</code>）复制到输出目录的操作</p>\n</blockquote>\n<ul>\n<li>maven-surefire-plugin 和 maven-failsafe-plugin</li>\n</ul>\n<blockquote>\n<p>执行测试用例</p>\n</blockquote>\n<p>依赖插件的同时，<code>spring-boot-maven-plugin</code>中还使用<code>&lt;resources&gt;</code>标签来重新定义jar包内部结构。</p>\n<p>以上信息是否满足将我们的服务打包成可执行jar呢？我们分析一下，如果达到我们想要的效果，我们需要</p>\n<ol>\n<li>自动配置主函数入口</li>\n<li>静态资源打包</li>\n<li>依赖打包</li>\n</ol>\n<p>对比上述插件，我们需要的功能都有，那么我们是否可以使用上方的插件及标签自己写个打包插件试试呢？ 当然！这里就不带着大家亲自尝试了，因为下面我要讲另一种Spring Boot没有用到的maven插件进行打包！</p>\n<h4 id=\"三-maven-assembly-plugin-插件打包jar\"><a class=\"header-anchor\" href=\"#三-maven-assembly-plugin-插件打包jar\">¶</a>三、maven-assembly-plugin 插件打包Jar</h4>\n<p><code>maven-assembly-plugin</code>是一个超灵活maven项目打包工具，提供默认配置和自定义配置，同时提供<code>Main-Class</code>的配置、静态文件Copy及依赖打包的功能，这里是官方对于这款插件的介绍</p>\n<blockquote>\n<p>The Assembly Plugin for Maven is primarily intended to allow users to aggregate the project output along with its dependencies, modules, site documentation, and other files into a single distributable archive.<br>\nYour project can build distribution “assemblies” easily, using one of the convenient, prefabricated assembly descriptors. These descriptors handle many common operations, such as packaging a project’s artifact along with generated documentation into a single zip archive. Alternatively, your project can provide its own descriptor and assume a much higher level of control over how dependencies, modules, file-sets, and individual files are packaged in the assembly.</p>\n</blockquote>\n<p>大概意思就是</p>\n<p>Maven的组装插件主要是允许用户将项目输出与它的依赖项、模块、站点文档和其他文件一起集成到一个可分发的归档文件中。您的项目可以使用一种方便的预制组装描述符轻松地构建分布“程序集”。这些描述符处理许多常见的操作，例如将项目的工件连同生成的文档打包到一个zip归档文件中。或者，您的项目可以提供自己的描述符，并对依赖项、模块、文件集和各个文件如何在程序集中打包具有更高的控制级别。</p>\n<p>通俗一点，你可以自定义你的项目打包格式，<code>maven-assembly-plugin</code>更像是多个打包插件的集成，并提供多种打包的文件格式，使用方面也很方便，最简单的一个使用如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t   &lt;artifactId&gt; maven-assembly-plugin &lt;/artifactId&gt;</span><br><span class=\"line\">\t   &lt;configuration&gt;</span><br><span class=\"line\">\t\t\t&lt;descriptorRefs&gt;</span><br><span class=\"line\">\t\t\t\t &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class=\"line\">\t\t\t&lt;/descriptorRefs&gt;</span><br><span class=\"line\">\t\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t\t &lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t\t  &lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t\t &lt;/manifest&gt;</span><br><span class=\"line\">\t\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t   &lt;/configuration&gt;</span><br><span class=\"line\">\t   &lt;executions&gt;</span><br><span class=\"line\">\t\t\t&lt;execution&gt;</span><br><span class=\"line\">\t\t\t\t &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">\t\t\t\t &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">\t\t\t\t &lt;goals&gt;</span><br><span class=\"line\">\t\t\t\t\t  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">\t\t\t\t &lt;/goals&gt;</span><br><span class=\"line\">\t\t\t&lt;/execution&gt;</span><br><span class=\"line\">\t   &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p><code>descriptorRefs</code>标签内部可以配置使用官方定制好的打包方式，其中如下可选配置</p>\n<ul>\n<li>bin</li>\n<li>jar-with-dependencies</li>\n<li>src</li>\n<li>project<br>\n不过官方定制好的有很大的局限性，我们可以将上述改成如下配置，来自定义打包方式</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">\t&lt;configuration&gt;</span><br><span class=\"line\">\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t&lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t&lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t&lt;/manifest&gt;</span><br><span class=\"line\">\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t\t&lt;descriptors&gt;</span><br><span class=\"line\">            &lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class=\"line\">        &lt;/descriptors&gt;</span><br><span class=\"line\">\t&lt;/configuration&gt;</span><br><span class=\"line\">\t&lt;executions&gt;</span><br><span class=\"line\">         &lt;execution&gt;</span><br><span class=\"line\">               &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">               &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">               &lt;goals&gt;</span><br><span class=\"line\">                    &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">               &lt;/goals&gt;</span><br><span class=\"line\">          &lt;/execution&gt;</span><br><span class=\"line\">     &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>可以看出，上述配置去掉了<code>&lt;descriptorRefs&gt;</code>标签，增加了<code>&lt;descriptors&gt;</code>配置，并且子标签中还指向了<code>src/main/resource/assembly-fat.xml</code>这个配置文件，如果你的思路跟着这篇文章走，一定可以猜得到，这个配置文件就是我们自定义打包方式的入口！它的格式如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;assembly xmlns=&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span><br><span class=\"line\">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">    xsi:schemaLocation=&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;&gt;</span><br><span class=\"line\">  &lt;id&gt;distribution&lt;/id&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;formats&gt;</span><br><span class=\"line\">    &lt;format&gt;jar&lt;/format&gt;</span><br><span class=\"line\">  &lt;/formats&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;dependencySets&gt;</span><br><span class=\"line\">\t\t&lt;dependencySet&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class=\"line\">\t\t\t&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class=\"line\">\t\t\t&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class=\"line\">\t\t&lt;/dependencySet&gt;</span><br><span class=\"line\">\t&lt;/dependencySets&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">  &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;fileSets&gt;</span><br><span class=\"line\">    &lt;fileSet&gt;</span><br><span class=\"line\">      &lt;directory&gt;$&#123;basedir&#125;&lt;/directory&gt;</span><br><span class=\"line\">      &lt;includes&gt;</span><br><span class=\"line\">        &lt;include&gt;*.txt&lt;/include&gt;</span><br><span class=\"line\">      &lt;/includes&gt;</span><br><span class=\"line\">      &lt;excludes&gt;</span><br><span class=\"line\">        &lt;exclude&gt;README.txt&lt;/exclude&gt;</span><br><span class=\"line\">        &lt;exclude&gt;NOTICE.txt&lt;/exclude&gt;</span><br><span class=\"line\">      &lt;/excludes&gt;</span><br><span class=\"line\">    &lt;/fileSet&gt;</span><br><span class=\"line\">  &lt;/fileSets&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;files&gt;</span><br><span class=\"line\">    &lt;file&gt;</span><br><span class=\"line\">      &lt;source&gt;README.txt&lt;/source&gt;</span><br><span class=\"line\">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class=\"line\">    &lt;/file&gt;</span><br><span class=\"line\">    &lt;file&gt;</span><br><span class=\"line\">      &lt;source&gt;NOTICE.txt&lt;/source&gt;</span><br><span class=\"line\">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class=\"line\">    &lt;/file&gt;</span><br><span class=\"line\">  &lt;/files&gt;</span><br><span class=\"line\">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>\n<h5 id=\"下面是标签的相关介绍\"><a class=\"header-anchor\" href=\"#下面是标签的相关介绍\">¶</a>下面是标签的相关介绍</h5>\n<ul>\n<li><code>&lt;id&gt;</code> 生成文件的后缀，如果有，文件名将会是<code>$&#123;artifactId&#125;-$&#123;id&#125;.jar</code></li>\n<li><code>&lt;formats&gt;</code>生成文件的格式，可以同时生成多个格式的目标文件</li>\n<li><code>dependencySets</code>依赖jar的打包方式</li>\n<li><code>includeBaseDirectory</code>是否将项目目录引入进来，如果是<strong>True</strong>的话，生成的目标文件打开之后将会是项目主目录，我们打包的资源将会被放于这个主目录中（推荐<strong>Fasle</strong>，因为<code>Main-Class</code>路径通常直接是类路径）</li>\n<li><code>&lt;fileSets&gt;</code>引入静态资源的配置（目录级）</li>\n<li><code>files</code>引入静态资源的配置（文件级）</li>\n</ul>\n<p>以上是最常用的几种标签，更多的配置大家可以查阅官网 <a href=\"maven.apache.org/components/plugins/maven-assembly-plugin/\">传送门</a></p>\n<p>配置完成之后可以通过<code>mvn assembly:assembly</code>或者<code>mvn package</code>指令打包。</p>\n<p>介绍完毕，下面会拉取笔者自己用<a href=\"https://gitee.com/ainilili/No-Framework\">NF</a>框架开发的模板工具来为大家演示一下<code>maven-assembly-plugin</code>在实战中的使用！</p>\n<h4 id=\"四-jar方式发布服务实战\"><a class=\"header-anchor\" href=\"#四-jar方式发布服务实战\">¶</a>四、Jar方式发布服务实战</h4>\n<p>首先是项目结构</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Project</span><br><span class=\"line\">│  LICENSE</span><br><span class=\"line\">│  pom.xml\t\t\t\t\t\t\t\t=》pom文件</span><br><span class=\"line\">│  README.md</span><br><span class=\"line\">├─src</span><br><span class=\"line\">│  └─main</span><br><span class=\"line\">│      ├─java\t\t\t\t\t\t\t=》源码目录</span><br><span class=\"line\">│      └─resource\t\t\t\t\t\t=》配置文件目录</span><br><span class=\"line\">└─web\t\t\t\t\t\t\t\t\t=》UI静态资源</span><br></pre></td></tr></table></figure>\n<p>从结构中可以看出，我们需要手动配置的打包资源是<code>src/main/resource</code>和<code>web</code>这两个目录，所以我们需要所有配置，将上述两个目录随着我们的<code>.class</code>文件一起打包进jar中，首先在原pom.xml保持不变的基础上插入<code>maven-assembly-plugin</code>插件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">\t&lt;configuration&gt;</span><br><span class=\"line\">\t\t&lt;source&gt;1.8&lt;/source&gt;</span><br><span class=\"line\">\t\t&lt;target&gt;1.8&lt;/target&gt;</span><br><span class=\"line\">\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t&lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t&lt;mainClass&gt;org.nico.ct.CtApplication&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t&lt;/manifest&gt;</span><br><span class=\"line\">\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t\t&lt;descriptors&gt;</span><br><span class=\"line\">\t\t\t&lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class=\"line\">\t\t&lt;/descriptors&gt;</span><br><span class=\"line\">\t&lt;/configuration&gt;</span><br><span class=\"line\">\t&lt;executions&gt;</span><br><span class=\"line\">\t\t&lt;execution&gt;</span><br><span class=\"line\">\t\t\t &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">\t\t\t &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">\t\t\t &lt;goals&gt;</span><br><span class=\"line\">\t\t\t\t  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">\t\t\t &lt;/goals&gt;</span><br><span class=\"line\">\t\t&lt;/execution&gt;</span><br><span class=\"line\">   &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>接下来编辑<code>src/main/resource/assembly-fat.xml</code>文件配置打包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;assembly</span><br><span class=\"line\">\txmlns=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3&quot;</span><br><span class=\"line\">\txmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">\txsi:schemaLocation=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd&quot;&gt;</span><br><span class=\"line\">\t&lt;id&gt;RELEASE&lt;/id&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;formats&gt;</span><br><span class=\"line\">\t\t&lt;format&gt;jar&lt;/format&gt;</span><br><span class=\"line\">\t&lt;/formats&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;dependencySets&gt;</span><br><span class=\"line\">\t\t&lt;dependencySet&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class=\"line\">\t\t\t&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class=\"line\">\t\t\t&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class=\"line\">\t\t&lt;/dependencySet&gt;</span><br><span class=\"line\">\t&lt;/dependencySets&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&lt;fileSets&gt;</span><br><span class=\"line\">\t\t&lt;fileSet&gt;</span><br><span class=\"line\">\t\t\t&lt;directory&gt;src/main/resource&lt;/directory&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;includes&gt;</span><br><span class=\"line\">\t\t\t\t&lt;include&gt;/**&lt;/include&gt;</span><br><span class=\"line\">\t\t\t&lt;/includes&gt;</span><br><span class=\"line\">\t\t&lt;/fileSet&gt;</span><br><span class=\"line\">\t\t&lt;fileSet&gt;</span><br><span class=\"line\">\t\t\t&lt;directory&gt;web&lt;/directory&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/web&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;includes&gt;</span><br><span class=\"line\">\t\t\t\t&lt;include&gt;/**&lt;/include&gt;</span><br><span class=\"line\">\t\t\t&lt;/includes&gt;</span><br><span class=\"line\">\t\t&lt;/fileSet&gt;</span><br><span class=\"line\">\t&lt;/fileSets&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;files&gt;</span><br><span class=\"line\">\t\t&lt;file&gt;</span><br><span class=\"line\">\t\t\t&lt;source&gt;README.md&lt;/source&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t&lt;/file&gt;</span><br><span class=\"line\">\t&lt;/files&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>\n<p>然后运行<code>mvn assembly:assembly</code>，等待maven构建成功</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">[INFO] META-INF/ already added, skipping</span><br><span class=\"line\">[INFO] META-INF/MANIFEST.MF already added, skipping</span><br><span class=\"line\">[INFO] org/ already added, skipping</span><br><span class=\"line\">[INFO] org/nico/ already added, skipping</span><br><span class=\"line\">[INFO] META-INF/maven/ already added, skipping</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br><span class=\"line\">[INFO] BUILD SUCCESS</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br><span class=\"line\">[INFO] Total time: 7.627 s</span><br><span class=\"line\">[INFO] Finished at: 2018-06-30T15:39:47+08:00</span><br><span class=\"line\">[INFO] Final Memory: 24M/269M</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n<p>看到<code>BUILD SUCCESS</code>之后，你会发现项目target目录中会有两个jar</p>\n<ul>\n<li>CoffeeTime-0.0.1-SNAPSHOT.jar</li>\n<li>CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</li>\n</ul>\n<p>文件名请忽略，后缀带<code>RELEASE</code>的jar就是<code>maven-assembly-plugin</code>插件生成的jar，解压看下目录</p>\n<pre><code>│  assembly-fat.xml\n│  cat-mysql-nico.xml\n│  cat-mysql.xml\n│  cat-redis-nico.xml\n│  cat-redis.xml\n│  cat.xml\n│  logno.properties\n│  module-info.class\n│  README.md\n├─com\n│  ├─mchange\n│  │ \n│  └─mysql  \n├─images\n├─META-INF\n│  ├─maven\n│  │ \n│  └─services\n├─net\n│  └─sf    \n├─org\n│  ├─apache\n│  │  \n│  ├─gjt\n│  │ \n│  ├─nico\n│  ├─objectweb\n│  └─slf4j\n│ \n├─redis\n│  └─clients\n│\n└─web\n    ├─images\n    ├─page \n    ├─plugins  \n    ├─script\n    ├─style\n    ├─video\n    └─videojs\n</code></pre>\n<p>路径没问题，我们试下能不能运行，切到jar包所在的目录，执行<code>jar -jar CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</code>运行之<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e78328722cfc4?w=1389&amp;h=752&amp;f=png&amp;s=66225\" alt=\"这里写图片描述\"></p>\n<p>SUCCESS !</p>\n","site":{"data":{}},"excerpt":"","more":"<h6 id=\"序言\"><a class=\"header-anchor\" href=\"#序言\">¶</a>序言</h6>\n<p>笔者前段时间在使用自研框架NF( <a href=\"https://gitee.com/ainilili/No-Framework\">传送门</a> )开发一个自动模板生成工具之后，想将他发布到Linux下，之前一直使用IDE直接<code>run as</code>运行，在遇到发布的时候考虑过发布为war或者jar，在一番抉择之后最终选择了jar（原因是NF自带服务容器，而war为tomcat而生，所以jar更适合NF），所以特意研究了一番如何将普通项目打包成jar发布。</p>\n<p>不出意外，最终我成功了，在兴奋之余，希望能够将自己实现的过程及遇到的坑记录下来，让看到有此需求的同学们少走一些弯路！</p>\n<h4 id=\"一-何为jar\"><a class=\"header-anchor\" href=\"#一-何为jar\">¶</a>一、何为Jar</h4>\n<p>JAR 文件格式以流行的 ZIP 文件格式为基础。与 ZIP 文件不同的是，JAR 文件不仅用于压缩和发布，而且还用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。在 JAR 中包含特殊的文件，如 manifests 和部署描述符，用来指示工具如何处理特定的 JAR。</p>\n<p>更多详情通过 <a href=\"https://www.ibm.com/developerworks/cn/java/j-jar/index.html\">传送门</a> 查阅。</p>\n<h4 id=\"二-发布服务的几种方案\"><a class=\"header-anchor\" href=\"#二-发布服务的几种方案\">¶</a>二、发布服务的几种方案</h4>\n<p>在web开发完成之后，我们往往想要发布服务到外网服务器中，而外网服务器大多是都是Linux系统，这时我们不能已常规方式直接在IDE中运行，需要特定几种形式去发布。</p>\n<p>我们最初最常用的方式就是打包成<code>.war</code>的格式发布到Tomcat的服务容器中，这之后Tomcat会帮助我们解压war包，并加载<code>classes</code>文件夹下的<code>.class</code>到内存中，加载完毕之后，我们的服务就可以在服务器中正常运行，但是<code>.war</code>通常只适合配合Tomcat容器，对于其他服务容器，尤其是自研服务容器来讲，适用性非常差，而<code>Spring Boot</code>率先打破了常规。</p>\n<p>Spring Boot采用jar的方式发布，也就是说，我们可以使用Spring Boot提供的maven插件，通过<code>mvn package</code>指令将服务打包成jar的形式发布，这就意味着服务中涉及的所有资源（class文件、依赖jar包、静态资源文件）都将会打包在一个jar包之内，在启动这个层次来讲就异常的简单了，只需要通过<code>java -jar xxxx.jar</code>的方式就可以正常启动服务，这对于我们在自己的服务器中去启动服务来说非常的方便，而Spring Boot是怎么做到这一点的呢？</p>\n<p>我们来看一下Spring Boot的<code>pom.xml</code>依赖插件 <code>spring-boot-maven-plugin</code>，全配置如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>我们通过之前对Jar包的了解已经得知，一个可执行jar的必要因素就是需要一个主函数入口，在上述配置中，我们可以看到很明确的主函数配置<code>&lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</code>， 而占位符<code>$&#123;start-class&#125;</code>的值就是我们平常开发中用来启动Spring Boot的主函数入口所在类，继续深入<code>spring-boot-maven-plugin</code>中，我们会看到这个插件内部依赖了更多maven自带的原生插件</p>\n<ul>\n<li>maven-failsafe-plugin</li>\n<li>maven-jar-plugin</li>\n<li>maven-surefire-plugin</li>\n<li>maven-war-plugin</li>\n<li>maven-resources-plugin</li>\n<li>maven-shade-plugin</li>\n</ul>\n<p>另外少部分插件如下</p>\n<ul>\n<li>exec-maven-plugin</li>\n<li>git-commit-id-plugin</li>\n<li>spring-boot-maven-plugin 自依赖，为了支持自己的插件</li>\n</ul>\n<p>从以上插件列表分析，<code>spring-boot-maven-plugin</code>中包含了很多maven原生插件，支持<code>jar</code>和 <code>war</code>的格式发布，我们只站在打包可执行jar的角度来分析以上插件的作用，可以这样理解</p>\n<ul>\n<li>maven-jar-plugin</li>\n</ul>\n<blockquote>\n<p>设定<code>manifest</code>中的<code>Main-Class</code>参数</p>\n</blockquote>\n<ul>\n<li>maven-shade-plugin</li>\n</ul>\n<blockquote>\n<p>用于把多个jar包，打成1个jar包</p>\n</blockquote>\n<ul>\n<li>maven-resources-plugin</li>\n</ul>\n<blockquote>\n<p>处理将项目资源（<code>src/main/</code>和 <code>src/test</code>）复制到输出目录的操作</p>\n</blockquote>\n<ul>\n<li>maven-surefire-plugin 和 maven-failsafe-plugin</li>\n</ul>\n<blockquote>\n<p>执行测试用例</p>\n</blockquote>\n<p>依赖插件的同时，<code>spring-boot-maven-plugin</code>中还使用<code>&lt;resources&gt;</code>标签来重新定义jar包内部结构。</p>\n<p>以上信息是否满足将我们的服务打包成可执行jar呢？我们分析一下，如果达到我们想要的效果，我们需要</p>\n<ol>\n<li>自动配置主函数入口</li>\n<li>静态资源打包</li>\n<li>依赖打包</li>\n</ol>\n<p>对比上述插件，我们需要的功能都有，那么我们是否可以使用上方的插件及标签自己写个打包插件试试呢？ 当然！这里就不带着大家亲自尝试了，因为下面我要讲另一种Spring Boot没有用到的maven插件进行打包！</p>\n<h4 id=\"三-maven-assembly-plugin-插件打包jar\"><a class=\"header-anchor\" href=\"#三-maven-assembly-plugin-插件打包jar\">¶</a>三、maven-assembly-plugin 插件打包Jar</h4>\n<p><code>maven-assembly-plugin</code>是一个超灵活maven项目打包工具，提供默认配置和自定义配置，同时提供<code>Main-Class</code>的配置、静态文件Copy及依赖打包的功能，这里是官方对于这款插件的介绍</p>\n<blockquote>\n<p>The Assembly Plugin for Maven is primarily intended to allow users to aggregate the project output along with its dependencies, modules, site documentation, and other files into a single distributable archive.<br>\nYour project can build distribution “assemblies” easily, using one of the convenient, prefabricated assembly descriptors. These descriptors handle many common operations, such as packaging a project’s artifact along with generated documentation into a single zip archive. Alternatively, your project can provide its own descriptor and assume a much higher level of control over how dependencies, modules, file-sets, and individual files are packaged in the assembly.</p>\n</blockquote>\n<p>大概意思就是</p>\n<p>Maven的组装插件主要是允许用户将项目输出与它的依赖项、模块、站点文档和其他文件一起集成到一个可分发的归档文件中。您的项目可以使用一种方便的预制组装描述符轻松地构建分布“程序集”。这些描述符处理许多常见的操作，例如将项目的工件连同生成的文档打包到一个zip归档文件中。或者，您的项目可以提供自己的描述符，并对依赖项、模块、文件集和各个文件如何在程序集中打包具有更高的控制级别。</p>\n<p>通俗一点，你可以自定义你的项目打包格式，<code>maven-assembly-plugin</code>更像是多个打包插件的集成，并提供多种打包的文件格式，使用方面也很方便，最简单的一个使用如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t   &lt;artifactId&gt; maven-assembly-plugin &lt;/artifactId&gt;</span><br><span class=\"line\">\t   &lt;configuration&gt;</span><br><span class=\"line\">\t\t\t&lt;descriptorRefs&gt;</span><br><span class=\"line\">\t\t\t\t &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class=\"line\">\t\t\t&lt;/descriptorRefs&gt;</span><br><span class=\"line\">\t\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t\t &lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t\t  &lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t\t &lt;/manifest&gt;</span><br><span class=\"line\">\t\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t   &lt;/configuration&gt;</span><br><span class=\"line\">\t   &lt;executions&gt;</span><br><span class=\"line\">\t\t\t&lt;execution&gt;</span><br><span class=\"line\">\t\t\t\t &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">\t\t\t\t &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">\t\t\t\t &lt;goals&gt;</span><br><span class=\"line\">\t\t\t\t\t  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">\t\t\t\t &lt;/goals&gt;</span><br><span class=\"line\">\t\t\t&lt;/execution&gt;</span><br><span class=\"line\">\t   &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p><code>descriptorRefs</code>标签内部可以配置使用官方定制好的打包方式，其中如下可选配置</p>\n<ul>\n<li>bin</li>\n<li>jar-with-dependencies</li>\n<li>src</li>\n<li>project<br>\n不过官方定制好的有很大的局限性，我们可以将上述改成如下配置，来自定义打包方式</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">\t&lt;configuration&gt;</span><br><span class=\"line\">\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t&lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t&lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t&lt;/manifest&gt;</span><br><span class=\"line\">\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t\t&lt;descriptors&gt;</span><br><span class=\"line\">            &lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class=\"line\">        &lt;/descriptors&gt;</span><br><span class=\"line\">\t&lt;/configuration&gt;</span><br><span class=\"line\">\t&lt;executions&gt;</span><br><span class=\"line\">         &lt;execution&gt;</span><br><span class=\"line\">               &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">               &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">               &lt;goals&gt;</span><br><span class=\"line\">                    &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">               &lt;/goals&gt;</span><br><span class=\"line\">          &lt;/execution&gt;</span><br><span class=\"line\">     &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>可以看出，上述配置去掉了<code>&lt;descriptorRefs&gt;</code>标签，增加了<code>&lt;descriptors&gt;</code>配置，并且子标签中还指向了<code>src/main/resource/assembly-fat.xml</code>这个配置文件，如果你的思路跟着这篇文章走，一定可以猜得到，这个配置文件就是我们自定义打包方式的入口！它的格式如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;assembly xmlns=&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span><br><span class=\"line\">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">    xsi:schemaLocation=&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;&gt;</span><br><span class=\"line\">  &lt;id&gt;distribution&lt;/id&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;formats&gt;</span><br><span class=\"line\">    &lt;format&gt;jar&lt;/format&gt;</span><br><span class=\"line\">  &lt;/formats&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;dependencySets&gt;</span><br><span class=\"line\">\t\t&lt;dependencySet&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class=\"line\">\t\t\t&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class=\"line\">\t\t\t&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class=\"line\">\t\t&lt;/dependencySet&gt;</span><br><span class=\"line\">\t&lt;/dependencySets&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">  &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;fileSets&gt;</span><br><span class=\"line\">    &lt;fileSet&gt;</span><br><span class=\"line\">      &lt;directory&gt;$&#123;basedir&#125;&lt;/directory&gt;</span><br><span class=\"line\">      &lt;includes&gt;</span><br><span class=\"line\">        &lt;include&gt;*.txt&lt;/include&gt;</span><br><span class=\"line\">      &lt;/includes&gt;</span><br><span class=\"line\">      &lt;excludes&gt;</span><br><span class=\"line\">        &lt;exclude&gt;README.txt&lt;/exclude&gt;</span><br><span class=\"line\">        &lt;exclude&gt;NOTICE.txt&lt;/exclude&gt;</span><br><span class=\"line\">      &lt;/excludes&gt;</span><br><span class=\"line\">    &lt;/fileSet&gt;</span><br><span class=\"line\">  &lt;/fileSets&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;files&gt;</span><br><span class=\"line\">    &lt;file&gt;</span><br><span class=\"line\">      &lt;source&gt;README.txt&lt;/source&gt;</span><br><span class=\"line\">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class=\"line\">    &lt;/file&gt;</span><br><span class=\"line\">    &lt;file&gt;</span><br><span class=\"line\">      &lt;source&gt;NOTICE.txt&lt;/source&gt;</span><br><span class=\"line\">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class=\"line\">    &lt;/file&gt;</span><br><span class=\"line\">  &lt;/files&gt;</span><br><span class=\"line\">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>\n<h5 id=\"下面是标签的相关介绍\"><a class=\"header-anchor\" href=\"#下面是标签的相关介绍\">¶</a>下面是标签的相关介绍</h5>\n<ul>\n<li><code>&lt;id&gt;</code> 生成文件的后缀，如果有，文件名将会是<code>$&#123;artifactId&#125;-$&#123;id&#125;.jar</code></li>\n<li><code>&lt;formats&gt;</code>生成文件的格式，可以同时生成多个格式的目标文件</li>\n<li><code>dependencySets</code>依赖jar的打包方式</li>\n<li><code>includeBaseDirectory</code>是否将项目目录引入进来，如果是<strong>True</strong>的话，生成的目标文件打开之后将会是项目主目录，我们打包的资源将会被放于这个主目录中（推荐<strong>Fasle</strong>，因为<code>Main-Class</code>路径通常直接是类路径）</li>\n<li><code>&lt;fileSets&gt;</code>引入静态资源的配置（目录级）</li>\n<li><code>files</code>引入静态资源的配置（文件级）</li>\n</ul>\n<p>以上是最常用的几种标签，更多的配置大家可以查阅官网 <a href=\"maven.apache.org/components/plugins/maven-assembly-plugin/\">传送门</a></p>\n<p>配置完成之后可以通过<code>mvn assembly:assembly</code>或者<code>mvn package</code>指令打包。</p>\n<p>介绍完毕，下面会拉取笔者自己用<a href=\"https://gitee.com/ainilili/No-Framework\">NF</a>框架开发的模板工具来为大家演示一下<code>maven-assembly-plugin</code>在实战中的使用！</p>\n<h4 id=\"四-jar方式发布服务实战\"><a class=\"header-anchor\" href=\"#四-jar方式发布服务实战\">¶</a>四、Jar方式发布服务实战</h4>\n<p>首先是项目结构</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Project</span><br><span class=\"line\">│  LICENSE</span><br><span class=\"line\">│  pom.xml\t\t\t\t\t\t\t\t=》pom文件</span><br><span class=\"line\">│  README.md</span><br><span class=\"line\">├─src</span><br><span class=\"line\">│  └─main</span><br><span class=\"line\">│      ├─java\t\t\t\t\t\t\t=》源码目录</span><br><span class=\"line\">│      └─resource\t\t\t\t\t\t=》配置文件目录</span><br><span class=\"line\">└─web\t\t\t\t\t\t\t\t\t=》UI静态资源</span><br></pre></td></tr></table></figure>\n<p>从结构中可以看出，我们需要手动配置的打包资源是<code>src/main/resource</code>和<code>web</code>这两个目录，所以我们需要所有配置，将上述两个目录随着我们的<code>.class</code>文件一起打包进jar中，首先在原pom.xml保持不变的基础上插入<code>maven-assembly-plugin</code>插件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">\t&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">\t&lt;configuration&gt;</span><br><span class=\"line\">\t\t&lt;source&gt;1.8&lt;/source&gt;</span><br><span class=\"line\">\t\t&lt;target&gt;1.8&lt;/target&gt;</span><br><span class=\"line\">\t\t&lt;archive&gt;</span><br><span class=\"line\">\t\t\t&lt;manifest&gt;</span><br><span class=\"line\">\t\t\t\t&lt;mainClass&gt;org.nico.ct.CtApplication&lt;/mainClass&gt;</span><br><span class=\"line\">\t\t\t&lt;/manifest&gt;</span><br><span class=\"line\">\t\t&lt;/archive&gt;</span><br><span class=\"line\">\t\t&lt;descriptors&gt;</span><br><span class=\"line\">\t\t\t&lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class=\"line\">\t\t&lt;/descriptors&gt;</span><br><span class=\"line\">\t&lt;/configuration&gt;</span><br><span class=\"line\">\t&lt;executions&gt;</span><br><span class=\"line\">\t\t&lt;execution&gt;</span><br><span class=\"line\">\t\t\t &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class=\"line\">\t\t\t &lt;phase&gt;package&lt;/phase&gt;</span><br><span class=\"line\">\t\t\t &lt;goals&gt;</span><br><span class=\"line\">\t\t\t\t  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class=\"line\">\t\t\t &lt;/goals&gt;</span><br><span class=\"line\">\t\t&lt;/execution&gt;</span><br><span class=\"line\">   &lt;/executions&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<p>接下来编辑<code>src/main/resource/assembly-fat.xml</code>文件配置打包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;assembly</span><br><span class=\"line\">\txmlns=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3&quot;</span><br><span class=\"line\">\txmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">\txsi:schemaLocation=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd&quot;&gt;</span><br><span class=\"line\">\t&lt;id&gt;RELEASE&lt;/id&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;formats&gt;</span><br><span class=\"line\">\t\t&lt;format&gt;jar&lt;/format&gt;</span><br><span class=\"line\">\t&lt;/formats&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;dependencySets&gt;</span><br><span class=\"line\">\t\t&lt;dependencySet&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class=\"line\">\t\t\t&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class=\"line\">\t\t\t&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class=\"line\">\t\t&lt;/dependencySet&gt;</span><br><span class=\"line\">\t&lt;/dependencySets&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&lt;fileSets&gt;</span><br><span class=\"line\">\t\t&lt;fileSet&gt;</span><br><span class=\"line\">\t\t\t&lt;directory&gt;src/main/resource&lt;/directory&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;includes&gt;</span><br><span class=\"line\">\t\t\t\t&lt;include&gt;/**&lt;/include&gt;</span><br><span class=\"line\">\t\t\t&lt;/includes&gt;</span><br><span class=\"line\">\t\t&lt;/fileSet&gt;</span><br><span class=\"line\">\t\t&lt;fileSet&gt;</span><br><span class=\"line\">\t\t\t&lt;directory&gt;web&lt;/directory&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/web&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t\t&lt;includes&gt;</span><br><span class=\"line\">\t\t\t\t&lt;include&gt;/**&lt;/include&gt;</span><br><span class=\"line\">\t\t\t&lt;/includes&gt;</span><br><span class=\"line\">\t\t&lt;/fileSet&gt;</span><br><span class=\"line\">\t&lt;/fileSets&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t&lt;files&gt;</span><br><span class=\"line\">\t\t&lt;file&gt;</span><br><span class=\"line\">\t\t\t&lt;source&gt;README.md&lt;/source&gt;</span><br><span class=\"line\">\t\t\t&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class=\"line\">\t\t&lt;/file&gt;</span><br><span class=\"line\">\t&lt;/files&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>\n<p>然后运行<code>mvn assembly:assembly</code>，等待maven构建成功</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">[INFO] META-INF/ already added, skipping</span><br><span class=\"line\">[INFO] META-INF/MANIFEST.MF already added, skipping</span><br><span class=\"line\">[INFO] org/ already added, skipping</span><br><span class=\"line\">[INFO] org/nico/ already added, skipping</span><br><span class=\"line\">[INFO] META-INF/maven/ already added, skipping</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br><span class=\"line\">[INFO] BUILD SUCCESS</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br><span class=\"line\">[INFO] Total time: 7.627 s</span><br><span class=\"line\">[INFO] Finished at: 2018-06-30T15:39:47+08:00</span><br><span class=\"line\">[INFO] Final Memory: 24M/269M</span><br><span class=\"line\">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n<p>看到<code>BUILD SUCCESS</code>之后，你会发现项目target目录中会有两个jar</p>\n<ul>\n<li>CoffeeTime-0.0.1-SNAPSHOT.jar</li>\n<li>CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</li>\n</ul>\n<p>文件名请忽略，后缀带<code>RELEASE</code>的jar就是<code>maven-assembly-plugin</code>插件生成的jar，解压看下目录</p>\n<pre><code>│  assembly-fat.xml\n│  cat-mysql-nico.xml\n│  cat-mysql.xml\n│  cat-redis-nico.xml\n│  cat-redis.xml\n│  cat.xml\n│  logno.properties\n│  module-info.class\n│  README.md\n├─com\n│  ├─mchange\n│  │ \n│  └─mysql  \n├─images\n├─META-INF\n│  ├─maven\n│  │ \n│  └─services\n├─net\n│  └─sf    \n├─org\n│  ├─apache\n│  │  \n│  ├─gjt\n│  │ \n│  ├─nico\n│  ├─objectweb\n│  └─slf4j\n│ \n├─redis\n│  └─clients\n│\n└─web\n    ├─images\n    ├─page \n    ├─plugins  \n    ├─script\n    ├─style\n    ├─video\n    └─videojs\n</code></pre>\n<p>路径没问题，我们试下能不能运行，切到jar包所在的目录，执行<code>jar -jar CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</code>运行之<br>\n<img src=\"https://user-gold-cdn.xitu.io/2018/11/6/166e78328722cfc4?w=1389&amp;h=752&amp;f=png&amp;s=66225\" alt=\"这里写图片描述\"></p>\n<p>SUCCESS !</p>\n"},{"title":"设计模式一：单例模式","author":"Nico","date":"2018-12-24T01:33:00.000Z","_content":"## 什么是单例模式\n单例是最常用的设计模式之一，其表达的最主要的意思是一个对象在整个jvm堆内存中只有一个实例，这样可以保证无论从任何代码块获取的单例实例都是唯一的。\n\n**单例的优缺点也很明显，优点有以下这些：**\n - 在单例模式中，活动的单例只有一个实例，对单例类的所有实例化得到的都是相同的一个实例。这样就 防止其它对象对自己的实例化，确保所有的对象都访问一个实例\n - 单例模式具有一定的伸缩性，类自己来控制实例化进程，类就在改变实例化进程上有相应的伸缩性。\n - 提供了对唯一实例的受控访问。\n - 由于在系统内存中只存在一个对象，因此可以 节约系统资源，当 需要频繁创建和销毁的对象时单例模式无疑可以提高系统的性能。\n - 允许可变数目的实例。\n - 避免对共享资源的多重占用。\n\n**缺点：**\n - 不适用于变化的对象，如果同一类型的对象总是要在不同的用例场景发生变化，单例就会引起数据的错误，不能保存彼此的状态。\n - 由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。\n - 单例类的职责过重，在一定程度上违背了“单一职责原则”。\n - 滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为的单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；如果实例化的对象长时间不被利用，系统会认为是垃圾而被回收，这将导致对象状态的丢失。\n\n**在很多场景单例模式是很有用的，例如配置容器，连接池等，在Java中获取编写一个单例也很简单（暂时屏蔽细节）：**\n - 第一步：私有化类构造\n - 第二步：内部定义一个类型为类本身的静态私有变量\n - 第三步：提供一个静态共有方法获取这个私有变量（获取之前赋值）\n\n**尤其是第三步，我们在获取这个私有变量的时候要对其进行赋值，那么就有两个阶段可以做这件事，**\n - 定义静态私有变量的时候直接赋值\n - 调用公有静态方法的时候再赋值\n\n这就引出了两种实现模式：``饿汉模式``和``懒汉模式``。\n## 饿汉模式\n饿汉从字面上的意思我们可以想到一个特别饥饿的大汉，而对于单例来讲则是形容以``迫不及待``的方式去将私有实例赋值，代码实现如下：\n```\npublic class Single {\n\tprivate static Single instance = new Single();\n\tprivate Single() {}\n\tpublic static Single getInstance() {\n\t\treturn instance;\n\t}\n}\n```\n这种模式的好处是不会存在并发下安全隐患，但是坏处也可想而知，对于jvm加载的过程就会将``instance``变量赋值，也就意味着我们即使没有用到这个单例对象也会将其实例``new``出来，可想而知，我们的永久带将会为其分配内存，带来的后果是永久带内存变少。\n\n## 懒汉模式\n懒汉模式则是在调用公有静态方法时才会为私有变量赋值：\n```\npublic class Single {\n\tprivate volatile static Single instance = null;// 1\n\tprivate Single() {}\n\tpublic static Single getInstance() {\n\t\tif(instance == null) { //2\n\t\t\tsynchronized (Single.class) { //3\n\t\t\t\tif(instance == null) { //4\n\t\t\t\t\tinstance = new Single(); // 5\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn instance;\n\t}\n}\n```\n相比之前的饿汉模式，我们有以下几个改动：\n - 标记1：增加volatile关键字保证``5``时不会指令重排\n - 标记2：是为了提高程序的效率，当Single对象被创建以后，再获取Single对象时就不用去验证同步代码块的锁及后面的代码，直接返回Single对象\n - 标记3：防止多线程下的重复执行\n - 标记4：同``3``，当多个线程同时调用``getInstance``方法，此时``instance``为空，两个线程可以轻松越过``2``，来到``3``抢锁，一个线程率先抢占到并且为``instance``赋值后，如果没有``4``的``if``判断，第二个线程也会重复去为``instance``赋值，这就会导致创建多个实例。\n\n而我们使用``volatile``则是因为在标记``5``赋值的时候会发生指令重排的问题！\n> 在Java中看似顺序的代码在JVM中，可能会出现编译器或者CPU对这些操作指令进行了重新排序；在特定情况下，指令重排将会给我们的程序带来不确定的结果.....\n\n对于``instance = new Single()``这一行代码，JVM执行的指令有多行：\n```\nmemory = allocate(); //1：分配对象的内存空间\nctorInstance(memory); //2：初始化对象\ninstance = memory; //3：设置instance指向刚分配的内存地址\n```\n经重排后如下：\n```\nmemory = allocate(); //1：分配对象的内存空间\ninstance = memory; //3：设置instance指向刚分配的内存地址，此时对象还没被初始化\nctorInstance(memory); //2：初始化对象\n```\n若有A线程进行完重排后的第二步，且未执行初始化对象。此时B线程来取instance时，发现instance不为空，于是便返回该值，但由于没有初始化完该对象，此时返回的对象是有问题的。\n","source":"_posts/设计模式一：单例模式.md","raw":"title: 设计模式一：单例模式\nauthor: Nico\ntags:\n  - 设计模式\ncategories:\n  - 设计模式\ndate: 2018-12-24 09:33:00\n---\n## 什么是单例模式\n单例是最常用的设计模式之一，其表达的最主要的意思是一个对象在整个jvm堆内存中只有一个实例，这样可以保证无论从任何代码块获取的单例实例都是唯一的。\n\n**单例的优缺点也很明显，优点有以下这些：**\n - 在单例模式中，活动的单例只有一个实例，对单例类的所有实例化得到的都是相同的一个实例。这样就 防止其它对象对自己的实例化，确保所有的对象都访问一个实例\n - 单例模式具有一定的伸缩性，类自己来控制实例化进程，类就在改变实例化进程上有相应的伸缩性。\n - 提供了对唯一实例的受控访问。\n - 由于在系统内存中只存在一个对象，因此可以 节约系统资源，当 需要频繁创建和销毁的对象时单例模式无疑可以提高系统的性能。\n - 允许可变数目的实例。\n - 避免对共享资源的多重占用。\n\n**缺点：**\n - 不适用于变化的对象，如果同一类型的对象总是要在不同的用例场景发生变化，单例就会引起数据的错误，不能保存彼此的状态。\n - 由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。\n - 单例类的职责过重，在一定程度上违背了“单一职责原则”。\n - 滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为的单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；如果实例化的对象长时间不被利用，系统会认为是垃圾而被回收，这将导致对象状态的丢失。\n\n**在很多场景单例模式是很有用的，例如配置容器，连接池等，在Java中获取编写一个单例也很简单（暂时屏蔽细节）：**\n - 第一步：私有化类构造\n - 第二步：内部定义一个类型为类本身的静态私有变量\n - 第三步：提供一个静态共有方法获取这个私有变量（获取之前赋值）\n\n**尤其是第三步，我们在获取这个私有变量的时候要对其进行赋值，那么就有两个阶段可以做这件事，**\n - 定义静态私有变量的时候直接赋值\n - 调用公有静态方法的时候再赋值\n\n这就引出了两种实现模式：``饿汉模式``和``懒汉模式``。\n## 饿汉模式\n饿汉从字面上的意思我们可以想到一个特别饥饿的大汉，而对于单例来讲则是形容以``迫不及待``的方式去将私有实例赋值，代码实现如下：\n```\npublic class Single {\n\tprivate static Single instance = new Single();\n\tprivate Single() {}\n\tpublic static Single getInstance() {\n\t\treturn instance;\n\t}\n}\n```\n这种模式的好处是不会存在并发下安全隐患，但是坏处也可想而知，对于jvm加载的过程就会将``instance``变量赋值，也就意味着我们即使没有用到这个单例对象也会将其实例``new``出来，可想而知，我们的永久带将会为其分配内存，带来的后果是永久带内存变少。\n\n## 懒汉模式\n懒汉模式则是在调用公有静态方法时才会为私有变量赋值：\n```\npublic class Single {\n\tprivate volatile static Single instance = null;// 1\n\tprivate Single() {}\n\tpublic static Single getInstance() {\n\t\tif(instance == null) { //2\n\t\t\tsynchronized (Single.class) { //3\n\t\t\t\tif(instance == null) { //4\n\t\t\t\t\tinstance = new Single(); // 5\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn instance;\n\t}\n}\n```\n相比之前的饿汉模式，我们有以下几个改动：\n - 标记1：增加volatile关键字保证``5``时不会指令重排\n - 标记2：是为了提高程序的效率，当Single对象被创建以后，再获取Single对象时就不用去验证同步代码块的锁及后面的代码，直接返回Single对象\n - 标记3：防止多线程下的重复执行\n - 标记4：同``3``，当多个线程同时调用``getInstance``方法，此时``instance``为空，两个线程可以轻松越过``2``，来到``3``抢锁，一个线程率先抢占到并且为``instance``赋值后，如果没有``4``的``if``判断，第二个线程也会重复去为``instance``赋值，这就会导致创建多个实例。\n\n而我们使用``volatile``则是因为在标记``5``赋值的时候会发生指令重排的问题！\n> 在Java中看似顺序的代码在JVM中，可能会出现编译器或者CPU对这些操作指令进行了重新排序；在特定情况下，指令重排将会给我们的程序带来不确定的结果.....\n\n对于``instance = new Single()``这一行代码，JVM执行的指令有多行：\n```\nmemory = allocate(); //1：分配对象的内存空间\nctorInstance(memory); //2：初始化对象\ninstance = memory; //3：设置instance指向刚分配的内存地址\n```\n经重排后如下：\n```\nmemory = allocate(); //1：分配对象的内存空间\ninstance = memory; //3：设置instance指向刚分配的内存地址，此时对象还没被初始化\nctorInstance(memory); //2：初始化对象\n```\n若有A线程进行完重排后的第二步，且未执行初始化对象。此时B线程来取instance时，发现instance不为空，于是便返回该值，但由于没有初始化完该对象，此时返回的对象是有问题的。\n","slug":"设计模式一：单例模式","published":1,"updated":"2021-03-21T17:43:06.193Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyi0019b0tzc3zi4ct6","content":"<h2 id=\"什么是单例模式\"><a class=\"header-anchor\" href=\"#什么是单例模式\">¶</a>什么是单例模式</h2>\n<p>单例是最常用的设计模式之一，其表达的最主要的意思是一个对象在整个jvm堆内存中只有一个实例，这样可以保证无论从任何代码块获取的单例实例都是唯一的。</p>\n<p><strong>单例的优缺点也很明显，优点有以下这些：</strong></p>\n<ul>\n<li>在单例模式中，活动的单例只有一个实例，对单例类的所有实例化得到的都是相同的一个实例。这样就 防止其它对象对自己的实例化，确保所有的对象都访问一个实例</li>\n<li>单例模式具有一定的伸缩性，类自己来控制实例化进程，类就在改变实例化进程上有相应的伸缩性。</li>\n<li>提供了对唯一实例的受控访问。</li>\n<li>由于在系统内存中只存在一个对象，因此可以 节约系统资源，当 需要频繁创建和销毁的对象时单例模式无疑可以提高系统的性能。</li>\n<li>允许可变数目的实例。</li>\n<li>避免对共享资源的多重占用。</li>\n</ul>\n<p><strong>缺点：</strong></p>\n<ul>\n<li>不适用于变化的对象，如果同一类型的对象总是要在不同的用例场景发生变化，单例就会引起数据的错误，不能保存彼此的状态。</li>\n<li>由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。</li>\n<li>单例类的职责过重，在一定程度上违背了“单一职责原则”。</li>\n<li>滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为的单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；如果实例化的对象长时间不被利用，系统会认为是垃圾而被回收，这将导致对象状态的丢失。</li>\n</ul>\n<p><strong>在很多场景单例模式是很有用的，例如配置容器，连接池等，在Java中获取编写一个单例也很简单（暂时屏蔽细节）：</strong></p>\n<ul>\n<li>第一步：私有化类构造</li>\n<li>第二步：内部定义一个类型为类本身的静态私有变量</li>\n<li>第三步：提供一个静态共有方法获取这个私有变量（获取之前赋值）</li>\n</ul>\n<p><strong>尤其是第三步，我们在获取这个私有变量的时候要对其进行赋值，那么就有两个阶段可以做这件事，</strong></p>\n<ul>\n<li>定义静态私有变量的时候直接赋值</li>\n<li>调用公有静态方法的时候再赋值</li>\n</ul>\n<p>这就引出了两种实现模式：<code>饿汉模式</code>和<code>懒汉模式</code>。</p>\n<h2 id=\"饿汉模式\"><a class=\"header-anchor\" href=\"#饿汉模式\">¶</a>饿汉模式</h2>\n<p>饿汉从字面上的意思我们可以想到一个特别饥饿的大汉，而对于单例来讲则是形容以<code>迫不及待</code>的方式去将私有实例赋值，代码实现如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Single &#123;</span><br><span class=\"line\">\tprivate static Single instance = new Single();</span><br><span class=\"line\">\tprivate Single() &#123;&#125;</span><br><span class=\"line\">\tpublic static Single getInstance() &#123;</span><br><span class=\"line\">\t\treturn instance;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这种模式的好处是不会存在并发下安全隐患，但是坏处也可想而知，对于jvm加载的过程就会将<code>instance</code>变量赋值，也就意味着我们即使没有用到这个单例对象也会将其实例<code>new</code>出来，可想而知，我们的永久带将会为其分配内存，带来的后果是永久带内存变少。</p>\n<h2 id=\"懒汉模式\"><a class=\"header-anchor\" href=\"#懒汉模式\">¶</a>懒汉模式</h2>\n<p>懒汉模式则是在调用公有静态方法时才会为私有变量赋值：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Single &#123;</span><br><span class=\"line\">\tprivate volatile static Single instance = null;// 1</span><br><span class=\"line\">\tprivate Single() &#123;&#125;</span><br><span class=\"line\">\tpublic static Single getInstance() &#123;</span><br><span class=\"line\">\t\tif(instance == null) &#123; //2</span><br><span class=\"line\">\t\t\tsynchronized (Single.class) &#123; //3</span><br><span class=\"line\">\t\t\t\tif(instance == null) &#123; //4</span><br><span class=\"line\">\t\t\t\t\tinstance = new Single(); // 5</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn instance;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>相比之前的饿汉模式，我们有以下几个改动：</p>\n<ul>\n<li>标记1：增加volatile关键字保证<code>5</code>时不会指令重排</li>\n<li>标记2：是为了提高程序的效率，当Single对象被创建以后，再获取Single对象时就不用去验证同步代码块的锁及后面的代码，直接返回Single对象</li>\n<li>标记3：防止多线程下的重复执行</li>\n<li>标记4：同<code>3</code>，当多个线程同时调用<code>getInstance</code>方法，此时<code>instance</code>为空，两个线程可以轻松越过<code>2</code>，来到<code>3</code>抢锁，一个线程率先抢占到并且为<code>instance</code>赋值后，如果没有<code>4</code>的<code>if</code>判断，第二个线程也会重复去为<code>instance</code>赋值，这就会导致创建多个实例。</li>\n</ul>\n<p>而我们使用<code>volatile</code>则是因为在标记<code>5</code>赋值的时候会发生指令重排的问题！</p>\n<blockquote>\n<p>在Java中看似顺序的代码在JVM中，可能会出现编译器或者CPU对这些操作指令进行了重新排序；在特定情况下，指令重排将会给我们的程序带来不确定的结果…</p>\n</blockquote>\n<p>对于<code>instance = new Single()</code>这一行代码，JVM执行的指令有多行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory = allocate(); //1：分配对象的内存空间</span><br><span class=\"line\">ctorInstance(memory); //2：初始化对象</span><br><span class=\"line\">instance = memory; //3：设置instance指向刚分配的内存地址</span><br></pre></td></tr></table></figure>\n<p>经重排后如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory = allocate(); //1：分配对象的内存空间</span><br><span class=\"line\">instance = memory; //3：设置instance指向刚分配的内存地址，此时对象还没被初始化</span><br><span class=\"line\">ctorInstance(memory); //2：初始化对象</span><br></pre></td></tr></table></figure>\n<p>若有A线程进行完重排后的第二步，且未执行初始化对象。此时B线程来取instance时，发现instance不为空，于是便返回该值，但由于没有初始化完该对象，此时返回的对象是有问题的。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"什么是单例模式\"><a class=\"header-anchor\" href=\"#什么是单例模式\">¶</a>什么是单例模式</h2>\n<p>单例是最常用的设计模式之一，其表达的最主要的意思是一个对象在整个jvm堆内存中只有一个实例，这样可以保证无论从任何代码块获取的单例实例都是唯一的。</p>\n<p><strong>单例的优缺点也很明显，优点有以下这些：</strong></p>\n<ul>\n<li>在单例模式中，活动的单例只有一个实例，对单例类的所有实例化得到的都是相同的一个实例。这样就 防止其它对象对自己的实例化，确保所有的对象都访问一个实例</li>\n<li>单例模式具有一定的伸缩性，类自己来控制实例化进程，类就在改变实例化进程上有相应的伸缩性。</li>\n<li>提供了对唯一实例的受控访问。</li>\n<li>由于在系统内存中只存在一个对象，因此可以 节约系统资源，当 需要频繁创建和销毁的对象时单例模式无疑可以提高系统的性能。</li>\n<li>允许可变数目的实例。</li>\n<li>避免对共享资源的多重占用。</li>\n</ul>\n<p><strong>缺点：</strong></p>\n<ul>\n<li>不适用于变化的对象，如果同一类型的对象总是要在不同的用例场景发生变化，单例就会引起数据的错误，不能保存彼此的状态。</li>\n<li>由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。</li>\n<li>单例类的职责过重，在一定程度上违背了“单一职责原则”。</li>\n<li>滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为的单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；如果实例化的对象长时间不被利用，系统会认为是垃圾而被回收，这将导致对象状态的丢失。</li>\n</ul>\n<p><strong>在很多场景单例模式是很有用的，例如配置容器，连接池等，在Java中获取编写一个单例也很简单（暂时屏蔽细节）：</strong></p>\n<ul>\n<li>第一步：私有化类构造</li>\n<li>第二步：内部定义一个类型为类本身的静态私有变量</li>\n<li>第三步：提供一个静态共有方法获取这个私有变量（获取之前赋值）</li>\n</ul>\n<p><strong>尤其是第三步，我们在获取这个私有变量的时候要对其进行赋值，那么就有两个阶段可以做这件事，</strong></p>\n<ul>\n<li>定义静态私有变量的时候直接赋值</li>\n<li>调用公有静态方法的时候再赋值</li>\n</ul>\n<p>这就引出了两种实现模式：<code>饿汉模式</code>和<code>懒汉模式</code>。</p>\n<h2 id=\"饿汉模式\"><a class=\"header-anchor\" href=\"#饿汉模式\">¶</a>饿汉模式</h2>\n<p>饿汉从字面上的意思我们可以想到一个特别饥饿的大汉，而对于单例来讲则是形容以<code>迫不及待</code>的方式去将私有实例赋值，代码实现如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Single &#123;</span><br><span class=\"line\">\tprivate static Single instance = new Single();</span><br><span class=\"line\">\tprivate Single() &#123;&#125;</span><br><span class=\"line\">\tpublic static Single getInstance() &#123;</span><br><span class=\"line\">\t\treturn instance;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这种模式的好处是不会存在并发下安全隐患，但是坏处也可想而知，对于jvm加载的过程就会将<code>instance</code>变量赋值，也就意味着我们即使没有用到这个单例对象也会将其实例<code>new</code>出来，可想而知，我们的永久带将会为其分配内存，带来的后果是永久带内存变少。</p>\n<h2 id=\"懒汉模式\"><a class=\"header-anchor\" href=\"#懒汉模式\">¶</a>懒汉模式</h2>\n<p>懒汉模式则是在调用公有静态方法时才会为私有变量赋值：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Single &#123;</span><br><span class=\"line\">\tprivate volatile static Single instance = null;// 1</span><br><span class=\"line\">\tprivate Single() &#123;&#125;</span><br><span class=\"line\">\tpublic static Single getInstance() &#123;</span><br><span class=\"line\">\t\tif(instance == null) &#123; //2</span><br><span class=\"line\">\t\t\tsynchronized (Single.class) &#123; //3</span><br><span class=\"line\">\t\t\t\tif(instance == null) &#123; //4</span><br><span class=\"line\">\t\t\t\t\tinstance = new Single(); // 5</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn instance;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>相比之前的饿汉模式，我们有以下几个改动：</p>\n<ul>\n<li>标记1：增加volatile关键字保证<code>5</code>时不会指令重排</li>\n<li>标记2：是为了提高程序的效率，当Single对象被创建以后，再获取Single对象时就不用去验证同步代码块的锁及后面的代码，直接返回Single对象</li>\n<li>标记3：防止多线程下的重复执行</li>\n<li>标记4：同<code>3</code>，当多个线程同时调用<code>getInstance</code>方法，此时<code>instance</code>为空，两个线程可以轻松越过<code>2</code>，来到<code>3</code>抢锁，一个线程率先抢占到并且为<code>instance</code>赋值后，如果没有<code>4</code>的<code>if</code>判断，第二个线程也会重复去为<code>instance</code>赋值，这就会导致创建多个实例。</li>\n</ul>\n<p>而我们使用<code>volatile</code>则是因为在标记<code>5</code>赋值的时候会发生指令重排的问题！</p>\n<blockquote>\n<p>在Java中看似顺序的代码在JVM中，可能会出现编译器或者CPU对这些操作指令进行了重新排序；在特定情况下，指令重排将会给我们的程序带来不确定的结果…</p>\n</blockquote>\n<p>对于<code>instance = new Single()</code>这一行代码，JVM执行的指令有多行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory = allocate(); //1：分配对象的内存空间</span><br><span class=\"line\">ctorInstance(memory); //2：初始化对象</span><br><span class=\"line\">instance = memory; //3：设置instance指向刚分配的内存地址</span><br></pre></td></tr></table></figure>\n<p>经重排后如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory = allocate(); //1：分配对象的内存空间</span><br><span class=\"line\">instance = memory; //3：设置instance指向刚分配的内存地址，此时对象还没被初始化</span><br><span class=\"line\">ctorInstance(memory); //2：初始化对象</span><br></pre></td></tr></table></figure>\n<p>若有A线程进行完重排后的第二步，且未执行初始化对象。此时B线程来取instance时，发现instance不为空，于是便返回该值，但由于没有初始化完该对象，此时返回的对象是有问题的。</p>\n"},{"_content":"","source":"_drafts/如何设计并实现一个db连接池？.md","raw":"","slug":"如何设计并实现一个db连接池？","published":0,"date":"2021-03-21T17:43:03.589Z","updated":"2021-03-21T17:43:03.589Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"ckzxn6uyl001bb0tz9zqmds7t","content":"","site":{"data":{}},"excerpt":"","more":""}],"PostAsset":[],"PostCategory":[{"post_id":"ckzxn6uxu0001b0tz9bnldgxq","category_id":"ckzxn6uxz0004b0tzhrsx6n5w","_id":"ckzxn6uy6000gb0tzfxst07xl"},{"post_id":"ckzxn6uy20008b0tz5xarcjh7","category_id":"ckzxn6uxz0004b0tzhrsx6n5w","_id":"ckzxn6uy8000jb0tzav8i2zmd"},{"post_id":"ckzxn6uxx0003b0tze3sk7msa","category_id":"ckzxn6uxz0004b0tzhrsx6n5w","_id":"ckzxn6uy9000mb0tzgm5136bz"},{"post_id":"ckzxn6uy6000eb0tzf4ew5sdj","category_id":"ckzxn6uxz0004b0tzhrsx6n5w","_id":"ckzxn6uya000qb0tzeel4au4t"},{"post_id":"ckzxn6uy00006b0tzanyy3uhe","category_id":"ckzxn6uxz0004b0tzhrsx6n5w","_id":"ckzxn6uyc000tb0tz6ei66nc2"},{"post_id":"ckzxn6uyc000vb0tzhy1gel1y","category_id":"ckzxn6uye000xb0tz4ibb8s2c","_id":"ckzxn6uyi0017b0tzbmgd1r3v"},{"post_id":"ckzxn6uyg0013b0tz9n3p1jdi","category_id":"ckzxn6uyh0015b0tz03vbcdw0","_id":"ckzxn6uym001eb0tzeemo7f5i"},{"post_id":"ckzxn6uyi0019b0tzc3zi4ct6","category_id":"ckzxn6uym001cb0tz06l13at9","_id":"ckzxn6uyn001hb0tzawe15ghk"}],"PostTag":[{"post_id":"ckzxn6uxu0001b0tz9bnldgxq","tag_id":"ckzxn6uy00005b0tzfnm34ij3","_id":"ckzxn6uy5000bb0tz729sefyg"},{"post_id":"ckzxn6uy20008b0tz5xarcjh7","tag_id":"ckzxn6uy00005b0tzfnm34ij3","_id":"ckzxn6uy5000db0tz38wr0k4e"},{"post_id":"ckzxn6uxx0003b0tze3sk7msa","tag_id":"ckzxn6uy3000ab0tz0i3r9d9h","_id":"ckzxn6uy8000kb0tzhppwd7j3"},{"post_id":"ckzxn6uy6000eb0tzf4ew5sdj","tag_id":"ckzxn6uy3000ab0tz0i3r9d9h","_id":"ckzxn6uy9000nb0tz04yz5xo9"},{"post_id":"ckzxn6uy00006b0tzanyy3uhe","tag_id":"ckzxn6uy00005b0tzfnm34ij3","_id":"ckzxn6uya000rb0tzay4d9omo"},{"post_id":"ckzxn6uy10007b0tzgnzka912","tag_id":"ckzxn6uy9000ob0tz4sribd82","_id":"ckzxn6uyf000zb0tz3pwl1a32"},{"post_id":"ckzxn6uy10007b0tzgnzka912","tag_id":"ckzxn6uyc000ub0tz1bjmduni","_id":"ckzxn6uyf0011b0tz4h03b50a"},{"post_id":"ckzxn6uye000yb0tz1mwe95pa","tag_id":"ckzxn6uyg0012b0tz4yhmhw6l","_id":"ckzxn6uyi0018b0tzdyhj5e7s"},{"post_id":"ckzxn6uyh0016b0tzhvs1001b","tag_id":"ckzxn6uyj001ab0tz8h49exw0","_id":"ckzxn6uyn001fb0tz8cdd0zc8"},{"post_id":"ckzxn6uyh0016b0tzhvs1001b","tag_id":"ckzxn6uyc000ub0tz1bjmduni","_id":"ckzxn6uyn001gb0tzbn956f08"},{"post_id":"ckzxn6uyi0019b0tzc3zi4ct6","tag_id":"ckzxn6uym001db0tz68v6gdel","_id":"ckzxn6uyn001ib0tz6t877ja2"}],"Tag":[{"name":"Kick Start","_id":"ckzxn6uy00005b0tzfnm34ij3"},{"name":"Code Jam","_id":"ckzxn6uy3000ab0tz0i3r9d9h"},{"name":"Jenkins","_id":"ckzxn6uy9000ob0tz4sribd82"},{"name":"Maven","_id":"ckzxn6uyc000ub0tz1bjmduni"},{"name":"连接池","_id":"ckzxn6uyg0012b0tz4yhmhw6l"},{"name":"Java","_id":"ckzxn6uyj001ab0tz8h49exw0"},{"name":"设计模式","_id":"ckzxn6uym001db0tz68v6gdel"}]}}